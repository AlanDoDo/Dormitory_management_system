### 基于vue + spring boot开发学生宿舍管理系统实战视频教程

#### 第01讲 课程介绍与项目演示

##### 1.技术要点

html、css3、js、vue基础

##### 2.适合人群

有html、css3、js、vue基础，想学习vue、element ui开发后台管理系统的在校大学生、工作人员；

想学习如何实现动态菜单、动态路由、按钮权限的在职人员；

##### 3.学习收获

​	1.学会使用vue-admin-template搭建后台系统；

​	2.vue-admin-template登录源码、权限权限验证流程分析；

​	3.vue动态菜单、动态路由、按钮权限实现原理，代码实现；

​	4.通用弹框、tree组件优化、页面优化、通用axios封装、restful api支持封装；

​	5.前后端分离中的token(JWT)验证处理；

​	6.掌握spring boot在前后端分离项目中的使用

​	7.全程手把手带领写代码，最终从0到1打造属于自己的前后端分离实战项目；





#### 第02讲 开发环境准备

##### 1、环境准备

```js
1、安装node.js
2、安装vue-cli
3、安装 vs code开发工具
```

<span style='color:#FF7670;'>注意：本课程采用 node-v12.19.0-x64.msi版本，建议下载跟课程相同的版本进行安装</span>

##### 2、下载node.js

​	浏览器打开   https://nodejs.org/zh-cn/download/   进入如下所示的界面

![](D:\项目实战\3\springboot+vue版宿舍管理系统\资料\images\以往版本选择.png)

###### 1.2点击【以往的版本】进入如下所示列表界面，选择自己所需要的版本进行下载安装

![](D:\项目实战\3\springboot+vue版宿舍管理系统\资料\images\以往版本列表.png)



##### 3、vue-cli安装

###### 1.2.1检查node.js是否安装

通过命令提示符，node -v  npm -v查看，如果没有请先安装node.js,如下图，说明已经安装node.js

![](D:\项目实战\3\springboot+vue版宿舍管理系统\资料\images\node安装9.png)



###### 1.2.2.把npm换成cnpm

命令工具输入   npm install -g cnpm --registry=https://registry.npm.taobao.org

安装完成 输入 cnpm -v 查看是否安装成功

卸载cnpm    npm uninstall cnpm -g

###### 1.2.3.安装vue-cli

cnpm install -g @vue/cli



###### 1.2.4.查看vue-cli是否安装成功

vue -V      

 注意 V是大写的



###### 4、vs code安装





#### 第03讲 vue-admin-template下载



##### 1、vue-element-admin介绍

[vue-element-admin](http://panjiachen.github.io/vue-element-admin) 是一个后台前端解决方案，它基于 [vue](https://github.com/vuejs/vue) 和 [element-ui](https://github.com/ElemeFE/element)实现。它使用了最新的前端技术栈，内置了 i18 国际化解决方案，动态路由，权限验证，提炼了典型的业务模型，提供了丰富的功能组件，它可以帮助你快速搭建企业级中后台产品原型。相信不管你的需求是什么，本项目都能帮助到你。

建议

本项目的定位是后台集成方案，不太适合当基础模板来进行二次开发。因为本项目集成了很多你可能用不到的功能，会造成不少的代码冗余。如果你的项目不关注这方面的问题，也可以直接基于它进行二次开发。

- 集成方案: [vue-element-admin](https://github.com/PanJiaChen/vue-element-admin)
- 基础模板: [vue-admin-template](https://github.com/PanJiaChen/vue-admin-template)
- 桌面终端: [electron-vue-admin](https://github.com/PanJiaChen/electron-vue-admin)
- Typescript 版: [vue-typescript-admin-template](https://github.com/Armour/vue-typescript-admin-template) (鸣谢: [@Armour](https://github.com/Armour))
- Others: [awesome-project](https://github.com/PanJiaChen/vue-element-admin/issues/2312)



**vue-element-admin和vue-admin-template区别**

```js
1、vue-admin-template是vue-element-admin的简化版，适合企业搭建项目；并且简化版有两个版本，注意选择；
2、vue-element-admin 定位是后台集成方案，不太适合当基础模板来进行二次开发。因为本项目集成了很多你可能用不到的功能，会造成不少的代码冗余
```



##### 2、vue-admin-template下载

```js
在线演示地址
https://panjiachen.github.io/vue-admin-template/#/login?redirect=%2Fdashboard

下载地址
https://gitee.com/panjiachen/vue-admin-template/blob/master/README-zh.md
```

##### 3、运行项目

```js
1.安装依赖   npm install 
2.运行项目   npm run dev
```

##### 4、运行项目报错解决

```js
1. error  Multiple spaces found before '//需要添加该项，否则上级不...'  no-multi-spaces错误
 找到项目的.eslintrc.js配置文件把rules:中的   'no-multi-spaces': 'off'   //关闭空格的检查

2. error    Trailing spaces not allowed                          no-trailing-spaces错误
找到项目的.eslintrc.js配置文件在rules:中添加   'no-trailing-spaces': 'error', // 行末不要空格
```





#### 第04讲  配置左侧导航菜单

![](D:\项目实战\3\springboot+vue版宿舍管理系统\资料\images\1-1.png)

##### 1、修改应用的名称

找到src目录下的settings.js配置文件，修改为如下所示

```js
module.exports = {

  title: '学生宿舍管理系统',

  /**
   * @type {boolean} true | false
   * @description Whether fix the header
   */
  fixedHeader: true,   //固定头部 true为打开伸缩栏

  /**
   * @type {boolean} true | false
   * @description Whether show the logo in sidebar
   */
  sidebarLogo: true  //显示图标 logo
}

```

##### 2、修改右侧的下拉菜单

找到src/layout/components下的Navbar.vue文件，把el-dropdown-menu修改为如下所示代码

```js
<el-dropdown-menu  slot="dropdown" class="user-dropdown">
          <el-dropdown-item divided>
            <span style="display:block;">重置密码</span>
          </el-dropdown-item>
          <el-dropdown-item divided @click.native="logout">
            <span style="display:block;">退出登录</span>
          </el-dropdown-item>
</el-dropdown-menu>
```

##### 3、修改Dashboard为首页

3.1、修改router下的router.js里面的dashboard的title为 首页

```js
{
    path: '/',
    component: Layout,
    redirect: '/dashboard',
    children: [{
      path: 'dashboard',
      name: 'Dashboard',
      component: () => import('@/views/dashboard/index'),
      meta: { title: '首页', icon: 'dashboard' }
    }]
  }
```

3.2、修改components/Breadcrumb/index.vue中的 title  为首页

```js
if (!this.isDashboard(first)) {
        matched = [{ path: '/dashboard', meta: { title: '首页' }}].concat(matched)
 }
```

##### 4、新建模块页面，并创建页面对应的路由

```js
import Vue from 'vue'
import Router from 'vue-router'

Vue.use(Router)

/* Layout */
import Layout from '@/layout'

/**
 * Note: sub-menu only appear when route children.length >= 1
 * Detail see: https://panjiachen.github.io/vue-element-admin-site/guide/essentials/router-and-nav.html
 *
 * hidden: true                   if set true, item will not show in the sidebar(default is false)
 * alwaysShow: true               if set true, will always show the root menu
 *                                if not set alwaysShow, when item has more than one children route,
 *                                it will becomes nested mode, otherwise not show the root menu
 * redirect: noRedirect           if set noRedirect will no redirect in the breadcrumb
 * name:'router-name'             the name is used by <keep-alive> (must set!!!)
 * meta : {
    roles: ['admin','editor']    control the page roles (you can set multiple roles)
    title: 'title'               the name show in sidebar and breadcrumb (recommend set)
    icon: 'svg-name'/'el-icon-x' the icon show in the sidebar
    breadcrumb: false            if set false, the item will hidden in breadcrumb(default is true)
    activeMenu: '/example/list'  if set path, the sidebar will highlight the path you set
  }
 */

/**
 * constantRoutes
 * a base page that does not have permission requirements
 * all roles can be accessed
 */
export const constantRoutes = [
  {
    path: '/login',
    component: () => import('@/views/login/index'),
    hidden: true
  },

  {
    path: '/404',
    component: () => import('@/views/404'),
    hidden: true
  },
  {
    path: '/',
    component: Layout,
    redirect: '/dashboard',
    children: [{
      path: 'dashboard',
      name: 'Dashboard',
      component: () => import('@/views/dashboard/index'),
      meta: { title: '首页', icon: 'dashboard' }
    }]
  }
]

/**
 * asyncRoutes
 * the routes that need to be dynamically loaded based on user roles
 */
export const asyncRoutes = [
  {
    path: '/system',
    component: Layout,
    alwaysShow: true,
    name: 'system',
    meta: { title: '系统管理', icon: 'el-icon-s-help' },
    children: [
      {
        path: '/sysUserList',
        name: 'sysUserList',
        component: () => import('@/views/system/sysUserList'),
        meta: { title: '用户管理', icon: 'table' }
      },
      {
        path: '/sysRoleList',
        name: 'sysRoleList',
        component: () => import('@/views/system/sysRoleList'),
        meta: { title: '角色管理', icon: 'tree' }
      },
      {
        path: '/sysMenuList',
        name: 'sysMenuList',
        component: () => import('@/views/system/sysMenuList'),
        meta: { title: '菜单管理', icon: 'tree' }
      }
    ]
  },
  {
    path: '/colloge',
    component: Layout,
    alwaysShow: true,
    name: 'colloge',
    meta: { title: '学院管理', icon: 'el-icon-s-help' },
    children: [
      {
        path: '/collogeList',
        name: 'collogeList',
        component: () => import('@/views/colloge/collogeList'),
        meta: { title: '学院管理', icon: 'table' }
      },
      {
        path: '/majorList',
        name: 'majorList',
        component: () => import('@/views/colloge/majorList'),
        meta: { title: '专业管理', icon: 'tree' }
      },
      {
        path: '/classList',
        name: 'classList',
        component: () => import('@/views/colloge/classList'),
        meta: { title: '班级管理', icon: 'tree' }
      }
    ]
  },

  // 404 page must be placed at the end !!!
  { path: '*', redirect: '/404', hidden: true }
]

const createRouter = () => new Router({
  // mode: 'history', // require service support
  scrollBehavior: () => ({ y: 0 }),
  routes: constantRoutes
})

const router = createRouter()

// Detail see: https://github.com/vuejs/vue-router/issues/1234#issuecomment-357941465
export function resetRouter() {
  const newRouter = createRouter()
  router.matcher = newRouter.matcher // reset router
}

export default router


```

##### 4、新建上面路由中对应的组件页面

###### 4.1、在src/views下新建system目录

1.新建sysMenuList.vue组件

```js
<template>
    <div>
菜单管理
    </div>
</template>

<script>
    export default {
        
    }
</script>

<style lang="scss" scoped>

</style>
```

2.新建sysRoleList.vue组件

```js
<template>
    <div>
角色管理
    </div>
</template>

<script>
    export default {
        
    }
</script>

<style lang="scss" scoped>

</style>
```

3.新建sysUserList.vue组件

```js
<template>
    <div>
        用户管理
    </div>
</template>

<script>
    export default {
        
    }
</script>

<style lang="scss" scoped>

</style>
```



###### 4.2、在src/views下新建colloge文件夹，并新建如下页面

1、collogeList.vue页面

```js
<template>
  <div>学院管理</div>
</template>

<script>
export default {};
</script>

<style lang="scss" scoped>
</style>
```



2、majorList.vue页面

```js
<template>
  <div>专业管理</div>
</template>

<script>
export default {};
</script>

<style lang="scss" scoped>
</style>
```



3、classList.vue页面

```js
<template>
  <div>班级管理</div>
</template>

<script>
export default {};
</script>

<style lang="scss" scoped>
</style>
```



##### 5、菜单改为打开一个

找到src/layout下的components目录，修改SideBar目录下的index.vue中的   :unique-opened="true"



#### 第05讲  项目添加添加tagsview选项卡

###### 1、添加TagsView文件

把vue-element-admin项目中的src\layout\components下的TagsView文件夹复制到vue-admin-template的 src\layout\components下

把vue-element-admin\src\store\modules\tagsView.js 复制到vue-admin-template\srcstore\modules\

###### 2、修改 vue-admin-template\src\layout\components\AppMain.vue文件

```js
<template>
  <section class="app-main">
    <transition name="fade-transform" mode="out-in">
      <!-- <router-view :key="key" /> -->
      <keep-alive :include="cachedViews">
        <router-view :key="key" />
      </keep-alive>
    </transition>
  </section>
</template>

<script>
export default {
  name: "AppMain",
  computed: {
    cachedViews() {
      return this.$store.state.tagsView.cachedViews;
    },
    key() {
      return this.$route.path;
    },
  },
};
</script>

<style scoped>
.app-main {
  /*50 = navbar  */
  min-height: calc(100vh - 50px);
  width: 100%;
  position: relative;
  overflow: hidden;
}
.fixed-header + .app-main {
  padding-top: 50px;
}
</style>

<style lang="scss">
// fix css style bug in open el-dialog
.el-popup-parent--hidden {
  .fixed-header {
    padding-right: 15px;
  }
}
</style>

```



###### 3、修改vue-admin-template\src\layout\components\index.js

```js
新增如下行：
export { default as TagsView } from './TagsView'
```

###### 4、修改 vue-admin-template\src\layout\index.vue

```js
<template>
  <div :class="classObj" class="app-wrapper">
    <div v-if="device==='mobile'&&sidebar.opened" class="drawer-bg" @click="handleClickOutside" />
    <sidebar class="sidebar-container" />
    <div class="main-container">
      <div :class="{'fixed-header':fixedHeader}">
        <navbar />
      </div>
      <tags-view />
      <app-main />
    </div>
  </div>
</template>

<script>
import { Navbar, Sidebar, AppMain,TagsView  } from './components'
import ResizeMixin from './mixin/ResizeHandler'

export default {
  name: 'Layout',
  components: {
    Navbar,
    Sidebar,
    AppMain,
    TagsView 
  },
  mixins: [ResizeMixin],
  computed: {
    sidebar() {
      return this.$store.state.app.sidebar
    },
    device() {
      return this.$store.state.app.device
    },
    fixedHeader() {
      return this.$store.state.settings.fixedHeader
    },
    classObj() {
      return {
        hideSidebar: !this.sidebar.opened,
        openSidebar: this.sidebar.opened,
        withoutAnimation: this.sidebar.withoutAnimation,
        mobile: this.device === 'mobile'
      }
    }
  },
  methods: {
    handleClickOutside() {
      this.$store.dispatch('app/closeSideBar', { withoutAnimation: false })
    }
  }
}
</script>

<style lang="scss" scoped>
  @import "~@/styles/mixin.scss";
  @import "~@/styles/variables.scss";

  .app-wrapper {
    @include clearfix;
    position: relative;
    height: 100%;
    width: 100%;
    &.mobile.openSidebar{
      position: fixed;
      top: 0;
    }
  }
  .drawer-bg {
    background: #000;
    opacity: 0.3;
    width: 100%;
    top: 0;
    height: 100%;
    position: absolute;
    z-index: 999;
  }

  .fixed-header {
    position: fixed;
    top: 0;
    right: 0;
    z-index: 9;
    width: calc(100% - #{$sideBarWidth});
    transition: width 0.28s;
  }

  .hideSidebar .fixed-header {
    width: calc(100% - 54px)
  }

  .mobile .fixed-header {
    width: 100%;
  }
</style>

```



###### 5、修改 vue-admin-template\src\store\getters.js，

新增

 visitedViews: state => state.tagsView.visitedViews,
 cachedViews: state => state.tagsView.cachedViews

```js
const getters = {
  sidebar: state => state.app.sidebar,
  device: state => state.app.device,
  token: state => state.user.token,
  avatar: state => state.user.avatar,
  name: state => state.user.name,
  visitedViews: state => state.tagsView.visitedViews,
  cachedViews: state => state.tagsView.cachedViews
}
export default getters

```

###### 6、修改 vue-admin-template\src\store\index.js

引入 import tagsView from './modules/tagsView'

```js
import Vue from 'vue'
import Vuex from 'vuex'
import getters from './getters'
import app from './modules/app'
import settings from './modules/settings'
import user from './modules/user'
import tagsView from './modules/tagsView'
Vue.use(Vuex)

const store = new Vuex.Store({
  modules: {
    app,
    settings,
    user,
    tagsView
  },
  getters
})

export default store

```

###### 7、运行报错如下

![](D:\项目实战\3\springboot+vue版宿舍管理系统\资料\images\tagsview错误.png)

解决方式

删除vue-admin-template\src\layout\components\TagsView\index.vue中routes方法

![](D:\项目实战\3\springboot+vue版宿舍管理系统\资料\images\tags报错1.png)

![](D:\项目实战\3\springboot+vue版宿舍管理系统\资料\images\tags报错2.png)



###### 8、解决开启头部固定，不会显示 TagsView的问题

如果settings里面开启的如下所示，TagsView将不会显示

```js
  fixedHeader: true,
```

8.1、修改vue-admin-template\src\settings.js 添加

```js
tagsView: true,
```

8.2、修改vue-admin-template\src\store\modules\settings.js

```js
import defaultSettings from '@/settings'

const { showSettings, fixedHeader, sidebarLogo,tagsView } = defaultSettings

const state = {
  showSettings: showSettings,
  fixedHeader: fixedHeader,
  sidebarLogo: sidebarLogo,
  tagsView: tagsView,
}

const mutations = {
  CHANGE_SETTING: (state, { key, value }) => {
    // eslint-disable-next-line no-prototype-builtins
    if (state.hasOwnProperty(key)) {
      state[key] = value
    }
  }
}

const actions = {
  changeSetting({ commit }, data) {
    commit('CHANGE_SETTING', data)
  }
}

export default {
  namespaced: true,
  state,
  mutations,
  actions
}
```

8.3、修改 vue-admin-template\src\layout\components\AppMain.vue文件的样式如下

主要是有hasTagsView样式的时候

```js
<template>
  <section class="app-main">
    <transition name="fade-transform" mode="out-in">
      <!-- <router-view :key="key" /> -->
      <keep-alive :include="cachedViews">
        <router-view :key="key" />
      </keep-alive>
    </transition>
  </section>
</template>

<script>
export default {
  name: "AppMain",
  computed: {
    cachedViews() {
      return this.$store.state.tagsView.cachedViews;
    },
    key() {
      return this.$route.path;
    },
  },
};
</script>

<style lang="scss" scoped>
.app-main {
  /* 50= navbar  50  */
  min-height: calc(100vh - 50px);
  width: 100%;
  position: relative;
  overflow: hidden;
}

.fixed-header+.app-main {
  padding-top: 50px;
}

.hasTagsView {
  .app-main {
    /* 84 = navbar + tags-view = 50 + 34 */
    min-height: calc(100vh - 84px);
  }

  .fixed-header+.app-main {
    padding-top: 84px;
  }
}
</style>

<style lang="scss">
// fix css style bug in open el-dialog
.el-popup-parent--hidden {
  .fixed-header {
    padding-right: 15px;
  }
}
</style>

```

8.4、修改 vue-admin-template\src\layout\index.vue如下

主要是通过needTagsView进行判断

```js
<template>
  <div :class="classObj" class="app-wrapper">
    <div
      v-if="device === 'mobile' && sidebar.opened"
      class="drawer-bg"
      @click="handleClickOutside"
    />
    <sidebar class="sidebar-container" />
    <div :class="{ hasTagsView: needTagsView }" class="main-container">
      <div :class="{ 'fixed-header': fixedHeader }">
        <navbar />
        <tags-view v-if="needTagsView" />
      </div>
      <app-main />
    </div>
    <!-- <div class="hasTagsView main-container">
      <div :class="{'fixed-header':fixedHeader}">
        <navbar />
      </div>
       <tags-view />
      <app-main />
    </div> -->
  </div>
</template>

<script>
import { Navbar, Sidebar, AppMain, TagsView } from "./components";
import ResizeMixin from "./mixin/ResizeHandler";

export default {
  name: "Layout",
  components: {
    Navbar,
    Sidebar,
    AppMain,
    TagsView,
  },
  mixins: [ResizeMixin],
  computed: {
    sidebar() {
      return this.$store.state.app.sidebar;
    },
    device() {
      return this.$store.state.app.device;
    },
    fixedHeader() {
      return this.$store.state.settings.fixedHeader;
    },
    needTagsView() {
      return this.$store.state.settings.tagsView;
    },
    classObj() {
      return {
        hideSidebar: !this.sidebar.opened,
        openSidebar: this.sidebar.opened,
        withoutAnimation: this.sidebar.withoutAnimation,
        mobile: this.device === "mobile",
      };
    },
  },
  methods: {
    handleClickOutside() {
      this.$store.dispatch("app/closeSideBar", { withoutAnimation: false });
    },
  },
};
</script>

<style lang="scss" scoped>
@import "~@/styles/mixin.scss";
@import "~@/styles/variables.scss";

.app-wrapper {
  @include clearfix;
  position: relative;
  height: 100%;
  width: 100%;
  &.mobile.openSidebar {
    position: fixed;
    top: 0;
  }
}
.drawer-bg {
  background: #000;
  opacity: 0.3;
  width: 100%;
  top: 0;
  height: 100%;
  position: absolute;
  z-index: 999;
}

.fixed-header {
  position: fixed;
  top: 0;
  right: 0;
  z-index: 9;
  width: calc(100% - #{$sideBarWidth});
  transition: width 0.28s;
}

.hideSidebar .fixed-header {
  width: calc(100% - 54px);
}

.mobile .fixed-header {
  width: 100%;
}
</style>

```

######  9、解决刷新浏览器，TagsView选项卡丢失问题

找到 src\views\layout\components\TagsView.vue 组件

9.1、在methods方法中添加如下方法

```js
// 解决刷新浏览器tabs选项卡丢失问题
    beforeUnload() {
      // 监听页面刷新
      window.addEventListener("beforeunload", () => {
        // visitedViews数据结构太复杂无法直接JSON.stringify处理，先转换需要的数据
        let tabViews = this.visitedViews.map((item) => {
          return {
            fullPath: item.fullPath,
            hash: item.hash,
            meta: { ...item.meta },
            name: item.name,
            params: { ...item.params },
            path: item.path,
            query: { ...item.query },
            title: item.title,
          };
        });
        sessionStorage.setItem("tabViews", JSON.stringify(tabViews));
      });
      // 页面初始化加载判断缓存中是否有数据
      let oldViews = JSON.parse(sessionStorage.getItem("tabViews")) || [];
      if (oldViews.length > 0) {
        this.$store.state.tagsView.visitedViews = oldViews;
      }
    },
```

9.2、mounted()生命周期函数中添加刷新选项卡方法

```js
mounted() {
    this.initTags();
    this.addTags();
     // 解决刷新选项卡丢失问题
    this.beforeUnload();
},
```

###### 10、解决选项卡为【首页】不能关闭的问题

在router中的index.js找到首页路由配置项，并在 meta中添加   affix: true    如下meta配置所示

```js
{
    path: '/',
    component: Layout,
    redirect: '/dashboard',
    children: [{
      path: 'dashboard',
      name: 'Dashboard',
      component: () => import('@/views/dashboard/index'),
      meta: { title: '首页', icon: 'dashboard', affix: true }
    }]
  }
```





#### 第06讲 权限相关数据库设计

采用RBAC模型

##### 1、用户表字段(sys_user)

| 字段名称                   | 数据类型 | 字段大小 | 是否主键 | 是否为空 | 备注                              |
| :------------------------- | -------- | -------- | -------- | -------- | --------------------------------- |
| user_id                    | int      | 11       | 是       | 否       | 用户id                            |
| username                   | varchar  | 64       | 否       | 是       | 登录账户                          |
| password                   | varchar  | 128      | 否       | 是       | 登录密码                          |
| phone                      | varchar  | 13       | 否       | 是       | 用户电话                          |
| email                      | varchar  | 36       | 否       | 是       | 邮箱                              |
| sex                        | varchar  | 2        | 否       | 是       | 0:男 1：女                        |
| is_admin                   | tinyint  | 2        | 否       | 是       | 是否为超级管理员 1：是 0：否      |
| is_account_non_expired     | tinyint  | 2        | 否       | 是       | 帐户是否过期(1 未过期，0已过期)   |
| is_account_non_locked      | tinyint  | 2        | 否       | 是       | 帐户是否被锁定(1 未锁定，0已锁定) |
| is_credentials_non_expired | tinyint  | 2        | 否       | 是       | 密码是否过期(1 未过期，0已过期)   |
| is_enabled                 | tinyint  | 2        | 否       | 是       | 帐户是否可用(1 可用，0 删除用户)  |
| nick_name                  | varchar  | 36       | 否       | 是       | 姓名                              |
| create_time                | datetime |          | 否       | 是       | 创建时间                          |
| update_time                | datetime |          | 否       | 是       | 更新时间                          |



##### 2、用户角色表(sys_user_role)

| 字段名称     | 数据类型 | 字段大小 | 是否主键 | 是否为空 | 备注   |
| ------------ | -------- | -------- | -------- | -------- | ------ |
| user_role_id | int      | 11       | 是       | 否       | 主键   |
| user_id      | int      | 11       | 否       | 否       | 用户id |
| role_id      | int      | 11       | 否       | 否       | 角色id |



##### 3、角色表字段(sys_role)

| 字段名称    | 数据类型 | 字段大小 | 是否主键 | 是否为空 | 备注                          |
| :---------- | -------- | -------- | -------- | -------- | ----------------------------- |
| role_id     | int      | 11       | 是       | 否       | 角色id                        |
| role_name   | varchar  | 64       | 否       | 是       | 角色名称                      |
| role_type   | varchar  | 2        | 否       | 是       | 角色类型 1：系统用户  2：学生 |
| remark      | varchar  | 128      | 否       | 是       | 备注                          |
| create_time | datetime |          | 否       | 是       | 创建时间                      |
| update_time | datetime |          | 否       | 是       | 更新时间                      |



##### 4、角色菜单表(sys_role_menu)

| 字段名称     | 数据类型 | 字段大小 | 是否主键 | 是否为空 | 备注   |
| ------------ | -------- | -------- | -------- | -------- | ------ |
| role_menu_id | int      | 11       | 是       | 否       | 主键   |
| menu_id      | int      | 11       | 否       | 否       | 菜单id |
| role_id      | int      | 11       | 否       | 否       | 角色id |



##### 5、菜单表字段(sys_menu)

| 字段名称    | 数据类型 | 字段大小 | 是否主键 | 是否为空 | 备注                      |
| :---------- | -------- | -------- | -------- | -------- | ------------------------- |
| menu_id     | int      | 11       | 是       | 否       | 菜单id                    |
| parent_id   | int      | 11       | 否       | 是       | 父级菜单id                |
| title       | varchar  | 64       | 否       | 是       | 菜单名称                  |
| code        | varchar  | 64       | 否       | 是       | 权限字段                  |
| name        | varchar  | 36       | 否       | 是       | 路由name                  |
| path        | varchar  | 36       | 否       | 是       | 路由path                  |
| url         | varchar  | 128      | 否       | 是       | 组件路径                  |
| type        | varchar  | 2        | 否       | 是       | 类型(0 目录 1菜单，2按钮) |
| icon        | varchar  | 36       | 否       | 是       | 菜单图标                  |
| parent_name | varchar  | 64       | 否       | 是       | 上级菜单名称              |
| order_num   | int      | 11       | 否       | 是       | 序号                      |
| create_time | datetime |          | 否       | 是       | 创建时间                  |
| update_time | datetime |          | 否       | 是       | 更新时间                  |

```js
/*==============================================================*/
/* DBMS name:      MySQL 5.0                                    */
/* Created on:     2021-10-12 14:54:17                          */
/*==============================================================*/


drop table if exists sys_menu;

drop table if exists sys_role;

drop table if exists sys_role_menu;

drop table if exists sys_user;

drop table if exists sys_user_role;

/*==============================================================*/
/* Table: sys_menu                                              */
/*==============================================================*/
create table sys_menu
(
   menu_id              int not null auto_increment comment '菜单id',
   parent_id            int comment '父级菜单id',
   title                varchar(36) comment '菜单名称',
   code                 varchar(36) comment '权限字段',
   name                 varchar(36) comment '路由name',
   path                 varchar(36) comment '路由path',
   url                  varchar(128) comment '组件路径',
   type                 varchar(2) comment '类型(0 目录 1菜单，2按钮)',
   icon                 varchar(36) comment '菜单图标',
   parent_name          varchar(36) comment '上级菜单名称',
   order_num            int comment '序号',
   create_time          datetime comment '创建时间',
   update_time          datetime comment '更新时间',
   primary key (menu_id)
);

/*==============================================================*/
/* Table: sys_role                                              */
/*==============================================================*/
create table sys_role
(
   role_id              int not null auto_increment comment '角色id',
   role_name            varchar(36) comment '角色名称',
   role_type            varchar(2) comment '角色类型 1：系统用户  2：学生',
   remark               varchar(64) comment '备注',
   create_time          datetime comment '创建时间',
   update_time          datetime comment '更新时间',
   primary key (role_id)
);

/*==============================================================*/
/* Table: sys_role_menu                                         */
/*==============================================================*/
create table sys_role_menu
(
   role_menu_id         int not null auto_increment comment '主键',
   role_id              int comment '角色id',
   menu_id              int comment '菜单id',
   primary key (role_menu_id)
);

/*==============================================================*/
/* Table: sys_user                                              */
/*==============================================================*/
create table sys_user
(
   user_id              int not null auto_increment comment '用户id',
   username             varchar(36) comment '登录账户',
   password             varchar(128) comment '密码',
   phone                varchar(13) comment '13',
   email                varchar(36) comment '邮箱',
   sex                  varchar(2) comment '性别',
   is_admin             varchar(2) comment '是否是管理员',
   is_account_non_expired int comment '帐户是否过期(1 未过期，0已过期)',
   is_account_non_locked int comment '帐户是否被锁定(1 未锁定，0已锁定)',
   is_credentials_non_expired int comment '密码是否过期(1 未过期，0已过期)',
   is_enabled           int comment '帐户是否可用(1 可用，0 删除用户)',
   nick_name            varbinary(36) comment '姓名',
   create_time          datetime comment '创建时间',
   update_time          datetime comment '更新时间',
   primary key (user_id)
);


/*==============================================================*/
/* Table: sys_user_role                                         */
/*==============================================================*/
create table sys_user_role
(
   user_role_id         int not null auto_increment comment '主键',
   user_id              int comment '用户id',
   role_id              int comment '角色id',
   primary key (user_role_id)
);



```





#### 第07讲  后台多模块系统搭建

**开发环境配置：**

```js
1、JDK安装配置
2、IDEA安装
3、maven安装
4、MySql安装
5、数据库可视化工具 Navicat安装
```

**maven配置**

```js
1、配置本地仓库地址：  <localRepository>D:\javaDe\apache-maven-3.5.4\repo</localRepository>
2、修改为阿里镜像：
<mirror>
  <id>nexus-aliyun</id>
  <mirrorOf>central</mirrorOf>
  <name>Nexus aliyun</name>
  <url>http://maven.aliyun.com/nexus/content/groups/public</url>
</mirror>
```



###### 1、项目依赖版本号**

JDk1.8及以上、Maven3.5以上、MySq5.7以上



###### 2、项目结构

| itmk-base-parent | 父模块，pom类型、统一管理子模块 |
| ---------------- | ------------------------------- |
| itmk-base-common | 公共模块、如通用工具的封装等    |
| itmk-base-web    | 前端接口模块，提供api接口       |

###### 3、创建itmk-base-parent父模块

1、打开IDEA，file -> new - > project

![](D:\项目实战\3\springboot+vue版宿舍管理系统\资料\images\4-1.png)

2、选择左侧**Maven**，Project SDK选择**1.8及以上**，点击Next

![](D:\项目实战\3\springboot+vue版宿舍管理系统\资料\images\4-2.png)

3、Name里面输入**模块名称**，Location选择**项目存储路径**，GroupId:**输入包名，同一个项目，各个模块的包名一致**    ArtifactId: **模块名称**；点击Finish

![](D:\项目实战\3\springboot+vue版宿舍管理系统\资料\images\4-3.png)

4、由于itmk-base-parent作为父模块，把生成的模块中的src删除；

![](D:\项目实战\3\springboot+vue版宿舍管理系统\资料\images\4-4.png)



###### 4、创建itmk-base-common模块

1.在父模块itmk-base-parent上右键->New->Module，如下所示

![](D:\项目实战\3\springboot+vue版宿舍管理系统\资料\images\4-5.png)

2.选择Maven,SDK选择1.8及以上，点击Next

![](D:\项目实战\3\springboot+vue版宿舍管理系统\资料\images\4-6.png)

3.Name:输入模块名称 itmk-base-common，点击Finish

![](D:\项目实战\3\springboot+vue版宿舍管理系统\资料\images\4-7.png)

###### 5、创建itmk-base-web模块

1.itmk-base-parent模块右键，点击New->Module

![](D:\项目实战\3\springboot+vue版宿舍管理系统\资料\images\4-8.png)

2.选择Maven，SDK选择1.8及以上，点击 Next

![](D:\项目实战\3\springboot+vue版宿舍管理系统\资料\images\4-9.png)

3.Name填入模块名称，点击Finish

![](D:\项目实战\3\springboot+vue版宿舍管理系统\资料\images\4-10.png)

4.项目最终模块

![](D:\项目实战\3\springboot+vue版宿舍管理系统\资料\images\4-11.png)





#### 第08讲 引入各个模块依赖

###### 1、修改package类型

修改父模块 itmk-base-parent的pom.xml打包类型为 pom; 

itmk-base-common的pom.xml打包类型为 jar；

itmk-base-wem的pom.xml打包类型为jar

![](D:\项目实战\3\springboot+vue版宿舍管理系统\资料\images\5-1.png)



###### 2、itmk-base-parent pom.xml文件

```js
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.itmk</groupId>
    <artifactId>itmk-base-parent</artifactId>
    <packaging>pom</packaging>
    <version>1.0-SNAPSHOT</version>
    <modules>
        <module>itmk-base-common</module>
        <module>itmk-base-web</module>
    </modules>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.4.4</version>
    </parent>
    <properties>
        <java.version>1.8</java.version>
        <swagger2.version>3.0.0</swagger2.version>
        <lombok-version>1.18.12</lombok-version>
        <mybatis-plus.version>3.4.2</mybatis-plus.version>
        <druid.version>1.2.1</druid.version>
        <kaptcha.version>2.3.2</kaptcha.version>
        <fastjson.version>1.2.68</fastjson.version>
        <commons-lang.version>2.6</commons-lang.version>
        <commons-collections.version>3.2.2</commons-collections.version>
        <commons-io.version>2.6</commons-io.version>
        <mysql-connection.version>8.0.21</mysql-connection.version>
    </properties>
    <dependencyManagement>
        <dependencies>
            <!-- lombok依赖 -->
            <dependency>
                <groupId>org.projectlombok</groupId>
                <artifactId>lombok</artifactId>
                <version>${lombok-version}</version>
                <scope>provided</scope>
            </dependency>
            <dependency>
                <groupId>mysql</groupId>
                <artifactId>mysql-connector-java</artifactId>
                <version>${mysql-connection.version}</version>
                <scope>runtime</scope>
            </dependency>
            <!--druid连接池-->
            <dependency>
                <groupId>com.alibaba</groupId>
                <artifactId>druid-spring-boot-starter</artifactId>
                <version>${druid.version}</version>
            </dependency>
            <!--mybatis-plus依赖-->
            <dependency>
                <groupId>com.baomidou</groupId>
                <artifactId>mybatis-plus-boot-starter</artifactId>
                <version>${mybatis-plus.version}</version>
            </dependency>
            <!-- kaptcha 图形验证码 -->
            <dependency>
                <groupId>com.github.penggle</groupId>
                <artifactId>kaptcha</artifactId>
                <version>${kaptcha.version}</version>
            </dependency>

            <!-- JSON转换工具类依赖 -->
            <dependency>
                <groupId>com.alibaba</groupId>
                <artifactId>fastjson</artifactId>
                <version>${fastjson.version}</version>
            </dependency>

            <dependency>
                <groupId>commons-lang</groupId>
                <artifactId>commons-lang</artifactId>
                <version>${commons-lang.version}</version>
            </dependency>
            <dependency>
                <groupId>commons-collections</groupId>
                <artifactId>commons-collections</artifactId>
                <version>${commons-collections.version}</version>
            </dependency>
            <dependency>
                <groupId>commons-io</groupId>
                <artifactId>commons-io</artifactId>
                <version>${commons-io.version}</version>
            </dependency>
            <dependency>
                <groupId>io.springfox</groupId>
                <artifactId>springfox-boot-starter</artifactId>
                <version>${swagger2.version}</version>
            </dependency>
        </dependencies>
    </dependencyManagement>

</project>
```



###### 3、itmk-base-common  pom.xml

```js
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>itmk-base-parent</artifactId>
        <groupId>com.itmk</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>itmk-base-common</artifactId>
    <dependencies>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
        <!-- swagger api文档 -->
        <dependency>
            <groupId>io.springfox</groupId>
            <artifactId>springfox-boot-starter</artifactId>
        </dependency>
        <!-- jwt-->
        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt</artifactId>
            <version>0.9.0</version>
        </dependency>
        <!-- 工具类依赖 -->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
        </dependency>
    </dependencies>
</project>
```



###### 4、itmk-base-web  pom.xml

```js
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>itmk-base-parent</artifactId>
        <groupId>com.itmk</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>itmk-base-web</artifactId>
    <dependencies>
        <dependency>
            <groupId>com.itmk</groupId>
            <artifactId>itmk-base-common</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
        <!--web启动器,对springmvc,serlvet等支持-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-aop</artifactId>
        </dependency>

        <!--数据库依赖-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-jdbc</artifactId>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
        </dependency>
        <!--mybatis-plus启动器-->
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
        </dependency>
        <!--druid连接池-->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>druid-spring-boot-starter</artifactId>
        </dependency>
        <!-- swagger api文档 -->
        <dependency>
            <groupId>io.springfox</groupId>
            <artifactId>springfox-boot-starter</artifactId>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-compress</artifactId>
            <version>1.18</version>
        </dependency>
		<dependency>
            <groupId>commons-lang</groupId>
            <artifactId>commons-lang</artifactId>
        </dependency>
    </dependencies>
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <version>2.1.4.RELEASE</version>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.1</version>
                <configuration>
                    <source>${java.version}</source>
                    <target>${java.version}</target>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-surefire-plugin</artifactId>
                <version>2.19.1</version>
                <configuration>
                    <skipTests>true</skipTests>    <!--打包过程默认关掉单元测试 -->
                </configuration>
            </plugin>
        </plugins>
    </build>

</project>
```



#### 第09讲 整合MyBatis Plus

mybatis plus官方教程**

```js
https://mp.baomidou.com/guide/
```



###### **1、新建application.yml文件**

​	1.1、在itmk-base-web模块resources文件下新建 application-test.yml文件

```js
#端口号配置
server:
  port: 8089
#数据库连接配置
spring:
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/sys_wygl?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=true&serverTimezone=GMT%2B8
    username: root
    password: 123456

#mybatis plus配置
mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  global-config:
    db-config:
      #配置mybatis plus 在更新时只更新非空和非NULL的字段
      update-strategy: not_empty

logging:
  pattern:
    console: '%d{yyyy-MM-dd} [%thread] %-5level %logger- %msg%n'
```

1.2、在itmk-base-web模块resources文件下新建 application.yml文件

```js
spring:
  profiles:
    active: test
```

###### 2、配置MyBatis Plus配置文件

```js
package com.itmk.config.mybatis;

import com.baomidou.mybatisplus.annotation.DbType;
import com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;
import com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;
import org.mybatis.spring.annotation.MapperScan;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
@MapperScan("com.itmk.*.*.mapper")
public class MyBatisPlusConfig {
    // 最新版
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return interceptor;
    }
}
```



###### 3、封装返回值

在itmk-base-common下新建 com.itmk.utils包

```js
package com.itmk.utils;
import lombok.AllArgsConstructor;
import lombok.Data;

@Data
@AllArgsConstructor
public class ResultVo<T> {
    private String msg;
    private int code;
    private T data;
}
```



###### 4、返回状态码定义

在itmk-base-common模块新建com.itmk.status包，然后新建 StatusCode类，如下所示

```js
package com.itmk.status;

/**
 * 返回状态码
 */
public class StatusCode {
    //返回成功
    public static final int SUCCESS_CODE = 200;
    //错误状态码
    public static final int ERROR_CODE = 500;
    //无权限
    public static final int NO_LOGIN = 600;
    public static final int NO_AUTH = 700;
}
```



###### 5、返回工具类的封装

在itmk-base-common模块下的com.itmk.utils包中新建ResultUtils类

```js
package com.itmk.utils;

import com.itmk.status.StatusCode;

/**
 * 数据返回工具类
 */
public class ResultUtils {
    /**
     * 无参数返回
     * @return
     */
    public static ResultVo succcess() {
        return Vo(null, StatusCode.SUCCESS_CODE, null);
    }
    public static ResultVo success(String msg){
        return Vo(msg,StatusCode.SUCCESS_CODE,null);
    }
    /**
     * 返回带参数
     * @param msg
     * @param data
     * @return
     */
    public static ResultVo success(String msg,Object data){
        return Vo(msg,StatusCode.SUCCESS_CODE,data);
    }
    public static ResultVo success(String msg,int code,Object data){
        return Vo(msg,code,data);
    }
    public static ResultVo Vo(String msg, int code, Object data) {
        return new ResultVo(msg, code, data);
    }

    /**
     * 错误返回
     * @return
     */
    public static ResultVo error(){
        return Vo(null,StatusCode.ERROR_CODE,null);
    }
    public static ResultVo error(String msg){
        return Vo(msg,StatusCode.ERROR_CODE,null);
    }
    public static ResultVo error(String msg,int code,Object data){
        return Vo(msg,code,data);
    }
    public static ResultVo error(String msg,int code){
        return Vo(msg,code,null);
    }
    public static ResultVo error(String msg,Object data){
        return Vo(msg, StatusCode.ERROR_CODE,data);
    }
}
```



#### 第10讲  用户管理列表页面制作

##### 1、sysUserList.vue页面编写

```js
<template>
  <el-main>
    <!-- 搜索栏   element ui的标签，就当做普通的div就可以，只是他添加了一些属性
    :model:  form表单绑定的数据，通常是一个对象
    :rules: form表单验证的规则
    ref :  类似div的id，是唯一的
    label-width：表单文字标签的宽度
    :inline ： 是否同一行显示
    size: 表单内组件的大小
     -->
    <el-form
      :model="listParm"
      ref="searchRef"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item>
        <el-input
          placeholder="请输入姓名"
          v-model="listParm.nickName"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input placeholder="请输入电话" v-model="listParm.phone"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn">重置</el-button>
        <el-button type="primary" @click="addBtn" icon="el-icon-plus"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height='tableHeight' :data="tableData" border stripe>
      <el-table-column prop="name" label="姓名"></el-table-column>
      <el-table-column prop="address" label="地址"></el-table-column>
      <el-table-column prop="date" label="日期"></el-table-column>
      <el-table-column label="操作" align="center" width="180">
        <template slot-scope="scope">
          <el-button
            type="primary"
            size="small"
            icon="el-icon-edit"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            size="small"
            icon="el-icon-delete"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10,20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total" background>
    </el-pagination>
    
  </el-main>
</template>

<script>
export default {
  data() {
    return {
      //表格高度
      tableHeight:0,
      //列表查询的参数
      listParm: {
        phone: "",
        nickName: "",
        currentPage:1,
        pageSize:10,
        total:0
      },
      //表格的数据
      tableData: [
        {
          date: "2016-05-02",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1518 弄",
        },
        {
          date: "2016-05-04",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1517 弄",
        },
        {
          date: "2016-05-01",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1519 弄",
        },
        {
          date: "2016-05-03",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1516 弄",
        },
      ],
    };
  },
  methods: {
    //重置按钮
    resetBtn(){

    },
    //搜索按钮
    searchBtn(){

    },
    //新增按钮
    addBtn() {},
    //编辑按钮
    editBtn(row) {},
    //删除按钮
    deleteBtn(row) {},
    //页容量改变触发
    sizeChange(val){

    },
    //页数改变触发
    currentChange(val){

    }
  },
  mounted(){
    this.$nextTick(() =>{
      this.tableHeight = window.innerHeight -220
    })
  }
};
</script>

<style lang="scss" scoped>
</style>
```

##### 2、分页插件显示中文

在main.js中引入如下，注释原来的local

```js
// import locale from 'element-ui/lib/locale/lang/en' // lang i18n
import locale from 'element-ui/lib/locale/lang/zh-CN'
```





#### 第11讲 通用弹框组件封装

```js
知识点：

父组件向子组件传值 ：属性绑定

子组件调用父组件的方法 : $emit向父组件触发事件
```



###### 1.封装效果

![](D:\项目实战\3\springboot+vue版宿舍管理系统\资料\images\对话框.png)

###### 2.对话框官网 

https://element.eleme.cn/#/zh-CN/component/dialog

###### 3.对话框封装

在components下新建system目录，然后新建SysDialog.vue组件，然后把官网弹框代码复制进去

```js
<!--弹出框组件
  参数说明：
  title:弹出框标题
  visible:控制弹出框的显示和影藏
  width:弹出框的宽度，百分百，0~100的整数
  before-close：弹出框右上角关闭事件
  close-on-click-modal:防止点击弹出框以外的区域造成弹出框关闭
-->
<template>
  <div>
    <el-dialog
      top="5vh"
      :title="title"
      :visible.sync="visible"
      :width="width + 'px'"
      :before-close="onClose"
      :close-on-click-modal="false"
    >
     <div class="containner" :style="{ height: height + 'px' }">
      <slot name="content"></slot>
    </div>
      <span slot="footer" class="dialog-footer">
        <el-button @click="onClose">取 消</el-button>
        <el-button type="primary" @click="onConfirm">确 定</el-button>
      </span>
    </el-dialog>
  </div>
</template>

<script>
export default {
  props: {
    title: {
      type: String,
      default: "标题",
    },
    visible: {
      type: Boolean,
      default: false,
    },
    width: {
      type: Number,
      default: 600,
    },
    height: {
      type: Number,
      default: 250,
    },
  },
  data() {
    return {};
  },
  methods: {
    onClose() {
      this.$emit("onClose");
    },
    onConfirm() {
      this.$emit("onConfirm");
    },
  },
};
</script>

<style lang="scss" scoped>
.containner{
  overflow-x: initial;
  overflow-y: auto;
}
        
.el-dialog__wrapper {
  ::v-deep .el-dialog {
    border-top-left-radius: 7px !important;
    border-top-right-radius: 7px !important;
    .el-dialog__header {
      border-top-left-radius: 7px !important;
      border-top-right-radius: 7px !important;
      background-color: #1890ff;
      .el-dialog__title {
        color: #fff;
        font-size: 15px;
        font-weight: 700;
      }
      .el-dialog__close {
        color: #fff;
      }
    }
    .el-dialog__body {
      padding: 10px 10px !important;
    }
    .el-dialog__footer {
      border-top: 1px solid #e8eaec !important;
      padding: 10px !important;
    }
  }
}
</style>

```

###### 4.测试官网对话框

​	找到sysUserList.vue组件，然后引入SysDialog.vue组件，并注册SysDialog组件

```js
<template>
  <div>
   <sys-dialog
      :title="addDialog.title"
      :visible="addDialog.visible"
      :width="addDialog.width"
      :height="addDialog.height"
      @onClose="onColse"
      @onConfirm="onConfirm"
    >
      <div slot="content">弹框内容</div>
    </sys-dialog>
  </div>
</template>

<script>
import SysDialog from "@/components/system/SysDialog";
export default {
  components: { 
      SysDialog 
  },
  data(){
      return{
          addDialog: {
        title: "新增用",
        visible: false,
        width: 600,
        height: 250,
      },
      }
  },
  methods:{
       //弹框取消事件
    onColse() {
      this.addDialog.visible = false;
    },
    //弹框确认事件
    onConfirm() {
      this.addDialog.visible = false;
    },
  }
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第12讲 新增用户页面布局讲解

##### 1、解决点击弹框外关闭问题

```js
1、添加  :close-on-click-modal='false'  属性
```

##### 2、新增表单效果

![](D:\项目实战\3\springboot+vue版宿舍管理系统\资料\images\新增用户弹框.png)

##### 3、代码

```js
<!-- 新增或编辑弹框组件 -->
    <sys-dialog
      :title="dialog.title"
      :visible="dialog.visible"
      :width="dialog.width"
      :height="dialog.height"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <!-- form表单
        el-form ： 当做普通的form标签
        model ： 表单数据对象
        ref : 相当于div的id,唯一的
        rules : 表单验证规则
        label-width ： 表单域标签的宽度
        inline ： 是否在同一行显示，如果和el-row使用的时候，不需要添加该属性
        size ： 尺寸
        el-form-item ： 当做普通的div，
         -->
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="60px"
          size="small"
          style="margin-right: 20px"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="姓名">
                <el-input v-model="addModel.nickName"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="电话">
                <el-input v-model="addModel.phone"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="邮箱">
                <el-input v-model="addModel.email"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="性别">
                <el-radio-group v-model="addModel.sex">
                  <el-radio :label="'0'">男</el-radio>
                  <el-radio :label="'1'">女</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="账户">
                <el-input v-model="addModel.username"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="密码">
                <el-input v-model="addModel.password"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
```





#### 第13讲 表单验证规则

##### 1、表单验证的关键

```js
1、给表单添加ref属性
2、给el-form-item添加prop属性
3、定义表单验证的规则
4、表单提交时，通过 this.$refs.表单的ref.validate()
```





#### 第14讲 用户管理接口开发

##### 1、新建用户实体类

新建com.itmk.web.sys_user.entity包，然后新建SysUser实体类

```js
package com.itmk.web.sys_user.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.util.Date;

@Data
@TableName("sys_user")
public class SysUser {
    @TableId(type = IdType.AUTO)
    private Long userId;
    private String username;
    private String password;
    private String phone;
    private String email;
    private String sex;
    private String isAdmin;
     //帐户是否过期(1 未过期，0已过期)
    private boolean isAccountNonExpired = true;
    //帐户是否被锁定(1 未锁定，0已锁定)
    private boolean isAccountNonLocked = true;
    //密码是否过期(1 未过期，0已过期)
    private boolean isCredentialsNonExpired = true;
    //帐户是否可用(1 可用，0 删除用户)
    private boolean isEnabled = true;
    private String nickName;
    //创建时间
    private Date createTime;
    //更新时间
    private Date updateTime;
}

```

##### 2、新建mapper接口

```js
package com.itmk.web.sys_user.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.sys_user.entity.SysUser;

public interface SysUserMapper extends BaseMapper<SysUser> {
}

```

##### 3、新建mapper接口映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.sys_user.mapper.SysUserMapper">

</mapper>
```

##### 4、新建service层

```js
package com.itmk.web.sys_user.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.sys_user.entity.PageParm;
import com.itmk.web.sys_user.entity.SysUser;

public interface SysUserService extends IService<SysUser> {
    IPage<SysUser> list(PageParm parm);
}

```

**参数接收类**

```js
package com.itmk.web.sys_user.entity;

import lombok.Data;

@Data
public class PageParm {
    private Long currentPage;
    private Long pageSize;
    private String phone;
    private String nickName;
}

```



**实现类**

```js
package com.itmk.web.sys_user.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.sys_user.entity.PageParm;
import com.itmk.web.sys_user.entity.SysUser;
import com.itmk.web.sys_user.mapper.SysUserMapper;
import com.itmk.web.sys_user.service.SysUserService;
import org.apache.commons.lang.StringUtils;
import org.springframework.stereotype.Service;

@Service
public class SysUserServiceImpl extends ServiceImpl<SysUserMapper, SysUser> implements SysUserService {
    @Override
    public IPage<SysUser> list(PageParm parm) {
        //构造分页对象
        IPage<SysUser> page = new Page<>();
        page.setSize(parm.getPageSize());
        page.setCurrent(parm.getCurrentPage());
        QueryWrapper<SysUser> query = new QueryWrapper<>();
        //构造查询条件
        if(StringUtils.isNotEmpty(parm.getNickName())){
            query.lambda().like(SysUser::getNickName,parm.getNickName());
        }
        if(StringUtils.isNotEmpty(parm.getPhone())){
            query.lambda().like(SysUser::getPhone,parm.getPhone());
        }
        return this.baseMapper.selectPage(page,query);
    }
}

```

##### 5、新建控制器层

```js
package com.itmk.web.sys_user.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.sys_user.entity.PageParm;
import com.itmk.web.sys_user.entity.SysUser;
import com.itmk.web.sys_user.service.SysUserService;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.DigestUtils;
import org.springframework.web.bind.annotation.*;

import java.util.Date;

@RestController
@RequestMapping("/api/user")
public class SysUserController {
    @Autowired
    private SysUserService sysUserService;

    //新增员工
    @PostMapping
    public ResultVo addUser(@RequestBody SysUser sysUser){
        //判断用户名是否存在
        QueryWrapper<SysUser> query = new QueryWrapper<>();
        query.lambda().eq(SysUser::getUsername,sysUser.getUsername());
        SysUser one = sysUserService.getOne(query);
        if(one != null){
            return ResultUtils.error("账户已经被占用");
        }
        //密码加密
        if(StringUtils.isNotEmpty(sysUser.getPassword())){
            sysUser.setPassword(DigestUtils.md5DigestAsHex(sysUser.getPassword().getBytes()));
        }
        sysUser.setIsAdmin("0");
        sysUser.setCreateTime(new Date());
        //存入数据库
        boolean save = sysUserService.save(sysUser);
        if(save){
            return ResultUtils.success("新增用户成功!");
        }
        return  ResultUtils.error("新增用户失败!");
    }

    //编辑员工
    @PutMapping
    public ResultVo editUser(@RequestBody SysUser sysUser){
        //判断用户名是否存在
        QueryWrapper<SysUser> query = new QueryWrapper<>();
        query.lambda().eq(SysUser::getUsername,sysUser.getUsername());
        SysUser one = sysUserService.getOne(query);
        if(one != null && one.getUserId() != sysUser.getUserId()){
            return ResultUtils.error("账户已经被占用");
        }
        //密码加密
        if(StringUtils.isNotEmpty(sysUser.getPassword())) {
            sysUser.setPassword(DigestUtils.md5DigestAsHex(sysUser.getPassword().getBytes()));
        }
        sysUser.setUpdateTime(new Date());
        //存入数据库
        boolean save = sysUserService.updateById(sysUser);
        if(save){
            return ResultUtils.success("编辑用户成功!");
        }
        return  ResultUtils.error("编辑用户失败!");
    }

    //删除用户
    @DeleteMapping("/{userId}")
    public ResultVo deleteUser(@PathVariable("userId") Long userId){
        boolean remove = sysUserService.removeById(userId);
        if(remove){
            return ResultUtils.success("删除用户成功!");
        }
        return ResultUtils.error("删除用户失败!");
    }
    //用户列表
    @GetMapping("/list")
    public ResultVo getList(PageParm parm){
        IPage<SysUser> list = sysUserService.list(parm);
        //密码不显示
        list.getRecords().stream().forEach(item ->{
            item.setPassword("");
        });
        return ResultUtils.success("查询成功",list);
    }
}

```



#### 第15讲 用户管理列表接口对接

##### 1、安装qs

```js
npm install qs
```

##### 2、新建http.js

```js
import axios from 'axios'
import { MessageBox, Message } from 'element-ui'
import store from '@/store'
import { getToken } from '@/utils/auth'
import qs from 'qs'
// create an axios instance
//创建一个axios实例
const service = axios.create({
  baseURL: process.env.VUE_APP_BASE_API_PRO, // url = base url + request url
  // withCredentials: true, // send cookies when cross-domain requests
  timeout: 5000 // request timeout
})

// request interceptor
//请求发送之前的拦截器
service.interceptors.request.use(
  config => {
    // do something before request is sent
    //如果token存在，把token添加到请求的头部
    if (store.getters.token) {
      // let each request carry token
      // ['X-Token'] is a custom headers key
      // please modify it according to the actual situation
      config.headers['token'] = getToken()
    }
    return config
  },
  error => {
    // do something with request error
    console.log(error) // for debug
    return Promise.reject(error)
  }
)

// response interceptor
//请求返回之后的处理
service.interceptors.response.use(
  /**
   * If you want to get http information such as headers or status
   * Please return  response => response
  */

  /**
   * Determine the request status by custom code
   * Here is just an example
   * You can also judge the status by HTTP Status Code
   */
  response => {
    const res = response.data

    // if the custom code is not 20000, it is judged as an error.
    if (res.code !== 200) {
      Message({
        message: res.msg || '服务器出错',
        type: 'error',
        duration: 5 * 1000
      })

      //600是token过期或token验证失败 50008: Illegal token; 50012: Other clients logged in; 50014: Token expired;
      if (res.code === 600) {
        // to re-login
        MessageBox.confirm('您的登录信息已过期，请重新登录！', '系统提示', {
          confirmButtonText: '去登录',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          store.dispatch('user/resetToken').then(() => {
            location.reload()
          })
        })
      }
      return Promise.reject(new Error(res.msg || '服务器出错'))
    } else {
      return res
    }
  },
  error => {
    console.log('err' + error) // for debug
    Message({
      message: error.msg || '服务器出错!',
      type: 'error',
      duration: 5 * 1000
    })
    return Promise.reject(error)
  }
)

//请求方法
const http = {
    post(url, params) {
      return service.post(url, params, {
        transformRequest: [(params) => {
          return JSON.stringify(params)
        }],
        headers: {
          'Content-Type': 'application/json'
        }
      })
    },
    put(url, params) {
      return service.put(url, params, {
        transformRequest: [(params) => {
          return JSON.stringify(params)
        }],
        headers: {
          'Content-Type': 'application/json'
        }
      })
    },
    //parm =>  {id:10}
    // http://localhost:8089/api/user?id=10
    get(url, params) {
      return service.get(url, {
        params: params,
        paramsSerializer: (params) => {
          return qs.stringify(params)
        }
      })
    },
    //parm =>  {id:10}
    // http://localhost:8089/api/user/10
    getRestApi(url, params) {
      let _params
      if (Object.is(params, undefined || null)) {
        _params = ''
      } else {
        _params = '/'
        for (const key in params) {
          console.log(key)
          console.log(params[key])
          // eslint-disable-next-line no-prototype-builtins
          if (params.hasOwnProperty(key) && params[key] !== null && params[key] !== '') {
            _params += `${params[key]}/`
          }
        }
        //去掉参数最后一位?
        _params = _params.substr(0, _params.length - 1)
      }
      console.log(_params)
      if (_params) {
        return service.get(`${url}${_params}`)
      } else {
        return service.get(url)
      }
    },
    //parm =>  {id:10}
    // http://localhost:8089/api/user/10
    delete(url, params) {
      let _params
      if (Object.is(params, undefined || null)) {
        _params = ''
      } else {
        _params = '/'
        for (const key in params) {
          // eslint-disable-next-line no-prototype-builtins
          if (params.hasOwnProperty(key) && params[key] !== null && params[key] !== '') {
            _params += `${params[key]}/`
          }
        }
        //去掉参数最后一位?
        _params = _params.substr(0, _params.length - 1)
      }
      if (_params) {
        return service.delete(`${url}${_params}`).catch(err => {
          // message.error(err.msg)
          return Promise.reject(err)
        })
      } else {
        return service.delete(url).catch(err => {
          // message.error(err.msg)
          return Promise.reject(err)
        })
      }
    },
    upload(url, params) {
      return service.post(url, params, {
        headers: {
          'Content-Type': 'multipart/form-data'
        }
      })
    }
  }
  export default http

```

##### 3、api/user添加getUserListApi()方法

```js
//获取用户列表
export const getUserListApi = async(parm) =>{
  return await http.get("/api/user/list",parm)
}
```



##### 4、sysUserList.vue页面使用



##### 5、跨域解决

```js
package com.itmk.config.web;

import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebMvcConfig implements WebMvcConfigurer {
    /**
     * 跨域配置
     * @param registry
     */
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOriginPatterns("*")
                .allowedMethods("*")
                .allowedHeaders("*")
                .maxAge(3600)
                .allowCredentials(true);
    }
}
```



#### 第16讲 常用工具的封装



##### 1、对象的快速复制

```js
//对象的快速复制
export default async function objCoppy(obj1,obj2){
    Object.keys(obj2).forEach(key =>{
        obj2[key] = obj1[key]
    })
}
```



##### 2、清空表单

```js
//表单清空
// formName: 表单的ref属性  obj表单的数据域
export default function resetForm(formName,obj){
    //清空表单
    if(this.$refs[formName]){
        this.$refs[formName].resetFields();
        this.$refs[formName].clearValidate();
    }
    //清空数据域
    Object.keys(obj).forEach(key =>{
        obj[key] = '';
    })
}
```



##### 3、信息确认弹框封装

```js
import {MessageBox,Message} from 'element-ui'
//信息确认弹框封装
export default function myconfirm(text){
    return new Promise((resolve,reject)=>{
        MessageBox.confirm(text,'系统提示',{
            confirmButtonText:'确定',
            cancelButtonText:'取消',
            type:'warning'
        }).then(()=>{
            resolve(true);
        }).catch(()=>{
            Message.warning('已取消')
            reject(false)
        })
    }).catch(()=>{
        return false;
    })
}
```



##### 4、main.js全局挂载

```js
//清空表单
import resetForm from '@/utils/resetForm'
Vue.prototype.$resetForm = resetForm;
//信息提示框
import myconfirm from '@/utils/myconfirm'
Vue.prototype.$myconfirm = myconfirm;
//对象快速复制
import objCoppy from '@/utils/objCoppy'
Vue.prototype.$objCoppy = objCoppy;
```





#### 第17讲 新增、编辑接口对接

##### 1、api/user下新增如下方法

```js
//新增
export const addUserApi = async (parm) => {
  return await http.post("/api/user", parm)
}
//编辑
export const editUserApi = async (parm) => {
  return await http.put("/api/user", parm)
}
```

##### 2、sysUserList.vue页面

```js
<template>
  <!-- 只需要把element的标签，当做一个普通的div -->
  <el-main>
    <!-- 搜索栏 
    :model： 表单绑定的数据，通常是一个对象
    ref ： 相当于一个div的id,唯一的
    :rules ： 表单验证的规则
    label-width： 表单域标签的宽度，例如 '50px'
    :inline ： 是否在同一行显示
    size： 尺寸
    -->
    <el-form
      :model="listParm"
      ref="form"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item>
        <el-input
          placeholder="请输入姓名"
          v-model="listParm.nickName"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input placeholder="请输入电话" v-model="listParm.phone"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button icon="el-icon-close" style="color: #ff7670" @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 
    :data 表格的数据

    -->
    <el-table :height="tableHeight" :data="tableData" border stripe>
      <el-table-column prop="nickName" label="姓名"></el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="email" label="邮箱"></el-table-column>
      <el-table-column label="操作" width="180" align="center">
        <template slot-scope="scope">
          <el-button
            type="primary"
            size="small"
            icon="el-icon-edit"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            size="small"
            icon="el-icon-delete"
            @click="editBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total"
      background
    >
    </el-pagination>
    <!-- 新增或编辑弹框组件 -->
    <sys-dialog
      :title="dialog.title"
      :visible="dialog.visible"
      :width="dialog.width"
      :height="dialog.height"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <!-- el-form :当做一个普通的form标签
        el-input : 相当于 普通的 input标签
          el-form-item ： 表单的每一项
          model ： 表单绑定的数据
          ref ： 相当于一个div的id , 唯一的
          rules : 表单验证规则
          label-width ： 表单域标签的宽度
          inline ： 是否在同一行显示，如果和el-row使用时，不需要该属性
          size ： 尺寸
         -->
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          size="small"
          style="margin-right: 40px"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="nickName" label="姓名">
                <el-input v-model="addModel.nickName"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="phone" label="电话">
                <el-input v-model="addModel.phone"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="邮箱">
                <el-input v-model="addModel.email"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="sex" label="性别">
                <el-radio-group v-model="addModel.sex">
                  <el-radio :label="'0'">男</el-radio>
                  <el-radio :label="'1'">女</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="username" label="账户">
                <el-input v-model="addModel.username"></el-input>
              </el-form-item>
            </el-col>
            <el-col v-if="addModel.type == '0'" :span="12" :offset="0">
              <el-form-item prop="password" label="密码">
                <el-input v-model="addModel.password"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getListApi, addUserApi, editUserApi } from "@/api/user";
//引入弹框组件
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  //注册弹框组件
  components: {
    SysDialog,
  },
  data() {
    return {
      //表单验证规则
      rules: {
        nickName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写姓名",
          },
        ],
        phone: [
          {
            trigger: "blur",
            required: true,
            message: "请填写电话",
          },
        ],
        sex: [
          {
            trigger: "blur",
            required: true,
            message: "请选择性别",
          },
        ],
        username: [
          {
            trigger: "blur",
            required: true,
            message: "请填写账户",
          },
        ],
        password: [
          {
            trigger: "blur",
            required: true,
            message: "请填写密码",
          },
        ],
      },
      //表单绑定的数据
      addModel: {
        type: "",
        userId: "",
        nickName: "",
        phone: "",
        email: "",
        sex: "",
        username: "",
        password: "",
      },
      //弹框属性
      dialog: {
        title: "",
        visible: false,
        width: 630,
        height: 200,
      },
      //表格的高度
      tableHeight: 0,
      listParm: {
        total: 0,
        pageSize: 10, //默认每页显示10条数据
        currentPage: 1,
        nickName: "",
        phone: "",
      },
      tableData: [],
    };
  },
  created() {
    this.getList();
  },
  methods: {
    async getList() {
      let res = await getListApi(this.listParm);
      console.log("请求成功");
      console.log(res);
      if (res && res.code == 200) {
        this.tableData = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    //弹框的确定
    onConfirm() {
      //表单验证
      this.$refs.addRef.validate(async (valid) => {
        if (valid) {
          this.dialog.visible = false;
          let res = null;
          if (this.addModel.type == "0") {
            res = await addUserApi(this.addModel);
          } else {
            res = await editUserApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新表单
            this.getList();
            this.$message({ type: "success", message: res.msg });
          }
        }
      });
    },
    //弹框的取消
    onClose() {
      this.dialog.visible = false;
    },
    //页数改变时触发
    currentChange(val) {},
    //页容量改变时触发
    sizeChange(val) {},
    //编辑按钮
    editBtn(row) {
      //设置弹框属性
      this.dialog.title = "编辑用户";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      //把当前要编辑的数据复制到表单数据域
      this.$objCoppy(row, this.addModel);
      //设置编辑标识
      this.addModel.type = "1";
    },
    //搜索按钮
    searchBtn() {},
    //搜索按钮
    resetBtn() {},
    //新增按钮
    addBtn() {
      //设置弹框属性
      this.dialog.title = "新增用户";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      //设置编辑标识
      this.addModel.type = "0";
    },
  },
  mounted() {
    this.$nextTick(() => {
      //计算表格的高度
      this.tableHeight = window.innerHeight - 220;
    });
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第18讲 删除、搜索功能对接

##### 1、api/user下新建如下方法

```js
//删除
export const deleteUserApi = async(parm) =>{
  return await http.delete("/api/user",parm)
}

```

##### 2、sysUserList.vue

```js
<template>
  <!-- 只需要把element的标签，当做一个普通的div -->
  <el-main>
    <!-- 搜索栏 
    :model： 表单绑定的数据，通常是一个对象
    ref ： 相当于一个div的id,唯一的
    :rules ： 表单验证的规则
    label-width： 表单域标签的宽度，例如 '50px'
    :inline ： 是否在同一行显示
    size： 尺寸
    -->
    <el-form
      :model="listParm"
      ref="form"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item>
        <el-input
          placeholder="请输入姓名"
          v-model="listParm.nickName"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input placeholder="请输入电话" v-model="listParm.phone"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button icon="el-icon-close" style="color: #ff7670" @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 
    :data 表格的数据

    -->
    <el-table :height="tableHeight" :data="tableData" border stripe>
      <el-table-column prop="nickName" label="姓名"></el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="email" label="邮箱"></el-table-column>
      <el-table-column label="操作" width="180" align="center">
        <template slot-scope="scope">
          <el-button
            type="primary"
            size="small"
            icon="el-icon-edit"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            size="small"
            icon="el-icon-delete"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total"
      background
    >
    </el-pagination>
    <!-- 新增或编辑弹框组件 -->
    <sys-dialog
      :title="dialog.title"
      :visible="dialog.visible"
      :width="dialog.width"
      :height="dialog.height"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <!-- el-form :当做一个普通的form标签
        el-input : 相当于 普通的 input标签
          el-form-item ： 表单的每一项
          model ： 表单绑定的数据
          ref ： 相当于一个div的id , 唯一的
          rules : 表单验证规则
          label-width ： 表单域标签的宽度
          inline ： 是否在同一行显示，如果和el-row使用时，不需要该属性
          size ： 尺寸
         -->
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          size="small"
          style="margin-right: 40px"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="nickName" label="姓名">
                <el-input v-model="addModel.nickName"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="phone" label="电话">
                <el-input v-model="addModel.phone"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="邮箱">
                <el-input v-model="addModel.email"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="sex" label="性别">
                <el-radio-group v-model="addModel.sex">
                  <el-radio :label="'0'">男</el-radio>
                  <el-radio :label="'1'">女</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="username" label="账户">
                <el-input v-model="addModel.username"></el-input>
              </el-form-item>
            </el-col>
            <el-col v-if="addModel.type == '0'" :span="12" :offset="0">
              <el-form-item prop="password" label="密码">
                <el-input v-model="addModel.password"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getListApi, addUserApi, editUserApi, deleteUserApi } from "@/api/user";
//引入弹框组件
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  //注册弹框组件
  components: {
    SysDialog,
  },
  data() {
    return {
      //表单验证规则
      rules: {
        nickName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写姓名",
          },
        ],
        phone: [
          {
            trigger: "blur",
            required: true,
            message: "请填写电话",
          },
        ],
        sex: [
          {
            trigger: "blur",
            required: true,
            message: "请选择性别",
          },
        ],
        username: [
          {
            trigger: "blur",
            required: true,
            message: "请填写账户",
          },
        ],
        password: [
          {
            trigger: "blur",
            required: true,
            message: "请填写密码",
          },
        ],
      },
      //表单绑定的数据
      addModel: {
        type: "",
        userId: "",
        nickName: "",
        phone: "",
        email: "",
        sex: "",
        username: "",
        password: "",
      },
      //弹框属性
      dialog: {
        title: "",
        visible: false,
        width: 630,
        height: 200,
      },
      //表格的高度
      tableHeight: 0,
      listParm: {
        total: 0,
        pageSize: 10, //默认每页显示10条数据
        currentPage: 1,
        nickName: "",
        phone: "",
      },
      tableData: [],
    };
  },
  created() {
    this.getList();
  },
  methods: {
    async getList() {
      let res = await getListApi(this.listParm);
      console.log("请求成功");
      console.log(res);
      if (res && res.code == 200) {
        this.tableData = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    //弹框的确定
    onConfirm() {
      //表单验证
      this.$refs.addRef.validate(async (valid) => {
        if (valid) {
          this.dialog.visible = false;
          let res = null;
          if (this.addModel.type == "0") {
            res = await addUserApi(this.addModel);
          } else {
            res = await editUserApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新表单
            this.getList();
            this.$message({ type: "success", message: res.msg });
          }
        }
      });
    },
    //弹框的取消
    onClose() {
      this.dialog.visible = false;
    },
    //页数改变时触发
    currentChange(val) {
      this.listParm.currentPage = val;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.listParm.pageSize = val;
      this.getList();
    },
    //编辑按钮
    editBtn(row) {
      //设置弹框属性
      this.dialog.title = "编辑用户";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      //把当前要编辑的数据复制到表单数据域
      this.$objCoppy(row, this.addModel);
      //设置编辑标识
      this.addModel.type = "1";
    },
    //删除按钮
    async deleteBtn(row) {
      let confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteUserApi({ userId: row.userId });
        if (res && res.code == 200) {
          //刷新表单
          this.getList();
          this.$message({ type: "success", message: res.msg });
        }
      }
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
    //搜索按钮
    resetBtn() {
      this.listParm.nickName = "";
      this.listParm.phone = "";
      this.getList();
    },
    //新增按钮
    addBtn() {
      //设置弹框属性
      this.dialog.title = "新增用户";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      //设置编辑标识
      this.addModel.type = "0";
    },
  },
  mounted() {
    this.$nextTick(() => {
      //计算表格的高度
      this.tableHeight = window.innerHeight - 220;
    });
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第19讲 角色管理模块接口开发

##### 1、新建实体类

```js
package com.itmk.web.sys_role.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.util.Date;

@Data
@TableName("sys_role")
public class SysRole {
    @TableId(type = IdType.AUTO)
    private Long roleId;
    private String roleName;
    private String roleType;
    private String remark;
    private Date createTime;
    private Date updateTime;
}

```

**列表参数接收**

```js
package com.itmk.web.sys_role.entity;

import lombok.Data;

@Data
public class RoleParm {
    private Long currentPage;
    private Long pageSize;
    private String roleName;
}

```

##### 2、新建mapper

```js
package com.itmk.web.sys_role.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.sys_role.entity.SysRole;

public interface SysRoleMapper extends BaseMapper<SysRole> {
}

```

**映射文件**

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.sys_role.mapper.SysRoleMapper">

</mapper>
```

##### 3、service层

```js
package com.itmk.web.sys_role.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.sys_role.entity.RoleParm;
import com.itmk.web.sys_role.entity.SysRole;

public interface SysRoleService extends IService<SysRole> {
    IPage<SysRole> list(RoleParm parm);
}

```

**实现类**

```js
package com.itmk.web.sys_role.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.sys_role.entity.RoleParm;
import com.itmk.web.sys_role.entity.SysRole;
import com.itmk.web.sys_role.mapper.SysRoleMapper;
import com.itmk.web.sys_role.service.SysRoleService;
import org.apache.commons.lang.StringUtils;
import org.springframework.stereotype.Service;

@Service
public class SysRoleServiceImpl extends ServiceImpl<SysRoleMapper, SysRole> implements SysRoleService {
    @Override
    public IPage<SysRole> list(RoleParm parm) {
        //构造分页对象
        IPage<SysRole> page = new Page<>();
        page.setSize(parm.getPageSize());
        page.setCurrent(parm.getCurrentPage());
        //构造查询条件
        QueryWrapper<SysRole> query = new QueryWrapper<>();
        if(StringUtils.isNotEmpty(parm.getRoleName())){
            query.lambda().like(SysRole::getRoleName,parm.getRoleName());
        }
        return this.baseMapper.selectPage(page,query);
    }
}

```

##### 4、控制器

```js
package com.itmk.web.sys_role.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.sys_role.entity.RoleParm;
import com.itmk.web.sys_role.entity.SysRole;
import com.itmk.web.sys_role.service.SysRoleService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.Date;

@RestController
@RequestMapping("/api/role")
public class SysRoleController {
    @Autowired
    private SysRoleService sysRoleService;

    //新增角色
    @PostMapping
    public ResultVo addRole(@RequestBody SysRole role){
        role.setCreateTime(new Date());
        boolean save = sysRoleService.save(role);
        if(save){
            return ResultUtils.success("新增成功!");
        }
        return ResultUtils.error("新增失败!");
    }

    //编辑角色
    @PutMapping
    public ResultVo editRole(@RequestBody SysRole role){
        role.setUpdateTime(new Date());
        boolean save = sysRoleService.updateById(role);
        if(save){
            return ResultUtils.success("编辑成功!");
        }
        return ResultUtils.error("编辑失败!");
    }

    //删除角色
    @DeleteMapping("/{roleId}")
    public ResultVo deleteRole(@PathVariable("roleId") Long roleId){
        boolean b = sysRoleService.removeById(roleId);
        if(b){
            return ResultUtils.success("删除成功!");
        }
        return ResultUtils.error("删除失败!");
    }

    //角色列表
    @GetMapping("/list")
    public ResultVo getList(RoleParm parm){
        IPage<SysRole> list = sysRoleService.list(parm);
        return ResultUtils.success("查询成功",list);
    }
}

```



#### 第20讲角色管理列表制作

##### 1、src/api新建role.js

```js
import http from '@/utils/http'
//获取列表
export const getListApi = async(parm) =>{
    return await http.get("/api/role/list",parm)
}
```

##### 2、sysRoleList.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="listParm" ref="searchRef" :inline="true" size="small">
      <el-form-item>
        <el-input
          placeholder="请输入角色名称"
          v-model="listParm.roleName"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search">搜索</el-button>
        <el-button icon="el-icon-close" style="color: #ff7670">重置</el-button>
        <el-button type="primary" icon="el-icon-plus">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableData" border stripe>
      <el-table-column prop="roleName" label="角色名称"></el-table-column>
      <el-table-column prop="remark" label="备注"></el-table-column>
      <el-table-column label="操作">
        <template slot-scope="scope">
          <el-button type="primary" size="small" @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button type="danger" size="small" @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total"
      background
    >
    </el-pagination>
  </el-main>
</template>

<script>
import { getListApi } from "@/api/role";
export default {
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //搜索栏数据
      listParm: {
        roleName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      //表格数据
      tableData: [],
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getList();
  },
  methods: {
    //获取列表
    async getList() {
      let res = await getListApi(this.listParm);
      if (res && res.code == 200) {
        //设置表格数据
        console.log(res);
        this.tableData = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    //页数改变时触发
    currentChange(val) {},
    //页容量改变时触发
    sizeChange(val) {},
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {},
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第21讲 新增、编辑制作与对接

##### 1、src/api/role.js添加如下方法

```js
//新增
export const addRoleApi = async(parm) =>{
     return await http.post("/api/role",parm)
}
//编辑
export const editRoleApi = async(parm) =>{
    return await http.put("/api/role",parm)
}
```

##### 2、sysRoleList.vue

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="listParm" ref="searchRef" :inline="true" size="small">
      <el-form-item>
        <el-input
          placeholder="请输入角色名称"
          v-model="listParm.roleName"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search">搜索</el-button>
        <el-button icon="el-icon-close" style="color: #ff7670">重置</el-button>
        <el-button type="primary" @click="addBtn" icon="el-icon-plus"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableData" border stripe>
      <el-table-column prop="roleName" label="角色名称"></el-table-column>
      <el-table-column prop="remark" label="备注"></el-table-column>
      <el-table-column label="操作" align="center" width="180">
        <template slot-scope="scope">
          <el-button type="primary" icon="el-icon-edit" size="small" @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button type="danger" icon="el-icon-delete" size="small" @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total"
      background
    >
    </el-pagination>
    <!-- 新增、编辑 -->
    <sys-dialog
      :title="dialog.title"
      :visible="dialog.visible"
      :height="dialog.height"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          size="small"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="roleName" label="角色名称">
                <el-input v-model="addModel.roleName"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="roleType" label="角色类型">
                <el-select v-model="addModel.roleType" placeholder="请选择">
                  <el-option
                    v-for="item in options"
                    :key="item.value"
                    :label="item.label"
                    :value="item.value"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="角色备注">
                <el-input v-model="addModel.remark"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getListApi, addRoleApi, editRoleApi } from "@/api/role";
export default {
  // 注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      //角色类型
      options: [
        {
          value: "1",
          label: "系统用户",
        },
        {
          value: "2",
          label: "学生",
        },
        {
          value: "3",
          label: "教师",
        },
      ],
      //表单验证
      rules: {
        roleName: [
          {
            required: true,
            message: "请输入角色名称",
            trigger: "blur",
          },
        ],
        roleType: [
          {
            required: true,
            message: "请选择角色类型",
            trigger: "blur",
          },
        ],
      },
      //新增表单绑定的数据
      addModel: {
        type: "", //0：新增 1：编辑
        roleId: "",
        roleName: "",
        roleType: "",
        remark: "",
      },
      //弹框属性
      dialog: {
        height: 150,
        visible: false,
        title: "",
      },
      //表格高度
      tableHeight: 0,
      //搜索栏数据
      listParm: {
        roleName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      //表格数据
      tableData: [],
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getList();
  },
  methods: {
    //新增按钮
    addBtn() {
      //设置弹框属性
      this.dialog.title = "新增角色";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm('addRef',this.addModel)
      //设置为新增
      this.addModel.type = '0'
    },
    //弹框确定
    onConfirm() {
      //表单验证
      this.$refs.addRef.validate(async(valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addRoleApi(this.addModel);
          } else {
            res = await editRoleApi(this.addModel);
          }
          if (res && res.code == 200) {
            //信息提示
            this.$message({ type: "success", message: res.msg });
            //刷新列表
            this.getList();
          }
        }
      });
      this.dialog.visible = false;
    },
    //弹框关闭
    onClose() {
      this.dialog.visible = false;
    },
    //获取列表
    async getList() {
      let res = await getListApi(this.listParm);
      if (res && res.code == 200) {
        //设置表格数据
        console.log(res);
        this.tableData = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    //页数改变时触发
    currentChange(val) {},
    //页容量改变时触发
    sizeChange(val) {},
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {
      //设置弹框属性
      this.dialog.title = '编辑角色'
      this.dialog.visible = true;
      //清空表单
      this.$resetForm('addRef',this.addModel)
      //设置为编辑
      this.addModel.type = '1'
      //把当前要编辑的数据设置到表单数据域
      this.$objCoppy(row,this.addModel)
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第22讲 删除、搜索功能对接

##### 1、src/api/role.js添加如下方法

```js
//删除
export const deleteRoleApi = async(parm) =>{
    return await http.delete("/api/role",parm)
}
```

##### 2、sysRoleList.vue

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form
      :model="listParm"
      ref="searchRef"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item>
        <el-input
          placeholder="请输入角色名称"
          v-model="listParm.roleName"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button @click="searchBtn" icon="el-icon-search">搜索</el-button>
        <el-button @click="resetBtn" style="color: #ff7670" icon="el-icon-close"
          >重置</el-button
        >
        <el-button type="primary" @click="addBtn" icon="el-icon-plus"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table
      :height="tableHeight"
      size="small"
      :data="tableData"
      border
      stripe
    >
      <el-table-column prop="roleName" label="角色名称"></el-table-column>
      <el-table-column prop="remark" label="角色备注"></el-table-column>
      <el-table-column label="操作" align="center" width="180">
        <template slot-scope="scope">
          <el-button
            type="primary"
            size="small"
            icon="el-icon-edit"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            size="small"
            icon="el-icon-delete"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total"
      background
    >
    </el-pagination>
    <!-- 新增编辑弹框 -->
    <sys-dialog
      :title="dialog.title"
      :visible="dialog.visible"
      :height="dialog.height"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          size="small"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="roleName" label="角色名称">
                <el-input v-model="addModel.roleName"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="roleType" label="角色类型">
                <el-select v-model="addModel.roleType" placeholder="请选择">
                  <el-option
                    v-for="item in options"
                    :key="item.value"
                    :label="item.label"
                    :value="item.value"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="角色备注">
                <el-input v-model="addModel.remark"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getListApi, addRoleApi, editRoleApi, deleteRoleApi } from "@/api/role";
import { getList } from "@/api/table";
export default {
  // 注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      //角色类型
      options: [
        {
          value: "1",
          label: "系统用户",
        },
        {
          value: "2",
          label: "学生",
        },
      ],
      //表单验证规则
      rules: {
        roleName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写角色名称",
          },
        ],
        roleType: [
          {
            trigger: "blur",
            required: true,
            message: "请选择角色类型",
          },
        ],
      },
      //表单数据
      addModel: {
        type: "", // 0 新增 1： 编辑
        roleId: "",
        roleName: "",
        roleType: "",
        remark: "",
      },
      //弹框属性
      dialog: {
        height: 150,
        visible: false,
        title: "",
      },
      //表格的高度
      tableHeight: 0,
      //表格数据
      tableData: [],
      //列表参数
      listParm: {
        roleName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getList();
  },
  methods: {
    //弹框关闭
    onClose() {
      this.dialog.visible = false;
    },
    //弹框确定
    onConfirm() {
      this.$refs.addRef.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addRoleApi(this.addModel);
          } else {
            res = await editRoleApi(this.addModel);
          }
          if (res && res.code == 200) {
            //信息提示
            this.$message({ type: "success", message: res.msg });
            //刷新列表
            this.getList();
            this.dialog.visible = false;
          }
        }
      });
    },
    //获取表格数据
    async getList() {
      let res = await getListApi(this.listParm);
      if (res && res.code == 200) {
        console.log(res);
        //赋值给表格
        this.tableData = res.data.records;
        this.total = res.data.total;
      }
    },
    //页数改变时触发
    currentChange(val) {},
    //页容量改变时触发
    sizeChange(val) {},
    //删除按钮
    async deleteBtn(row) {
      //提示
      const confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteRoleApi({ roleId: row.roleId });
        if (res && res.code == 200) {
          //信息提示
          this.$message({ type: "success", message: res.msg });
          //刷新列表
          this.getList();
        }
      }
    },
    //编辑按钮
    editBtn(row) {
      //设置弹框属性
      this.dialog.title = "编辑角色";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      this.addModel.type = "1";
      //把当前编辑的数据放到表单数据里面
      this.$objCoppy(row, this.addModel);
    },
    //新增按钮
    addBtn() {
      //设置弹框属性
      this.dialog.title = "新增角色";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      this.addModel.type = "0";
    },
    //重置按钮
    resetBtn() {
      //表单清空
      this.listParm.roleName = ''
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第23讲 菜单管理模块接口开发

##### 1、新建实体类

```js
package com.itmk.web.sys_menu.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.util.ArrayList;
import java.util.Date;
import java.util.List;

@Data
@TableName("sys_menu")
public class SysMenu {
    @TableId(type = IdType.AUTO)
    private Long menuId;
    private Long parentId;
    private String title;
    private String code;
    private String name;
    private String path;
    private String url;
    //类型(0 目录 1菜单，2按钮)
    private String type;
    private String icon;
    private String parentName;
    private Long orderNum;
    private Date createTime;
    private Date updateTime;
    //该字段不属于数据库表，需要排除
    @TableField(exist = false)
    private List<SysMenu> children = new ArrayList<>();
}

```

##### 2、新建mapper

```js
package com.itmk.web.sys_menu.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.sys_menu.entity.SysMenu;

public interface SysMenuMapper extends BaseMapper<SysMenu> {
}

```

**映射文件**

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.sys_menu.mapper.SysMenuMapper">

</mapper>
```

##### 3、新建service

```js
package com.itmk.web.sys_menu.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.sys_menu.entity.SysMenu;

import java.util.List;

public interface SysMenuService extends IService<SysMenu> {
    List<SysMenu> menuList();
}

```

**实现类**

```js
package com.itmk.web.sys_menu.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.sys_menu.entity.MakeTree;
import com.itmk.web.sys_menu.entity.SysMenu;
import com.itmk.web.sys_menu.mapper.SysMenuMapper;
import com.itmk.web.sys_menu.service.SysMenuService;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class SysMenuServiceImpl extends ServiceImpl<SysMenuMapper, SysMenu> implements SysMenuService {

    @Override
    public List<SysMenu> menuList() {
        //查询列表
        QueryWrapper<SysMenu> query = new QueryWrapper<>();
        query.lambda().orderByAsc(SysMenu::getOrderNum);
        List<SysMenu> menuList = this.baseMapper.selectList(query);
        //组装树
        List<SysMenu> list = MakeTree.makeMenuTree(menuList, 0L);
        return list;
    }
}

```

```js
package com.itmk.web.sys_menu.entity;

import org.springframework.beans.BeanUtils;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

public class MakeTree {

    public static List<SysMenu> makeMenuTree(List<SysMenu> menuList, Long pid) {
        List<SysMenu> list = new ArrayList<>();
        Optional.ofNullable(menuList).orElse(new ArrayList<>())
                .stream()
                .filter(item -> item != null && item.getParentId() == pid)
                .forEach(dom -> {
                    SysMenu menu = new SysMenu();
                    BeanUtils.copyProperties(dom, menu);
                    //查询该项的下级菜单
                    List<SysMenu> sysMenus = makeMenuTree(menuList, dom.getMenuId());
                    menu.setChildren(sysMenus);
                    list.add(menu);
                });
        return list;
    }
}

```

##### 4、新建控制器

```js
package com.itmk.web.sys_menu.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.sys_menu.entity.SysMenu;
import com.itmk.web.sys_menu.service.SysMenuService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.Date;
import java.util.List;

@RestController
@RequestMapping("/api/menu")
public class SysMenuController {
    @Autowired
    private SysMenuService sysMenuService;

    //新增
    @PostMapping
    public ResultVo addMenu(@RequestBody SysMenu menu){
        menu.setCreateTime(new Date());
        boolean save = sysMenuService.save(menu);
        if(save){
            return ResultUtils.success("新增成功!");
        }
        return ResultUtils.error("新增失败!");
    }

    //编辑
    @PutMapping
    public ResultVo editMenu(@RequestBody SysMenu menu){
        menu.setUpdateTime(new Date());
        boolean save = sysMenuService.updateById(menu);
        if(save){
            return ResultUtils.success("编辑成功!");
        }
        return ResultUtils.error("编辑失败!");
    }

    //删除
    @DeleteMapping("/{menuId}")
    public ResultVo deleteMenu(@PathVariable("menuId") Long menuId){
        //判断是否有下级，有下级，不能删除
        QueryWrapper<SysMenu> query = new QueryWrapper<>();
        query.lambda().eq(SysMenu::getParentId,menuId);
        List<SysMenu> list = sysMenuService.list(query);
        if(list.size() > 0){
            return ResultUtils.error("该菜单存在下级，不能删除!");
        }
        boolean save = sysMenuService.removeById(menuId);
        if(save){
            return ResultUtils.success("删除成功!");
        }
        return ResultUtils.error("删除失败!");
    }

    //菜单列表
    public ResultVo getList(){
        List<SysMenu> list = sysMenuService.menuList();
        return ResultUtils.success("查询成功",list);
    }
}

```



#### 第24讲 菜单管理列表制作

##### 1、api下新建menu.js

```js
import http from '@/utils/http'
export const getMenuListApi = async() =>{
    return await http.get("/api/menu/list",null)
}
```

##### 2、sysMenuList.vue

```js
<template>
  <el-main>
    <el-form size="small">
      <el-form-item>
        <el-button type="primary" icon="el-icon-plus">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table
      :height="tableHeight"
      :data="tableData"
      border
      stripe
      row-key="id"
      default-expand-all
      :tree-props="{ children: 'children', hasChildren: 'hasChildren' }"
    >
      <el-table-column prop="date" label="日期" sortable width="180">
      </el-table-column>
      <el-table-column prop="name" label="姓名" sortable width="180">
      </el-table-column>
      <el-table-column prop="address" label="地址"> </el-table-column>
    </el-table>
  </el-main>
</template>

<script>
import {getMenuListApi} from '@/api/menu'
export default {
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //表格数据
      tableData: [
        {
          id: 1,
          date: "2016-05-02",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1518 弄",
        },
        {
          id: 2,
          date: "2016-05-04",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1517 弄",
        },
        {
          id: 3,
          date: "2016-05-01",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1519 弄",
          children: [
            {
              id: 31,
              date: "2016-05-01",
              name: "王小虎",
              address: "上海市普陀区金沙江路 1519 弄",
            },
            {
              id: 32,
              date: "2016-05-01",
              name: "王小虎",
              address: "上海市普陀区金沙江路 1519 弄",
            },
          ],
        },
        {
          id: 4,
          date: "2016-05-03",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1516 弄",
        },
      ],
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created(){
    this.getList()
  },
  methods:{
    async getList(){
      let res = await getMenuListApi()
      if(res && res.code == 200){
        console.log(res)
        // this.tableData = res.data
      }
    }
  }
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第25讲 新增菜单制作

```js
<template>
  <el-main>
    <el-form size="small">
      <el-form-item>
        <el-button @click="addBtn" type="primary" icon="el-icon-plus"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table
      :height="tableHeight"
      :data="tableData"
      border
      stripe
      row-key="id"
      default-expand-all
      :tree-props="{ children: 'children', hasChildren: 'hasChildren' }"
    >
      <el-table-column prop="date" label="日期" sortable width="180">
      </el-table-column>
      <el-table-column prop="name" label="姓名" sortable width="180">
      </el-table-column>
      <el-table-column prop="address" label="地址"> </el-table-column>
    </el-table>
    <!-- 新增、编辑 -->
    <sys-dialog
      :title="dialog.title"
      :height="dialog.height"
      :width="dialog.width"
      :visible="dialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          size="small"
          style="margin-right:8px;"
        >
          <el-row>
            <el-col :span="24" :offset="0">
              <el-form-item label="菜单类型">
                <el-radio-group v-model="addModel.type">
                  <el-radio :label="'0'">目录</el-radio>
                  <el-radio :label="'1'">菜单</el-radio>
                  <el-radio :label="'2'">按钮</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="上级菜单">
                <!-- <el-input type="hidden" v-model="addModel.parentId"></el-input> -->
                <el-input v-model="addModel.parentName"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="菜单名称">
                <el-input v-model="addModel.title"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col v-if="addModel.type != '2'" :span="12" :offset="0">
              <el-form-item label="菜单图标">
                <el-input v-model="addModel.icon"></el-input>
              </el-form-item>
            </el-col>
            <el-col v-if="addModel.type == '1'" :span="12" :offset="0">
              <el-form-item label="路由名称">
                <el-input v-model="addModel.name"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row v-if="addModel.type == '1'">
            <el-col :span="12" :offset="0">
              <el-form-item label="路由地址">
                <el-input v-model="addModel.path"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="组件路径">
                <el-input v-model="addModel.url"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="权限字段">
                <el-input v-model="addModel.code"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="菜单序号">
                <el-input v-model="addModel.orderNum"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getMenuListApi } from "@/api/menu";
export default {
  // 注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      //表单验证规则
      rules: {},
      //表单数据
      addModel: {
        editType: "", // 0:新增 1：编辑
        menuId: "",
        type: "",
        parentId: "",
        title: "",
        code: "",
        name: "",
        path: "",
        url: "",
        icon: "",
        parentName: "",
        orderNum: "",
      },
      //弹框属性
      dialog: {
        width:650,
        title: "",
        height: 280,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      //表格数据
      tableData: [
        {
          id: 1,
          date: "2016-05-02",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1518 弄",
        },
        {
          id: 2,
          date: "2016-05-04",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1517 弄",
        },
        {
          id: 3,
          date: "2016-05-01",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1519 弄",
          children: [
            {
              id: 31,
              date: "2016-05-01",
              name: "王小虎",
              address: "上海市普陀区金沙江路 1519 弄",
            },
            {
              id: 32,
              date: "2016-05-01",
              name: "王小虎",
              address: "上海市普陀区金沙江路 1519 弄",
            },
          ],
        },
        {
          id: 4,
          date: "2016-05-03",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1516 弄",
        },
      ],
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getList();
  },
  methods: {
    //新增按钮
    addBtn() {
      //设置弹框属性
      this.dialog.title = "新增菜单";
      this.dialog.visible = true;
    },
    //弹框确定
    onConfirm() {
      this.dialog.visible = false;
    },
    //弹框关闭
    onClose() {
      this.dialog.visible = false;
    },
    async getList() {
      let res = await getMenuListApi();
      if (res && res.code == 200) {
        console.log(res);
        // this.tableData = res.data
      }
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第26讲选择上级菜单

##### 1、SysMenuService接口添加如下方法

```js
List<SysMenu> parentList();
```

**实现类**

```js
 @Override
    public List<SysMenu> parentList() {
        String[] types = {"0","1"};
        QueryWrapper<SysMenu> query = new QueryWrapper<>();
        query.lambda().in(SysMenu::getType, Arrays.asList(types)).orderByAsc(SysMenu::getOrderNum);
        List<SysMenu> menuList = this.baseMapper.selectList(query);
        //组装顶级菜单，防止无数据的时候，没有菜单
        SysMenu menu = new SysMenu();
        menu.setMenuId(0L);
        menu.setParentId(-1L);
        menu.setTitle("顶级菜单");
        menuList.add(menu);
        List<SysMenu> list = MakeTree.makeMenuTree(menuList, -1L);
        return list;
    }
```

##### 2、控制器

```js
//上级菜单列表
    @GetMapping("/parent")
    public ResultVo getParentList(){
        List<SysMenu> list = sysMenuService.parentList();
        return ResultUtils.success("查询成功",list);
    }
```

##### 3、api/menu.js

```js
//上级菜单树
export const getParentMenuListApi = async() =>{
    return await http.get("/api/menu/parent",null)
}
```

##### 4、上级菜单弹框

```js
<template>
  <el-main>
    <el-form size="small">
      <el-form-item>
        <el-button @click="addBtn" type="primary" icon="el-icon-plus"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table
      :height="tableHeight"
      :data="tableData"
      border
      stripe
      row-key="id"
      default-expand-all
      :tree-props="{ children: 'children', hasChildren: 'hasChildren' }"
    >
      <el-table-column prop="date" label="日期" sortable width="180">
      </el-table-column>
      <el-table-column prop="name" label="姓名" sortable width="180">
      </el-table-column>
      <el-table-column prop="address" label="地址"> </el-table-column>
    </el-table>
    <!-- 新增、编辑 -->
    <sys-dialog
      :title="dialog.title"
      :height="dialog.height"
      :width="dialog.width"
      :visible="dialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          size="small"
          style="margin-right: 8px"
        >
          <el-row>
            <el-col :span="24" :offset="0">
              <el-form-item label="菜单类型">
                <el-radio-group v-model="addModel.type">
                  <el-radio :label="'0'">目录</el-radio>
                  <el-radio :label="'1'">菜单</el-radio>
                  <el-radio :label="'2'">按钮</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="上级菜单">
                <!-- <el-input type="hidden" v-model="addModel.parentId"></el-input> -->
                <el-input
                  @click.native="selectParent"
                  readonly
                  v-model="addModel.parentName"
                ></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="菜单名称">
                <el-input v-model="addModel.title"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col v-if="addModel.type != '2'" :span="12" :offset="0">
              <el-form-item label="菜单图标">
                <el-input v-model="addModel.icon"></el-input>
              </el-form-item>
            </el-col>
            <el-col v-if="addModel.type == '1'" :span="12" :offset="0">
              <el-form-item label="路由名称">
                <el-input v-model="addModel.name"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row v-if="addModel.type == '1'">
            <el-col :span="12" :offset="0">
              <el-form-item label="路由地址">
                <el-input v-model="addModel.path"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="组件路径">
                <el-input v-model="addModel.url"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="权限字段">
                <el-input v-model="addModel.code"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="菜单序号">
                <el-input v-model="addModel.orderNum"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
    <!-- 上级部门弹框 -->
    <sys-dialog
      :title="parentDialog.title"
      :width="parentDialog.width"
      :height="parentDialog.height"
      :visible="parentDialog.visible"
      @onClose="parentClose"
      @onConfirm="parentConfirm"
    >
      <div slot="content">
        <el-tree
          ref="parentTree"
          :data="parentData"
          node-key="menuId"
          :props="defaultProps"
          empty-text="暂无数据"
          :show-checkbox="false"
          :highlight-current="true"
          default-expand-all
          :expand-on-click-node="false"
          @node-click="handleNodeClick"
        ></el-tree>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getMenuListApi, getParentMenuListApi } from "@/api/menu";
export default {
  // 注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      defaultProps: {
        children: "children",
        label: "title",
      },
      //上级菜单树数据
      parentData: [],
      //上级弹框属性
      parentDialog: {
        width: 300,
        title: "选择上级菜单",
        height: 450,
        visible: false,
      },
      //表单验证规则
      rules: {},
      //表单数据
      addModel: {
        editType: "", // 0:新增 1：编辑
        menuId: "",
        type: "",
        parentId: "",
        title: "",
        code: "",
        name: "",
        path: "",
        url: "",
        icon: "",
        parentName: "",
        orderNum: "",
      },
      //弹框属性
      dialog: {
        width: 650,
        title: "",
        height: 280,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      //表格数据
      tableData: [
        {
          id: 1,
          date: "2016-05-02",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1518 弄",
        },
        {
          id: 2,
          date: "2016-05-04",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1517 弄",
        },
        {
          id: 3,
          date: "2016-05-01",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1519 弄",
          children: [
            {
              id: 31,
              date: "2016-05-01",
              name: "王小虎",
              address: "上海市普陀区金沙江路 1519 弄",
            },
            {
              id: 32,
              date: "2016-05-01",
              name: "王小虎",
              address: "上海市普陀区金沙江路 1519 弄",
            },
          ],
        },
        {
          id: 4,
          date: "2016-05-03",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1516 弄",
        },
      ],
      selectNode: {
        id: "",
        title: "",
      },
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getList();
  },
  methods: {
    //上级树节点点击事件
    handleNodeClick(node) {
      console.log(node);
      this.selectNode.id = node.menuId
      this.selectNode.title = node.title
    },
    parentConfirm() {
      this.addModel.parentId = this.selectNode.id
      this.addModel.parentName = this.selectNode.title
      this.parentDialog.visible = false;
    },
    parentClose() {
      this.parentDialog.visible = false;
    },
    //选择上级菜单
    async selectParent() {
      let res = await getParentMenuListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.parentData = res.data;
      }
      console.log(this.parentData);
      this.parentDialog.visible = true;
    },
    //新增按钮
    addBtn() {
      //设置弹框属性
      this.dialog.title = "新增菜单";
      this.dialog.visible = true;
    },
    //弹框确定
    onConfirm() {
      this.dialog.visible = false;
    },
    //弹框关闭
    onClose() {
      this.dialog.visible = false;
    },
    async getList() {
      let res = await getMenuListApi();
      if (res && res.code == 200) {
        console.log(res);
        // this.tableData = res.data
      }
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第27讲 菜单新增对接

##### 1、api/menu.js添加如下方法

```js
export const addMenuApi = async(parm) =>{
    return await http.post("/api/menu",parm)
}
//编辑
export const editMenuApi = async(parm) =>{
    return await http.put(parm)
}
```

##### 2、sysMenuList.vue

```js
<template>
  <el-main>
    <el-form size="small">
      <el-form-item>
        <el-button @click="addBtn" type="primary" icon="el-icon-plus"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table
      :height="tableHeight"
      :data="tableData"
      border
      stripe
      row-key="menuId"
      default-expand-all
      :tree-props="{ children: 'children', hasChildren: 'hasChildren' }"
    >
      <el-table-column prop="title" label="菜单名称"> </el-table-column>
      <el-table-column prop="title" label="菜单图标">
        <template slot-scope="scope">
          <i :class="scope.row.icon"></i>
        </template>
      </el-table-column>
      <el-table-column prop="name" label="菜单类型"> 
        <template slot-scope="scope">
          <el-tag v-if="scope.row.type == '0'">目录</el-tag>
          <el-tag type="success" v-if="scope.row.type == '1'">菜单</el-tag>
          <el-tag type="danger" v-if="scope.row.type == '2'">按钮</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="name" label="路由名称"> </el-table-column>
      <el-table-column prop="path" label="路由地址"> </el-table-column>
    </el-table>
    <!-- 新增、编辑 -->
    <sys-dialog
      :title="dialog.title"
      :height="dialog.height"
      :width="dialog.width"
      :visible="dialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          size="small"
          style="margin-right: 8px"
        >
          <el-row>
            <el-col :span="24" :offset="0">
              <el-form-item prop="type" label="菜单类型">
                <el-radio-group v-model="addModel.type">
                  <el-radio :label="'0'">目录</el-radio>
                  <el-radio :label="'1'">菜单</el-radio>
                  <el-radio :label="'2'">按钮</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="parentName" label="上级菜单">
                <!-- <el-input type="hidden" v-model="addModel.parentId"></el-input> -->
                <el-input
                  @click.native="selectParent"
                  v-model="addModel.parentName"
                ></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="title" label="菜单名称">
                <el-input v-model="addModel.title"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col v-if="addModel.type != '2'" :span="12" :offset="0">
              <el-form-item label="菜单图标">
                <el-input v-model="addModel.icon"></el-input>
              </el-form-item>
            </el-col>
            <el-col v-if="addModel.type == '1'" :span="12" :offset="0">
              <el-form-item prop="name" label="路由名称">
                <el-input v-model="addModel.name"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row v-if="addModel.type == '1'">
            <el-col :span="12" :offset="0">
              <el-form-item prop="path" label="路由地址">
                <el-input v-model="addModel.path"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="url" label="组件路径">
                <el-input v-model="addModel.url"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="权限字段">
                <el-input v-model="addModel.code"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="菜单序号">
                <el-input v-model="addModel.orderNum"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
    <!-- 上级菜单 -->
    <sys-dialog
      :title="parentDialog.title"
      :width="parentDialog.width"
      :height="parentDialog.height"
      :visible="parentDialog.visible"
      @onClose="parentClose"
      @onConfirm="parentConfirm"
    >
      <div slot="content">
        <el-tree
          :data="treeData"
          :props="defaultProps"
          @node-click="handleNodeClick"
        ></el-tree>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import {
  getMenuListApi,
  getParentMenuListApi,
  addMenuApi,
  editMenuApi,
} from "@/api/menu";
export default {
  // 注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      defaultProps: {
        children: "children",
        label: "title",
      },
      //上级菜单数据
      treeData: [],
      //上级弹框属性
      parentDialog: {
        width: 300,
        title: "选择上级菜单",
        height: 450,
        visible: false,
      },
      //表单验证规则
      rules: {
        type: [
          {
            trigger: "blur",
            required: true,
            message: "请选择菜单类型",
          },
        ],
        parentName: [
          {
            trigger: "blur",
            required: true,
            message: "请选择上级菜单",
          },
        ],
        title: [
          {
            trigger: "blur",
            required: true,
            message: "请填写菜单名称",
          },
        ],
        name: [
          {
            trigger: "blur",
            required: true,
            message: "请填写路由名称",
          },
        ],
        path: [
          {
            trigger: "blur",
            required: true,
            message: "请填写路由地址",
          },
        ],
        url: [
          {
            trigger: "blur",
            required: true,
            message: "请填写组件路径",
          },
        ],
      },
      //表单数据
      addModel: {
        editType: "", // 0:新增 1：编辑
        menuId: "",
        type: "",
        parentId: "",
        title: "",
        code: "",
        name: "",
        path: "",
        url: "",
        icon: "",
        parentName: "",
        orderNum: "",
      },
      //弹框属性
      dialog: {
        width: 650,
        title: "",
        height: 280,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      //表格数据
      tableData: [],
      //树选择的数据
      selectNode: {
        id: "",
        title: "",
      },
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getList();
  },
  methods: {
    //上级菜单树点击事件
    handleNodeClick(node) {
      console.log(node);
      this.selectNode.id = node.menuId;
      this.selectNode.title = node.title;
    },
    //上级菜单确定事件
    parentConfirm() {
      this.addModel.parentId = this.selectNode.id;
      this.addModel.parentName = this.selectNode.title;
      this.parentDialog.visible = false;
      console.log(this.addModel);
    },
    //上级菜单关闭事件
    parentClose() {
      this.parentDialog.visible = false;
    },
    //选择上级菜单事件
    async selectParent() {
      //查询上级菜单树数据
      let res = await getParentMenuListApi();
      if (res && res.code == 200) {
        this.treeData = res.data;
      }
      this.parentDialog.visible = true;
    },
    //新增按钮
    addBtn() {
      //设置弹框属性
      this.dialog.title = "新增菜单";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      this.addModel.editType = "0";
    },
    //弹框确定
    onConfirm() {
      this.$refs.addRef.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addMenuApi(this.addModel);
          } else {
            res = await editMenuApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.getList();
            this.dialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.dialog.visible = false;
    },
    async getList() {
      let res = await getMenuListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.tableData = res.data;
      }
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第28讲 菜单删除接口对接

##### 1、api/menu.js添加如下方法

```js
import http from '@/utils/http'
//列表
export const getMenuListApi = async() =>{
    return await http.get("/api/menu/list",null)
}
//上级列表
export const getParentMenuListApi = async() =>{
    return await http.get("/api/menu/parent",null)
}
//新增
export const addMenuApi = async(parm) =>{
    return await http.post("/api/menu",parm)
}
//编辑
export const editMenuApi = async(parm) =>{
    return await http.put("/api/menu",parm)
}
//删除
export const deleteMenuApi = async(parm) =>{
    return await http.delete("/api/menu",parm)
}
```



##### 2、sysMenuList.vue

```js
<template>
  <el-main>
    <el-form size="small">
      <el-form-item>
        <el-button @click="addBtn" type="primary" icon="el-icon-plus"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table
      :height="tableHeight"
      :data="tableData"
      border
      stripe
      row-key="menuId"
      default-expand-all
      :tree-props="{ children: 'children', hasChildren: 'hasChildren' }"
    >
      <el-table-column prop="title" label="菜单名称"> </el-table-column>
      <el-table-column prop="title" label="菜单图标">
        <template slot-scope="scope">
          <i :class="scope.row.icon"></i>
        </template>
      </el-table-column>
      <el-table-column prop="name" label="菜单类型">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.type == '0'">目录</el-tag>
          <el-tag type="success" v-if="scope.row.type == '1'">菜单</el-tag>
          <el-tag type="danger" v-if="scope.row.type == '2'">按钮</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="name" label="路由名称"> </el-table-column>
      <el-table-column prop="path" label="路由地址"> </el-table-column>
      <el-table-column label="操作" align="center" width="180">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 新增、编辑 -->
    <sys-dialog
      :title="dialog.title"
      :height="dialog.height"
      :width="dialog.width"
      :visible="dialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          size="small"
          style="margin-right: 8px"
        >
          <el-row>
            <el-col :span="24" :offset="0">
              <el-form-item prop="type" label="菜单类型">
                <el-radio-group v-model="addModel.type">
                  <el-radio :label="'0'">目录</el-radio>
                  <el-radio :label="'1'">菜单</el-radio>
                  <el-radio :label="'2'">按钮</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="parentName" label="上级菜单">
                <!-- <el-input type="hidden" v-model="addModel.parentId"></el-input> -->
                <el-input
                  @click.native="selectParent"
                  v-model="addModel.parentName"
                ></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="title" label="菜单名称">
                <el-input v-model="addModel.title"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col v-if="addModel.type != '2'" :span="12" :offset="0">
              <el-form-item label="菜单图标">
                <el-input v-model="addModel.icon"></el-input>
              </el-form-item>
            </el-col>
            <el-col v-if="addModel.type == '1'" :span="12" :offset="0">
              <el-form-item prop="name" label="路由名称">
                <el-input v-model="addModel.name"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row v-if="addModel.type == '1'">
            <el-col :span="12" :offset="0">
              <el-form-item prop="path" label="路由地址">
                <el-input v-model="addModel.path"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="url" label="组件路径">
                <el-input v-model="addModel.url"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="权限字段">
                <el-input v-model="addModel.code"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="菜单序号">
                <el-input v-model="addModel.orderNum"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
    <!-- 上级菜单 -->
    <sys-dialog
      :title="parentDialog.title"
      :width="parentDialog.width"
      :height="parentDialog.height"
      :visible="parentDialog.visible"
      @onClose="parentClose"
      @onConfirm="parentConfirm"
    >
      <div slot="content">
        <el-tree
          ref="parentTree"
          :data="treeData"
          node-key="menuId"
          :props="defaultProps"
          empty-text="暂无数据"
          :show-checkbox="false"
          :highlight-current="true"
          default-expand-all
          :expand-on-click-node="false"
          @node-click="handleNodeClick"
        >
          <div slot-scope="{ node, data }">
            <!-- 如果没有下级，显示文档图标 -->
            <span v-if="data.children.length == 0">
              <i style="margin-left: 3px" class="el-icon-document"></i>
            </span>
            <!-- 有下级，判断是否展开 -->
            <span v-else @click.stop="openBtn(data)">
              <i
                v-if="data.open"
                style="margin-left: 3px"
                class="el-icon-plus"
              ></i>
              <i v-else style="margin-left: 3px" class="el-icon-minus"></i>
            </span>
            <span style="margin-left: 3px">{{ node.label }}</span>
          </div>
        </el-tree>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import {
  getMenuListApi,
  getParentMenuListApi,
  addMenuApi,
  editMenuApi,
  deleteMenuApi,
} from "@/api/menu";
export default {
  // 注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      defaultProps: {
        children: "children",
        label: "title",
      },
      //上级菜单数据
      treeData: [],
      //上级弹框属性
      parentDialog: {
        width: 300,
        title: "选择上级菜单",
        height: 450,
        visible: false,
      },
      //表单验证规则
      rules: {
        type: [
          {
            trigger: "blur",
            required: true,
            message: "请选择菜单类型",
          },
        ],
        parentName: [
          {
            trigger: "blur",
            required: true,
            message: "请选择上级菜单",
          },
        ],
        title: [
          {
            trigger: "blur",
            required: true,
            message: "请填写菜单名称",
          },
        ],
        name: [
          {
            trigger: "blur",
            required: true,
            message: "请填写路由名称",
          },
        ],
        path: [
          {
            trigger: "blur",
            required: true,
            message: "请填写路由地址",
          },
        ],
        url: [
          {
            trigger: "blur",
            required: true,
            message: "请填写组件路径",
          },
        ],
      },
      //表单数据
      addModel: {
        editType: "", // 0:新增 1：编辑
        menuId: "",
        type: "",
        parentId: "",
        title: "",
        code: "",
        name: "",
        path: "",
        url: "",
        icon: "",
        parentName: "",
        orderNum: "",
      },
      //弹框属性
      dialog: {
        width: 650,
        title: "",
        height: 280,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      //表格数据
      tableData: [],
      //树选择的数据
      selectNode: {
        id: "",
        title: "",
      },
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getList();
  },
  methods: {
    //编辑
    editBtn(row) {
      //设置弹框属性
      this.dialog.title = "编辑菜单";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      //把要编辑的数据放到表单绑定的数据里面,回显
      this.$objCoppy(row, this.addModel);
      this.addModel.editType = "1";
    },
    //删除按钮
    async deleteBtn(row) {
      const confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteMenuApi({ menuId: row.menuId });
        if (res && res.code == 200) {
          this.$message({ type: "success", message: res.msg });
          this.getList();
        }
      }
    },
    //上级部门节点加号和减号点击事件
    openBtn(data) {
      data.open = !data.open;
      this.$refs.parentTree.store.nodesMap[data.menuId].expanded = !data.open;
    },
    //上级菜单树点击事件
    handleNodeClick(node) {
      console.log(node);
      this.selectNode.id = node.menuId;
      this.selectNode.title = node.title;
    },
    //上级菜单确定事件
    parentConfirm() {
      this.addModel.parentId = this.selectNode.id;
      this.addModel.parentName = this.selectNode.title;
      this.parentDialog.visible = false;
      console.log(this.addModel);
    },
    //上级菜单关闭事件
    parentClose() {
      this.parentDialog.visible = false;
    },
    //选择上级菜单事件
    async selectParent() {
      //查询上级菜单树数据
      let res = await getParentMenuListApi();
      if (res && res.code == 200) {
        this.treeData = res.data;
      }
      this.parentDialog.visible = true;
    },
    //新增按钮
    addBtn() {
      //设置弹框属性
      this.dialog.title = "新增菜单";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      this.addModel.editType = "0";
    },
    //弹框确定
    onConfirm() {
      this.$refs.addRef.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addMenuApi(this.addModel);
          } else {
            res = await editMenuApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message({ type: "success", message: res.msg });
            this.getList();
            this.dialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.dialog.visible = false;
    },
    async getList() {
      let res = await getMenuListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.tableData = res.data;
      }
    },
  },
};
</script>


<style lang="scss" scoped>
::v-deep .el-tree {
  // 将每一行的设置为相对定位 方便后面before after 使用绝对定位来固定位置
  .el-tree-node {
    position: relative;
    padding-left: 10px;
  }
  // 子集像右偏移 给数线留出距离
  .el-tree-node__children {
    padding-left: 20px;
  }
  //这是竖线
  .el-tree-node :last-child:before {
    height: 40px;
  }
  .el-tree > .el-tree-node:before {
    border-left: none;
  }
  .el-tree > .el-tree-node:after {
    border-top: none;
  }
  //这自定义的线 的公共部分
  .el-tree-node:before,
  .el-tree-node:after {
    content: "";
    left: -4px;
    position: absolute;
    right: auto;
    border-width: 1px;
  }
  .tree :first-child .el-tree-node:before {
    border-left: none;
  }
  // 竖线
  .el-tree-node:before {
    border-left: 1px dotted #d9d9d9;
    bottom: 0px;
    height: 100%;
    top: -25px;
    width: 1px;
  }
  //横线
  .el-tree-node:after {
    border-top: 1px dotted #d9d9d9;
    height: 20px;
    top: 14px;
    width: 24px;
  }
  .el-tree-node__expand-icon.is-leaf {
    width: 8px;
  }
  //去掉elementui自带的展开按钮  一个向下的按钮,打开时向右
  .el-tree-node__content > .el-tree-node__expand-icon {
    display: none;
  }
  //每一行的高度
  .el-tree-node__content {
    line-height: 30px;
    height: 30px;
    padding-left: 10px !important;
  }
}
//去掉最上级的before  after 即是去电最上层的连接线
::v-deep .el-tree > div {
  &::before {
    display: none;
  }
  &::after {
    display: none;
  }
}
</style>
```





#### 第29讲 用户分配角色

##### 1、api/user.js添加getRoleListApi 和 getRoleByUserIdApi()和方法

```js
//角色列表
export const getRoleListApi = async()=>{
  return await http.get("/api/user/roleList")
}
//根据用户Id查询角色
export const getRoleByUserIdApi = async(parm)=>{
  return await http.get("/api/user/getRoleByUserId",parm)
}
```

##### 2、新建SysRoleMenu实体类

```js
package com.itmk.web.sys_role_menu.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
@TableName("sys_role_menu")
public class SysRoleMenu {
    @TableId(type = IdType.AUTO)
    private Long roleMenuId;
    private Long roleId;
    private Long menuId;
}

```

##### 3、新建SysRoleMenuMapper接口

```js
package com.itmk.web.sys_role_menu.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.sys_role_menu.entity.SysRoleMenu;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface SysRoleMenuMapper extends BaseMapper<SysRoleMenu> {
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.sys_role_menu.mapper.SysRoleMenuMapper">

</mapper>
```

##### 4、新建SysRoleMenuService接口

```js
package com.itmk.web.sys_role_menu.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.sys_role_menu.entity.SysRoleMenu;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface SysRoleMenuService extends IService<SysRoleMenu> {
}

```

实现类

```js
package com.itmk.web.sys_role_menu.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.sys_role_menu.entity.SysRoleMenu;
import com.itmk.web.sys_role_menu.mapper.SysRoleMenuMapper;
import com.itmk.web.sys_role_menu.service.SysRoleMenuService;
import org.springframework.stereotype.Service;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class SysRoleMenuServiceImpl extends ServiceImpl<SysRoleMenuMapper, SysRoleMenu> implements SysRoleMenuService {
}

```

##### 5、新建SysUserRole实体类

```js
package com.itmk.web.sys_user_role.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
@TableName("sys_user_role")
public class SysUserRole {
    @TableId(type = IdType.AUTO)
    private Long userRoleId;
    private Long userId;
    private Long roleId;
}

```

##### 6、SysUserRoleMapper接口

```js
package com.itmk.web.sys_user_role.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.sys_user_role.entity.SysUserRole;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface SysUserRoleMapper extends BaseMapper<SysUserRole> {
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.sys_user_role.mapper.SysUserRoleMapper">

</mapper>
```

##### 7、新建SysUserRoleService接口

```js
package com.itmk.web.sys_user_role.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.sys_user_role.entity.SysUserRole;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface SysUserRoleService extends IService<SysUserRole> {
}

```

实现类

```js
package com.itmk.web.sys_user_role.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.sys_user_role.entity.SysUserRole;
import com.itmk.web.sys_user_role.mapper.SysUserRoleMapper;
import com.itmk.web.sys_user_role.service.SysUserRoleService;
import org.springframework.stereotype.Service;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class SysUserRoleServiceImpl extends ServiceImpl<SysUserRoleMapper, SysUserRole> implements SysUserRoleService {
}

```

##### 8、SysUserService新增add和edit方法

```js
package com.itmk.web.sys_user.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.sys_user.entity.PageParm;
import com.itmk.web.sys_user.entity.SysUser;

public interface SysUserService extends IService<SysUser> {
    IPage<SysUser> list(PageParm parm);
    //新增
    void add(SysUser user);
    //编辑
    void edit(SysUser user);
}

```

实现类

```js
package com.itmk.web.sys_user.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.sys_user.entity.PageParm;
import com.itmk.web.sys_user.entity.SysUser;
import com.itmk.web.sys_user.mapper.SysUserMapper;
import com.itmk.web.sys_user.service.SysUserService;
import com.itmk.web.sys_user_role.entity.SysUserRole;
import com.itmk.web.sys_user_role.service.SysUserRoleService;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
public class SysUserServiceImpl extends ServiceImpl<SysUserMapper, SysUser> implements SysUserService {
    @Autowired
    private SysUserRoleService sysUserRoleService;
    @Override
    public IPage<SysUser> list(PageParm parm) {
        //构造分页对象
        IPage<SysUser> page = new Page<>();
        page.setCurrent(parm.getCurrentPage());
        page.setSize(parm.getPageSize());
        //构造查询条件
        QueryWrapper<SysUser> query = new QueryWrapper<>();
        if(StringUtils.isNotEmpty(parm.getNickName())){
            query.lambda().like(SysUser::getNickName,parm.getNickName());
        }
        if(StringUtils.isNotEmpty(parm.getPhone())){
            query.lambda().like(SysUser::getPhone,parm.getPhone());
        }
        return this.baseMapper.selectPage(page,query);
    }

    @Override
    @Transactional
    public void add(SysUser user) {
        //新增用户
        int insert = this.baseMapper.insert(user);
        //保存角色
        if(insert > 0){
            SysUserRole role = new SysUserRole();
            role.setRoleId(user.getRoleId());
            role.setUserId(user.getUserId());
            sysUserRoleService.save(role);
        }
    }

    @Override
    @Transactional
    public void edit(SysUser user) {
        //编辑
        int i = this.baseMapper.updateById(user);
        //角色 ：先删除，再插入
        if(i > 0){
            //先删除原来的角色
            QueryWrapper<SysUserRole> query = new QueryWrapper<>();
            query.lambda().eq(SysUserRole::getUserId,user.getUserId());
            sysUserRoleService.remove(query);
            //保存
            SysUserRole role = new SysUserRole();
            role.setUserId(user.getUserId());
            role.setRoleId(user.getRoleId());
            sysUserRoleService.save(role);
        }
    }
}

```

##### 9、SysUserController控制器

```js
package com.itmk.web.sys_user.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.sys_role.entity.SysRole;
import com.itmk.web.sys_role.service.SysRoleService;
import com.itmk.web.sys_user.entity.PageParm;
import com.itmk.web.sys_user.entity.SysUser;
import com.itmk.web.sys_user.service.SysUserService;
import com.itmk.web.sys_user_role.entity.SysUserRole;
import com.itmk.web.sys_user_role.service.SysUserRoleService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.Date;
import java.util.List;

@RestController
@RequestMapping("/api/user")
public class SysUserController {
    @Autowired
    private SysUserService sysUserService;
    @Autowired
    private SysRoleService sysRoleService;
    @Autowired
    private SysUserRoleService sysUserRoleService;

    //新增用户
    @PostMapping
    public ResultVo addUser(@RequestBody SysUser user) {
        //判断账户是否被占用
        QueryWrapper<SysUser> query = new QueryWrapper<>();
        query.lambda().eq(SysUser::getUsername, user.getUsername());
        SysUser one = sysUserService.getOne(query);
        if (one != null) {
            return ResultUtils.error("账户被占用!");
        }
        user.setIsAdmin("0");
        user.setCreateTime(new Date());
        //入库处理
        sysUserService.add(user);
        return ResultUtils.success("新增用户成功!");
    }

    //编辑用户
    @PutMapping
    public ResultVo editUser(@RequestBody SysUser user) {
        //判断账户是否被占用
        QueryWrapper<SysUser> query = new QueryWrapper<>();
        query.lambda().eq(SysUser::getUsername, user.getUsername());
        SysUser one = sysUserService.getOne(query);
        if (one != null && one.getUserId() != user.getUserId()) {
            return ResultUtils.error("账户被占用!");
        }
        user.setUpdateTime(new Date());
        //更新处理
        sysUserService.edit(user);
        return ResultUtils.success("编辑用户成功!");
    }

    //删除用户
    @DeleteMapping("/{userId}")
    public ResultVo deleteUser(@PathVariable("userId") Long userId) {
        boolean remove = sysUserService.removeById(userId);
        if (remove) {
            return ResultUtils.success("删除成功!");
        }
        return ResultUtils.error("删除失败!");
    }

    //列表查询
    @GetMapping("/list")
    public ResultVo getList(PageParm parm) {
        IPage<SysUser> list = sysUserService.list(parm);
        //密码不显示
        list.getRecords().stream().forEach(item -> {
            item.setPassword("");
        });
        return ResultUtils.success("查询成功", list);
    }

    //查询角色列表
    @GetMapping("/roleList")
    public ResultVo getRoleList(){
        List<SysRole> list = sysRoleService.list();
        return ResultUtils.success("查询成功",list);
    }

    //查询用户对应的角色
    @GetMapping("/getRoleByUserId")
    public ResultVo getRoleByUserId(Long userId){
        QueryWrapper<SysUserRole> query = new QueryWrapper<>();
        query.lambda().eq(SysUserRole::getUserId,userId);
        SysUserRole one = sysUserRoleService.getOne(query);
        return ResultUtils.success("查询成功",one);
    }
}

```



#### 第30讲  登录页面制作

```js

<template>
  <div class="logincontainer">
    <el-form
      class="loginform"
      :model="addModel"
      ref="loginForm"
      :rules="rules"
      :inline="false"
      size="medium"
    >
      <el-form-item>
        <span class="loginTitle">高校宿舍管理系统</span>
      </el-form-item>
      <el-form-item prop="username">
        <el-input
          v-model="addModel.username"
          placeholder="请输入账户"
        ></el-input>
      </el-form-item>
      <el-form-item prop="password">
        <el-input
          v-model="addModel.password"
          placeholder="请输入密码"
        ></el-input>
      </el-form-item>
      <el-form-item prop="userType">
        <el-radio-group v-model="addModel.userType">
          <el-radio :label="0">学生</el-radio>
          <el-radio :label="1">管理</el-radio>
        </el-radio-group>
      </el-form-item>
      <el-form-item>
        <el-row :gutter="20">
          <el-col :span="12" :offset="0">
            <el-button class="loginbtn" type="primary" @click="onSubmit"
              >登录</el-button
            >
          </el-col>
          <el-col :span="12" :offset="0">
            <el-button class="loginbtn">取消</el-button>
          </el-col>
        </el-row>
      </el-form-item>
    </el-form>
  </div>
</template>

<script>
export default {
  data() {
    return {
      //表单数据
      addModel: {
        username: "",
        password: "",
        userType: "",
      },
      //表单验证规则
      rules: {
        username: [
          {
            trigger: "change",
            required: true,
            message: "请输入账户",
          },
        ],
        password: [
          {
            trigger: "change",
            required: true,
            message: "请输入密码",
          },
        ],
        userType: [
          {
            trigger: "change",
            required: true,
            message: "请选择用户类型",
          },
        ],
      },
    };
  },
  methods: {
    onSubmit() {
      this.$refs.loginForm.validate((valid) => {
        if (valid) {
          console.log("验证通过");
          console.log(this.addModel)
        }
      });
    },
  },
};
</script>

<style lang="scss" scoped>
.logincontainer {
  height: 100%;
  background: #fff;
  background-image: url("../../assets/images/login_bg.png");
  display: flex;
  align-items: center;
  justify-content: center;
  background-size: 100% 100%;
  .loginform {
    height: 350px;
    width: 450px;
    background: #fff;
    padding: 35px 20px;
    border-radius: 10px;
    .loginTitle {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: #409eff;
      font-weight: 600;
      margin-bottom: 10px;
    }
    .loginbtn {
      width: 100%;
    }
  }
}
</style>
```







#### 第31讲  用户登录接口开发

**依赖**

```
<jwt.version>3.10.3</jwt.version>
```

```js
<dependency>
       <groupId>com.auth0</groupId>
       <artifactId>java-jwt</artifactId>
       <version>${jwt.version}</version>
</dependency>
```

```
<dependency>
    <groupId>com.auth0</groupId>
    <artifactId>java-jwt</artifactId>
</dependency>
```



##### 1、jwt工具类讲解

###### 1.1、jwt配置文件

```js
#jwt配置
jwt:
  #颁发者
  issuer: itmk
  #秘钥
  secret: com.itmk
  #30分钟过期
  expiration: 30
```



###### 1.2、JwtUtils工具

```js
package com.itmk.jwt;

import com.auth0.jwt.JWT;
import com.auth0.jwt.JWTCreator;
import com.auth0.jwt.algorithms.Algorithm;
import com.auth0.jwt.exceptions.AlgorithmMismatchException;
import com.auth0.jwt.exceptions.JWTVerificationException;
import com.auth0.jwt.exceptions.SignatureVerificationException;
import com.auth0.jwt.exceptions.TokenExpiredException;
import com.auth0.jwt.interfaces.DecodedJWT;
import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

import java.util.Calendar;
import java.util.Date;
import java.util.Map;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Component
@Data
@ConfigurationProperties(prefix = "jwt")
public class JwtUtils {
    //颁发者
    private String issuer;
    //密钥
    private String secret;
    // 过期时间 分钟
    private int expiration;

    /**
     * @param map 自定义参数
     */
    public String generateToken(Map<String, String> map) {
        //设置令牌的过期时间
        Calendar instance = Calendar.getInstance();
        //设置失效时间
        instance.add(Calendar.MINUTE, expiration);
        //创建JWT builder
        JWTCreator.Builder builder = JWT.create();
        //payload
        map.forEach((k, v) -> {
            builder.withClaim(k, v);
        });
        String token = builder.withIssuer(issuer).withIssuedAt(new Date()).withExpiresAt(instance.getTime()) //指定令牌过期时间
                .sign(Algorithm.HMAC256(secret));
        return token;
    }

    /**
     * 验证令牌是否合法
     *
     * @param token
     */
    public boolean verify(String token) {
        try {
            JWT.require(Algorithm.HMAC256(secret)).build().verify(token);
        } catch (JWTVerificationException e) {
            return false;
        }
        return true;
    }

    /**
     * 解析token
     *
     * @param token
     * @return
     */
    public DecodedJWT jwtDecode(String token) {
        try {
            return JWT.require(Algorithm.HMAC256(secret)).build().verify(token);
        } catch (SignatureVerificationException e) {
            throw new RuntimeException("token签名错误!");
        } catch (AlgorithmMismatchException e) {
            throw new RuntimeException("token算法不匹配!");
        } catch (TokenExpiredException e) {
            throw new RuntimeException("token过期!");
        } catch (Exception e) {
            throw new RuntimeException("token解析失败!");
        }
    }
}

```

##### 2、登录接口

```js
package com.itmk.web.login.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.itmk.jwt.JwtUtils;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.login.entity.LoginParm;
import com.itmk.web.login.entity.LoginResult;
import com.itmk.web.user.entity.User;
import com.itmk.web.user.service.UserService;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.DigestUtils;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.HashMap;
import java.util.Map;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/login")
public class LoginController {
    @Autowired
    private JwtUtils jwtUtils;
    @Autowired
    private SysUserService userService;

    @PostMapping("/login")
    public ResultVo login(@RequestBody LoginParm loginParm) {
        if (StringUtils.isEmpty(loginParm.getUsername()) || StringUtils.isEmpty(loginParm.getPassword())) {
            return ResultUtils.error("用户名或密码不能为空!");
        }
        //查询用户
        QueryWrapper<User> query = new QueryWrapper<>();
        query.lambda().eq(User::getUsername, loginParm.getUsername()).eq(User::getPassword,
                DigestUtils.md5DigestAsHex(loginParm.getPassword().getBytes()));
        User user = userService.getOne(query);
        if (user == null) {
            return ResultUtils.error("用户名或密码错误!");
        }
        //生成token
        Map<String, String> map = new HashMap<>();
        map.put("username", user.getUsername());
        map.put("userId", Long.toString(user.getUserId()));
        String token = jwtUtils.generateToken(map);
        //构造返回值
        LoginResult result = new LoginResult();
        result.setUserId(user.getUserId());
        result.setToken(token);
        result.setUsername(user.getUsername());
        return ResultUtils.success("登录成功", result);
    }
}

```

```js
package com.itmk.web.login.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class LoginParm {
    private String username;
    private String password;
    private String userType;
}

```

```js
package com.itmk.web.login.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class LoginResult {
    private Long userId;
    private String username;
    private String token;
}

```











#### 第32讲 登录接口对接

**登录流程图**

![](D:\项目实战\3\springboot+vue版宿舍管理系统\资料\images\登录流程图.png)





##### 1、api/user.js添加loginApi()方法

```js
import request from '@/utils/request'
import http from '@/utils/http'
export function login(data) {
  return request({
    url: '/vue-admin-template/user/login',
    method: 'post',
    data
  })
}

export function getInfo(token) {
  return request({
    url: '/vue-admin-template/user/info',
    method: 'get',
    params: { token }
  })
}

export function logout() {
  return request({
    url: '/vue-admin-template/user/logout',
    method: 'post'
  })
}
//获取用户列表
export const getListApi = async(parm) =>{
  return await http.get("/api/user/list",parm)
}
//新增
export const addUserApi = async(parm) =>{
  return await http.post("/api/user",parm)
}
//编辑
export const editUserApi = async(parm) =>{
  return await http.put("/api/user",parm)
}
//删除
export const deleteUserApi = async(parm) =>{
  return await http.delete("/api/user",parm)
}
//角色列表
export const getRoleListApi = async()=>{
  return await http.get("/api/user/roleList")
}
//获取角色
export const getRoleApi = async(parm)=>{
  return await http.get("/api/user/role",parm)
}
//登录对接
export const loginApi = async(parm)=>{
  return await http.post("/api/login/login",parm)
}
```

##### 2、utils下的auth.js添加存储用户id的方法

```js
import Cookies from 'js-cookie'

const TokenKey = 'vue_admin_template_token'
const userIdKey = 'userId'
export function getToken() {
  return Cookies.get(TokenKey)
}

export function setToken(token) {
  return Cookies.set(TokenKey, token)
}

export function removeToken() {
  return Cookies.remove(TokenKey)
}
//存储用户id
export function setUserId(userId) {
  return sessionStorage.setItem(userIdKey, userId)
}
export function getUserId() {
  return sessionStorage.getItem(userIdKey)
}
export function removeUserId() {
  return sessionStorage.remove(userIdKey);
}
//sessionStorage清空
export function clearSession() {
  return sessionStorage.clear()
}

```

##### 3、store/user.js中的login修改为如下

```js
 // user login
  login({ commit }, userInfo) {
    const { username, password,userType } = userInfo
    return new Promise((resolve, reject) => {
      loginApi({ username: username.trim(), password: password ,userType:userType}).then(response => {
        console.log(response)
        const { data } = response
        // commit('SET_TOKEN', data.token)
        commit('SET_TOKEN', 'admin-token')
        setToken(data.token)
        resolve()
      }).catch(error => {
        reject(error)
      })
    })
  },
```

##### 4、登录页面

```js
<template>
  <div class="logincontainer">
    <el-form
      class="loginForm"
      :model="addModel"
      ref="loginForm"
      :rules="rules"
      :inline="false"
      size="normal"
    >
      <el-form-item>
        <span class="loginTitle">高校宿舍管理系统</span>
      </el-form-item>
      <el-form-item prop="username">
        <el-input
          placeholder="请输入账户"
          v-model="addModel.username"
        ></el-input>
      </el-form-item>
      <el-form-item prop="password">
        <el-input
          placeholder="请输入密码"
          v-model="addModel.password"
        ></el-input>
      </el-form-item>
      <el-form-item prop="userType">
        <el-radio-group v-model="addModel.userType">
          <el-radio :label="0">学生</el-radio>
          <el-radio :label="1">管理员</el-radio>
        </el-radio-group>
      </el-form-item>
      <el-form-item>
        <el-row :gutter="20">
          <el-col :span="12" :offset="0">
            <el-button class="mybtn" type="primary" @click="onSubmit"
              >登录</el-button
            >
          </el-col>
          <el-col :span="12" :offset="0">
            <el-button class="mybtn">取消</el-button>
          </el-col>
        </el-row>
      </el-form-item>
    </el-form>
  </div>
</template>

<script>
export default {
  data() {
    return {
      addModel: {
        username: "",
        password: "",
        userType: "",
      },
      rules: {
        username: [
          {
            trigger: "change",
            required: true,
            message: "请输入账户",
          },
        ],
        password: [
          {
            trigger: "change",
            required: true,
            message: "请输入密码",
          },
        ],
        userType: [
          {
            trigger: "change",
            required: true,
            message: "请选择用户类型",
          },
        ],
      },
    };
  },
  methods: {
    onSubmit() {
      this.$refs.loginForm.validate((valid) => {
        if (valid) {
          this.$store.dispatch("user/login", this.addModel).then(() => {
            this.$router.push({ path: this.redirect || "/" });
          });
        }
      });
    },
  },
};
</script>

<style lang="scss" scoped>
.logincontainer {
  height: 100%;
  background: #fff;
  background-image: url("../../assets/images/login_bg.png");
  display: flex;
  align-items: center;
  justify-content: center;
  background-size: 100% 100%;
  .loginForm {
    height: 350px;
    width: 450px;
    background: #fff;
    padding: 35px 20px;
    border-radius: 10px;
    .loginTitle {
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      font-weight: 600;
      color: #409eff;
    }
    .mybtn {
      width: 100%;
    }
  }
}
</style>
```







#### 第33讲 分配权限树回显接口开发

##### 1、SysMenuService接口新增getMenuByUserId()方法和getMenuByRoleId()方法

```js
	//根据用户id查询权限
    List<SysMenu> getMenuByUserId(Long userId);
    //根据角色id查询权限
    List<SysMenu> getMenuByRoleId(Long roleId);
```

SysMenuServiceImpl实现类

```js
	@Override
    public List<SysMenu> getMenuByUserId(Long userId) {
        return this.baseMapper.getMenuByUserId(userId);
    }

    @Override
    public List<SysMenu> getMenuByRoleId(Long roleId) {
        return this.baseMapper.getMenuByRoleId(roleId);
    }
```

##### 2、SysMenuMapper接口新增getMenuByUserId()方法和getMenuByRoleId()方法

```js
	//根据用户id查询权限
    List<SysMenu> getMenuByUserId(@Param("userId") Long userId);
	//根据角色id查询权限
    List<SysMenu> getMenuByRoleId(@Param("roleId") Long roleId);
```

##### 3、SysMenuMapper.xml映射文件

```js
<select id="getMenuByUserId" resultType="com.itmk.web.sys_menu.entity.SysMenu">
        select m.* from  sys_user_role as ur
        left join sys_role  as r on ur.role_id = r.role_id
        left join sys_role_menu as rm on r.role_id = rm.role_id
        left join sys_menu  as m on rm.menu_id = m.menu_id
        where ur.user_id =#{userId}
        order by m.order_num asc
</select>

<select id="getMenuByRoleId" resultType="com.itmk.web.sys_menu.entity.SysMenu">
        select m.* from sys_role_menu as rm , sys_menu as m
        where rm.menu_id = m.menu_id  and rm.role_id =#{roleId}
</select>
```

##### 4、新建AssignVo实体类

```js
package com.itmk.web.sys_role.entiy;

import com.itmk.web.sys_menu.entity.SysMenu;
import lombok.Data;

import java.util.ArrayList;
import java.util.List;

@Data
public class AssignVo {
    //当前用户拥有的菜单
    private List<SysMenu> menuList = new ArrayList<>();
    //被分配的角色拥有的菜单id
    private Object[] checkList;
}

```

##### 5、SysRoleService接口新增getAssignShow()方法

参数实体类

```
package com.itmk.web.sys_role.entiy;

import lombok.Data;

@Data
public class AssignParm {
    private Long userId;
    private Long roleId;
}
```

```js
	//角色权限的回显
    AssignVo getAssignShow(AssignParm parm);
```

实现类

```js
	@Override
    public AssignVo getAssignShow(AssignParm parm) {
        //查询当前用户的信息
        SysUser user = sysUserService.getById(parm.getUserId());
        //菜单数据
        List<SysMenu> list = null;
        if(user.getIsAdmin().equals("1")){ //如果是超级管理员，拥有所有的权限
            QueryWrapper<SysMenu> query = new QueryWrapper<>();
            query.lambda().orderByAsc(SysMenu::getOrderNum);
            list = sysMenuService.list(query);
        }else{
            list = sysMenuService.getMenuByUserId(user.getUserId());
        }
        //组装树
        List<SysMenu> menuList = MakeTree.makeMenuTree(list, 0L);
        //查询角色原来的菜单
        List<SysMenu> roleList = sysMenuService.getMenuByRoleId(parm.getRoleId());
        List<Long> ids = new ArrayList<>();
        Optional.ofNullable(roleList).orElse(new ArrayList<>()).stream().filter(item -> item != null).forEach(item ->{
            ids.add(item.getMenuId());
        });
        //组装数据
        AssignVo vo = new AssignVo();
        vo.setMenuList(menuList);
        vo.setCheckList(ids.toArray());
        return vo;
    }
```

##### 6、SysRoleController控制器添加getAssingShow()方法

```js
	//查询角色权限树的回显
    @GetMapping("/getAssingShow")
    public ResultVo getAssingShow(AssignParm parm) {
        AssignVo show = sysRoleService.getAssignShow(parm);
        return ResultUtils.success("查询成功", show);
    }
```







#### 第34讲 分配权限回显对接

##### 1、api/role.js添加assignRoleApi()方法

```js
import http from '@/utils/http'
//列表
export const getListApi = async(parm) =>{
    return await http.get("/api/role/list",parm)
}
//新增
export const addRoleApi = async(parm) =>{
    return await http.post("/api/role",parm)
}
//编辑
export const editRoleApi = async(parm) =>{
    return await http.put("/api/role",parm)
}
//删除
export const deleteRoleApi = async(parm) =>{
    return await http.delete("/api/role",parm)
}
//分配权限回显
export const assignRoleApi = async(parm)=>{
    return await http.get("/api/role/getAssingShow",parm)
}
```

##### 2、sysRoleList.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form
      :model="listParm"
      ref="searchRef"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item>
        <el-input
          placeholder="请输入角色名称"
          v-model="listParm.roleName"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button @click="searchBtn" icon="el-icon-search">搜索</el-button>
        <el-button @click="resetBtn" style="color: #ff7670" icon="el-icon-close"
          >重置</el-button
        >
        <el-button type="primary" @click="addBtn" icon="el-icon-plus"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table
      :height="tableHeight"
      size="small"
      :data="tableData"
      border
      stripe
    >
      <el-table-column prop="roleName" label="角色名称"></el-table-column>
      <el-table-column prop="remark" label="角色备注"></el-table-column>
      <el-table-column label="操作" align="center" width="300">
        <template slot-scope="scope">
          <el-button
            type="primary"
            size="small"
            icon="el-icon-edit"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="primary"
            size="small"
            icon="el-icon-edit"
            @click="assignBtn(scope.row)"
            >分配权限</el-button
          >
          <el-button
            type="danger"
            size="small"
            icon="el-icon-delete"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total"
      background
    >
    </el-pagination>
    <!-- 新增编辑弹框 -->
    <sys-dialog
      :title="dialog.title"
      :visible="dialog.visible"
      :height="dialog.height"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          size="small"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="roleName" label="角色名称">
                <el-input v-model="addModel.roleName"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="roleType" label="角色类型">
                <el-select v-model="addModel.roleType" placeholder="请选择">
                  <el-option
                    v-for="item in options"
                    :key="item.value"
                    :label="item.label"
                    :value="item.value"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="角色备注">
                <el-input v-model="addModel.remark"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
    <!-- 分配权限弹框 -->
    <sys-dialog
      :title="assignDialog.title"
      :height="assignDialog.height"
      :width="assignDialog.width"
      :visible="assignDialog.visible"
      @confirm="assignConfirm"
      @onClose="assingClose"
    >
      <div slot="content">
        <el-tree
          ref="assignTree"
          :data="assignTreeData"
          node-key="menuId"
          :props="defaultProps"
          empty-text="暂无数据"
          :show-checkbox="true"
          default-expand-all
          :default-checked-keys="assignTreeChecked"
        ></el-tree>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import {
  getListApi,
  addRoleApi,
  editRoleApi,
  deleteRoleApi,
  assignRoleApi,
} from "@/api/role";
import { getUserId } from "@/utils/auth";
export default {
  // 注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      defaultProps: {
        children: "children",
        label: "title",
      },
      //树数据
      assignTreeData: [],
      //角色原来的权限
      assignTreeChecked: [],
      //分配权限弹框属性
      assignDialog: {
        title: "",
        height: 450,
        width: 300,
        visible: false,
      },
      //角色类型
      options: [
        {
          value: "1",
          label: "系统用户",
        },
        {
          value: "2",
          label: "学生",
        },
      ],
      //表单验证规则
      rules: {
        roleName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写角色名称",
          },
        ],
        roleType: [
          {
            trigger: "blur",
            required: true,
            message: "请选择角色类型",
          },
        ],
      },
      //表单数据
      addModel: {
        type: "", // 0 新增 1： 编辑
        roleId: "",
        roleName: "",
        roleType: "",
        remark: "",
      },
      //弹框属性
      dialog: {
        height: 150,
        visible: false,
        title: "",
      },
      //表格的高度
      tableHeight: 0,
      //表格数据
      tableData: [],
      //列表参数
      listParm: {
        roleName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getList();
  },
  methods: {
    //分配权限确定
    assignConfirm() {
      this.assignDialog.visible = false;
    },
    //分配权限取消
    assingClose() {
      this.assignDialog.visible = false;
    },
    //分配权限按钮
    async assignBtn(row) {
      //清空数据
      this.roleId = "";
      this.assignTreeData = [];
      this.assignTreeChecked = [];
      this.roleId = row.roleId;
      //设置弹框属性
      this.assignDialog.title = "为【" + row.roleName + "】分配权限";
      this.assignDialog.visible = true;
      //获取权限数据
      let parm = {
        userId: getUserId(),
        roleId: this.roleId,
      };
      let res = await assignRoleApi(parm);
      console.log(res);
      if (res && res.code == 200) {
        this.assignTreeData = res.data.menuList;
        this.assignTreeChecked = res.data.checkList;
      }
      //如果角色原来有权限
      if (this.assignTreeChecked.length > 0) {
        let newArr = [];
        this.assignTreeChecked.forEach((item) => {
          this.checked(item, this.assignTreeData, newArr);
        });
        this.assignTreeChecked = newArr;
      }
    },
    //找出所有的回显数据
    checked(id, data, newArr) {
      data.forEach((item) => {
        if (item.menuId == id) {
          //是不是末级
          if (item.children && item.children.length == 0) {
            newArr.push(item.menuId);
          }
        } else {
          if (item.children && item.children.length != 0) {
            this.checked(id, item.children, newArr);
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.dialog.visible = false;
    },
    //弹框确定
    onConfirm() {
      this.$refs.addRef.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addRoleApi(this.addModel);
          } else {
            res = await editRoleApi(this.addModel);
          }
          if (res && res.code == 200) {
            //信息提示
            this.$message({ type: "success", message: res.msg });
            //刷新列表
            this.getList();
            this.dialog.visible = false;
          }
        }
      });
    },
    //获取表格数据
    async getList() {
      let res = await getListApi(this.listParm);
      if (res && res.code == 200) {
        console.log(res);
        //赋值给表格
        this.tableData = res.data.records;
        this.total = res.data.total;
      }
    },
    //页数改变时触发
    currentChange(val) {},
    //页容量改变时触发
    sizeChange(val) {},
    //删除按钮
    async deleteBtn(row) {
      //提示
      const confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteRoleApi({ roleId: row.roleId });
        if (res && res.code == 200) {
          //信息提示
          this.$message({ type: "success", message: res.msg });
          //刷新列表
          this.getList();
        }
      }
    },
    //编辑按钮
    editBtn(row) {
      //设置弹框属性
      this.dialog.title = "编辑角色";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      this.addModel.type = "1";
      //把当前编辑的数据放到表单数据里面
      this.$objCoppy(row, this.addModel);
    },
    //新增按钮
    addBtn() {
      //设置弹框属性
      this.dialog.title = "新增角色";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      this.addModel.type = "0";
    },
    //重置按钮
    resetBtn() {
      //表单清空
      this.listParm.roleName = "";
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```









#### 第35讲 分配权限保存接口开发

##### 1、SysRoleMenuMapper添加saveRoleMenu()方法

```js
package com.itmk.web.sys_role_menu.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.sys_role_menu.entity.SysRoleMenu;
import org.apache.ibatis.annotations.Param;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface SysRoleMenuMapper extends BaseMapper<SysRoleMenu> {
    boolean saveRoleMenu(@Param("roleId") Long roleId, @Param("menuIds")List<Long> menuIds);
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.sys_role_menu.mapper.SysRoleMenuMapper">
    <insert id="saveRoleMenu">
        insert into sys_role_menu(role_id,menu_id) values
        <foreach collection="menuIds" item="item" index="index" separator=",">
            (#{roleId},#{item})
        </foreach>
    </insert>
</mapper>
```

##### 2、SysRoleMenuService接口添加saveRoleMenu方法

```js
package com.itmk.web.sys_role_menu.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.sys_role_menu.entity.SysRoleMenu;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface SysRoleMenuService extends IService<SysRoleMenu> {
    void saveRoleMenu(Long roleId, List<Long> menuIds);
}

```

实现类

```js
package com.itmk.web.sys_role_menu.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.sys_role_menu.entity.SysRoleMenu;
import com.itmk.web.sys_role_menu.mapper.SysRoleMenuMapper;
import com.itmk.web.sys_role_menu.service.SysRoleMenuService;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class SysRoleMenuServiceImpl extends ServiceImpl<SysRoleMenuMapper, SysRoleMenu> implements SysRoleMenuService {
    @Override
    @Transactional
    public void saveRoleMenu(Long roleId, List<Long> menuIds) {
        //先删除原来的，再插入
        QueryWrapper<SysRoleMenu> query = new QueryWrapper<>();
        query.lambda().eq(SysRoleMenu::getRoleId,roleId);
        this.baseMapper.delete(query);
        //插入新的
        this.baseMapper.saveRoleMenu(roleId,menuIds);
    }
}

```

##### 3、SysRoleController控制器添加saveRoleMenu()方法

```js
package com.itmk.web.sys_role.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.sys_role.entity.*;
import com.itmk.web.sys_role.service.SysRoleService;
import com.itmk.web.sys_role_menu.service.SysRoleMenuService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.Date;

@RestController
@RequestMapping("/api/role")
public class SysRoleController {
    @Autowired
    private SysRoleService sysRoleService;
    @Autowired
    private SysRoleMenuService sysRoleMenuService;

    //新增
    @PostMapping
    public ResultVo addRole(@RequestBody SysRole role){
        role.setCreateTime(new Date());
        boolean save = sysRoleService.save(role);
        if(save){
            return ResultUtils.success("新增角色成功!");
        }
        return ResultUtils.error("新增角色失败!");
    }

    //编辑
    @PutMapping
    public ResultVo editRole(@RequestBody SysRole role){
        role.setUpdateTime(new Date());
        boolean save = sysRoleService.updateById(role);
        if(save){
            return ResultUtils.success("编辑角色成功!");
        }
        return ResultUtils.error("编辑角色失败!");
    }

    //删除
    @DeleteMapping("/{roleId}")
    public ResultVo deleteRole(@PathVariable("roleId") Long roleId){
        boolean remove = sysRoleService.removeById(roleId);
        if(remove){
            return ResultUtils.success("删除成功");
        }
        return ResultUtils.error("删除失败!");
    }

    //角色列表
    @GetMapping("/list")
    public ResultVo getList(RoleParm parm){
        IPage<SysRole> list = sysRoleService.list(parm);
        return ResultUtils.success("查询成功",list);
    }

    //分配权限回显
    @GetMapping("/getAssingShow")
    public ResultVo getAssingShow(AssignParm parm){
        AssignVo show = sysRoleService.getAssignShow(parm);
        return ResultUtils.success("查询成功",show);
    }

    //分配权限保存
    @PostMapping("/saveRoleMenu")
    public ResultVo saveRoleMenu(@RequestBody SaveRoleParm parm){
        sysRoleMenuService.saveRoleMenu(parm.getRoleId(),parm.getList());
        return ResultUtils.success("分配权限成功!");
    }
}

```







#### 第36讲 角色分配权限保存对接

##### 1、api/role.js添加saveAssignApi()方法

```js
import http from '@/utils/http'
//获取列表
export const getListApi = async(parm) =>{
    return await http.get("/api/role/list",parm)
}
//新增
export const addRoleApi = async(parm) =>{
     return await http.post("/api/role",parm)
}
//编辑
export const editRoleApi = async(parm) =>{
    return await http.put("/api/role",parm)
}
//删除
export const deleteRoleApi = async(parm) =>{
    return await http.delete("/api/role",parm)
}
//获取分配权限的数据
export const assignRoleApi = async(parm)=>{
    return await http.get("/api/role/getAssingShow",parm)
}
//分配权限保存
export const saveAssignApi = async(parm)=>{
    return await http.post("/api/role/saveRoleMenu",parm)
}
```

##### 2、sysRoleList.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="listParm" ref="searchRef" :inline="true" size="small">
      <el-form-item>
        <el-input
          placeholder="请输入角色名称"
          v-model="listParm.roleName"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBrn">搜索</el-button>
        <el-button icon="el-icon-close" style="color: #ff7670" @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" @click="addBtn" icon="el-icon-plus"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableData" border stripe>
      <el-table-column prop="roleName" label="角色名称"></el-table-column>
      <el-table-column prop="remark" label="备注"></el-table-column>
      <el-table-column label="操作" align="center" width="300">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="assignBtn(scope.row)"
            >分配权限</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total"
      background
    >
    </el-pagination>
    <!-- 新增、编辑 -->
    <sys-dialog
      :title="dialog.title"
      :visible="dialog.visible"
      :height="dialog.height"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          size="small"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="roleName" label="角色名称">
                <el-input v-model="addModel.roleName"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="roleType" label="角色类型">
                <el-select v-model="addModel.roleType" placeholder="请选择">
                  <el-option
                    v-for="item in options"
                    :key="item.value"
                    :label="item.label"
                    :value="item.value"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="角色备注">
                <el-input v-model="addModel.remark"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
    <!-- 分配权限弹框 -->
    <sys-dialog
      :title="assignDialog.title"
      :width="assignDialog.width"
      :height="assignDialog.height"
      :visible="assignDialog.visible"
      @onClose="assignClose"
      @onConfirm="assignConfrim"
    >
      <div slot="content">
        <el-tree
          ref="assignTree"
          :data="assignTreeData"
          node-key="menuId"
          :props="defaultProps"
          empty-text="暂无数据"
          :show-checkbox="true"
          default-expand-all
          :default-checked-keys="assignTreeChecked"
        ></el-tree>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import {
  getListApi,
  addRoleApi,
  editRoleApi,
  deleteRoleApi,
  assignRoleApi,
  saveAssignApi,
} from "@/api/role";
import { getUserId } from "@/utils/auth";
export default {
  // 注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      defaultProps: {
        children: "children",
        label: "title",
      },
      //角色id
      roleId: "",
      //树数据
      assignTreeData: [],
      //角色原来的权限
      assignTreeChecked: [],
      //定义弹框属性
      assignDialog: {
        title: "",
        height: 450,
        width: 300,
        visible: false,
      },
      //角色类型
      options: [
        {
          value: "1",
          label: "系统用户",
        },
        {
          value: "2",
          label: "学生",
        },
        {
          value: "3",
          label: "教师",
        },
      ],
      //表单验证
      rules: {
        roleName: [
          {
            required: true,
            message: "请输入角色名称",
            trigger: "blur",
          },
        ],
        roleType: [
          {
            required: true,
            message: "请选择角色类型",
            trigger: "blur",
          },
        ],
      },
      //新增表单绑定的数据
      addModel: {
        type: "", //0：新增 1：编辑
        roleId: "",
        roleName: "",
        roleType: "",
        remark: "",
      },
      //弹框属性
      dialog: {
        height: 150,
        visible: false,
        title: "",
      },
      //表格高度
      tableHeight: 0,
      //搜索栏数据
      listParm: {
        roleName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      //表格数据
      tableData: [],
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getList();
  },
  methods: {
    //分配权限弹框确定
    async assignConfrim() {
      //  this.$refs.assignTree.getCheckedKeys()
      // console.log(this.$refs.assignTree.getCheckedKeys())
      // console.log(this.$refs.assignTree.getHalfCheckedKeys())
      // this.assignDialog.visible = false;
      let ids = this.$refs.assignTree
        .getCheckedKeys()
        .concat(this.$refs.assignTree.getHalfCheckedKeys());
      console.log(ids);
      let parm = {
        roleId: this.roleId,
        list: ids,
      };
      let res = await saveAssignApi(parm);
      if (res && res.code == 200) {
        this.$message.success(res.msg);
        this.assignDialog.visible = false;
      }
    },
    //分配权限弹框关闭
    assignClose() {
      this.assignDialog.visible = false;
    },
    //分配权限按钮
    async assignBtn(row) {
      console.log(row);
      this.roleId = row.roleId;
      //设置弹框的属性
      this.assignDialog.title = "为【" + row.roleName + "】分配权限";
      this.assignDialog.visible = true;
      //获取权限树数据
      let parm = {
        userId: getUserId(),
        roleId: row.roleId,
      };
      const res = await assignRoleApi(parm);
      if (res && res.code == 200) {
        //设置树的数据
        console.log(res);
        this.assignTreeData = res.data.menuList;
        this.assignTreeChecked = res.data.checkList;
      }
      //过滤回显的数据
      if (this.assignTreeChecked.length > 0) {
        let newArr = [];
        this.assignTreeChecked.forEach((item) => {
          this.checked(item, this.assignTreeData, newArr);
        });
        this.assignTreeChecked = newArr;
      }
    },
    //过滤工具
    checked(id, data, newArr) {
      data.forEach((item) => {
        if (item.menuId == id) {
          if (item.children && item.children.length == 0) {
            newArr.push(item.menuId);
          }
        } else {
          //有下级的时候，继续查找
          if (item.children && item.children.length != 0) {
            //递归算法：自己调用自己
            this.checked(id, item.children, newArr);
          }
        }
      });
    },
    //重置按钮
    resetBtn() {
      this.listParm.roleName = "";
      this.getList();
    },
    //搜索按钮
    searchBrn() {
      this.getList();
    },
    //新增按钮
    addBtn() {
      //设置弹框属性
      this.dialog.title = "新增角色";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      //设置为新增
      this.addModel.type = "0";
    },
    //弹框确定
    onConfirm() {
      //表单验证
      this.$refs.addRef.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addRoleApi(this.addModel);
          } else {
            res = await editRoleApi(this.addModel);
          }
          if (res && res.code == 200) {
            //信息提示
            this.$message({ type: "success", message: res.msg });
            //刷新列表
            this.getList();
          }
        }
      });
      this.dialog.visible = false;
    },
    //弹框关闭
    onClose() {
      this.dialog.visible = false;
    },
    //获取列表
    async getList() {
      let res = await getListApi(this.listParm);
      if (res && res.code == 200) {
        //设置表格数据
        console.log(res);
        this.tableData = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    //页数改变时触发
    currentChange(val) {
      this.listParm.currentPage = val;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.listParm.pageSize = val;
      this.getList();
    },
    //删除按钮
    async deleteBtn(row) {
      const confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteRoleApi({ roleId: row.roleId });
        if (res && res.code == 200) {
          //信息提示
          this.$message({ type: "success", message: res.msg });
          //刷新列表
          this.getList();
        }
      }
    },
    //编辑按钮
    editBtn(row) {
      //设置弹框属性
      this.dialog.title = "编辑角色";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      //设置为编辑
      this.addModel.type = "1";
      //把当前要编辑的数据设置到表单数据域
      this.$objCoppy(row, this.addModel);
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第37讲 学院管理接口开发

##### 1、数据库脚本

```js
drop table if exists school_collage;

/*==============================================================*/
/* Table: school_collage                                        */
/*==============================================================*/
create table school_collage
(
   collage_id           int not null auto_increment comment '学院id',
   collage_name         varchar(64) comment '学院名称',
   order_num            int comment '序号',
   create_time          datetime comment '创建时间',
   primary key (collage_id)
);

```

##### 2、新建实体类

```js
package com.itmk.web.school_collage.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.util.Date;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
@TableName("school_collage")
public class SchoolCollage {
    @TableId(type = IdType.AUTO)
    private Long collageId;
    private String collageName;
    private Integer orderNum;
    private Date createTime;
}

```

```js
package com.itmk.web.school_collage.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class ListParm {
    private Long currentPage;
    private Long pageSize;
    private String collageName;
}

```

##### 3、mapper接口

```js
package com.itmk.web.school_collage.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.school_collage.entity.SchoolCollage;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface SchoolCollageMapper extends BaseMapper<SchoolCollage> {
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.school_collage.mapper.SchoolCollageMapper">

</mapper>
```

##### 4、service接口

```js
package com.itmk.web.school_collage.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.school_collage.entity.SchoolCollage;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface SchoolCollageService extends IService<SchoolCollage> {
}

```

实现类

```js
package com.itmk.web.school_collage.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.school_collage.entity.SchoolCollage;
import com.itmk.web.school_collage.mapper.SchoolCollageMapper;
import com.itmk.web.school_collage.service.SchoolCollageService;
import org.springframework.stereotype.Service;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class SchoolCollageServiceImpl extends ServiceImpl<SchoolCollageMapper, SchoolCollage> implements SchoolCollageService {
}

```

##### 5、控制器

```js
package com.itmk.web.school_collage.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.school_collage.entity.ListParm;
import com.itmk.web.school_collage.entity.SchoolCollage;
import com.itmk.web.school_collage.service.SchoolCollageService;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.Date;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/collage")
public class SchoolCollageController {
    @Autowired
    private SchoolCollageService schoolCollageService;

    //新增
    @PostMapping
    public ResultVo add(@RequestBody SchoolCollage schoolCollage){
        //设置创建时间
        schoolCollage.setCreateTime(new Date());
        boolean save = schoolCollageService.save(schoolCollage);
        if(save){
            return ResultUtils.success("新增学院成功!");
        }
        return ResultUtils.error("新增学院失败!");
    }

    //编辑
    @PutMapping
    public ResultVo edit(@RequestBody SchoolCollage schoolCollage){

        boolean save = schoolCollageService.updateById(schoolCollage);
        if(save){
            return ResultUtils.success("编辑学院成功!");
        }
        return ResultUtils.error("编辑学院失败!");
    }

    //删除
    @DeleteMapping("/{collageId}")
    public ResultVo delete(@PathVariable("collageId") Long collageId){
        boolean b = schoolCollageService.removeById(collageId);
        if(b){
            return ResultUtils.success("删除学院成功!");
        }
        return ResultUtils.error("删除学院失败!");

    }

    //列表
    @GetMapping("/list")
    public ResultVo getList(ListParm listParm){
        //构造查询条件
        QueryWrapper<SchoolCollage> query = new QueryWrapper<>();
        if(StringUtils.isNotEmpty(listParm.getCollageName())){
            query.lambda().like(SchoolCollage::getCollageName,listParm.getCollageName());
        }
        //构造分页对象
        IPage<SchoolCollage> page = new Page<>(listParm.getCurrentPage(),listParm.getPageSize());
        //查询
        IPage<SchoolCollage> list = schoolCollageService.page(page, query);
        return ResultUtils.success("查询成功",list);
    }

}
```







#### 第38讲 新增学院接口对接

##### 1、api下新建college.js

```js
import http from "@/utils/http";
//新增
export const addApi = async parm => {
  return await http.post("/api/collage", parm);
};

```

##### 2、sysCollogeList.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchForm" label-width="80px" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchForm.collageName"
          placeholder="请输入学院的名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="collageName" label="学院名称">
            <el-input
              v-model="addModel.collageName"
              placeholder="请输入学院名称"
            ></el-input>
          </el-form-item>
          <el-form-item label="序号">
            <el-input
              v-model="addModel.orderNum"
              placeholder="请输入序号"
            ></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { addApi } from "@/api/college.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  //注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      //表单验证规则
      rules: {
        collageName: [
          {
            trigger: "blur",
            required: true,
            message: "请输入学院名称",
          },
        ],
      },
      //表单绑定对象
      addModel: {
        type: "", //区分是新增还是编辑 0：新增 1：编辑
        collageId: "",
        collageName: "",
        orderNum: "",
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 150,
        width: 650,
        visible: false,
      },
      //搜索表单
      searchForm: {
        collageName: "",
        currentPage: 1,
        pageSize: 10,
      },
    };
  },
  methods: {
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //弹框确定
    onConfirm() {
      //表单验证
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          }
          if (res && res.code == 200) {
            //信息提示
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    //新增
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置弹框属性
      this.addDialog.title = "新增学院";
      this.addDialog.visible = true;
      //设置编辑的属性
      this.addModel.type = "0"; //新增
    },
    //重置按钮
    resetBtn() {},
    //搜索按钮
    searchBtn() {},
  },
};
</script>

<style lang="scss" scoped>
</style>
```







#### 第39讲 学院列表页面对接

##### 1、api/college.js添加listApi()方法

```js
import http from "@/utils/http";
//新增
export const addApi = async (parm) => {
  return await http.post("/api/collage", parm);
};
//列表
export const listApi = async(parm)=>{
  return await http.get("/api/collage/list",parm)
}

```

##### 2、collogeList.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchForm" label-width="80px" :inline="true" size="mini">
      <el-form-item>
        <el-input
          v-model="searchForm.collageName"
          placeholder="请输入学院的名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 列表 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="collageName" label="学院名称"></el-table-column>
      <el-table-column prop="orderNum" label="序号"></el-table-column>
      <el-table-column label="操作" align="center" width="250">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchForm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchForm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchForm.total"
      background
    >
    </el-pagination>

    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="collageName" label="学院名称">
            <el-input
              v-model="addModel.collageName"
              placeholder="请输入学院名称"
            ></el-input>
          </el-form-item>
          <el-form-item label="序号">
            <el-input
              v-model="addModel.orderNum"
              placeholder="请输入序号"
            ></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { addApi, listApi } from "@/api/college.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  //注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //表单验证规则
      rules: {
        collageName: [
          {
            trigger: "blur",
            required: true,
            message: "请输入学院名称",
          },
        ],
      },
      //表单绑定对象
      addModel: {
        type: "", //区分是新增还是编辑 0：新增 1：编辑
        collageId: "",
        collageName: "",
        orderNum: "",
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 150,
        width: 650,
        visible: false,
      },
      //搜索表单
      searchForm: {
        collageName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      tableList: [],
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  methods: {
    //页数改变时触发
    currentChange(page) {
      this.searchForm.currentPage = page;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(size) {
      this.searchForm.pageSize = size;
      this.getList();
    },
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {},
    //获取列表
    async getList() {
      let res = await listApi(this.searchForm);
      if (res && res.code == 200) {
        console.log(res);
        //设置表格数据
        this.tableList = res.data.records;
        //总条数
        this.searchForm.total = res.data.total;
      }
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //弹框确定
    onConfirm() {
      //表单验证
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          }
          if (res && res.code == 200) {
            //信息提示
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    //新增
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置弹框属性
      this.addDialog.title = "新增学院";
      this.addDialog.visible = true;
      //设置编辑的属性
      this.addModel.type = "0"; //新增
    },
    //重置按钮
    resetBtn() {
      this.searchForm.currentPage = 1;
      this.searchForm.collageName = "";
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```







#### 第40讲 学院编辑、删除接口对接

##### 1、college.js添加editApi()和deleteApi()方法

```js
import http from "@/utils/http";
//新增
export const addApi = async (parm) => {
  return await http.post("/api/collage", parm);
};
//列表
export const listApi = async(parm)=>{
  return await http.get("/api/collage/list",parm)
}
//编辑
export const editApi = async(parm)=>{
  return await http.put("/api/collage", parm)
}
//删除
export const deleteApi = async(parm)=>{
  return await http.delete("/api/collage", parm)
}
```



##### 2、collogeList.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchForm" label-width="80px" :inline="true" size="mini">
      <el-form-item>
        <el-input
          v-model="searchForm.collageName"
          placeholder="请输入学院的名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 列表 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="collageName" label="学院名称"></el-table-column>
      <el-table-column prop="orderNum" label="序号"></el-table-column>
      <el-table-column label="操作" align="center" width="250">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchForm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchForm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchForm.total"
      background
    >
    </el-pagination>

    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="collageName" label="学院名称">
            <el-input
              v-model="addModel.collageName"
              placeholder="请输入学院名称"
            ></el-input>
          </el-form-item>
          <el-form-item label="序号">
            <el-input
              v-model="addModel.orderNum"
              placeholder="请输入序号"
            ></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { addApi, listApi, editApi, deleteApi } from "@/api/college.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  //注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //表单验证规则
      rules: {
        collageName: [
          {
            trigger: "blur",
            required: true,
            message: "请输入学院名称",
          },
        ],
      },
      //表单绑定对象
      addModel: {
        type: "", //区分是新增还是编辑 0：新增 1：编辑
        collageId: "",
        collageName: "",
        orderNum: "",
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 150,
        width: 650,
        visible: false,
      },
      //搜索表单
      searchForm: {
        collageName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      tableList: [],
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  methods: {
    //页数改变时触发
    currentChange(page) {
      this.searchForm.currentPage = page;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(size) {
      this.searchForm.pageSize = size;
      this.getList();
    },
    //删除按钮
    async deleteBtn(row) {
      //信息提示
      let confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteApi({
          collageId: row.collageId,
        });
        if (res && res.code == 200) {
          //信息提示
          this.$message.success(res.msg);
          //刷新列表
          this.getList();
        }
      }
    },
    //编辑按钮
    editBtn(row) {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //把要编辑的数据设置到表单绑定的对象
      this.$objCoppy(row, this.addModel);
      //设置编辑的属性
      this.addModel.type = "1";
      //设置弹框属性
      this.addDialog.title = "编辑学院";
      this.addDialog.visible = true;
    },
    //获取列表
    async getList() {
      let res = await listApi(this.searchForm);
      if (res && res.code == 200) {
        console.log(res);
        //设置表格数据
        this.tableList = res.data.records;
        //总条数
        this.searchForm.total = res.data.total;
      }
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //弹框确定
    onConfirm() {
      //表单验证
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            //信息提示
            this.$message.success(res.msg);
            this.addDialog.visible = false;
            //刷新列表
            this.getList();
          }
        }
      });
    },
    //新增
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置弹框属性
      this.addDialog.title = "新增学院";
      this.addDialog.visible = true;
      //设置编辑的属性
      this.addModel.type = "0"; //新增
    },
    //重置按钮
    resetBtn() {
      this.searchForm.currentPage = 1;
      this.searchForm.collageName = "";
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第41讲 专业管理模块接口开发

##### 1、数据库脚本

```js
drop table if exists school_major;

/*==============================================================*/
/* Table: school_major                                          */
/*==============================================================*/
create table school_major
(
   major_id             int not null auto_increment comment '专业id',
   collage_id           int comment '学院id',
   major_name           varchar(64) comment '专业名称',
   order_num            int comment '序号',
   primary key (major_id)
);
```

##### 2、新建实体类

```js
package com.itmk.web.school_major.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
@TableName("school_major")
public class SchoolMajor {
    @TableId(type = IdType.AUTO)
    private Long majorId;
    private Long collageId;
    private String majorName;
    private Integer orderNum;
    //学院名称，不属于专业表，需要排除
    @TableField(exist = false)
    private String collageName;
}

```

```js
package com.itmk.web.school_major.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class MajorList {
    private String majorName;
    private String collageName;
    private Long currentPage;
    private Long pageSize;
}

```

##### 3、新建mapper层

```js
package com.itmk.web.school_major.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.web.school_major.entity.MajorList;
import com.itmk.web.school_major.entity.SchoolMajor;
import org.apache.ibatis.annotations.Param;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface SchoolMajorMapper extends BaseMapper<SchoolMajor> {
    IPage<SchoolMajor> getList(IPage<SchoolMajor> page, @Param("parm")MajorList majorList);
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.school_major.mapper.SchoolMajorMapper">
    <select id="getList">
        select sm.*,sc.collage_name from school_major as sm
        left join school_collage as sc
        on sm.collage_id = sc.collage_id
        where 1=1
        <if test="parm.majorName !=null and parm.majorName !=''">
            and sm.major_name like concat('%',#{parm.majorName},'%')
        </if>
        <if test="parm.collageName !=null and parm.collageName !=''">
            and sc.collage_name like concat('%',#{parm.collageName},'%')
        </if>
    </select>
</mapper>
```

##### 4、新建service层

```js
package com.itmk.web.school_major.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.school_major.entity.MajorList;
import com.itmk.web.school_major.entity.SchoolMajor;


/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface SchoolMajorService extends IService<SchoolMajor> {
    IPage<SchoolMajor> getList(MajorList majorList);
}

```

实现类

```js
package com.itmk.web.school_major.service.impl;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.school_major.entity.MajorList;
import com.itmk.web.school_major.entity.SchoolMajor;
import com.itmk.web.school_major.mapper.SchoolMajorMapper;
import com.itmk.web.school_major.service.SchoolMajorService;
import org.springframework.stereotype.Service;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class SchoolMajorServiceImpl extends ServiceImpl<SchoolMajorMapper, SchoolMajor> implements SchoolMajorService {
    @Override
    public IPage<SchoolMajor> getList(MajorList majorList) {
        //构造分页对象
        IPage<SchoolMajor> page = new Page<>(majorList.getCurrentPage(),majorList.getPageSize());
        return this.baseMapper.getList(page,majorList);
    }
}

```

##### 5、新建控制器

```js
package com.itmk.web.school_major.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.school_major.entity.MajorList;
import com.itmk.web.school_major.entity.SchoolMajor;
import com.itmk.web.school_major.service.SchoolMajorService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/major")
public class SchoolMajorController {
    @Autowired
    private SchoolMajorService schoolMajorService;

    //新增
    @PostMapping
    public ResultVo add(@RequestBody SchoolMajor schoolMajor){
        boolean save = schoolMajorService.save(schoolMajor);
        if(save){
            return ResultUtils.success("新增成功");
        }
        return ResultUtils.error("新增失败!");
    }

    //编辑
    @PutMapping
    public ResultVo edit(@RequestBody SchoolMajor schoolMajor){
        boolean save = schoolMajorService.updateById(schoolMajor);
        if(save){
            return ResultUtils.success("编辑成功");
        }
        return ResultUtils.error("编辑失败!");
    }

    //删除
    @DeleteMapping("/{majorId}")
    public ResultVo delete(@PathVariable("majorId") Long majorId){
        boolean save = schoolMajorService.removeById(majorId);
        if(save){
            return ResultUtils.success("删除成功");
        }
        return ResultUtils.error("删除失败!");
    }

    //查询列表
    @GetMapping("/list")
    public ResultVo getList(MajorList majorList){
        IPage<SchoolMajor> list = schoolMajorService.getList(majorList);
        return ResultUtils.success("查询成功",list);
    }

}
```





#### 第42讲 新增专业页面制作与对接

##### 1、api下新建major.js

```js
import http from "@/utils/http";
//查询学院列表
export const getCollegeListApi = async()=>{
    return await http.get("/api/major/getCollegeList")
}
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/major",parm)
}
```



##### 2、新建majorList.vue页面

```js
<template>
  <el-main>
    <!--搜索栏-->
    <el-form :model="searchForm" :inline="true" size="small">
      <el-form-item label="">
        <el-input
          v-model="searchForm.collageName"
          placeholder="请输入学院名称"
        ></el-input>
      </el-form-item>
      <el-form-item label="">
        <el-input
          v-model="searchForm.majorName"
          placeholder="请输入专业名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="collageId" label="所属学院">
            <el-select
              style="width: 100%"
              v-model="addModel.collageId"
              placeholder="请选择学院"
            >
              <el-option
                v-for="item in collogeList"
                :key="item.collageId"
                :label="item.collageName"
                :value="item.collageId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="专业名称" prop="majorName">
            <el-input v-model="addModel.majorName"></el-input>
          </el-form-item>
          <el-form-item label="序号">
            <el-input v-model="addModel.orderNum"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getCollegeListApi, addApi } from "@/api/major.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      //表单验证规则
      rules: {
        collageId: [
          {
            trigger: "blur",
            required: true,
            message: "请选择学院",
          },
        ],
        majorName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写专业名称",
          },
        ],
      },
      //新增表单属性
      addModel: {
        type: "",
        majorId: "",
        collageId: "",
        majorName: "",
        orderNum: "",
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 200,
        width: 650,
        visible: false,
      },
      searchForm: {
        majorName: "",
        collageName: "",
        currentPage: "",
        pageSize: "",
        total: 0,
      },
      collogeList: [],
    };
  },
  methods: {
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //弹框确定
    onConfirm() {
      this.$refs.addForm.validate(async(valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          }
          if(res && res.code == 200){
            //信息提示
            this.$message.success(res.msg)
            //刷新列表
          }
          console.log(this.addModel);
          this.addDialog.visible = false;
        }
      });
    },
    //新增按钮
    async addBtn() {
      //清空表单
      this.$resetForm('addForm',this.addModel)
      //获取学院列表
      let res = await getCollegeListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.collogeList = res.data;
      }
      //显示弹框
      this.addDialog.title = "新增专业";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    //重置按钮
    resetBtn() {},
    //搜索按钮
    searchBtn() {},
  },
};
</script>

<style lang="scss" scoped>
</style>
```







#### 第43讲 专业列表制作与对接

##### 1、api/major.js添加listApi()

```js
import http from "@/utils/http";
//查询学院列表
export const getCollegeListApi = async()=>{
    return await http.get("/api/major/getCollegeList")
}
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/major",parm)
}
//列表
export const listApi = async(parm)=>{
    return await http.get("/api/major/list",parm)
}
```

##### 2、majorList.vue页面

```js
<template>
  <el-main>
    <!--搜索栏-->
    <el-form :model="searchForm" :inline="true" size="small">
      <el-form-item label="">
        <el-input
          v-model="searchForm.collageName"
          placeholder="请输入学院名称"
        ></el-input>
      </el-form-item>
      <el-form-item label="">
        <el-input
          v-model="searchForm.majorName"
          placeholder="请输入专业名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格数据 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="majorName" label="专业名称"></el-table-column>
      <el-table-column prop="collageName" label="所属学院"></el-table-column>
      <el-table-column prop="orderNum" label="序号"></el-table-column>
      <el-table-column label="操作" align="center" width="220">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchForm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchForm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchForm.total"
      background
    >
    </el-pagination>

    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="collageId" label="所属学院">
            <el-select
              style="width: 100%"
              v-model="addModel.collageId"
              placeholder="请选择学院"
            >
              <el-option
                v-for="item in collogeList"
                :key="item.collageId"
                :label="item.collageName"
                :value="item.collageId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="专业名称" prop="majorName">
            <el-input v-model="addModel.majorName"></el-input>
          </el-form-item>
          <el-form-item label="序号">
            <el-input v-model="addModel.orderNum"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getCollegeListApi, addApi, listApi } from "@/api/major.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //表单验证规则
      rules: {
        collageId: [
          {
            trigger: "blur",
            required: true,
            message: "请选择学院",
          },
        ],
        majorName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写专业名称",
          },
        ],
      },
      //新增表单属性
      addModel: {
        type: "",
        majorId: "",
        collageId: "",
        majorName: "",
        orderNum: "",
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 200,
        width: 650,
        visible: false,
      },
      searchForm: {
        majorName: "",
        collageName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      collogeList: [],
      //表格数据
      tableList: [],
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  methods: {
    //页数改变时触发
    currentChange(page) {
      this.searchForm.currentPage = page;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(size) {
      this.searchForm.pageSize = size;
      this.getList();
    },
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {},
    //获取列表数据
    async getList() {
      let res = await listApi(this.searchForm);
      if (res && res.code == 200) {
        console.log(res);
        //设置表格数据
        this.tableList = res.data.records;
        //设置分页
        this.searchForm.total = res.data.total;
      }
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //弹框确定
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          }
          if (res && res.code == 200) {
            //信息提示
            this.$message.success(res.msg);
            //刷新列表
          }
          console.log(this.addModel);
          this.addDialog.visible = false;
        }
      });
    },
    //新增按钮
    async addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //获取学院列表
      let res = await getCollegeListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.collogeList = res.data;
      }
      //显示弹框
      this.addDialog.title = "新增专业";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    //重置按钮
    resetBtn() {
      this.searchForm.majorName = "";
      this.searchForm.collageName = "";
      this.searchForm.currentPage = 1;
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```







#### 第44讲 专业编辑、删除接口对接

##### 1、api/major.js添加editApi()和deleteApi()方法

```js
import http from "@/utils/http";
//查询学院列表
export const getCollegeListApi = async()=>{
    return await http.get("/api/major/getCollegeList")
}
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/major",parm)
}
//列表
export const listApi = async(parm)=>{
    return await http.get("/api/major/list",parm)
}
//编辑
export const editApi = async(parm)=>{
    return await http.put("/api/major",parm)
}
//删除
export const deleteApi = async(parm)=>{
    return await http.delete("/api/major",parm)
}
```

##### 2、majorList.vue页面

```js
<template>
  <el-main>
    <!--搜索栏-->
    <el-form :model="searchForm" :inline="true" size="small">
      <el-form-item label="">
        <el-input
          v-model="searchForm.collageName"
          placeholder="请输入学院名称"
        ></el-input>
      </el-form-item>
      <el-form-item label="">
        <el-input
          v-model="searchForm.majorName"
          placeholder="请输入专业名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格数据 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="majorName" label="专业名称"></el-table-column>
      <el-table-column prop="collageName" label="所属学院"></el-table-column>
      <el-table-column prop="orderNum" label="序号"></el-table-column>
      <el-table-column label="操作" align="center" width="220">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchForm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchForm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchForm.total"
      background
    >
    </el-pagination>

    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="collageId" label="所属学院">
            <el-select
              style="width: 100%"
              v-model="addModel.collageId"
              placeholder="请选择学院"
            >
              <el-option
                v-for="item in collogeList"
                :key="item.collageId"
                :label="item.collageName"
                :value="item.collageId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="专业名称" prop="majorName">
            <el-input v-model="addModel.majorName"></el-input>
          </el-form-item>
          <el-form-item label="序号">
            <el-input v-model="addModel.orderNum"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import {
  getCollegeListApi,
  addApi,
  listApi,
  editApi,
  deleteApi,
} from "@/api/major.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //表单验证规则
      rules: {
        collageId: [
          {
            trigger: "blur",
            required: true,
            message: "请选择学院",
          },
        ],
        majorName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写专业名称",
          },
        ],
      },
      //新增表单属性
      addModel: {
        type: "",
        majorId: "",
        collageId: "",
        majorName: "",
        orderNum: "",
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 200,
        width: 650,
        visible: false,
      },
      searchForm: {
        majorName: "",
        collageName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      collogeList: [],
      //表格数据
      tableList: [],
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  methods: {
    //页数改变时触发
    currentChange(page) {
      this.searchForm.currentPage = page;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(size) {
      this.searchForm.pageSize = size;
      this.getList();
    },
    //删除按钮
    async deleteBtn(row) {
      //信息提示
      const confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteApi({
          majorId: row.majorId,
        });
        if (res && res.code == 200) {
          //信息提示
          this.$message.success(res.msg);
          this.getList();
        }
      }
    },
    //编辑按钮
    async editBtn(row) {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //获取学院列表
      let res = await getCollegeListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.collogeList = res.data;
      }
      //把要编辑的数据设置到表单绑定的对象里面
      this.$objCoppy(row, this.addModel);
      //显示弹框
      this.addDialog.title = "编辑专业";
      this.addDialog.visible = true;
      this.addModel.type = "1";
    },
    //获取列表数据
    async getList() {
      let res = await listApi(this.searchForm);
      if (res && res.code == 200) {
        console.log(res);
        //设置表格数据
        this.tableList = res.data.records;
        //设置分页
        this.searchForm.total = res.data.total;
      }
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //弹框确定
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            //信息提示
            this.$message.success(res.msg);
            //刷新列表
            this.getList();
          }
          console.log(this.addModel);
          this.addDialog.visible = false;
        }
      });
    },
    //新增按钮
    async addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //获取学院列表
      let res = await getCollegeListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.collogeList = res.data;
      }
      //显示弹框
      this.addDialog.title = "新增专业";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    //重置按钮
    resetBtn() {
      this.searchForm.majorName = "";
      this.searchForm.collageName = "";
      this.searchForm.currentPage = 1;
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```







#### 第45讲 班级管理模块接口开发

##### ·1、数据库脚本

```js
drop table if exists school_class;

/*==============================================================*/
/* Table: school_class                                          */
/*==============================================================*/
create table school_class
(
   class_id             int not null auto_increment comment '班级id',
   major_id             int comment '专业id',
   class_name           varchar(64) comment '班级名称',
   class_year           varchar(12) comment '招生年份',
   order_num            int comment '序号',
   primary key (class_id)
);
```

##### 2、新建实体类

```js
package com.itmk.web.school_class.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class ListParm {
    private String className;
    private String majorName;
    private String collageName;
    private Long currentPage;
    private Long pageSize;
}

```

```js
package com.itmk.web.school_class.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
@TableName("school_class")
public class SchoolClass {
    @TableId(type = IdType.AUTO)
    private Long classId;
    private Long majorId;
    @TableField(exist = false)
    private Long collageId;
    private String className;
    @TableField(exist = false)
    private String majorName;
    @TableField(exist = false)
    private String collageName;
    private String classYear;
    private Integer orderNum;
}

```

##### 3、新建mapper层

```js
package com.itmk.web.school_class.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.web.school_class.entity.ListParm;
import com.itmk.web.school_class.entity.SchoolClass;
import org.apache.ibatis.annotations.Param;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface SchoolClassMapper extends BaseMapper<SchoolClass> {
    //编辑回显
    SchoolClass getSchoolClassById(@Param("classId") Long classId);
    //查询列表
    IPage<SchoolClass> getList(IPage<SchoolClass> page, @Param("parm")ListParm parm);
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.school_class.mapper.SchoolClassMapper">
    <select id="getSchoolClassById" resultType="com.itmk.web.school_class.entity.SchoolClass">
        SELECT sc.* ,scc.collage_id FROM  school_class as sc
        left join school_major as sm  on sm.major_id = sc.major_id
        left join school_collage as scc on scc.collage_id = sm.collage_id
        where  sc.class_id =#{classId}
    </select>

    <select id="getList" resultType="com.itmk.web.school_class.entity.SchoolClass">
        SELECT sc.* ,scc.collage_name,sm.major_name FROM  school_class as sc
        left join school_major as sm  on sm.major_id = sc.major_id
        left join school_collage as scc on scc.collage_id = sm.collage_id
        where  1=1
        <if test="parm.className != null and parm.className !=''">
           and sc.class_name like concat('%',#{parm.className},'%')
        </if>
        <if test="parm.majorName != null and parm.majorName !=''">
           and  sm.major_name like concat('%',#{parm.majorName},'%')
        </if>
        <if test="parm.collageName != null and parm.collageName !=''">
           and  scc.collage_name like concat('%',#{parm.collageName},'%')
        </if>
    </select>
</mapper>
```



##### 4、新建service层

```js
package com.itmk.web.school_class.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.school_class.entity.ListParm;
import com.itmk.web.school_class.entity.SchoolClass;



/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface SchoolClassService extends IService<SchoolClass> {
     SchoolClass getSchoolClassById(Long classId);
      //查询列表
    IPage<SchoolClass> getList(ListParm parm);
}

```

实现类

```js
package com.itmk.web.school_class.service.impl;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.school_class.entity.ListParm;
import com.itmk.web.school_class.entity.SchoolClass;
import com.itmk.web.school_class.mapper.SchoolClassMapper;
import com.itmk.web.school_class.service.SchoolClassService;
import org.springframework.stereotype.Service;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class SchoolClassServiceImpl extends ServiceImpl<SchoolClassMapper, SchoolClass> implements SchoolClassService {
    @Override
    public SchoolClass getSchoolClassById(Long classId) {
        return this.baseMapper.getSchoolClassById(classId);
    }

    @Override
    public IPage<SchoolClass> getList(ListParm parm) {
        //构造分页对象
        IPage<SchoolClass> page = new Page<>(parm.getCurrentPage(),parm.getPageSize());
        return this.baseMapper.getList(page,parm);
    }
}

```

##### 5、控制器

```js
package com.itmk.web.school_class.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.school_class.entity.ListParm;
import com.itmk.web.school_class.entity.SchoolClass;
import com.itmk.web.school_class.service.SchoolClassService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/class")
public class SchoolClassController {
    @Autowired
    private SchoolClassService schoolClassService;

    //新增
    @PostMapping
    public ResultVo add(@RequestBody SchoolClass schoolClass){
        boolean save = schoolClassService.save(schoolClass);
        if(save){
            return ResultUtils.success("新增成功!");
        }
        return ResultUtils.error("新增失败!");
    }

     //编辑
    @PutMapping
    public ResultVo edit(@RequestBody SchoolClass schoolClass){
        boolean save = schoolClassService.updateById(schoolClass);
        if(save){
            return ResultUtils.success("编辑成功!");
        }
        return ResultUtils.error("编辑失败!");
    }

    //编辑回显
    @GetMapping("/getClassById")
    public ResultVo getClassById(Long classId){
        SchoolClass schoolClass = schoolClassService.getSchoolClassById(classId);
        return ResultUtils.success("查询成功",schoolClass);
    }


    //删除
    @DeleteMapping("/{classId}")
    public ResultVo delete(@PathVariable("classId") Long classId){
        boolean b = schoolClassService.removeById(classId);
        if(b){
            return ResultUtils.success("删除成功!");
        }
        return ResultUtils.error("删除失败!");
    }

    //列表查询
    @GetMapping("/list")
    public ResultVo getList(ListParm parm){
        IPage<SchoolClass> list = schoolClassService.getList(parm);
        return ResultUtils.success("查询成功",list);
    }

}

```





#### 第46讲 新增班级页面制作与对接

##### 1、api下新建classes.js

```js
import http from "@/utils/http";
//根据学院id查询专业列表
export const getMajorListApi = async(parm)=>{
    return http.get("/api/class/getMajorList",parm)
}
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/class",parm)
}
```



##### 2、classList.vue

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchModel.collageName"
          placeholder="请输入学院名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.majorName"
          placeholder="请输入专业名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.className"
          placeholder="请输入班级名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button icon="el-icon-close" style="color: #ff7670" @click="resetBtn"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :width="addDialog.width"
      :height="addDialog.height"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="collageId" label="所属学院">
            <el-select
              @change="selectChange"
              style="width: 100%"
              v-model="addModel.collageId"
              placeholder="请选择学院"
            >
              <el-option
                v-for="item in collogeList"
                :key="item.collageId"
                :label="item.collageName"
                :value="item.collageId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="majorId" label="所属专业">
            <el-select
              style="width: 100%"
              v-model="addModel.majorId"
              placeholder="请选择专业"
            >
              <el-option
                v-for="item in majorList"
                :key="item.majorId"
                :label="item.majorName"
                :value="item.majorId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="班级名称" prop="className">
            <el-input v-model="addModel.className"></el-input>
          </el-form-item>
          <el-form-item label="招生年份" prop="classYear">
            <el-date-picker
              style="width: 100%"
              v-model="addModel.classYear"
              type="year"
              placeholder="选择年份"
              value-format="yyyy"
            >
            </el-date-picker>
          </el-form-item>
          <el-form-item label="序号">
            <el-input v-model="addModel.orderNum"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getMajorListApi, addApi } from "@/api/classes.js";
import { getCollegeListApi } from "@/api/major.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      //表单绑定的数据对象
      addModel: {
        type: "",
        classId: "",
        majorId: "",
        collageId: "",
        className: "",
        classYear: "",
        orderNum: "",
      },
      //学院列表
      collogeList: [],
      //表单验证规则
      rules: {
        collageId: [
          {
            trigger: "blur",
            message: "请选择学院",
            required: true,
          },
        ],
        majorId: [
          {
            trigger: "blur",
            message: "请选择专业",
            required: true,
          },
        ],
        className: [
          {
            trigger: "blur",
            message: "请填写班级名称",
            required: true,
          },
        ],
        classYear: [
          {
            trigger: "blur",
            message: "请选择招生年份",
            required: true,
          },
        ],
      },
      //弹框属性
      addDialog: {
        title: "",
        width: 650,
        height: 260,
        visible: false,
      },
      //列表参数
      searchModel: {
        className: "",
        majorName: "",
        collageName: "",
        currentPage: "",
        pageSize: "",
      },
      majorList: [],
    };
  },
  methods: {
    //选用选择事件
    async selectChange(val) {
      //清空数据
      this.addModel.majorId = "";
      this.majorList = [];
      console.log(val);
      let res = await getMajorListApi({
        collageId: val,
      });
      if (res && res.code == 200) {
        //设置专业数据
        this.majorList = res.data;
      }
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //弹框确定
    onConfirm() {
      console.log(this.addModel);
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          }
          if (res && res.code == 200) {
            //信息提示
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    //新增
    async addBtn() {
      //清空数据
      this.$resetForm("addForm", this.addModel);
      this.collogeList = [];
      let res = await getCollegeListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.collogeList = res.data;
      }
      //设置弹框属性
      this.addDialog.title = "新增班级";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    //重置
    resetBtn() {},
    //搜索
    searchBtn() {},
  },
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第47讲 班级列表页面制作与对接

###### 1、api/classes.js添加getListApi()方法

```js
import http from "@/utils/http";
//根据学院id查询专业列表
export const getMajorListApi = async(parm)=>{
    return http.get("/api/class/getMajorList",parm)
}
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/class",parm)
}
//列表
export const getListApi = async(parm)=>{
    return await http.get("/api/class/list",parm)
}
```

##### 2、classList.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchModel.collageName"
          placeholder="请输入学院名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.majorName"
          placeholder="请输入专业名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.className"
          placeholder="请输入班级名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button icon="el-icon-close" style="color: #ff7670" @click="resetBtn"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height='tableHeight' :data="tableList" border stripe>
      <el-table-column prop="className" label="班级名称"></el-table-column>
      <el-table-column prop="classYear" label="招生年份"></el-table-column>
      <el-table-column prop="collageName" label="学院名称"></el-table-column>
      <el-table-column prop="majorName" label="专业名称"></el-table-column>
      <el-table-column prop="orderNum" label="序号"></el-table-column>
      <el-table-column label="操作" align="center" width="220">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
          >编辑</el-button>
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
          >删除</el-button>
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchModel.currentPage"
      :page-sizes="[10,20, 40, 80, 100]"
      :page-size="searchModel.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchModel.total" background>
    </el-pagination>
    
    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :width="addDialog.width"
      :height="addDialog.height"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="collageId" label="所属学院">
            <el-select
              @change="selectChange"
              style="width: 100%"
              v-model="addModel.collageId"
              placeholder="请选择学院"
            >
              <el-option
                v-for="item in collogeList"
                :key="item.collageId"
                :label="item.collageName"
                :value="item.collageId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="majorId" label="所属专业">
            <el-select
              style="width: 100%"
              v-model="addModel.majorId"
              placeholder="请选择专业"
            >
              <el-option
                v-for="item in majorList"
                :key="item.majorId"
                :label="item.majorName"
                :value="item.majorId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="班级名称" prop="className">
            <el-input v-model="addModel.className"></el-input>
          </el-form-item>
          <el-form-item label="招生年份" prop="classYear">
            <el-date-picker
              style="width: 100%"
              v-model="addModel.classYear"
              type="year"
              placeholder="选择年份"
              value-format="yyyy"
            >
            </el-date-picker>
          </el-form-item>
          <el-form-item label="序号">
            <el-input v-model="addModel.orderNum"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getMajorListApi, addApi, getListApi } from "@/api/classes.js";
import { getCollegeListApi } from "@/api/major.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      tableHeight:0,
      //表单绑定的数据对象
      addModel: {
        type: "",
        classId: "",
        majorId: "",
        collageId: "",
        className: "",
        classYear: "",
        orderNum: "",
      },
      //学院列表
      collogeList: [],
      //表单验证规则
      rules: {
        collageId: [
          {
            trigger: "blur",
            message: "请选择学院",
            required: true,
          },
        ],
        majorId: [
          {
            trigger: "blur",
            message: "请选择专业",
            required: true,
          },
        ],
        className: [
          {
            trigger: "blur",
            message: "请填写班级名称",
            required: true,
          },
        ],
        classYear: [
          {
            trigger: "blur",
            message: "请选择招生年份",
            required: true,
          },
        ],
      },
      //弹框属性
      addDialog: {
        title: "",
        width: 650,
        height: 260,
        visible: false,
      },
      //列表参数
      searchModel: {
        className: "",
        majorName: "",
        collageName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      majorList: [],
      tableList: [],
    };
  },
  created() {
    this.getList();
  },
  mounted(){
    this.$nextTick(()=>{
      this.tableHeight = window.innerHeight - 230
    })
  },
  methods: {
    //页数改变时触发
    currentChange(val){
      this.searchModel.currentPage = val
      this.getList()
    },
    //页容量改变时触发
    sizeChange(val){
      this.searchModel.pageSize = val
      this.getList()
    },
    //列表
    async getList() {
      let res = await getListApi(this.searchModel);
      if (res && res.code == 200) {
        console.log(res);
        //设置数据到表格的数据
        this.tableList = res.data.records;
        this.searchModel.total = res.data.total;
      }
    },
    //选用选择事件
    async selectChange(val) {
      //清空数据
      this.addModel.majorId = "";
      this.majorList = [];
      console.log(val);
      let res = await getMajorListApi({
        collageId: val,
      });
      if (res && res.code == 200) {
        //设置专业数据
        this.majorList = res.data;
      }
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //弹框确定
    onConfirm() {
      console.log(this.addModel);
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          }
          if (res && res.code == 200) {
            //信息提示
            this.$message.success(res.msg);
            //刷新列表
            this.getList()
            this.addDialog.visible = false;
          }
        }
      });
    },
    //新增
    async addBtn() {
      //清空数据
      this.$resetForm("addForm", this.addModel);
      this.collogeList = [];
      let res = await getCollegeListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.collogeList = res.data;
      }
      //设置弹框属性
      this.addDialog.title = "新增班级";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    //重置
    resetBtn() {
      this.searchModel.className = ''
      this.searchModel.majorName = ''
      this.searchModel.collageName = ''
      this.searchModel.currentPage = 1
      this.getList()
    },
    //搜索
    searchBtn() {
      this.getList()
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第48讲 班级编辑、删除接口对接

##### 1、classes.js添加editApi()、deleteApi()、getClassByIdApi()方法

```js
import http from "@/utils/http";
//根据学院id查询专业列表
export const getMajorListApi = async(parm)=>{
    return http.get("/api/class/getMajorList",parm)
}
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/class",parm)
}
//列表
export const getListApi = async(parm)=>{
    return await http.get("/api/class/list",parm)
}
//编辑
export const editApi = async(parm)=>{
    return await http.put("/api/class",parm)
}
//删除
export const deleteApi = async(parm)=>{
    return await http.delete("/api/class",parm)
}
//根据id查询编辑的数据
export const getClassByIdApi = async(parm)=>{
    return await http.get("/api/class/getClassById",parm)
}
```

##### 2、classList.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchModel.collageName"
          placeholder="请输入学院名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.majorName"
          placeholder="请输入专业名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.className"
          placeholder="请输入班级名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button icon="el-icon-close" style="color: #ff7670" @click="resetBtn"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="className" label="班级名称"></el-table-column>
      <el-table-column prop="classYear" label="招生年份"></el-table-column>
      <el-table-column prop="collageName" label="学院名称"></el-table-column>
      <el-table-column prop="majorName" label="专业名称"></el-table-column>
      <el-table-column prop="orderNum" label="序号"></el-table-column>
      <el-table-column label="操作" align="center" width="220">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchModel.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchModel.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchModel.total"
      background
    >
    </el-pagination>

    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :width="addDialog.width"
      :height="addDialog.height"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="collageId" label="所属学院">
            <el-select
              @change="selectChange"
              style="width: 100%"
              v-model="addModel.collageId"
              placeholder="请选择学院"
            >
              <el-option
                v-for="item in collogeList"
                :key="item.collageId"
                :label="item.collageName"
                :value="item.collageId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="majorId" label="所属专业">
            <el-select
              style="width: 100%"
              v-model="addModel.majorId"
              placeholder="请选择专业"
            >
              <el-option
                v-for="item in majorList"
                :key="item.majorId"
                :label="item.majorName"
                :value="item.majorId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="班级名称" prop="className">
            <el-input v-model="addModel.className"></el-input>
          </el-form-item>
          <el-form-item label="招生年份" prop="classYear">
            <el-date-picker
              style="width: 100%"
              v-model="addModel.classYear"
              type="year"
              placeholder="选择年份"
              value-format="yyyy"
            >
            </el-date-picker>
          </el-form-item>
          <el-form-item label="序号">
            <el-input v-model="addModel.orderNum"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import {
  getMajorListApi,
  addApi,
  getListApi,
  editApi,
  deleteApi,
  getClassByIdApi,
} from "@/api/classes.js";
import { getCollegeListApi } from "@/api/major.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      tableHeight: 0,
      //表单绑定的数据对象
      addModel: {
        type: "",
        classId: "",
        majorId: "",
        collageId: "",
        className: "",
        classYear: "",
        orderNum: "",
      },
      //学院列表
      collogeList: [],
      //表单验证规则
      rules: {
        collageId: [
          {
            trigger: "blur",
            message: "请选择学院",
            required: true,
          },
        ],
        majorId: [
          {
            trigger: "blur",
            message: "请选择专业",
            required: true,
          },
        ],
        className: [
          {
            trigger: "blur",
            message: "请填写班级名称",
            required: true,
          },
        ],
        classYear: [
          {
            trigger: "blur",
            message: "请选择招生年份",
            required: true,
          },
        ],
      },
      //弹框属性
      addDialog: {
        title: "",
        width: 650,
        height: 260,
        visible: false,
      },
      //列表参数
      searchModel: {
        className: "",
        majorName: "",
        collageName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      majorList: [],
      tableList: [],
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 230;
    });
  },
  methods: {
    //删除按钮
    async deleteBtn(row){
      //信息确定
      const confrim = await this.$myconfirm('确定删除该数据吗？')
      if(confrim){
        let res = await deleteApi({
          classId:row.classId
        })
        if(res && res.code ==200){
          //信息提示
          this.$message.success(res.msg)
          this.getList()
        }
      }
    },
    //编辑按钮
    async editBtn(row) {
      //清空数据
      this.$resetForm("addForm", this.addModel);
      this.collogeList = [];
      //获取要编辑的数据
      let classes = await getClassByIdApi({ classId: row.classId });
      if (classes && classes.code == 200) {
        // console.log(classes);
        this.$objCoppy(classes.data, this.addModel);
      }
      let res = await getCollegeListApi();
      if (res && res.code == 200) {
        // console.log(res);
        this.collogeList = res.data;
        let resmajor = await getMajorListApi({
          collageId: this.addModel.collageId,
        });
        if (resmajor && resmajor.code == 200) {
          //设置专业数据
          this.majorList = resmajor.data;
        }
      }
      //设置弹框属性
      this.addDialog.title = "编辑班级";
      this.addDialog.visible = true;
      this.addModel.type = "1";
    },
    //页数改变时触发
    currentChange(val) {
      this.searchModel.currentPage = val;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.searchModel.pageSize = val;
      this.getList();
    },
    //列表
    async getList() {
      let res = await getListApi(this.searchModel);
      if (res && res.code == 200) {
        console.log(res);
        //设置数据到表格的数据
        this.tableList = res.data.records;
        this.searchModel.total = res.data.total;
      }
    },
    //选用选择事件
    async selectChange(val) {
      //清空数据
      this.addModel.majorId = "";
      this.majorList = [];
      console.log(val);
      let res = await getMajorListApi({
        collageId: val,
      });
      if (res && res.code == 200) {
        //设置专业数据
        this.majorList = res.data;
      }
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //弹框确定
    onConfirm() {
      console.log(this.addModel);
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            //信息提示
            this.$message.success(res.msg);
            //刷新列表
            this.getList();
            this.addDialog.visible = false;
          }
        }
      });
    },
    //新增
    async addBtn() {
      //清空数据
      this.$resetForm("addForm", this.addModel);
      this.collogeList = [];
      let res = await getCollegeListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.collogeList = res.data;
      }
      //设置弹框属性
      this.addDialog.title = "新增班级";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    //重置
    resetBtn() {
      this.searchModel.className = "";
      this.searchModel.majorName = "";
      this.searchModel.collageName = "";
      this.searchModel.currentPage = 1;
      this.getList();
    },
    //搜索
    searchBtn() {
      this.getList();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```







#### 第49讲 学生管理模块接口开发

##### 1、数据库脚本

```js
drop table if exists school_student;

/*==============================================================*/
/* Table: school_student                                        */
/*==============================================================*/
create table school_student
(
   stu_id               int not null auto_increment comment '学生id',
   class_id             int comment '班级id',
   stu_name             varchar(36) comment '姓名',
   sex                  varchar(2) comment '性别',
   stu_num              varchar(64) comment '学号',
   id_card              varchar(36) comment '身份证',
   phone                varchar(16) comment '手机号',
   primary key (stu_id)
);

```

##### 2、新建实体类

```js
package com.itmk.web.school_student.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class StuParm {
    private String stuName;
    private String className;
    private String majorName;
    private String collageName;
    private Long currentPage;
    private Long pageSize;
}

```

```js
package com.itmk.web.school_student.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
@TableName("school_student")
public class SchoolStudent {
    @TableId(type = IdType.AUTO)
    private Long stuId;
    private Long classId;
    @TableField(exist = false)
    private Long collageId;
    @TableField(exist = false)
    private Long majorId;
    private String stuName;
    private String sex;
    private String stuNum;
    private String idCard;
    private String phone;
    @TableField(exist = false)
    private String className;
    @TableField(exist = false)
    private String majorName;
    @TableField(exist = false)
    private String collageName;
}

```

##### 3、新建mapper

```js
package com.itmk.web.school_student.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.web.school_student.entity.SchoolStudent;
import com.itmk.web.school_student.entity.StuParm;
import org.apache.ibatis.annotations.Param;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface SchoolStudentMapper extends BaseMapper<SchoolStudent> {
    SchoolStudent getStuById(@Param("stuId") Long stuId);
    IPage<SchoolStudent> getList(IPage<SchoolStudent> page, @Param("parm")StuParm parm);
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.school_student.mapper.SchoolStudentMapper">
    <select id="getStuById" resultType="com.itmk.web.school_student.entity.SchoolStudent">
        select st.*,sm.major_id,scc.collage_id from school_student as st
        left join school_class as sc on st.class_id = sc.class_id
        left join school_major as sm on sm.major_id = sc.major_id
        left join school_collage as scc on scc.collage_id = sm.collage_id
        where  st.stu_id =#{stuId}
    </select>
    <select id="getList">
        select st.*,sm.major_id,sm.major_name,scc.collage_id,scc.collage_name,sc.class_name from school_student as st
        left join school_class as sc on st.class_id = sc.class_id
        left join school_major as sm on sm.major_id = sc.major_id
        left join school_collage as scc on scc.collage_id = sm.collage_id
        where 1=1
        <if test="parm.stuName != null and parm.stuName !=''">
            and st.stu_name like concat('%',#{parm.stuName},'%')
        </if>
        <if test="parm.className != null and parm.className !=''">
            and sc.class_name like concat('%',#{parm.className},'%')
        </if>
        <if test="parm.majorName != null and parm.majorName !=''">
            and sm.major_name like concat('%',#{parm.majorName},'%')
        </if>
        <if test="parm.collageName != null and parm.collageName !=''">
            and scc.collage_name like concat('%',#{parm.collageName},'%')
        </if>
    </select>
</mapper>
```

##### 4、新建service层

```js
package com.itmk.web.school_student.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.school_student.entity.SchoolStudent;
import com.itmk.web.school_student.entity.StuParm;



/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface SchoolStudentService extends IService<SchoolStudent> {
    SchoolStudent getStuById(Long stuId);
    IPage<SchoolStudent> getList(StuParm parm);
}

```

实现类

```js
package com.itmk.web.school_student.service.impl;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.school_student.entity.SchoolStudent;
import com.itmk.web.school_student.entity.StuParm;
import com.itmk.web.school_student.mapper.SchoolStudentMapper;
import com.itmk.web.school_student.service.SchoolStudentService;
import org.springframework.stereotype.Service;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class SchoolStudentServiceImpl extends ServiceImpl<SchoolStudentMapper, SchoolStudent> implements SchoolStudentService {
    @Override
    public SchoolStudent getStuById(Long stuId) {
        return this.baseMapper.getStuById(stuId);
    }

    @Override
    public IPage<SchoolStudent> getList(StuParm parm) {
        //构造分页对象
        IPage<SchoolStudent> page = new Page<>(parm.getCurrentPage(),parm.getPageSize());
        return this.baseMapper.getList(page,parm);
    }
}

```

##### 5、控制器

```js
package com.itmk.web.school_student.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.school_student.entity.SchoolStudent;
import com.itmk.web.school_student.entity.StuParm;
import com.itmk.web.school_student.service.SchoolStudentService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/student")
public class SchoolStudentController {
    @Autowired
    private SchoolStudentService schoolStudentService;

    //新增
    @PostMapping
    public ResultVo add(@RequestBody SchoolStudent schoolStudent){
        boolean save = schoolStudentService.save(schoolStudent);
        if(save){
            return ResultUtils.success("新增成功!");
        }
        return ResultUtils.error("新增失败!");
    }

    //编辑
    @PutMapping
    public ResultVo edit(@RequestBody SchoolStudent schoolStudent){
        boolean save = schoolStudentService.updateById(schoolStudent);
        if(save){
            return ResultUtils.success("编辑成功!");
        }
        return ResultUtils.error("编辑失败!");
    }

    //根据id查询学生信息
    @GetMapping("/getById")
    public ResultVo getById(Long stuId){
        SchoolStudent stu = schoolStudentService.getStuById(stuId);
        return ResultUtils.success("查询成功",stu);
    }

    //删除
    @DeleteMapping("/{stuId}")
    public ResultVo delete(@PathVariable("stuId") Long stuId){
        boolean save = schoolStudentService.removeById(stuId);
        if(save){
            return ResultUtils.success("删除成功!");
        }
        return ResultUtils.error("删除失败!");
    }

     //列表
    @GetMapping("/list")
    public ResultVo getList(StuParm parm){
        IPage<SchoolStudent> stu = schoolStudentService.getList(parm);
        return ResultUtils.success("查询成功",stu);
    }

}

```





#### 第50讲 新增学生页面制作与对接

##### 1、api下新建student.js

```js
import http from "@/utils/http";
//查询班级列表
export const getClassListApi = async(parm)=>{
    return await http.get("/api/student/getClassList",parm)
}
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/student",parm)
}
```

##### 2、后端SchoolStudentController添加如下方法

```js
//列表
    @GetMapping("/getClassList")
    public ResultVo getClassList(Long  major){
        QueryWrapper<SchoolClass> query = new QueryWrapper<>();
        query.lambda().eq(SchoolClass::getMajorId,major);
        List<SchoolClass> list = schoolClassService.list(query);
        return ResultUtils.success("查询成功",list);
    }
```

##### 3、stuList.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchModel.collageName"
          placeholder="请输入学院名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.majorName"
          placeholder="请输入专业名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.className"
          placeholder="请输入班级名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.stuName"
          placeholder="请输入学生姓名"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button icon="el-icon-close" @click="resetBtn" style="color: #ff7670"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :width="addDialog.width"
      :height="addDialog.height"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="collageId" label="所属学院">
                <el-select
                  @change="selectChange"
                  style="width: 100%"
                  v-model="addModel.collageId"
                  placeholder="请选择学院"
                >
                  <el-option
                    v-for="item in collogeList"
                    :key="item.collageId"
                    :label="item.collageName"
                    :value="item.collageId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="majorId" label="所属专业">
                <el-select
                  @change="selectMajorChange"
                  style="width: 100%"
                  v-model="addModel.majorId"
                  placeholder="请选择专业"
                >
                  <el-option
                    v-for="item in majorList"
                    :key="item.majorId"
                    :label="item.majorName"
                    :value="item.majorId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="classId" label="所属班级">
                <el-select
                  style="width: 100%"
                  v-model="addModel.classId"
                  placeholder="请选择专业"
                >
                  <el-option
                    v-for="item in classList"
                    :key="item.classId"
                    :label="item.className"
                    :value="item.classId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="姓名" prop="stuName">
                <el-input v-model="addModel.stuName"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="学号" prop="stuNum">
                <el-input v-model="addModel.stuNum"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="性别" prop="sex">
                <el-radio-group v-model="addModel.sex">
                  <el-radio :label="'0'">男</el-radio>
                  <el-radio :label="'1'">女</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="身份证" prop="idCard">
                <el-input v-model="addModel.idCard"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="电话" prop="phone">
                <el-input v-model="addModel.phone"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getCollegeListApi } from "@/api/major.js";
import { getMajorListApi } from "@/api/classes.js";
import { getClassListApi, addApi } from "@/api/student.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      //学院数据
      collogeList: [],
      //专业数据
      majorList: [],
      //班级数据
      classList: [],
      //表单验证规则
      rules: {
        collageId: [
          {
            trigger: "change",
            required: true,
            message: "请选择学院",
          },
        ],
        majorId: [
          {
            trigger: "change",
            required: true,
            message: "请选择专业",
          },
        ],
        classId: [
          {
            trigger: "change",
            required: true,
            message: "请选择班级",
          },
        ],
        stuName: [
          {
            trigger: "change",
            required: true,
            message: "请填写姓名",
          },
        ],
        sex: [
          {
            trigger: "change",
            required: true,
            message: "请选择性别",
          },
        ],
        stuNum: [
          {
            trigger: "change",
            required: true,
            message: "请填写学号",
          },
        ],
        idCard: [
          {
            trigger: "change",
            required: true,
            message: "请填写身份证",
          },
        ],
        phone: [
          {
            trigger: "change",
            required: true,
            message: "请填写电话",
          },
        ],
      },
      //表单绑定的对象
      addModel: {
        type: "",
        stuId: "",
        classId: "",
        collageId: "",
        majorId: "",
        stuName: "",
        sex: "",
        stuNum: "",
        idCard: "",
        phone: "",
      },
      //弹框属性
      addDialog: {
        title: "",
        width: 680,
        height: 260,
        visible: false,
      },
      //搜索参数
      searchModel: {
        collageName: "",
        majorName: "",
        className: "",
        stuName: "",
        currentPage: 1,
        pageSize: 10,
      },
    };
  },
  methods: {
    //专业选择事件
    async selectMajorChange(val) {
      let res = await getClassListApi({
        major: val,
      });
      if (res && res.code == 200) {
        this.classList = res.data;
      }
      console.log(this.classList);
    },
    //选用选择事件
    async selectChange(val) {
      //清空数据
      this.addModel.majorId = "";
      this.majorList = [];
      console.log(val);
      let res = await getMajorListApi({
        collageId: val,
      });
      if (res && res.code == 200) {
        //设置专业数据
        this.majorList = res.data;
      }
    },
    //弹框确定
    onConfirm() {
      this.$refs.addForm.validate(async(valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //查询学院
      this.collogeList = [];
      this.getCollogeList();
      //设置弹框属性
      this.addDialog.title = "新增学生";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    //查询学院
    async getCollogeList() {
      let res = await getCollegeListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.collogeList = res.data;
      }
    },
    //重置按钮
    resetBtn() {},
    //搜索按钮
    searchBtn() {},
  },
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第51讲 学生列表页面制作与对接

##### 1、api/student.js添加listApi()方法

```js
import http from "@/utils/http";
//查询班级列表
export const getClassListApi = async(parm)=>{
    return await http.get("/api/student/getClassList",parm)
}
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/student",parm)
}
//列表
export const listApi = async(parm)=>{
    return await http.get("/api/student/list",parm)
}
```

##### 2、stuList.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchModel.collageName"
          placeholder="请输入学院名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.majorName"
          placeholder="请输入专业名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.className"
          placeholder="请输入班级名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.stuName"
          placeholder="请输入学生姓名"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button icon="el-icon-close" @click="resetBtn" style="color: #ff7670"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格数据 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column label="学生姓名" prop="stuName"></el-table-column>
      <el-table-column label="学号" prop="stuNum"></el-table-column>
      <el-table-column label="性别" prop="stuName">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.sex == '0'" type="danger" size="small"
            >男</el-tag
          >
          <el-tag v-if="scope.row.sex == '1'" type="blue" size="small"
            >女</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column label="学生电话" prop="phone"></el-table-column>
      <el-table-column label="身份证号" prop="idCard"></el-table-column>
      <el-table-column label="班级" prop="className"></el-table-column>
      <el-table-column label="专业" prop="majorName"></el-table-column>
      <el-table-column label="学院" prop="collageName"></el-table-column>
      <el-table-column label="操作" align="center" width="220">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchModel.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchModel.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchModel.total"
      background
    >
    </el-pagination>

    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :width="addDialog.width"
      :height="addDialog.height"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="collageId" label="所属学院">
                <el-select
                  @change="selectChange"
                  style="width: 100%"
                  v-model="addModel.collageId"
                  placeholder="请选择学院"
                >
                  <el-option
                    v-for="item in collogeList"
                    :key="item.collageId"
                    :label="item.collageName"
                    :value="item.collageId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="majorId" label="所属专业">
                <el-select
                  @change="selectMajorChange"
                  style="width: 100%"
                  v-model="addModel.majorId"
                  placeholder="请选择专业"
                >
                  <el-option
                    v-for="item in majorList"
                    :key="item.majorId"
                    :label="item.majorName"
                    :value="item.majorId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="classId" label="所属班级">
                <el-select
                  style="width: 100%"
                  v-model="addModel.classId"
                  placeholder="请选择专业"
                >
                  <el-option
                    v-for="item in classList"
                    :key="item.classId"
                    :label="item.className"
                    :value="item.classId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="姓名" prop="stuName">
                <el-input v-model="addModel.stuName"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="学号" prop="stuNum">
                <el-input v-model="addModel.stuNum"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="性别" prop="sex">
                <el-radio-group v-model="addModel.sex">
                  <el-radio :label="'0'">男</el-radio>
                  <el-radio :label="'1'">女</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="身份证" prop="idCard">
                <el-input v-model="addModel.idCard"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="电话" prop="phone">
                <el-input v-model="addModel.phone"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getCollegeListApi } from "@/api/major.js";
import { getMajorListApi } from "@/api/classes.js";
import { getClassListApi, addApi, listApi } from "@/api/student.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //表格数据
      tableList: [],
      //学院数据
      collogeList: [],
      //专业数据
      majorList: [],
      //班级数据
      classList: [],
      //表单验证规则
      rules: {
        collageId: [
          {
            trigger: "change",
            required: true,
            message: "请选择学院",
          },
        ],
        majorId: [
          {
            trigger: "change",
            required: true,
            message: "请选择专业",
          },
        ],
        classId: [
          {
            trigger: "change",
            required: true,
            message: "请选择班级",
          },
        ],
        stuName: [
          {
            trigger: "change",
            required: true,
            message: "请填写姓名",
          },
        ],
        sex: [
          {
            trigger: "change",
            required: true,
            message: "请选择性别",
          },
        ],
        stuNum: [
          {
            trigger: "change",
            required: true,
            message: "请填写学号",
          },
        ],
        idCard: [
          {
            trigger: "change",
            required: true,
            message: "请填写身份证",
          },
        ],
        phone: [
          {
            trigger: "change",
            required: true,
            message: "请填写电话",
          },
        ],
      },
      //表单绑定的对象
      addModel: {
        type: "",
        stuId: "",
        classId: "",
        collageId: "",
        majorId: "",
        stuName: "",
        sex: "",
        stuNum: "",
        idCard: "",
        phone: "",
      },
      //弹框属性
      addDialog: {
        title: "",
        width: 680,
        height: 260,
        visible: false,
      },
      //搜索参数
      searchModel: {
        collageName: "",
        majorName: "",
        className: "",
        stuName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
    };
  },
  created() {
    this.getLsit();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  methods: {
    //页数改变触发
    currentChange(val) {
      this.searchModel.currentPage = val;
      this.getLsit();
    },
    //页容量
    sizeChange(val) {
      this.searchModel.pageSize = val;
      this.getLsit();
    },
    //删除
    deleteBtn(row) {},
    //编辑
    editBtn(row) {},
    //获取表格数据
    async getLsit() {
      let res = await listApi(this.searchModel);
      if (res && res.code == 200) {
        console.log(res);
        //设置表格数据
        this.tableList = res.data.records;
        this.searchModel.total = res.data.total;
      }
    },
    //专业选择事件
    async selectMajorChange(val) {
      let res = await getClassListApi({
        major: val,
      });
      if (res && res.code == 200) {
        this.classList = res.data;
      }
      console.log(this.classList);
    },
    //选用选择事件
    async selectChange(val) {
      //清空数据
      this.addModel.majorId = "";
      this.majorList = [];
      console.log(val);
      let res = await getMajorListApi({
        collageId: val,
      });
      if (res && res.code == 200) {
        //设置专业数据
        this.majorList = res.data;
      }
    },
    //弹框确定
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            //刷新列表
            this.getLsit();
            this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //查询学院
      this.collogeList = [];
      this.getCollogeList();
      //设置弹框属性
      this.addDialog.title = "新增学生";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    //查询学院
    async getCollogeList() {
      let res = await getCollegeListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.collogeList = res.data;
      }
    },
    //重置按钮
    resetBtn() {
      this.searchModel.collageName = "";
      this.searchModel.className = "";
      this.searchModel.majorName = "";
      this.searchModel.className = "";
      this.searchModel.stuName = "";
      this.searchModel.currentPage = 1;
      this.getLsit();
    },
    //搜索按钮
    searchBtn() {
      this.getLsit();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第52讲  学生编辑、删除接口对接

##### 1、student.js添加editApi()和deleteApi()方法

```js
import http from "@/utils/http";
//查询班级列表
export const getClassListApi = async(parm)=>{
    return await http.get("/api/student/getClassList",parm)
}
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/student",parm)
}
//列表
export const listApi = async(parm)=>{
    return await http.get("/api/student/list",parm)
}
//编辑回显查询
export const getByIdApi = async(parm)=>{
    return await http.get("/api/student/getById",parm)
}
//编辑保存
export const editApi = async(parm)=>{
    return await http.put("/api/student",parm)
}
//删除
export const deleteApi = async(parm)=>{
    return await http.delete("/api/student",parm)
}
```

##### 2、stuList.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchModel.collageName"
          placeholder="请输入学院名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.majorName"
          placeholder="请输入专业名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.className"
          placeholder="请输入班级名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.stuName"
          placeholder="请输入学生姓名"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button icon="el-icon-close" @click="resetBtn" style="color: #ff7670"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格数据 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column label="学生姓名" prop="stuName"></el-table-column>
      <el-table-column label="学号" prop="stuNum"></el-table-column>
      <el-table-column label="性别" prop="stuName">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.sex == '0'" type="danger" size="small"
            >男</el-tag
          >
          <el-tag v-if="scope.row.sex == '1'" type="blue" size="small"
            >女</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column label="学生电话" prop="phone"></el-table-column>
      <el-table-column label="身份证号" prop="idCard"></el-table-column>
      <el-table-column label="班级" prop="className"></el-table-column>
      <el-table-column label="专业" prop="majorName"></el-table-column>
      <el-table-column label="学院" prop="collageName"></el-table-column>
      <el-table-column label="操作" align="center" width="220">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchModel.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchModel.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchModel.total"
      background
    >
    </el-pagination>

    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :width="addDialog.width"
      :height="addDialog.height"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="collageId" label="所属学院">
                <el-select
                  @change="selectChange"
                  style="width: 100%"
                  v-model="addModel.collageId"
                  placeholder="请选择学院"
                >
                  <el-option
                    v-for="item in collogeList"
                    :key="item.collageId"
                    :label="item.collageName"
                    :value="item.collageId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="majorId" label="所属专业">
                <el-select
                  @change="selectMajorChange"
                  style="width: 100%"
                  v-model="addModel.majorId"
                  placeholder="请选择专业"
                >
                  <el-option
                    v-for="item in majorList"
                    :key="item.majorId"
                    :label="item.majorName"
                    :value="item.majorId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="classId" label="所属班级">
                <el-select
                  style="width: 100%"
                  v-model="addModel.classId"
                  placeholder="请选择专业"
                >
                  <el-option
                    v-for="item in classList"
                    :key="item.classId"
                    :label="item.className"
                    :value="item.classId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="姓名" prop="stuName">
                <el-input v-model="addModel.stuName"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="学号" prop="stuNum">
                <el-input v-model="addModel.stuNum"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="性别" prop="sex">
                <el-radio-group v-model="addModel.sex">
                  <el-radio :label="'0'">男</el-radio>
                  <el-radio :label="'1'">女</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="身份证" prop="idCard">
                <el-input v-model="addModel.idCard"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="电话" prop="phone">
                <el-input v-model="addModel.phone"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getCollegeListApi } from "@/api/major.js";
import { getMajorListApi } from "@/api/classes.js";
import {
  getClassListApi,
  addApi,
  listApi,
  getByIdApi,
  editApi,
  deleteApi,
} from "@/api/student.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //表格数据
      tableList: [],
      //学院数据
      collogeList: [],
      //专业数据
      majorList: [],
      //班级数据
      classList: [],
      //表单验证规则
      rules: {
        collageId: [
          {
            trigger: "blur",
            required: true,
            message: "请选择学院",
          },
        ],
        majorId: [
          {
            trigger: "blur",
            required: true,
            message: "请选择专业",
          },
        ],
        classId: [
          {
            trigger: "blur",
            required: true,
            message: "请选择班级",
          },
        ],
        stuName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写姓名",
          },
        ],
        sex: [
          {
            trigger: "blur",
            required: true,
            message: "请选择性别",
          },
        ],
        stuNum: [
          {
            trigger: "blur",
            required: true,
            message: "请填写学号",
          },
        ],
        idCard: [
          {
            trigger: "blur",
            required: true,
            message: "请填写身份证",
          },
        ],
        phone: [
          {
            trigger: "blur",
            required: true,
            message: "请填写电话",
          },
        ],
      },
      //表单绑定的对象
      addModel: {
        type: "",
        stuId: "",
        classId: "",
        collageId: "",
        majorId: "",
        stuName: "",
        sex: "",
        stuNum: "",
        idCard: "",
        phone: "",
      },
      //弹框属性
      addDialog: {
        title: "",
        width: 680,
        height: 260,
        visible: false,
      },
      //搜索参数
      searchModel: {
        collageName: "",
        majorName: "",
        className: "",
        stuName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
    };
  },
  created() {
    this.getLsit();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  methods: {
    //页数改变触发
    currentChange(val) {
      this.searchModel.currentPage = val;
      this.getLsit();
    },
    //页容量
    sizeChange(val) {
      this.searchModel.pageSize = val;
      this.getLsit();
    },
    //删除
    async deleteBtn(row) {
      const confrim = await this.$myconfirm("确定删除该数据吗?");
      if (confrim) {
        let res = await deleteApi({
          stuId: row.stuId,
        });
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          this.getLsit();
        }
      }
    },
    //编辑
    editBtn(row) {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //查询编辑的信息
      this.getIfById(row.stuId);
      //查询学院
      this.collogeList = [];
      this.getCollogeList();
      //设置弹框属性
      this.addDialog.title = "编辑学生";
      this.addDialog.visible = true;
      this.addModel.type = "1";
    },
    //根据学生id查询学生信息
    async getIfById(stuId) {
      let res = await getByIdApi({
        stuId: stuId,
      });
      if (res && res.code == 200) {
        //设置编辑的信息
        this.$objCoppy(res.data, this.addModel);
        this.selectChangeEdit(res.data.collageId);
        this.selectMajorChangeEdit(res.data.majorId);
      }
    },
    async selectMajorChangeEdit(val) {
      this.classList = [];
      let res = await getClassListApi({
        major: val,
      });
      if (res && res.code == 200) {
        this.classList = res.data;
      }
    },
    async selectChangeEdit(val) {
      //清空数据
      this.majorList = [];
      let res = await getMajorListApi({
        collageId: val,
      });
      if (res && res.code == 200) {
        //设置专业数据
        this.majorList = res.data;
      }
    },
    //获取表格数据
    async getLsit() {
      let res = await listApi(this.searchModel);
      if (res && res.code == 200) {
        //设置表格数据
        this.tableList = res.data.records;
        this.searchModel.total = res.data.total;
      }
    },
    //专业选择事件
    async selectMajorChange(val) {
      this.addModel.classId = "";
      this.classList = [];
      let res = await getClassListApi({
        major: val,
      });
      if (res && res.code == 200) {
        this.classList = res.data;
      }
      // console.log(this.classList);
    },
    //选用选择事件,返回专业列表
    async selectChange(val) {
      //清空数据
      this.addModel.majorId = "";
      this.majorList = [];
      this.addModel.classId = "";
      this.classList = [];
      // console.log(val);
      let res = await getMajorListApi({
        collageId: val,
      });
      if (res && res.code == 200) {
        //设置专业数据
        this.majorList = res.data;
      }
    },
    //弹框确定
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            //刷新列表
            this.getLsit();
            this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //查询学院
      this.collogeList = [];
      this.getCollogeList();
      //设置弹框属性
      this.addDialog.title = "新增学生";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    //查询学院
    async getCollogeList() {
      let res = await getCollegeListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.collogeList = res.data;
      }
    },
    //重置按钮
    resetBtn() {
      this.searchModel.collageName = "";
      this.searchModel.className = "";
      this.searchModel.majorName = "";
      this.searchModel.className = "";
      this.searchModel.stuName = "";
      this.searchModel.currentPage = 1;
      this.getLsit();
    },
    //搜索按钮
    searchBtn() {
      this.getLsit();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第53讲 学生功能优化1

##### 1、数据库脚本

```js
drop table if exists stu_role;

/*==============================================================*/
/* Table: stu_role                                              */
/*==============================================================*/
create table stu_role
(
   stu_role_id          int not null auto_increment comment '主键',
   stu_id               int comment '学生id',
   role_id              int comment '角色id',
   primary key (stu_role_id)
);

```

##### 2、新建stu_role模块

###### 2.1、新建实体类

```js

```

```
package com.itmk.web.stu_role.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
@TableName("stu_role")
public class StuRole {
    @TableId(type = IdType.AUTO)
    private Long stuRoleId;
    private Long stuId;
    private Long roleId;
}
```

###### 2.2、新建mapper层

```js
package com.itmk.web.stu_role.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.stu_role.entity.StuRole;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface StuRoleMapper extends BaseMapper<StuRole> {
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.stu_role.mapper.StuRoleMapper">

</mapper>
```

###### 2.3、新建service

```js
package com.itmk.web.stu_role.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.stu_role.entity.StuRole;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface StuRoleService extends IService<StuRole> {
}

```

实现类

```js
package com.itmk.web.stu_role.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.stu_role.entity.StuRole;
import com.itmk.web.stu_role.mapper.StuRoleMapper;
import com.itmk.web.stu_role.service.StuRoleService;
import org.springframework.stereotype.Service;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class StuRoleServiceImpl extends ServiceImpl<StuRoleMapper, StuRole> implements StuRoleService {
}

```

##### 3、修改学生相关接口

###### 3.1、修改SchoolStudentMapper.xml如下

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.school_student.mapper.SchoolStudentMapper">
    <select id="getStuById" resultType="com.itmk.web.school_student.entity.SchoolStudent">
        select st.*,sm.major_id,scc.collage_id,sr.role_id from school_student as st
        left join school_class as sc on st.class_id = sc.class_id
        left join school_major as sm on sm.major_id = sc.major_id
        left join school_collage as scc on scc.collage_id = sm.collage_id
        left join stu_role as sr on sr.stu_id = st.stu_id
        where  st.stu_id =#{stuId}
    </select>
    <select id="getList" resultType="com.itmk.web.school_student.entity.SchoolStudent">
        select st.*,sm.major_id,sm.major_name,scc.collage_id,scc.collage_name,sc.class_name from school_student as st
        left join school_class as sc on st.class_id = sc.class_id
        left join school_major as sm on sm.major_id = sc.major_id
        left join school_collage as scc on scc.collage_id = sm.collage_id
        where 1=1
        <if test="parm.stuName != null and parm.stuName !=''">
            and st.stu_name like concat('%',#{parm.stuName},'%')
        </if>
        <if test="parm.className != null and parm.className !=''">
            and sc.class_name like concat('%',#{parm.className},'%')
        </if>
        <if test="parm.majorName != null and parm.majorName !=''">
            and sm.major_name like concat('%',#{parm.majorName},'%')
        </if>
        <if test="parm.collageName != null and parm.collageName !=''">
            and scc.collage_name like concat('%',#{parm.collageName},'%')
        </if>
    </select>

    <select id="getById" resultType="com.itmk.web.school_student.entity.SchoolStudent">
        select st.*,sr.role_id from school_student as st
        left join stu_role as sr on sr.stu_id = st.stu_id
        where st.stu_id =#{stuId}
    </select>
</mapper>
```

###### 3.2、SchoolStudentMapper接口

```js
package com.itmk.web.school_student.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.web.school_student.entity.SchoolStudent;
import com.itmk.web.school_student.entity.StuParm;
import org.apache.ibatis.annotations.Param;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface SchoolStudentMapper extends BaseMapper<SchoolStudent> {
    SchoolStudent getStuById(@Param("stuId") Long stuId);
    IPage<SchoolStudent> getList(IPage<SchoolStudent> page, @Param("parm")StuParm parm);
    SchoolStudent getById(@Param("stuId") Long stuId);
}

```

###### 3.3、SchoolStudent实体类

```js
package com.itmk.web.school_student.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
@TableName("school_student")
public class SchoolStudent {
    @TableId(type = IdType.AUTO)
    private Long stuId;
    private Long classId;
    @TableField(exist = false)
    private Long collageId;
    @TableField(exist = false)
    private Long majorId;
     @TableField(exist = false)
    private Long roleId;
    private String stuName;
    private String sex;
    private String stuNum;
    private String idCard;
    private String phone;
    private String password;
    @TableField(exist = false)
    private String className;
    @TableField(exist = false)
    private String majorName;
    @TableField(exist = false)
    private String collageName;
}

```

###### 3.4、service层

````js
package com.itmk.web.school_student.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.school_student.entity.SchoolStudent;
import com.itmk.web.school_student.entity.StuParm;



/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface SchoolStudentService extends IService<SchoolStudent> {
    SchoolStudent getStuById(Long stuId);
    IPage<SchoolStudent> getList(StuParm parm);
    //新增
    void addStu(SchoolStudent schoolStudent);
    //编辑
    void editStu(SchoolStudent schoolStudent);
    //删除
    void deleteStu(Long studId);
    //查询学生信息
    SchoolStudent getById(Long studId);
}

````

实现类

```js
package com.itmk.web.school_student.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.school_student.entity.SchoolStudent;
import com.itmk.web.school_student.entity.StuParm;
import com.itmk.web.school_student.mapper.SchoolStudentMapper;
import com.itmk.web.school_student.service.SchoolStudentService;
import com.itmk.web.stu_role.entity.StuRole;
import com.itmk.web.stu_role.service.StuRoleService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class SchoolStudentServiceImpl extends ServiceImpl<SchoolStudentMapper, SchoolStudent> implements SchoolStudentService {
    @Autowired
    private StuRoleService stuRoleService;
    @Override
    public SchoolStudent getStuById(Long stuId) {
        return this.baseMapper.getStuById(stuId);
    }

    @Override
    public IPage<SchoolStudent> getList(StuParm parm) {
        //构造分页对象
        IPage<SchoolStudent> page = new Page<>(parm.getCurrentPage(),parm.getPageSize());
        return this.baseMapper.getList(page,parm);
    }

    @Override
    @Transactional
    public void addStu(SchoolStudent schoolStudent) {
        //保存学生信息
        int insert = this.baseMapper.insert(schoolStudent);
        //设置学生角色
        if(insert > 0){
            StuRole stuRole = new StuRole();
            stuRole.setStuId(schoolStudent.getStuId());
            stuRole.setRoleId(schoolStudent.getRoleId());
            stuRoleService.save(stuRole);
        }
    }

    @Override
    @Transactional
    public void editStu(SchoolStudent schoolStudent) {
        //编辑学生信息
        int i = this.baseMapper.updateById(schoolStudent);
        //设置角色
        if(i>0){
            //先删除，再插入
            QueryWrapper<StuRole> query = new QueryWrapper<>();
            query.lambda().eq(StuRole::getStuId,schoolStudent.getStuId());
            stuRoleService.remove(query);
            StuRole stuRole = new StuRole();
            stuRole.setStuId(schoolStudent.getStuId());
            stuRole.setRoleId(schoolStudent.getRoleId());
            stuRoleService.save(stuRole);
        }
    }

    @Override
    public void deleteStu(Long studId) {
        int i = this.baseMapper.deleteById(studId);
        if(i>0){
            QueryWrapper<StuRole> query = new QueryWrapper<>();
            query.lambda().eq(StuRole::getStuId,studId);
            stuRoleService.remove(query);
        }
    }


    @Override
    public SchoolStudent getById(Long studId) {
        return this.baseMapper.getStuById(studId);
    }
}

```

###### 3.5、控制器

```js
package com.itmk.web.school_student.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.school_class.entity.SchoolClass;
import com.itmk.web.school_class.service.SchoolClassService;
import com.itmk.web.school_student.entity.SchoolStudent;
import com.itmk.web.school_student.entity.StuParm;
import com.itmk.web.school_student.service.SchoolStudentService;
import com.itmk.web.sys_role.entity.SysRole;
import com.itmk.web.sys_role.service.SysRoleService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.DigestUtils;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/student")
public class SchoolStudentController {
    @Autowired
    private SchoolStudentService schoolStudentService;
    @Autowired
    private SchoolClassService schoolClassService;
    @Autowired
    private SysRoleService sysRoleService;

    //新增
    @PostMapping
    public ResultVo add(@RequestBody SchoolStudent schoolStudent){
        schoolStudent.setPassword(DigestUtils.md5DigestAsHex(schoolStudent.getPassword().getBytes()));
       schoolStudentService.addStu(schoolStudent);
       return ResultUtils.success("新增成功!");
    }

    //编辑
    @PutMapping
    public ResultVo edit(@RequestBody SchoolStudent schoolStudent){
        schoolStudentService.editStu(schoolStudent);
        return ResultUtils.success("编辑成功!");
    }

    //根据id查询学生信息
    @GetMapping("/getById")
    public ResultVo getById(Long stuId){
        SchoolStudent stu = schoolStudentService.getStuById(stuId);
        return ResultUtils.success("查询成功",stu);
    }

    //删除
    @DeleteMapping("/{stuId}")
    public ResultVo delete(@PathVariable("stuId") Long stuId){
       schoolStudentService.deleteStu(stuId);
       return ResultUtils.success("删除成功!");
    }

     //列表
    @GetMapping("/list")
    public ResultVo getList(StuParm parm){
        IPage<SchoolStudent> stu = schoolStudentService.getList(parm);
        return ResultUtils.success("查询成功",stu);
    }

     //列表
    @GetMapping("/getClassList")
    public ResultVo getClassList(Long  major){
        QueryWrapper<SchoolClass> query = new QueryWrapper<>();
        query.lambda().eq(SchoolClass::getMajorId,major);
        List<SchoolClass> list = schoolClassService.list(query);
        return ResultUtils.success("查询成功",list);
    }

    //查询角色列表
    @GetMapping("/getRoleList")
    public ResultVo getRoleList(){
        List<SysRole> list = sysRoleService.list();
        return ResultUtils.success("查询成功",list);
    }

}

```

##### 4、stuList.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchModel.collageName"
          placeholder="请输入学院名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.majorName"
          placeholder="请输入专业名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.className"
          placeholder="请输入班级名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.stuName"
          placeholder="请输入学生姓名"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button icon="el-icon-close" @click="resetBtn" style="color: #ff7670"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格数据 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column label="学生姓名" prop="stuName"></el-table-column>
      <el-table-column label="学号" prop="stuNum"></el-table-column>
      <el-table-column label="性别" prop="stuName">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.sex == '0'" type="danger" size="small"
            >男</el-tag
          >
          <el-tag v-if="scope.row.sex == '1'" type="blue" size="small"
            >女</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column label="学生电话" prop="phone"></el-table-column>
      <el-table-column label="身份证号" prop="idCard"></el-table-column>
      <el-table-column label="班级" prop="className"></el-table-column>
      <el-table-column label="专业" prop="majorName"></el-table-column>
      <el-table-column label="学院" prop="collageName"></el-table-column>
      <el-table-column label="操作" align="center" width="220">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchModel.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchModel.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchModel.total"
      background
    >
    </el-pagination>

    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :width="addDialog.width"
      :height="addDialog.height"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="collageId" label="所属学院">
                <el-select
                  @change="selectChange"
                  style="width: 100%"
                  v-model="addModel.collageId"
                  placeholder="请选择学院"
                >
                  <el-option
                    v-for="item in collogeList"
                    :key="item.collageId"
                    :label="item.collageName"
                    :value="item.collageId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="majorId" label="所属专业">
                <el-select
                  @change="selectMajorChange"
                  style="width: 100%"
                  v-model="addModel.majorId"
                  placeholder="请选择专业"
                >
                  <el-option
                    v-for="item in majorList"
                    :key="item.majorId"
                    :label="item.majorName"
                    :value="item.majorId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="classId" label="所属班级">
                <el-select
                  style="width: 100%"
                  v-model="addModel.classId"
                  placeholder="请选择专业"
                >
                  <el-option
                    v-for="item in classList"
                    :key="item.classId"
                    :label="item.className"
                    :value="item.classId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="姓名" prop="stuName">
                <el-input v-model="addModel.stuName"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="学号" prop="stuNum">
                <el-input v-model="addModel.stuNum"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="性别" prop="sex">
                <el-radio-group v-model="addModel.sex">
                  <el-radio :label="'0'">男</el-radio>
                  <el-radio :label="'1'">女</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="身份证" prop="idCard">
                <el-input v-model="addModel.idCard"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="电话" prop="phone">
                <el-input v-model="addModel.phone"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="roleId" label="角色">
                <el-select
                  style="width: 100%"
                  v-model="addModel.roleId"
                  placeholder="请选择角色"
                >
                  <el-option
                    v-for="item in roleList"
                    :key="item.roleId"
                    :label="item.roleName"
                    :value="item.roleId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="密码" prop="password">
                <el-input v-model="addModel.password"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getCollegeListApi } from "@/api/major.js";
import { getMajorListApi } from "@/api/classes.js";
import {
  getClassListApi,
  addApi,
  listApi,
  getByIdApi,
  editApi,
  deleteApi,
  getRoleListApi,
} from "@/api/student.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //表格数据
      tableList: [],
      //学院数据
      collogeList: [],
      //专业数据
      majorList: [],
      //班级数据
      classList: [],
      //表单验证规则
      rules: {
        collageId: [
          {
            trigger: "blur",
            required: true,
            message: "请选择学院",
          },
        ],
        majorId: [
          {
            trigger: "blur",
            required: true,
            message: "请选择专业",
          },
        ],
        classId: [
          {
            trigger: "blur",
            required: true,
            message: "请选择班级",
          },
        ],
        stuName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写姓名",
          },
        ],
        sex: [
          {
            trigger: "blur",
            required: true,
            message: "请选择性别",
          },
        ],
        stuNum: [
          {
            trigger: "blur",
            required: true,
            message: "请填写学号",
          },
        ],
        idCard: [
          {
            trigger: "blur",
            required: true,
            message: "请填写身份证",
          },
        ],
        phone: [
          {
            trigger: "blur",
            required: true,
            message: "请填写电话",
          },
        ],
      },
      //表单绑定的对象
      addModel: {
        type: "",
        stuId: "",
        roleId: "",
        password: "",
        classId: "",
        collageId: "",
        majorId: "",
        stuName: "",
        sex: "",
        stuNum: "",
        idCard: "",
        phone: "",
      },
      //弹框属性
      addDialog: {
        title: "",
        width: 680,
        height: 260,
        visible: false,
      },
      //搜索参数
      searchModel: {
        collageName: "",
        majorName: "",
        className: "",
        stuName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      roleList: [],
    };
  },
  created() {
    this.getLsit();
    this.getRoleList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  methods: {
    //角色列表
    async getRoleList() {
      let res = await getRoleListApi();
      if (res && res.code == 200) {
        this.roleList = res.data;
      }
    },
    //页数改变触发
    currentChange(val) {
      this.searchModel.currentPage = val;
      this.getLsit();
    },
    //页容量
    sizeChange(val) {
      this.searchModel.pageSize = val;
      this.getLsit();
    },
    //删除
    async deleteBtn(row) {
      const confrim = await this.$myconfirm("确定删除该数据吗?");
      if (confrim) {
        let res = await deleteApi({
          stuId: row.stuId,
        });
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          this.getLsit();
        }
      }
    },
    //编辑
    editBtn(row) {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //查询编辑的信息
      this.getIfById(row.stuId);
      //查询学院
      this.collogeList = [];
      this.getCollogeList();
      //设置弹框属性
      this.addDialog.title = "编辑学生";
      this.addDialog.visible = true;
      this.addModel.type = "1";
    },
    //根据学生id查询学生信息
    async getIfById(stuId) {
      let res = await getByIdApi({
        stuId: stuId,
      });
      if (res && res.code == 200) {
        //设置编辑的信息
        this.$objCoppy(res.data, this.addModel);
        this.selectChangeEdit(res.data.collageId);
        this.selectMajorChangeEdit(res.data.majorId);
      }
    },
    async selectMajorChangeEdit(val) {
      this.classList = [];
      let res = await getClassListApi({
        major: val,
      });
      if (res && res.code == 200) {
        this.classList = res.data;
      }
    },
    async selectChangeEdit(val) {
      //清空数据
      this.majorList = [];
      let res = await getMajorListApi({
        collageId: val,
      });
      if (res && res.code == 200) {
        //设置专业数据
        this.majorList = res.data;
      }
    },
    //获取表格数据
    async getLsit() {
      let res = await listApi(this.searchModel);
      if (res && res.code == 200) {
        //设置表格数据
        this.tableList = res.data.records;
        this.searchModel.total = res.data.total;
      }
    },
    //专业选择事件
    async selectMajorChange(val) {
      this.addModel.classId = "";
      this.classList = [];
      let res = await getClassListApi({
        major: val,
      });
      if (res && res.code == 200) {
        this.classList = res.data;
      }
      // console.log(this.classList);
    },
    //选用选择事件,返回专业列表
    async selectChange(val) {
      //清空数据
      this.addModel.majorId = "";
      this.majorList = [];
      this.addModel.classId = "";
      this.classList = [];
      // console.log(val);
      let res = await getMajorListApi({
        collageId: val,
      });
      if (res && res.code == 200) {
        //设置专业数据
        this.majorList = res.data;
      }
    },
    //弹框确定
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            //刷新列表
            this.getLsit();
            this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //查询学院
      this.collogeList = [];
      this.getCollogeList();
      //设置弹框属性
      this.addDialog.title = "新增学生";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    //查询学院
    async getCollogeList() {
      let res = await getCollegeListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.collogeList = res.data;
      }
    },
    //重置按钮
    resetBtn() {
      this.searchModel.collageName = "";
      this.searchModel.className = "";
      this.searchModel.majorName = "";
      this.searchModel.className = "";
      this.searchModel.stuName = "";
      this.searchModel.currentPage = 1;
      this.getLsit();
    },
    //搜索按钮
    searchBtn() {
      this.getLsit();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第54讲 学生功能优化2

##### 1、stuList.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-select
          @change="serchCollogeChange"
          style="width: 100%"
          v-model="searchModel.collageId"
          placeholder="请选择学院"
        >
          <el-option
            v-for="item in searchCollogeList"
            :key="item.collageId"
            :label="item.collageName"
            :value="item.collageId"
          >
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-select
          @change="selectSearchMajorChangeEdit"
          style="width: 100%"
          v-model="searchModel.majorId"
          placeholder="请选择专业"
        >
          <el-option
            v-for="item in searchMajorList"
            :key="item.majorId"
            :label="item.majorName"
            :value="item.majorId"
          >
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-select
          style="width: 100%"
          v-model="searchModel.classId"
          placeholder="请选择专业"
        >
          <el-option
            v-for="item in searchClassList"
            :key="item.classId"
            :label="item.className"
            :value="item.classId"
          >
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.stuName"
          placeholder="请输入学生姓名"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button icon="el-icon-close" @click="resetBtn" style="color: #ff7670"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格数据 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column label="学生姓名" prop="stuName"></el-table-column>
      <el-table-column label="学号" prop="stuNum"></el-table-column>
      <el-table-column label="性别" prop="stuName">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.sex == '0'" type="danger" size="small"
            >男</el-tag
          >
          <el-tag v-if="scope.row.sex == '1'" type="blue" size="small"
            >女</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column label="学生电话" prop="phone"></el-table-column>
      <el-table-column label="身份证号" prop="idCard"></el-table-column>
      <el-table-column label="班级" prop="className"></el-table-column>
      <el-table-column label="专业" prop="majorName"></el-table-column>
      <el-table-column label="学院" prop="collageName"></el-table-column>
      <el-table-column label="操作" align="center" width="220">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchModel.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchModel.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchModel.total"
      background
    >
    </el-pagination>

    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :width="addDialog.width"
      :height="addDialog.height"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="collageId" label="所属学院">
                <el-select
                  @change="selectChange"
                  style="width: 100%"
                  v-model="addModel.collageId"
                  placeholder="请选择学院"
                >
                  <el-option
                    v-for="item in collogeList"
                    :key="item.collageId"
                    :label="item.collageName"
                    :value="item.collageId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="majorId" label="所属专业">
                <el-select
                  @change="selectMajorChange"
                  style="width: 100%"
                  v-model="addModel.majorId"
                  placeholder="请选择专业"
                >
                  <el-option
                    v-for="item in majorList"
                    :key="item.majorId"
                    :label="item.majorName"
                    :value="item.majorId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="classId" label="所属班级">
                <el-select
                  style="width: 100%"
                  v-model="addModel.classId"
                  placeholder="请选择专业"
                >
                  <el-option
                    v-for="item in classList"
                    :key="item.classId"
                    :label="item.className"
                    :value="item.classId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="姓名" prop="stuName">
                <el-input v-model="addModel.stuName"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="学号" prop="stuNum">
                <el-input v-model="addModel.stuNum"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="性别" prop="sex">
                <el-radio-group v-model="addModel.sex">
                  <el-radio :label="'0'">男</el-radio>
                  <el-radio :label="'1'">女</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="身份证" prop="idCard">
                <el-input v-model="addModel.idCard"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="电话" prop="phone">
                <el-input v-model="addModel.phone"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="roleId" label="角色">
                <el-select
                  style="width: 100%"
                  v-model="addModel.roleId"
                  placeholder="请选择角色"
                >
                  <el-option
                    v-for="item in roleList"
                    :key="item.roleId"
                    :label="item.roleName"
                    :value="item.roleId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col v-if="addModel.type == '0'" :span="12" :offset="0">
              <el-form-item label="密码" prop="password">
                <el-input v-model="addModel.password"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getCollegeListApi } from "@/api/major.js";
import { getMajorListApi } from "@/api/classes.js";
import {
  getClassListApi,
  addApi,
  listApi,
  getByIdApi,
  editApi,
  deleteApi,
  getRoleListApi,
} from "@/api/student.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      searchClassList: [],
      searchMajorList: [],
      searchCollogeList: [],
      //表格高度
      tableHeight: 0,
      //表格数据
      tableList: [],
      //学院数据
      collogeList: [],
      //专业数据
      majorList: [],
      //班级数据
      classList: [],
      //表单验证规则
      rules: {
        collageId: [
          {
            trigger: "blur",
            required: true,
            message: "请选择学院",
          },
        ],
        majorId: [
          {
            trigger: "blur",
            required: true,
            message: "请选择专业",
          },
        ],
        classId: [
          {
            trigger: "blur",
            required: true,
            message: "请选择班级",
          },
        ],
        stuName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写姓名",
          },
        ],
        sex: [
          {
            trigger: "blur",
            required: true,
            message: "请选择性别",
          },
        ],
        stuNum: [
          {
            trigger: "blur",
            required: true,
            message: "请填写学号",
          },
        ],
        idCard: [
          {
            trigger: "blur",
            required: true,
            message: "请填写身份证",
          },
        ],
        phone: [
          {
            trigger: "blur",
            required: true,
            message: "请填写电话",
          },
        ],
      },
      //表单绑定的对象
      addModel: {
        type: "",
        stuId: "",
        roleId: "",
        password: "",
        classId: "",
        collageId: "",
        majorId: "",
        stuName: "",
        sex: "",
        stuNum: "",
        idCard: "",
        phone: "",
      },
      //弹框属性
      addDialog: {
        title: "",
        width: 680,
        height: 260,
        visible: false,
      },
      //搜索参数
      searchModel: {
        collageName: "",
        majorName: "",
        className: "",
        stuName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
        classId: "",
        collageId: "",
        majorId: "",
      },
      roleList: [],
    };
  },
  created() {
    this.getLsit();
    this.getRoleList();
    this.getSearchCollogeList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  methods: {
    //搜索查询学院
    async getSearchCollogeList() {
      let res = await getCollegeListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.searchCollogeList = res.data;
      }
    },
    async serchCollogeChange(val) {
      //清空数据
      this.searchModel.majorId = "";
      this.searchMajorList = [];
      this.searchModel.classId = "";
      this.searchClassList = [];
      // console.log(val);
      let res = await getMajorListApi({
        collageId: val,
      });
      if (res && res.code == 200) {
        //设置专业数据
        this.searchMajorList = res.data;
      }
    },
    async selectSearchMajorChangeEdit(val) {
      this.searchClassList = [];
      let res = await getClassListApi({
        major: val,
      });
      if (res && res.code == 200) {
        this.searchClassList = res.data;
      }
    },
    //角色列表
    async getRoleList() {
      let res = await getRoleListApi();
      if (res && res.code == 200) {
        this.roleList = res.data;
      }
    },
    //页数改变触发
    currentChange(val) {
      this.searchModel.currentPage = val;
      this.getLsit();
    },
    //页容量
    sizeChange(val) {
      this.searchModel.pageSize = val;
      this.getLsit();
    },
    //删除
    async deleteBtn(row) {
      const confrim = await this.$myconfirm("确定删除该数据吗?");
      if (confrim) {
        let res = await deleteApi({
          stuId: row.stuId,
        });
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          this.getLsit();
        }
      }
    },
    //编辑
    editBtn(row) {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //查询编辑的信息
      this.getIfById(row.stuId);
      //查询学院
      this.collogeList = [];
      this.getCollogeList();
      //设置弹框属性
      this.addDialog.title = "编辑学生";
      this.addDialog.visible = true;
      this.addModel.type = "1";
      //密码清空
      this.addModel.password = "";
    },
    //根据学生id查询学生信息
    async getIfById(stuId) {
      let res = await getByIdApi({
        stuId: stuId,
      });
      if (res && res.code == 200) {
        //设置编辑的信息
        this.$objCoppy(res.data, this.addModel);
        this.selectChangeEdit(res.data.collageId);
        this.selectMajorChangeEdit(res.data.majorId);
      }
    },
    async selectMajorChangeEdit(val) {
      this.classList = [];
      let res = await getClassListApi({
        major: val,
      });
      if (res && res.code == 200) {
        this.classList = res.data;
      }
    },
    async selectChangeEdit(val) {
      //清空数据
      this.majorList = [];
      let res = await getMajorListApi({
        collageId: val,
      });
      if (res && res.code == 200) {
        //设置专业数据
        this.majorList = res.data;
      }
    },
    //获取表格数据
    async getLsit() {
      let res = await listApi(this.searchModel);
      if (res && res.code == 200) {
        //设置表格数据
        this.tableList = res.data.records;
        this.searchModel.total = res.data.total;
      }
    },
    //专业选择事件
    async selectMajorChange(val) {
      this.addModel.classId = "";
      this.classList = [];
      let res = await getClassListApi({
        major: val,
      });
      if (res && res.code == 200) {
        this.classList = res.data;
      }
      // console.log(this.classList);
    },
    //选用选择事件,返回专业列表
    async selectChange(val) {
      //清空数据
      this.addModel.majorId = "";
      this.majorList = [];
      this.addModel.classId = "";
      this.classList = [];
      // console.log(val);
      let res = await getMajorListApi({
        collageId: val,
      });
      if (res && res.code == 200) {
        //设置专业数据
        this.majorList = res.data;
      }
    },
    //弹框确定
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            //刷新列表
            this.getLsit();
            this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //查询学院
      this.collogeList = [];
      this.getCollogeList();
      //设置弹框属性
      this.addDialog.title = "新增学生";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    //查询学院
    async getCollogeList() {
      let res = await getCollegeListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.collogeList = res.data;
      }
    },
    //重置按钮
    resetBtn() {
      this.searchModel.collageId = "";
      this.searchModel.classId = "";
      this.searchModel.majorId = "";
      this.searchModel.stuName = "";
      this.searchModel.currentPage = 1;
      this.getLsit();
    },
    //搜索按钮
    searchBtn() {
      console.log(this.searchModel)
      this.getLsit();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第55讲 宿舍管理模块数据库设计

##### 1、栋数表

```js
drop table if exists drom_build;

/*==============================================================*/
/* Table: drom_build                                            */
/*==============================================================*/
create table drom_build
(
   build_id             int not null auto_increment comment '栋数id',
   user_id              int comment '用户id',
   build_storey         int comment '层数',
   sex                  varchar(2) comment '性别 0：男 1：女',
   build_name           varchar(36) comment '栋数名称',
   order_num            int comment '序号',
   primary key (build_id)
);
```

##### 2、楼层表

```js
drop table if exists drom_storey;

/*==============================================================*/
/* Table: drom_storey                                           */
/*==============================================================*/
create table drom_storey
(
   storey_id            int not null auto_increment comment '层数id',
   build_id             int comment '栋数id',
   storey_name          varchar(36) comment '层名称',
   primary key (storey_id)
);
```

##### 3、宿舍表

```js
drop table if exists dorm_room;

/*==============================================================*/
/* Table: dorm_room                                             */
/*==============================================================*/
create table dorm_room
(
   room_id              int not null auto_increment comment '宿舍id',
   storey_id            int comment '层数id',
   root_type            varchar(10) comment '宿舍编号 1:1人间 2：2人间 4:4人间  6:6人间',
   room_code            varchar(36) comment '宿舍编号',
   total_bed            int comment '容纳人数',
   primary key (room_id)
);
```

##### 4、床位表

```js
drop table if exists drom_room_bed;

/*==============================================================*/
/* Table: drom_room_bed                                         */
/*==============================================================*/
create table drom_room_bed
(
   bed_id               int not null auto_increment comment '床位id',
   room_id              int comment '宿舍id',
   bed_code             varchar(36) comment '床位编号',
   primary key (bed_id)
);
```





#### 第56讲 栋数接口开发

##### 1、新建drom_storey模块

###### 1.1、新建实体类

```js
package com.itmk.web.drom_storey.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
@TableName("drom_storey")
public class DromStorey {
    @TableId(type = IdType.AUTO)
    private Long storeyId;
    private Long buildId;
    private String storeyName;
    private Integer orderNum;
}

```

###### 1.2、新建mapper层

```js
package com.itmk.web.drom_storey.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.drom_storey.entity.DromStorey;
import org.apache.ibatis.annotations.Param;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface DromStoreyMapper extends BaseMapper<DromStorey> {
    //新增
    void addDrom(@Param("list")List<DromStorey> list);
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.drom_storey.mapper.DromStoreyMapper">
     <insert id="addDrom">
        insert  into drom_storey(build_id,storey_name,order_num) values
        <foreach collection="list" item="item" index="index" separator=",">
            (#{item.buildId},#{item.storeyName},#{item.orderNum})
        </foreach>
    </insert>
</mapper>
```

###### 1.3、新建service层

```js
package com.itmk.web.drom_storey.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.drom_storey.entity.DromStorey;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface DromStoreyService extends IService<DromStorey> {
    //新增
    void addDrom(List<DromStorey> list);
}

```

实现类

```js
package com.itmk.web.drom_storey.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.drom_storey.entity.DromStorey;
import com.itmk.web.drom_storey.mapper.DromStoreyMapper;
import com.itmk.web.drom_storey.service.DromStoreyService;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class DromStoreyServiceImpl extends ServiceImpl<DromStoreyMapper, DromStorey> implements DromStoreyService {
    @Override
    public void addDrom(List<DromStorey> list) {
        this.baseMapper.addDrom(list);
    }
}

```

##### 2、新建drom_build模块

###### 2.1、新建实体类

```js
package com.itmk.web.drom_build.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import com.itmk.web.drom_storey.entity.DromStorey;
import lombok.Data;

import java.util.ArrayList;
import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
@TableName("drom_build")
public class DromBuild {
    @TableId(type = IdType.AUTO)
    private Long buildId;
    private Long userId;
    private Long buildStorey;
    private String sex;
    private String buildName;
    private Integer orderNum;
    //楼栋对应的层数
    @TableField(exist = false)
    private List<DromStorey> storeys = new ArrayList<>();
}

```

```js
package com.itmk.web.drom_build.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class BuildParm {
    private String buildName;
    private Long currentPage;
    private Long pageSize;
}

```

###### 2.2、新建mapper层

```js
package com.itmk.web.drom_build.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.drom_build.entity.DromBuild;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface DromBuildMapper extends BaseMapper<DromBuild> {
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.drom_build.mapper.DromBuildMapper">

</mapper>
```

###### 2.3、新建service层

```js
package com.itmk.web.drom_build.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.drom_build.entity.DromBuild;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface DromBuildService extends IService<DromBuild> {
    //新增
    void addBuild(DromBuild dromBuild);
}

```

实现类

```js
package com.itmk.web.drom_build.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.drom_build.entity.DromBuild;
import com.itmk.web.drom_build.mapper.DromBuildMapper;
import com.itmk.web.drom_build.service.DromBuildService;
import com.itmk.web.drom_storey.entity.DromStorey;
import com.itmk.web.drom_storey.service.DromStoreyService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class DromBuildServiceImpl extends ServiceImpl<DromBuildMapper, DromBuild> implements DromBuildService {
    @Autowired
    private DromStoreyService dromStoreyService;

    @Override
    @Transactional
    public void addBuild(DromBuild dromBuild) {
        //新增栋数
        int insert = this.baseMapper.insert(dromBuild);
        //新增层数
        if(insert > 0){
            String[] storey = {"一层","二层","三层","四层","五层","六层","七层","八层","九层","十层","十一层","十二层"};
            //存放构建的层数
            List<DromStorey> list = new ArrayList<>();
            for(int i=0; i < dromBuild.getBuildStorey();i++){
                DromStorey dromStorey = new DromStorey();
                dromStorey.setBuildId(dromBuild.getBuildId());
                dromStorey.setStoreyName(storey[i]);
                dromStorey.setOrderNum(i+1);
                list.add(dromStorey);
            }
            //插入层数表
            dromStoreyService.addDrom(list);
        }
    }
}

```

###### 2.4、控制器

```js
package com.itmk.web.drom_build.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.drom_build.entity.BuildParm;
import com.itmk.web.drom_build.entity.DromBuild;
import com.itmk.web.drom_build.service.DromBuildService;
import com.itmk.web.drom_storey.entity.DromStorey;
import com.itmk.web.drom_storey.service.DromStoreyService;
import com.itmk.web.sys_user.entity.SysUser;
import com.itmk.web.sys_user.service.SysUserService;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/build")
public class DromBuildController {
    @Autowired
    private DromBuildService dromBuildService;
    @Autowired
    private DromStoreyService dromStoreyService;
    @Autowired
    private SysUserService sysUserService;

    //新增
    @PostMapping
    public ResultVo add(@RequestBody DromBuild dromBuild){
        if(dromBuild.getBuildStorey() > 12){
            return ResultUtils.error("层数不能大于12层!");
        }
        dromBuildService.addBuild(dromBuild);
        return ResultUtils.success("新增成功!");
    }

     //新增
    @PutMapping
    public ResultVo edit(@RequestBody DromBuild dromBuild){
        boolean b = dromBuildService.updateById(dromBuild);
        if(b){
             return ResultUtils.success("编辑成功!");
        }
        return ResultUtils.error("编辑失败!");
    }

    @DeleteMapping("/{buildId}")
    public ResultVo delete(@PathVariable("buildId") Long buildId){
        //判断楼栋下面是否有层数
        QueryWrapper<DromStorey> query = new QueryWrapper<>();
        query.lambda().eq(DromStorey::getBuildId,buildId);
        List<DromStorey> list = dromStoreyService.list(query);
        if(list.size() >0){
             return ResultUtils.error("该楼栋存在层数,删除失败!");
        }
        boolean b = dromBuildService.removeById(buildId);
        if(b){
             return ResultUtils.success("删除成功!");
        }
        return ResultUtils.error("删除失败!");
    }

    //查询管理员
    @GetMapping("/getUserList")
    public ResultVo getUserList(){
        List<SysUser> list = sysUserService.list(new QueryWrapper<SysUser>().select("user_id", "nick_name"));
        return ResultUtils.success("查询成功",list);
    }

    //查询列表
    @GetMapping("/list")
    public ResultVo getBuildList(BuildParm parm){
        //构造分页对象
        IPage<DromBuild> page = new Page<>(parm.getCurrentPage(),parm.getPageSize());
        //构造查询条件
        QueryWrapper<DromBuild> query = new QueryWrapper<>();
        if(StringUtils.isNotEmpty(parm.getBuildName())){
            query.lambda().like(DromBuild::getBuildName,parm.getBuildName());
        }
        query.lambda().orderByAsc(DromBuild::getOrderNum);
        IPage<DromBuild> list = dromBuildService.page(page, query);
        if(list.getRecords().size() >0){
            for (int i =0;i<list.getRecords().size();i++){
                Long buildId = list.getRecords().get(i).getBuildId();
                QueryWrapper<DromStorey> queryWrapper = new QueryWrapper<>();
                queryWrapper.lambda().eq(DromStorey::getBuildId,buildId).orderByAsc(DromStorey::getOrderNum);
                List<DromStorey> list1 = dromStoreyService.list(queryWrapper);
                list.getRecords().get(i).setStoreys(list1);
            }
        }
        return ResultUtils.success("查询成功",list);
    }

}

```



#### 第57讲 新增楼栋页面制作与对接

##### 1、api下新建build.js

```js
import http from "@/utils/http";
//查询用户列表
export const getUserListApi = async()=>{
    return await http.get("/api/build/getUserList",null)
}
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/build",parm)
}
```

##### 2、buildList.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchModel.buildName"
          placeholder="请输入楼栋名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="buildName" label="栋数名称">
                <el-input
                  v-model="addModel.buildName"
                  placeholder="请输入栋数名称"
                ></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="buildStorey" label="层数">
                <el-input
                  type="number"
                  v-model="addModel.buildStorey"
                  placeholder="请输入层数"
                ></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="userId" label="管理员">
                <el-select
                  style="width: 100%"
                  v-model="addModel.userId"
                  placeholder="请选择管理员"
                >
                  <el-option
                    v-for="item in userList"
                    :key="item.userId"
                    :label="item.nickName"
                    :value="item.userId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="sex" label="性别">
                <el-radio-group v-model="addModel.sex">
                  <el-radio :label="'0'">男</el-radio>
                  <el-radio :label="'1'">女</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="序号">
                <el-input
                  type="number"
                  v-model="addModel.orderNum"
                  placeholder="请输入序号"
                ></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getUserListApi, addApi } from "@/api/build.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      //表单验证规则
      rules: {
        userId: [
          {
            trigger: "blur",
            required: true,
            message: "请选择管理员",
          },
        ],
        buildStorey: [
          {
            trigger: "blur",
            required: true,
            message: "请填写层数",
          },
        ],
        sex: [
          {
            trigger: "blur",
            required: true,
            message: "请选择性别",
          },
        ],
        buildName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写栋数名称",
          },
        ],
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 200,
        width: 650,
        visible: false,
      },
      //表单绑定的对象
      addModel: {
        type: "",
        buildId: "",
        userId: "",
        buildStorey: "",
        sex: "",
        buildName: "",
        orderNum: "",
      },
      //查询列表的参数
      searchModel: {
        buildName: "",
      },
      userList: [],
    };
  },
  created() {
    this.getUserList();
  },
  methods: {
    //管理员数据
    async getUserList() {
      let res = await getUserListApi();
      if (res && res.code) {
        this.userList = res.data;
      }
    },
    //弹框确定
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //新增按钮
    addBtn() {
      this.$resetForm("addForm", this.addModel);
      //弹框属性设置
      this.addDialog.title = "新增栋数";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    //重置按钮
    resetBtn() {},
    //搜索按钮
    searchBtn() {},
  },
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第58讲 列表页面制作与对接

##### 1、api/build.js

```js
import http from "@/utils/http";
//查询用户列表
export const getUserListApi = async()=>{
    return await http.get("/api/build/getUserList",null)
}
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/build",parm)
}
//列表
export const listApi = async(parm)=>{
    return await http.get("/api/build/list",parm)
}
```

##### 2、buildList.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchModel.buildName"
          placeholder="请输入楼栋名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :header-cell-style="{background:'#FAFAFA'}" :data="tableList" @expand-change="expandChange" :height="tableHeight" border stripe>
      <el-table-column width="100" type="expand">
        <template slot-scope="scope">
          <el-table border :data="scope.row.storeys">
            <el-table-column
              label="层数"
              align="center"
              prop="storeyName"
            ></el-table-column>
            <el-table-column
              label="序号"
              align="center"
              prop="orderNum"
            ></el-table-column>
            <el-table-column label="操作" align="center" width="180">
              <template slot-scope="scope">
                <el-button
                  round
                  icon="el-icon-edit"
                  type="success"
                  size="mini"
                  @click="childEdit(scope.row)"
                  >编辑</el-button
                >
                <el-button
                  round
                  icon="el-icon-delete"
                  type="warning"
                  size="mini"
                  @click="childDelete(scope.row)"
                  >删除</el-button
                >
              </template>
            </el-table-column>
          </el-table>
        </template>
      </el-table-column>
      <el-table-column prop="buildName" label="名称"></el-table-column>
      <el-table-column prop="sex" label="性别">
        <template slot-scope="scope">
          <el-tag
            v-if="scope.row.sex == '0'"
            type="danger"
            size="small"
            effect="dark"
            >男</el-tag
          >
          <el-tag
            v-if="scope.row.sex == '1'"
            type="blue"
            size="small"
            effect="dark"
            >女</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column prop="buildStorey" label="层数"></el-table-column>
      <el-table-column prop="orderNum" label="序号"></el-table-column>
      <el-table-column label="操作" align="center" width="200">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="mini"
            @click="buildEdit(scope.row)"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="mini"
            @click="buildDelete(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchModel.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchModel.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchModel.total"
      background
    >
    </el-pagination>

    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="buildName" label="栋数名称">
                <el-input
                  v-model="addModel.buildName"
                  placeholder="请输入栋数名称"
                ></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="buildStorey" label="层数">
                <el-input
                  type="number"
                  v-model="addModel.buildStorey"
                  placeholder="请输入层数"
                ></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="userId" label="管理员">
                <el-select
                  style="width: 100%"
                  v-model="addModel.userId"
                  placeholder="请选择管理员"
                >
                  <el-option
                    v-for="item in userList"
                    :key="item.userId"
                    :label="item.nickName"
                    :value="item.userId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="sex" label="性别">
                <el-radio-group v-model="addModel.sex">
                  <el-radio :label="'0'">男</el-radio>
                  <el-radio :label="'1'">女</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="序号">
                <el-input
                  type="number"
                  v-model="addModel.orderNum"
                  placeholder="请输入序号"
                ></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getUserListApi, addApi, listApi } from "@/api/build.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //表单验证规则
      rules: {
        userId: [
          {
            trigger: "blur",
            required: true,
            message: "请选择管理员",
          },
        ],
        buildStorey: [
          {
            trigger: "blur",
            required: true,
            message: "请填写层数",
          },
        ],
        sex: [
          {
            trigger: "blur",
            required: true,
            message: "请选择性别",
          },
        ],
        buildName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写栋数名称",
          },
        ],
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 200,
        width: 650,
        visible: false,
      },
      //表单绑定的对象
      addModel: {
        type: "",
        buildId: "",
        userId: "",
        buildStorey: "",
        sex: "",
        buildName: "",
        orderNum: "",
      },
      //查询列表的参数
      searchModel: {
        buildName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      userList: [],
      tableList: [],
    };
  },
  created() {
    this.getUserList();
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 230;
    });
  },
  methods: {
    expandChange(row, expandedRows){
      console.log(row)
      console.log(expandedRows)
    },
    //栋数删除
    buildDelete(row) {
      console.log(row);
    },
    //栋数编辑
    buildEdit(row) {
      console.log(row);
    },
    currentChange() {},
    sizeChange(val) {},
    //层数删除
    childDelete(row) {
      console.log(row);
    },
    //层数编辑
    childEdit(row) {
      console.log(row);
    },
    //查询表格数据
    async getList() {
      let res = await listApi(this.searchModel);
      if (res && res.code == 200) {
        this.tableList = res.data.records;
        console.log(this.tableList);
        this.searchModel.total = res.data.total;
      }
    },
    //管理员数据
    async getUserList() {
      let res = await getUserListApi();
      if (res && res.code) {
        this.userList = res.data;
      }
    },
    //弹框确定
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //新增按钮
    addBtn() {
      this.$resetForm("addForm", this.addModel);
      //弹框属性设置
      this.addDialog.title = "新增栋数";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    //重置按钮
    resetBtn() {},
    //搜索按钮
    searchBtn() {},
  },
};
</script>

<style lang="scss" scoped>
</style>
```











#### 第59讲 编辑、删除栋数接口对接

##### 1、api/build.js添加editApi()和deleteApi()

```js
import http from "@/utils/http";
//查询用户列表
export const getUserListApi = async()=>{
    return await http.get("/api/build/getUserList",null)
}
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/build",parm)
}
//列表
export const listApi = async(parm)=>{
    return await http.get("/api/build/list",parm)
}
//编辑
export const editApi = async(parm)=>{
    return await http.put("/api/build",parm)
}
//删除
export const deleteApi = async(parm)=>{
    return await http.delete("/api/build",parm)
}
```



##### 2、buildList.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchModel.buildName"
          placeholder="请输入楼栋名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table
      :header-cell-style="{ background: '#FAFAFA' }"
      :data="tableList"
      @expand-change="expandChange"
      :height="tableHeight"
      border
      stripe
    >
      <el-table-column width="100" type="expand">
        <!-- 子表格
        1；type="expand"
         -->
        <template slot-scope="scope">
          <el-table border :data="scope.row.storeys">
            <el-table-column
              label="层数"
              align="center"
              prop="storeyName"
            ></el-table-column>
            <el-table-column
              label="序号"
              align="center"
              prop="orderNum"
            ></el-table-column>
            <el-table-column label="操作" align="center" width="180">
              <template slot-scope="scope">
                <el-button
                  round
                  icon="el-icon-edit"
                  type="success"
                  size="mini"
                  @click="childEdit(scope.row)"
                  >编辑</el-button
                >
                <el-button
                  round
                  icon="el-icon-delete"
                  type="warning"
                  size="mini"
                  @click="childDelete(scope.row)"
                  >删除</el-button
                >
              </template>
            </el-table-column>
          </el-table>
        </template>
      </el-table-column>
      <el-table-column prop="buildName" label="名称"></el-table-column>
      <el-table-column prop="sex" label="性别">
        <template slot-scope="scope">
          <el-tag
            v-if="scope.row.sex == '0'"
            type="danger"
            size="small"
            effect="dark"
            >男</el-tag
          >
          <el-tag
            v-if="scope.row.sex == '1'"
            type="blue"
            size="small"
            effect="dark"
            >女</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column prop="buildStorey" label="层数"></el-table-column>
      <el-table-column prop="orderNum" label="序号"></el-table-column>
      <el-table-column label="操作" align="center" width="300">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="mini"
            @click="buildEdit(scope.row)"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="mini"
            @click="buildDelete(scope.row)"
            >删除</el-button
          >
          <el-button
            icon="el-icon-plus"
            type="success"
            size="mini"
            @click="storeyAdd(scope.row)"
            >新增层数</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchModel.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchModel.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchModel.total"
      background
    >
    </el-pagination>

    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="buildName" label="栋数名称">
                <el-input
                  v-model="addModel.buildName"
                  placeholder="请输入栋数名称"
                ></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="buildStorey" label="层数">
                <el-input
                  :disabled="disabled"
                  type="number"
                  v-model="addModel.buildStorey"
                  placeholder="请输入层数"
                ></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="userId" label="管理员">
                <el-select
                  style="width: 100%"
                  v-model="addModel.userId"
                  placeholder="请选择管理员"
                >
                  <el-option
                    v-for="item in userList"
                    :key="item.userId"
                    :label="item.nickName"
                    :value="item.userId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="sex" label="性别">
                <el-radio-group v-model="addModel.sex">
                  <el-radio :label="'0'">男</el-radio>
                  <el-radio :label="'1'">女</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="序号">
                <el-input
                  type="number"
                  v-model="addModel.orderNum"
                  placeholder="请输入序号"
                ></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import {
  getUserListApi,
  addApi,
  listApi,
  editApi,
  deleteApi,
} from "@/api/build.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      disabled: false,
      tableHeight: 0,
      //表单验证规则
      rules: {
        userId: [
          {
            trigger: "blur",
            required: true,
            message: "请选择管理员",
          },
        ],
        buildStorey: [
          {
            trigger: "blur",
            required: true,
            message: "请填写层数",
          },
        ],
        sex: [
          {
            trigger: "blur",
            required: true,
            message: "请选择性别",
          },
        ],
        buildName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写栋数名称",
          },
        ],
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 200,
        width: 650,
        visible: false,
      },
      //表单绑定的对象
      addModel: {
        type: "",
        buildId: "",
        userId: "",
        buildStorey: "",
        sex: "",
        buildName: "",
        orderNum: "",
      },
      //查询列表的参数
      searchModel: {
        buildName: "",
        total: 0,
        currentPage: 1,
        pageSize: 10,
      },
      userList: [],
      tableList: [],
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 230;
    });
  },
  created() {
    this.getUserList();
    this.getList();
  },
  methods: {
    //层删除按钮
    childDelete(row) {},
    //层编辑按钮
    childEdit(row) {},
    //删除按钮
    async buildDelete(row) {
      //信息确定
      const confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteApi({
          buildId: row.buildId,
        });
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          //刷新列表
          this.getList();
        }
      }
    },
    //编辑按钮
    buildEdit(row) {
      console.log(row);
      this.$resetForm("addForm", this.addModel);
      //数据回显
      this.$objCoppy(row, this.addModel);
      this.disabled = true;
      //弹框属性设置
      this.addDialog.title = "编辑栋数";
      this.addDialog.visible = true;
      this.addModel.type = "1";
    },
    //页数改变时触发
    currentChange(val) {},
    //页容量改变时触发
    sizeChange(val) {},
    //新增层数事件
    storeyAdd(row) {},
    expandChange(row, expandedRows) {
      console.log(row);
      console.log(expandedRows);
    },
    //列表查询
    async getList() {
      let res = await listApi(this.searchModel);
      if (res && res.code == 200) {
        //设置表格数据
        this.tableList = res.data.records;
        this.searchModel.total = res.data.total;
      }
    },
    //管理员数据
    async getUserList() {
      let res = await getUserListApi();
      if (res && res.code) {
        this.userList = res.data;
      }
    },
    //弹框确定
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.getList();
            this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //新增按钮
    addBtn() {
      this.$resetForm("addForm", this.addModel);
      //弹框属性设置
      this.disabled = false;
      this.addDialog.title = "新增栋数";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    //重置按钮
    resetBtn() {
      this.searchModel.buildName = "";
      this.searchModel.currentPage = 1;
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```











#### 第60讲 新增层数页面制作与对接

##### 1、DromStoreyService添加如下方法

```js
package com.itmk.web.drom_storey.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.drom_storey.entity.DromStorey;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface DromStoreyService extends IService<DromStorey> {
    //新增
    void addDrom(List<DromStorey> list);
    void add(DromStorey dromStorey);
    void eidt(DromStorey dromStorey);
    void delete(Long buildId,Long storeyId);
}

```

实现类

```js
package com.itmk.web.drom_storey.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.drom_build.entity.DromBuild;
import com.itmk.web.drom_build.service.DromBuildService;
import com.itmk.web.drom_storey.entity.DromStorey;
import com.itmk.web.drom_storey.mapper.DromStoreyMapper;
import com.itmk.web.drom_storey.service.DromStoreyService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class DromStoreyServiceImpl extends ServiceImpl<DromStoreyMapper, DromStorey> implements DromStoreyService {
    @Autowired
    private DromBuildService dromBuildService;
    @Override
    public void addDrom(List<DromStorey> list) {
        this.baseMapper.addDrom(list);
    }

    @Override
    @Transactional
    public void add(DromStorey dromStorey) {
        int insert = this.baseMapper.insert(dromStorey);
        if(insert >0){
            DromBuild build = dromBuildService.getById(dromStorey.getBuildId());
            DromBuild newBuild = new DromBuild();
            newBuild.setBuildId(build.getBuildId());
            newBuild.setBuildStorey(build.getBuildStorey() + 1L);
            dromBuildService.updateById(newBuild);
        }
    }

    @Override
    @Transactional
    public void eidt(DromStorey dromStorey) {
        this.baseMapper.updateById(dromStorey);
//        if(insert >0){
//            DromBuild build = dromBuildService.getById(dromStorey.getBuildId());
//            DromBuild newBuild = new DromBuild();
//            newBuild.setBuildId(build.getBuildId());
//            newBuild.setBuildStorey(build.getBuildStorey() - 1L);
//            dromBuildService.updateById(newBuild);
//        }
    }

    @Override
    @Transactional
    public void delete(Long buildId, Long storeyId) {
        int insert = this.baseMapper.deleteById(storeyId);
        if(insert >0){
            DromBuild build = dromBuildService.getById(buildId);
            DromBuild newBuild = new DromBuild();
            newBuild.setBuildId(build.getBuildId());
            newBuild.setBuildStorey(build.getBuildStorey() - 1L);
            dromBuildService.updateById(newBuild);
        }
    }
}

```

##### 2、新建DromStoreyController

```js
package com.itmk.web.drom_storey.controller;

import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.drom_build.service.DromBuildService;
import com.itmk.web.drom_storey.entity.DromStorey;
import com.itmk.web.drom_storey.service.DromStoreyService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/storey")
public class DromStoreyController {
    @Autowired
    private DromStoreyService dromStoreyService;

    //新增
    @PostMapping
    public ResultVo add(@RequestBody DromStorey dromStorey){
        dromStoreyService.add(dromStorey);
        return ResultUtils.success("新增成功");
    }

    //新增
    @PutMapping
    public ResultVo edit(@RequestBody DromStorey dromStorey){
        dromStoreyService.eidt(dromStorey);
        return ResultUtils.success("编辑成功");
    }

    //删除
    @DeleteMapping("/{buildId}/{storeyId}")
    public ResultVo delete(@PathVariable("buildId") Long buildId,@PathVariable("storeyId") Long storeyId){
        //判断层下面，是否有宿舍，如果有宿舍，不能删除
       dromStoreyService.delete(buildId,storeyId);
       return ResultUtils.success("删除成功");
    }


}

```





##### 3、api/build.js添加addStroyApi()方法

```js
import http from "@/utils/http";
//查询用户列表
export const getUserListApi = async()=>{
    return await http.get("/api/build/getUserList",null)
}
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/build",parm)
}
//列表
export const listApi = async(parm)=>{
    return await http.get("/api/build/list",parm)
}
//编辑
export const editApi = async(parm)=>{
    return await http.put("/api/build",parm)
}
//删除
export const deleteApi = async(parm)=>{
    return await http.delete("/api/build",parm)
}
//新增层数
export const addStroyApi = async(parm)=>{
    return await http.post("/api/storey",parm)
}
```



##### 4、buildList.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchModel.buildName"
          placeholder="请输入楼栋名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table
      :header-cell-style="{ background: '#FAFAFA' }"
      :data="tableList"
      @expand-change="expandChange"
      :height="tableHeight"
      border
      stripe
    >
      <el-table-column width="100" type="expand">
        <!-- 子表格
        1；type="expand"
         -->
        <template slot-scope="scope">
          <el-table border :data="scope.row.storeys">
            <el-table-column
              label="层数"
              align="center"
              prop="storeyName"
            ></el-table-column>
            <el-table-column
              label="序号"
              align="center"
              prop="orderNum"
            ></el-table-column>
            <el-table-column label="操作" align="center" width="180">
              <template slot-scope="scope">
                <el-button
                  round
                  icon="el-icon-edit"
                  type="success"
                  size="mini"
                  @click="childEdit(scope.row)"
                  >编辑</el-button
                >
                <el-button
                  round
                  icon="el-icon-delete"
                  type="warning"
                  size="mini"
                  @click="childDelete(scope.row)"
                  >删除</el-button
                >
              </template>
            </el-table-column>
          </el-table>
        </template>
      </el-table-column>
      <el-table-column prop="buildName" label="名称"></el-table-column>
      <el-table-column prop="sex" label="性别">
        <template slot-scope="scope">
          <el-tag
            v-if="scope.row.sex == '0'"
            type="danger"
            size="small"
            effect="dark"
            >男</el-tag
          >
          <el-tag
            v-if="scope.row.sex == '1'"
            type="blue"
            size="small"
            effect="dark"
            >女</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column prop="buildStorey" label="层数"></el-table-column>
      <el-table-column prop="orderNum" label="序号"></el-table-column>
      <el-table-column label="操作" align="center" width="300">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="mini"
            @click="buildEdit(scope.row)"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="mini"
            @click="buildDelete(scope.row)"
            >删除</el-button
          >
          <el-button
            icon="el-icon-plus"
            type="success"
            size="mini"
            @click="storeyAdd(scope.row)"
            >新增层数</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchModel.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchModel.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchModel.total"
      background
    >
    </el-pagination>

    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="buildName" label="栋数名称">
                <el-input
                  v-model="addModel.buildName"
                  placeholder="请输入栋数名称"
                ></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="buildStorey" label="层数">
                <el-input
                  :disabled="disabled"
                  type="number"
                  v-model="addModel.buildStorey"
                  placeholder="请输入层数"
                ></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="userId" label="管理员">
                <el-select
                  style="width: 100%"
                  v-model="addModel.userId"
                  placeholder="请选择管理员"
                >
                  <el-option
                    v-for="item in userList"
                    :key="item.userId"
                    :label="item.nickName"
                    :value="item.userId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="sex" label="性别">
                <el-radio-group v-model="addModel.sex">
                  <el-radio :label="'0'">男</el-radio>
                  <el-radio :label="'1'">女</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="序号">
                <el-input
                  type="number"
                  v-model="addModel.orderNum"
                  placeholder="请输入序号"
                ></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
    <!-- 新增层数弹框 -->
    <sys-dialog
      :title="dstireyDialog.title"
      :height="dstireyDialog.height"
      :width="dstireyDialog.width"
      :visible="dstireyDialog.visible"
      @onClose="destoryClose"
      @onConfirm="destoryConfirm"
    >
      <div slot="content">
        <el-form
          :model="destoryModel"
          ref="destoryForm"
          :rules="destoryRules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="storeyName" label="层数名称">
            <el-input v-model="destoryModel.storeyName"></el-input>
          </el-form-item>
          <el-form-item prop="orderNum" label="序号">
            <el-input v-model="destoryModel.orderNum"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import {
  getUserListApi,
  addApi,
  listApi,
  editApi,
  deleteApi,
  addStroyApi,
} from "@/api/build.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      destoryRules: {
        storeyName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写层数名称",
          },
        ],
        orderNum: [
          {
            trigger: "blur",
            required: true,
            message: "请填写序号",
          },
        ],
      },
      destoryModel: {
        storeyId: "",
        type: "",
        buildId: "",
        storeyName: "",
        orderNum: "",
      },
      //层数弹框属性
      dstireyDialog: {
        title: "",
        height: 150,
        width: 650,
        visible: false,
      },
      disabled: false,
      tableHeight: 0,
      //表单验证规则
      rules: {
        userId: [
          {
            trigger: "blur",
            required: true,
            message: "请选择管理员",
          },
        ],
        buildStorey: [
          {
            trigger: "blur",
            required: true,
            message: "请填写层数",
          },
        ],
        sex: [
          {
            trigger: "blur",
            required: true,
            message: "请选择性别",
          },
        ],
        buildName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写栋数名称",
          },
        ],
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 200,
        width: 650,
        visible: false,
      },
      //表单绑定的对象
      addModel: {
        type: "",
        buildId: "",
        userId: "",
        buildStorey: "",
        sex: "",
        buildName: "",
        orderNum: "",
      },
      //查询列表的参数
      searchModel: {
        buildName: "",
        total: 0,
        currentPage: 1,
        pageSize: 10,
      },
      userList: [],
      tableList: [],
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 230;
    });
  },
  created() {
    this.getUserList();
    this.getList();
  },
  methods: {
    //新增层数弹框确定
    destoryConfirm() {
      this.$refs.destoryForm.validate(async(valid) => {
        if (valid) {
          console.log(this.destoryModel);
          let res = null;
          if (this.destoryModel.type == "0") {
            res = await addStroyApi(this.destoryModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.getList();
            this.dstireyDialog.visible = false;
          }
        }
      });
    },
    //新增层数关闭
    destoryClose() {
      this.dstireyDialog.visible = false;
    },
    //层删除按钮
    childDelete(row) {},
    //层编辑按钮
    childEdit(row) {},
    //删除按钮
    async buildDelete(row) {
      //信息确定
      const confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteApi({
          buildId: row.buildId,
        });
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          //刷新列表
          this.getList();
        }
      }
    },
    //编辑按钮
    buildEdit(row) {
      console.log(row);
      this.$resetForm("addForm", this.addModel);
      //数据回显
      this.$objCoppy(row, this.addModel);
      this.disabled = true;
      //弹框属性设置
      this.addDialog.title = "编辑栋数";
      this.addDialog.visible = true;
      this.addModel.type = "1";
    },
    //页数改变时触发
    currentChange(val) {},
    //页容量改变时触发
    sizeChange(val) {},
    //新增层数事件
    storeyAdd(row) {
      //清空表单
      this.$resetForm("destoryForm", this.destoryModel);
      this.destoryModel.type = "0";
      this.dstireyDialog.title = "新增层数";
      this.dstireyDialog.visible = true;
      this.destoryModel.buildId = row.buildId;
    },
    expandChange(row, expandedRows) {
      console.log(row);
      console.log(expandedRows);
    },
    //列表查询
    async getList() {
      let res = await listApi(this.searchModel);
      if (res && res.code == 200) {
        //设置表格数据
        this.tableList = res.data.records;
        this.searchModel.total = res.data.total;
      }
    },
    //管理员数据
    async getUserList() {
      let res = await getUserListApi();
      if (res && res.code) {
        this.userList = res.data;
      }
    },
    //弹框确定
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.getList();
            this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //新增按钮
    addBtn() {
      this.$resetForm("addForm", this.addModel);
      //弹框属性设置
      this.disabled = false;
      this.addDialog.title = "新增栋数";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    //重置按钮
    resetBtn() {
      this.searchModel.buildName = "";
      this.searchModel.currentPage = 1;
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第61讲 编辑、删除层数对接

##### 1、build.js添加editStoryApi()和deleteStoryApi()方法

```js
import http from "@/utils/http";
//查询用户列表
export const getUserListApi = async()=>{
    return await http.get("/api/build/getUserList",null)
}
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/build",parm)
}
//列表
export const listApi = async(parm)=>{
    return await http.get("/api/build/list",parm)
}
//编辑
export const editApi = async(parm)=>{
    return await http.put("/api/build",parm)
}
//删除
export const deleteApi = async(parm)=>{
    return await http.delete("/api/build",parm)
}
//新增层数
export const addStroyApi = async(parm)=>{
    return await http.post("/api/storey",parm)
}
//编辑层数
export const editStoryApi = async(parm)=>{
    return await http.put("/api/storey",parm)
}
//删除层数
export const deleteStoryApi = async(parm)=>{
    return await http.delete("/api/storey",parm)
}
//编号查询楼栋
export const getBuildListApi = async()=>{
    return await http.get("/api/build/getBuildList",null)
}
//根据楼栋编号查询层数
export const getDestoryListApi = async(parm)=>{
    return await http.get("/api/storey/getDestoryList",parm)
}
```

##### 2、buildList.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchModel.buildName"
          placeholder="请输入楼栋名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button icon="el-icon-plus" type="primary" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table
      :header-cell-style="{ background: '#FAFAFA' }"
      :data="tableList"
      @expand-change="expandChange"
      :height="tableHeight"
      border
      stripe
    >
      <el-table-column width="100" type="expand">
        <!-- 子表格
        1；type="expand"
         -->
        <template slot-scope="scope">
          <el-table border :data="scope.row.storeys">
            <el-table-column
              label="层数"
              align="center"
              prop="storeyName"
            ></el-table-column>
            <el-table-column
              label="序号"
              align="center"
              prop="orderNum"
            ></el-table-column>
            <el-table-column label="操作" align="center" width="180">
              <template slot-scope="scope">
                <el-button
                  round
                  icon="el-icon-edit"
                  type="success"
                  size="mini"
                  @click="childEdit(scope.row)"
                  >编辑</el-button
                >
                <el-button
                  round
                  icon="el-icon-delete"
                  type="warning"
                  size="mini"
                  @click="childDelete(scope.row)"
                  >删除</el-button
                >
              </template>
            </el-table-column>
          </el-table>
        </template>
      </el-table-column>
      <el-table-column prop="buildName" label="名称"></el-table-column>
      <el-table-column prop="sex" label="性别">
        <template slot-scope="scope">
          <el-tag
            v-if="scope.row.sex == '0'"
            type="danger"
            size="small"
            effect="dark"
            >男</el-tag
          >
          <el-tag
            v-if="scope.row.sex == '1'"
            type="blue"
            size="small"
            effect="dark"
            >女</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column prop="buildStorey" label="层数"></el-table-column>
      <el-table-column prop="orderNum" label="序号"></el-table-column>
      <el-table-column label="操作" align="center" width="300">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="mini"
            @click="buildEdit(scope.row)"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="mini"
            @click="buildDelete(scope.row)"
            >删除</el-button
          >
          <el-button
            icon="el-icon-plus"
            type="success"
            size="mini"
            @click="storeyAdd(scope.row)"
            >新增层数</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchModel.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchModel.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchModel.total"
      background
    >
    </el-pagination>

    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="buildName" label="栋数名称">
                <el-input
                  v-model="addModel.buildName"
                  placeholder="请输入栋数名称"
                ></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="buildStorey" label="层数">
                <el-input
                  :disabled="disabled"
                  type="number"
                  v-model="addModel.buildStorey"
                  placeholder="请输入层数"
                ></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="userId" label="管理员">
                <el-select
                  style="width: 100%"
                  v-model="addModel.userId"
                  placeholder="请选择管理员"
                >
                  <el-option
                    v-for="item in userList"
                    :key="item.userId"
                    :label="item.nickName"
                    :value="item.userId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="sex" label="性别">
                <el-radio-group v-model="addModel.sex">
                  <el-radio :label="'0'">男</el-radio>
                  <el-radio :label="'1'">女</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="序号">
                <el-input
                  type="number"
                  v-model="addModel.orderNum"
                  placeholder="请输入序号"
                ></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
    <!-- 新增层数弹框 -->
    <sys-dialog
      :title="dstireyDialog.title"
      :height="dstireyDialog.height"
      :width="dstireyDialog.width"
      :visible="dstireyDialog.visible"
      @onClose="destoryClose"
      @onConfirm="destoryConfirm"
    >
      <div slot="content">
        <el-form
          :model="destoryModel"
          ref="destoryForm"
          :rules="destoryRules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="storeyName" label="层数名称">
            <el-input v-model="destoryModel.storeyName"></el-input>
          </el-form-item>
          <el-form-item prop="orderNum" label="序号">
            <el-input v-model="destoryModel.orderNum"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import {
  getUserListApi,
  addApi,
  listApi,
  editApi,
  deleteApi,
  addStroyApi,
  editStoryApi,
  deleteStoryApi
} from "@/api/build.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      destoryRules: {
        storeyName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写层数名称",
          },
        ],
        orderNum: [
          {
            trigger: "blur",
            required: true,
            message: "请填写序号",
          },
        ],
      },
      destoryModel: {
        storeyId: "",
        type: "",
        buildId: "",
        storeyName: "",
        orderNum: "",
      },
      //层数弹框属性
      dstireyDialog: {
        title: "",
        height: 150,
        width: 650,
        visible: false,
      },
      disabled: false,
      tableHeight: 0,
      //表单验证规则
      rules: {
        userId: [
          {
            trigger: "blur",
            required: true,
            message: "请选择管理员",
          },
        ],
        buildStorey: [
          {
            trigger: "blur",
            required: true,
            message: "请填写层数",
          },
        ],
        sex: [
          {
            trigger: "blur",
            required: true,
            message: "请选择性别",
          },
        ],
        buildName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写栋数名称",
          },
        ],
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 200,
        width: 650,
        visible: false,
      },
      //表单绑定的对象
      addModel: {
        type: "",
        buildId: "",
        userId: "",
        buildStorey: "",
        sex: "",
        buildName: "",
        orderNum: "",
      },
      //查询列表的参数
      searchModel: {
        buildName: "",
        total: 0,
        currentPage: 1,
        pageSize: 10,
      },
      userList: [],
      tableList: [],
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 230;
    });
  },
  created() {
    this.getUserList();
    this.getList();
  },
  methods: {
    //新增层数弹框确定
    destoryConfirm() {
      this.$refs.destoryForm.validate(async(valid) => {
        console.log(this.destoryModel)
        if (valid) {
          console.log(this.destoryModel);
          let res = null;
          if (this.destoryModel.type == "0") {
            res = await addStroyApi(this.destoryModel);
          }else{
            res = await editStoryApi(this.destoryModel)
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.getList();
            this.dstireyDialog.visible = false;
          }
        }
      });
    },
    //新增层数关闭
    destoryClose() {
      this.dstireyDialog.visible = false;
    },
    //层删除按钮
    async childDelete(row) {
      console.log(row)
      const confirm = await this.$myconfirm('确定删除该数据吗?')
      if(confirm){
        let res = await deleteStoryApi({
          buildId:row.buildId,
          storeyId:row.storeyId
        })
        if(res && res.code == 200){
          this.$message.success(res.msg)
          this.getList()
        }
      }
    },
    //层编辑按钮
    childEdit(row) {
       //清空表单
      this.$resetForm("destoryForm", this.destoryModel);
      //设置编辑回显的数据
      this.$objCoppy(row,this.destoryModel)
      this.destoryModel.type = "1";
      this.dstireyDialog.title = "编辑层数";
      this.dstireyDialog.visible = true;
      this.destoryModel.buildId = row.buildId;
    },
    //删除按钮
    async buildDelete(row) {
      //信息确定
      const confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteApi({
          buildId: row.buildId,
        });
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          //刷新列表
          this.getList();
        }
      }
    },
    //编辑按钮
    buildEdit(row) {
      console.log(row);
      this.$resetForm("addForm", this.addModel);
      //数据回显
      this.$objCoppy(row, this.addModel);
      this.disabled = true;
      //弹框属性设置
      this.addDialog.title = "编辑栋数";
      this.addDialog.visible = true;
      this.addModel.type = "1";
    },
    //页数改变时触发
    currentChange(val) {},
    //页容量改变时触发
    sizeChange(val) {},
    //新增层数事件
    storeyAdd(row) {
      //清空表单
      this.$resetForm("destoryForm", this.destoryModel);
      this.destoryModel.type = "0";
      this.dstireyDialog.title = "新增层数";
      this.dstireyDialog.visible = true;
      this.destoryModel.buildId = row.buildId;
    },
    expandChange(row, expandedRows) {
      console.log(row);
      console.log(expandedRows);
    },
    //列表查询
    async getList() {
      let res = await listApi(this.searchModel);
      if (res && res.code == 200) {
        //设置表格数据
        this.tableList = res.data.records;
        this.searchModel.total = res.data.total;
      }
    },
    //管理员数据
    async getUserList() {
      let res = await getUserListApi();
      if (res && res.code) {
        this.userList = res.data;
      }
    },
    //弹框确定
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.getList();
            this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //新增按钮
    addBtn() {
      this.$resetForm("addForm", this.addModel);
      //弹框属性设置
      this.disabled = false;
      this.addDialog.title = "新增栋数";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    //重置按钮
    resetBtn() {
      this.searchModel.buildName = "";
      this.searchModel.currentPage = 1;
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```







#### 第62讲 设置编号页面布局

##### 1、DromBuildController添加getBuildList()方法

```js
package com.itmk.web.drom_build.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.drom_build.entity.BuildParm;
import com.itmk.web.drom_build.entity.DromBuild;
import com.itmk.web.drom_build.service.DromBuildService;
import com.itmk.web.drom_storey.entity.DromStorey;
import com.itmk.web.drom_storey.service.DromStoreyService;
import com.itmk.web.sys_user.entity.SysUser;
import com.itmk.web.sys_user.service.SysUserService;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/build")
public class DromBuildController {
    @Autowired
    private DromBuildService dromBuildService;
    @Autowired
    private DromStoreyService dromStoreyService;
    @Autowired
    private SysUserService sysUserService;

    //新增
    @PostMapping
    public ResultVo add(@RequestBody DromBuild dromBuild){
        if(dromBuild.getBuildStorey() > 12){
            return ResultUtils.error("层数不能大于12层!");
        }
        dromBuildService.addBuild(dromBuild);
        return ResultUtils.success("新增成功!");
    }

     //新增
    @PutMapping
    public ResultVo edit(@RequestBody DromBuild dromBuild){
        boolean b = dromBuildService.updateById(dromBuild);
        if(b){
             return ResultUtils.success("编辑成功!");
        }
        return ResultUtils.error("编辑失败!");
    }

    @DeleteMapping("/{buildId}")
    public ResultVo delete(@PathVariable("buildId") Long buildId){
        //判断楼栋下面是否有层数
        QueryWrapper<DromStorey> query = new QueryWrapper<>();
        query.lambda().eq(DromStorey::getBuildId,buildId);
        List<DromStorey> list = dromStoreyService.list(query);
        if(list.size() >0){
             return ResultUtils.error("该楼栋存在层数,删除失败!");
        }
        boolean b = dromBuildService.removeById(buildId);
        if(b){
             return ResultUtils.success("删除成功!");
        }
        return ResultUtils.error("删除失败!");
    }

    //查询管理员
    @GetMapping("/getUserList")
    public ResultVo getUserList(){
        List<SysUser> list = sysUserService.list(new QueryWrapper<SysUser>().select("user_id", "nick_name"));
        return ResultUtils.success("查询成功",list);
    }

    //查询列表
    @GetMapping("/list")
    public ResultVo getBuildList(BuildParm parm){
        //构造分页对象
        IPage<DromBuild> page = new Page<>(parm.getCurrentPage(),parm.getPageSize());
        //构造查询条件
        QueryWrapper<DromBuild> query = new QueryWrapper<>();
        if(StringUtils.isNotEmpty(parm.getBuildName())){
            query.lambda().like(DromBuild::getBuildName,parm.getBuildName());
        }
        query.lambda().orderByAsc(DromBuild::getOrderNum);
        IPage<DromBuild> list = dromBuildService.page(page, query);
        if(list.getRecords().size() >0){
            for (int i =0;i<list.getRecords().size();i++){
                Long buildId = list.getRecords().get(i).getBuildId();
                QueryWrapper<DromStorey> queryWrapper = new QueryWrapper<>();
                queryWrapper.lambda().eq(DromStorey::getBuildId,buildId).orderByAsc(DromStorey::getOrderNum);
                List<DromStorey> list1 = dromStoreyService.list(queryWrapper);
                list.getRecords().get(i).setStoreys(list1);
            }
        }
        return ResultUtils.success("查询成功",list);
    }

    //查询楼栋
    @GetMapping("/getBuildList")
    public ResultVo getBuildList(){
        List<DromBuild> list = dromBuildService.list();
        return ResultUtils.success("查询成功",list);
    }
}

```



##### 2、DromStoreyController控制器添加getDestoryList()方法

```js
package com.itmk.web.drom_storey.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.drom_build.service.DromBuildService;
import com.itmk.web.drom_storey.entity.DromStorey;
import com.itmk.web.drom_storey.service.DromStoreyService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/storey")
public class DromStoreyController {
    @Autowired
    private DromStoreyService dromStoreyService;

    //新增
    @PostMapping
    public ResultVo add(@RequestBody DromStorey dromStorey){
        dromStoreyService.add(dromStorey);
        return ResultUtils.success("新增成功");
    }

    //新增
    @PutMapping
    public ResultVo edit(@RequestBody DromStorey dromStorey){
        dromStoreyService.eidt(dromStorey);
        return ResultUtils.success("编辑成功");
    }

    //删除
    @DeleteMapping("/{buildId}/{storeyId}")
    public ResultVo delete(@PathVariable("buildId") Long buildId,@PathVariable("storeyId") Long storeyId){
        //判断层下面，是否有宿舍，如果有宿舍，不能删除
       dromStoreyService.delete(buildId,storeyId);
       return ResultUtils.success("删除成功");
    }

    //根据楼栋查询层数列表
    @GetMapping("/getDestoryList")
    public ResultVo getDestoryList(Long buildId){
        QueryWrapper<DromStorey> query = new QueryWrapper<>();
        query.lambda().eq(DromStorey::getBuildId,buildId);
        List<DromStorey> list = dromStoreyService.list(query);
        return ResultUtils.success("查询成功",list);
    }


}

```

##### 3、build.js添加getBuildListApi()方法和getDestoryListApi()方法

```js
import http from "@/utils/http";
//查询用户列表
export const getUserListApi = async()=>{
    return await http.get("/api/build/getUserList",null)
}
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/build",parm)
}
//列表
export const listApi = async(parm)=>{
    return await http.get("/api/build/list",parm)
}
//编辑
export const editApi = async(parm)=>{
    return await http.put("/api/build",parm)
}
//删除
export const deleteApi = async(parm)=>{
    return await http.delete("/api/build",parm)
}
//新增层数
export const addStroyApi = async(parm)=>{
    return await http.post("/api/storey",parm)
}
//编辑层数
export const editStoryApi = async(parm)=>{
    return await http.put("/api/storey",parm)
}
//删除层数
export const deleteStoryApi = async(parm)=>{
    return await http.delete("/api/storey",parm)
}
//编号查询楼栋
export const getBuildListApi = async()=>{
    return await http.get("/api/build/getBuildList",null)
}
//根据楼栋编号查询层数
export const getDestoryListApi = async(parm)=>{
    return await http.get("/api/storey/getDestoryList",parm)
}
```

##### 4、buildCode.vue页面

```js
<template>
  <el-main class="build-main">
    <!-- 楼栋 -->
    <el-divider content-position="left">楼栋</el-divider>
    <div class="build-list">
      <div
        class="build-item"
        v-for="(item, index) in buildList"
        :key="index"
        :class="{ isActive: isChange === index }"
        :id="'build' + index"
        @click="btnClick(item.buildId, index)"
      >
        {{ item.buildName }}
      </div>
    </div>
    <el-divider content-position="left">楼层</el-divider>
    <el-container class="containers">
      <el-aside
        :style="{ height: leftHeight + 'px' }"
        class="leftAsside"
        width="150px"
      >
        <div
          class="storey-item"
          v-for="(item, index) in destoryList"
          :class="{ destoryActive: isDestory === index }"
          :key="index"
          :id="'destory' + index"
          @click="destoryClick(item.storeyId, index)"
        >
          {{ item.storeyName }}
        </div>
      </el-aside>
      <el-main :style="{ height: rightHeight + 'px' }">Main</el-main>
    </el-container>
  </el-main>
</template>

<script>
import { getBuildListApi, getDestoryListApi } from "@/api/build.js";
export default {
  data() {
    return {
      isDestory: 0,
      isChange: 0,
      leftHeight: 0,
      rightHeight: 0,
      buildList: [],
      destoryList: [],
    };
  },
  created() {
    this.getBuildList();
  },
  mounted() {
    this.$nextTick(() => {
      this.leftHeight = window.innerHeight - 300;
      this.rightHeight = window.innerHeight - 300;
    });
  },
  methods: {
    //楼层点击事件
    destoryClick(storeyId, index) {
      this.isDestory = index;
    },
    //楼栋点击事件
    btnClick(buildId, index) {
      this.isChange = index;
      this.isDestory = 0;
      console.log(buildId);
      this.getDestoryList(buildId);
    },
    //根据楼栋id查询层数列表
    async getDestoryList(buildId) {
      let res = await getDestoryListApi({
        buildId: buildId,
      });
      if (res && res.code == 200) {
        this.destoryList = res.data;
      }
    },
    async getBuildList() {
      let res = await getBuildListApi();
      if (res && res.code == 200) {
        this.buildList = res.data;
        this.$nextTick(() => {
          //   document.querySelector("#build0").focus();
          document.querySelector("#build0").click();
        });
      }
    },
  },
};
</script>

<style lang="scss" scoped>
.build-main {
  padding-top: 10px;
}
.build-list {
  display: flex;
  flex-wrap: wrap;
}
.build-item {
  padding: 8px 30px;
  margin: 10px 10px;
  font-size: 14px;
  border: 1px solid #dedede;
  border-radius: 4px;
  cursor: pointer;
  background-color: #f8f8f8;
}
.isActive {
  background: #42b983 !important;
  border-color: #42b983 !important;
  color: #fff;
}
.leftAsside {
  border-right: 1px solid #dcdfe6;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.storey-item {
  padding: 8px 30px;
  margin: 10px 10px;
  font-size: 14px;
  border: 1px solid #dedede;
  border-radius: 4px;
  cursor: pointer;
  background-color: #f8f8f8;
}
.destoryActive {
  background: #5FB878 !important;
  border-color: #5FB878 !important;
  color: #fff;
}
.containers {
  margin-top: 20px;
  border: 1px solid #dcdfe6;
}
</style>
```





#### 第63讲 设置编号模块接口开发

##### 1、新建实体类

```js
package com.itmk.web.dorm_room.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
@TableName("dorm_room")
public class DormRoom {
    @TableId(type = IdType.AUTO)
    private Long roomId;
    private Long storeyId;
    private String rootType;
    private String roomCode;
    private Integer totalBed;
}

```

```js
package com.itmk.web.dorm_room.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class RoomParm {
    private String area;
    private Integer start;
    private Integer end;
    private Integer stuNum;
    private Long storeyId;
     private String rootType;
}

```

##### 2、新建mapper层

```js
package com.itmk.web.dorm_room.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.dorm_room.entity.DormRoom;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface DormRoomMapper extends BaseMapper<DormRoom> {
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.dorm_room.mapper.DormRoomMapper">

</mapper>
```

##### 3、新建service层

```js
package com.itmk.web.dorm_room.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.dorm_room.entity.DormRoom;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface DormRoomService extends IService<DormRoom> {

}

```

实现类

```js
package com.itmk.web.dorm_room.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.dorm_room.entity.DormRoom;
import com.itmk.web.dorm_room.mapper.DormRoomMapper;
import com.itmk.web.dorm_room.service.DormRoomService;
import org.springframework.stereotype.Service;


/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class DormRoomServiceImpl extends ServiceImpl<DormRoomMapper, DormRoom> implements DormRoomService {

}

```

##### 4、新建控制器层

```js
package com.itmk.web.dorm_room.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.dorm_room.entity.DormRoom;
import com.itmk.web.dorm_room.entity.RoomListParm;
import com.itmk.web.dorm_room.entity.RoomParm;
import com.itmk.web.dorm_room.service.DormRoomService;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.ArrayList;
import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/dormRoom")
public class DormRoomController {
    @Autowired
    private DormRoomService dormRoomService;

    //新增
    @PostMapping
    public ResultVo add(@RequestBody RoomParm parm) {
        //起始编号
        int start = parm.getStart();
        List<DormRoom> list = new ArrayList<>();
        while (start <= parm.getEnd()) {
            //房间实体类创建
            DormRoom room = new DormRoom();
            room.setTotalBed(parm.getStuNum());
            room.setRootType(parm.getRootType());
            room.setStoreyId(parm.getStoreyId());
            //构造编号 A100
            if (StringUtils.isNotEmpty(parm.getArea())) {
                room.setRoomCode(parm.getArea() + start);
            } else { // 100
                room.setRoomCode(Integer.toString(start));
            }
            //判断是否重复
            QueryWrapper<DormRoom> query = new QueryWrapper<>();
            query.lambda().eq(DormRoom::getRoomCode, room.getRoomCode());
            DormRoom one = dormRoomService.getOne(query);
            if (one == null) { //没有重复的才放入
                list.add(room);
            }
            //此条件不能少，死循环
            start = start + 1;
        }
        //保存房间
        if(list.size() > 0){
             dormRoomService.saveBatch(list);
        }
        return ResultUtils.success("设置成功");
    }

    //编辑
    @PutMapping
    public ResultVo edit(@RequestBody DormRoom room) {
        //判断编号是否重复
        QueryWrapper<DormRoom> query = new QueryWrapper<>();
        query.lambda().eq(DormRoom::getRoomCode, room.getRoomCode());
        DormRoom one = dormRoomService.getOne(query);
        if (one != null) {
            return ResultUtils.error("编号重复");
        }
        boolean b = dormRoomService.updateById(room);
        if (b) {
            return ResultUtils.success("编辑成功");
        }
        return ResultUtils.error("编辑失败");
    }

    //删除
    @DeleteMapping("/{roomId}")
    public ResultVo delete(@PathVariable("roomId") Long roomId){
        //判断房间下面是否住着人
        //如果没有人，才能删除
        boolean b = dormRoomService.removeById(roomId);
        if (b) {
            return ResultUtils.success("删除成功");
        }
        return ResultUtils.error("删除失败");
    }

    //列表查询
   @GetMapping("/list")
    public ResultVo getList(RoomListParm parm){
        //构造分页对象
        IPage<DormRoom> page = new Page<>(parm.getCurrentPage(),parm.getPageSize());
        QueryWrapper<DormRoom> query = new QueryWrapper<>();
        query.lambda().eq(DormRoom::getStoreyId,parm.getStoreyId());
        IPage<DormRoom> list = dormRoomService.page(page,query);
        return ResultUtils.success("查询成功",list);
    }

}

```



#### 第64讲 新增编号页面制作与对接

##### 1、api下新建setCode.js

```js
import http from "@/utils/http";
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/dormRoom",parm)
}
```

##### 2、buildCode.vue组件

```js
<template>
  <el-main class="build-main">
    <!-- 楼栋布局 -->
    <el-divider content-position="left">楼宇</el-divider>
    <div class="build-list">
      <div
        class="build-item"
        :id="'build' + index"
        @click="btnClick(item.buildId, index)"
        v-for="(item, index) in buildList"
        :key="index"
        :class="{ isActive: isChange === index }"
      >
        {{ item.buildName }}
      </div>
    </div>
    <el-container class="containers">
      <el-aside
        class="leftAsside"
        :style="{ height: leftHeight + 'px' }"
        width="150px"
      >
        <div
          v-for="(item, index) in destoryList"
          :key="index"
          :id="'storey' + index"
          class="storey-item"
          :class="{ destoryActive: isDestory === index }"
          @click="storyClick(item.storeyId, index)"
        >
          {{ item.storeyName }}
        </div>
      </el-aside>
      <el-main class="mains">
        <el-button
          type="primary"
          icon="el-icon-plus"
          size="small"
          @click="addBtn"
          >新增</el-button
        >
      </el-main>
    </el-container>
    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="area" label="区域">
            <el-input v-model="addModel.area"></el-input>
          </el-form-item>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="start" label="起始编号">
                <el-input v-model="addModel.start"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="end" label="结束编号">
                <el-input v-model="addModel.end"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item prop="rootType" label="类型">
            <el-select
              @change="selectChange"
              v-model="addModel.rootType"
              placeholder="请选择"
            >
              <el-option
                v-for="item in options"
                :key="item.value"
                :label="item.label"
                :value="item.value"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="stuNum" label="人数">
            <el-input v-model="addModel.stuNum"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getBuildListApi, getDestoryListApi } from "@/api/build.js";
import { addApi } from "@/api/setCode.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      //类型数据
      options: [
        {
          value: "1",
          label: "1人家",
        },
        {
          value: "2",
          label: "2人家",
        },
        {
          value: "4",
          label: "4人家",
        },
        {
          value: "6",
          label: "6人间",
        },
      ],
      //表单验证规则
      rules: {
        start: [
          {
            trigger: "blur",
            required: true,
            message: "请填写起始编号",
          },
        ],
        end: [
          {
            trigger: "blur",
            required: true,
            message: "请填写结束编号",
          },
        ],
        stuNum: [
          {
            trigger: "blur",
            required: true,
            message: "请填写人数",
          },
        ],
        rootType: [
          {
            trigger: "blur",
            required: true,
            message: "请选择类型",
          },
        ],
      },
      //新增弹框绑定的对象
      addModel: {
        area: "",
        start: "",
        end: "",
        stuNum: "",
        storeyId: "",
        rootType: "",
      },
      //新增弹框属性
      addDialog: {
        title: "",
        height: 250,
        width: 650,
        visible: false,
      },
      //点击颜色切换状态
      isDestory: 0,
      isChange: 0,
      buildList: [],
      destoryList: [],
      leftHeight: 0,
      rightHeight: 0,
    };
  },
  created() {
    this.getBuildList();
  },
  mounted() {
    this.$nextTick(() => {
      this.leftHeight = window.innerHeight - 230;
      this.rightHeight = window.innerHeight - 230;
    });
  },
  methods: {
    selectChange(val) {
      this.addModel.stuNum = val;
    },
    //新增按钮
    addBtn() {
      //设置弹框属性
      this.addDialog.title = "设置编号";
      this.addDialog.visible = true;
    },
    //新增弹框确定
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = await addApi(this.addModel);
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    //新增弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //层数点击事件
    storyClick(storeyId, index) {
      this.isDestory = index;
      this.addModel.storeyId = storeyId;
    },
    //楼栋点击事件
    btnClick(buildId, index) {
      console.log(index);
      this.isChange = index;
      this.isDestory = 0;
      this.getDestoryList(buildId);
    },
    //获取层数列表
    async getDestoryList(buildId) {
      let res = await getDestoryListApi({
        buildId: buildId,
      });
      if (res && res.code == 200) {
        console.log(res);
        this.destoryList = res.data;
        this.$nextTick(() => {
          document.querySelector("#storey0").click();
        });
      }
    },
    //获取楼栋列表
    async getBuildList() {
      let res = await getBuildListApi();
      if (res && res.code == 200) {
        this.buildList = res.data;
        //点击第一个楼栋,一定要放到 nextTick里面
        this.$nextTick(() => {
          document.querySelector("#build0").click();
        });
      }
    },
  },
};
</script>

<style lang="scss" scoped>
.build-main {
  padding-top: 0px;
}
.build-list {
  display: flex;
  flex-wrap: wrap;
}
.build-item {
  display: flex;
  padding: 8px 30px;
  margin: 10px;
  font-size: 14px;
  border: 1px solid #dedede;
  border-radius: 4px;
  cursor: pointer;
  background: #f8f8f8;
}
.isActive {
  background: #42b983;
  color: #fff;
}
.containers {
  margin-top: 20px;
  border: 1px solid #dcdfe6;
}
.leftAsside {
  border-right: 1px solid #dcdfe6;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.storey-item {
  padding: 8px 30px;
  margin: 10px 10px;
  font-size: 14px;
  border: 1px solid #dedede;
  border-radius: 4px;
  cursor: pointer;
  background-color: #f8f8f8;
}
.destoryActive {
  background: #5fb878 !important;
  border-color: #5fb878 !important;
  color: #fff;
}
.mains {
  padding-top: 10px;
}
</style>
```





#### 第65讲 房间列表页面制作与对接

##### 1、setCode.js添加getStoreyListApi()方法

```js
import http from "@/utils/http";
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/dormRoom",parm)
}
//列表
export const getStoreyListApi = async(parm)=>{
    return await http.get("/api/dormRoom/list",parm)
}
```

##### 2、buildCode.vue组件

```js
<template>
  <el-main class="build-main">
    <!-- 楼栋布局 -->
    <el-divider content-position="left">楼宇</el-divider>
    <div class="build-list">
      <div
        class="build-item"
        :id="'build' + index"
        @click="btnClick(item.buildId, index)"
        v-for="(item, index) in buildList"
        :key="index"
        :class="{ isActive: isChange === index }"
      >
        {{ item.buildName }}
      </div>
    </div>
    <el-container class="containers">
      <el-aside
        class="leftAsside"
        :style="{ height: leftHeight + 'px' }"
        width="150px"
      >
        <div
          v-for="(item, index) in destoryList"
          :key="index"
          :id="'storey' + index"
          class="storey-item"
          :class="{ destoryActive: isDestory === index }"
          @click="storyClick(item.storeyId, index)"
        >
          {{ item.storeyName }}
        </div>
      </el-aside>
      <el-main class="mains">
        <el-button
          type="primary"
          icon="el-icon-plus"
          size="small"
          @click="addBtn"
          >新增</el-button
        >
        <!-- 表格 -->
        <el-table :height='tableHeight' style="margin-top:10px;" :data="tableList" border stripe>
          <el-table-column align="center" prop="roomCode" label="宿舍编号"></el-table-column>
          <el-table-column align="center" prop="roomCode" label="宿舍类型">
            <template slot-scope="scope">
              <el-tag v-if="scope.row.rootType == '1'"  size="small" >1人间</el-tag>
              <el-tag v-if="scope.row.rootType == '2'" type="danger" size="small" >2人间</el-tag>
              <el-tag v-if="scope.row.rootType == '4'" type="success" size="small" >4人间</el-tag>
              <el-tag v-if="scope.row.rootType == '6'" type="warning" size="small" >6人间</el-tag>
            </template>
          </el-table-column>
          <el-table-column align="center" prop="totalBed" label="人数"></el-table-column>
          <el-table-column align="center"  label="操作" width="200">
            <template slot-scope="scope">
              <el-button icon="el-icon-edit" type="primary" size="small" @click="editBtn(scope.row)">编辑</el-button>
              <el-button icon="el-icon-delete" type="danger" size="small" @click="deleteBtn(scope.row)">删除</el-button>
            </template>
          </el-table-column>
        </el-table>
        <!-- 分页 -->
        <el-pagination
          @size-change="sizeChange"
          @current-change="currentChange"
          :current-page.sync="listParm.currentPage"
          :page-sizes="[10,20, 40, 80, 100]"
          :page-size="listParm.pageSize"
          layout="total, sizes, prev, pager, next, jumper"
          :total="listParm.total" background>
        </el-pagination>
        
      </el-main>
    </el-container>
    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="area" label="区域">
            <el-input v-model="addModel.area"></el-input>
          </el-form-item>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="start" label="起始编号">
                <el-input v-model="addModel.start"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="end" label="结束编号">
                <el-input v-model="addModel.end"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item prop="rootType" label="类型">
            <el-select
              @change="selectChange"
              v-model="addModel.rootType"
              placeholder="请选择"
            >
              <el-option
                v-for="item in options"
                :key="item.value"
                :label="item.label"
                :value="item.value"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="stuNum" label="人数">
            <el-input v-model="addModel.stuNum"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getBuildListApi, getDestoryListApi, listApi } from "@/api/build.js";
import { addApi, getStoreyListApi } from "@/api/setCode.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      tableHeight:0,
      //类型数据
      options: [
        {
          value: "1",
          label: "1人间",
        },
        {
          value: "2",
          label: "2人间",
        },
        {
          value: "4",
          label: "4人间",
        },
        {
          value: "6",
          label: "6人间",
        },
      ],
      //表单验证规则
      rules: {
        start: [
          {
            trigger: "blur",
            required: true,
            message: "请填写起始编号",
          },
        ],
        end: [
          {
            trigger: "blur",
            required: true,
            message: "请填写结束编号",
          },
        ],
        stuNum: [
          {
            trigger: "blur",
            required: true,
            message: "请填写人数",
          },
        ],
        rootType: [
          {
            trigger: "blur",
            required: true,
            message: "请选择类型",
          },
        ],
      },
      //新增弹框绑定的对象
      addModel: {
        area: "",
        start: "",
        end: "",
        stuNum: "",
        storeyId: "",
        rootType: "",
      },
      //新增弹框属性
      addDialog: {
        title: "",
        height: 250,
        width: 650,
        visible: false,
      },
      //点击颜色切换状态
      isDestory: 0,
      isChange: 0,
      buildList: [],
      destoryList: [],
      leftHeight: 0,
      rightHeight: 0,
      listParm: {
        currentPage: 1,
        pageSize: 10,
        total: 0,
        storeyId: "",
      },
      tableList: [],
    };
  },
  created() {
    this.getBuildList();
  },
  mounted() {
    this.$nextTick(() => {
      this.leftHeight = window.innerHeight - 230;
      this.rightHeight = window.innerHeight - 230;
      this.tableHeight = window.innerHeight - 350;
    });
  },
  methods: {
    deleteBtn(row){

    },
    editBtn(row){

    },
    //页数改变时触发
    currentChange(val){
      this.listParm.currentPage = val;
      this.getList()
    },
    //页容量改变时触发
    sizeChange(val){
      this.listParm.pageSize = val;
      this.listParm.currentPage = 1;
      this.getList()
    },
    //获取表格数据
    async getList() {
      let res = await getStoreyListApi(this.listParm);
      if (res && res.code == 200) {
        //设置表格数据
        this.tableList = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    selectChange(val) {
      this.addModel.stuNum = val;
    },
    //新增按钮
    addBtn() {
      //设置弹框属性
      this.addDialog.title = "设置编号";
      this.addDialog.visible = true;
    },
    //新增弹框确定
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = await addApi(this.addModel);
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.getList()
            this.addDialog.visible = false;
          }
        }
      });
    },
    //新增弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //层数点击事件
    storyClick(storeyId, index) {
      console.log("层数点击");
      this.isDestory = index;
      this.addModel.storeyId = storeyId;
      this.listParm.storeyId = storeyId;
      this.getList();
    },
    //楼栋点击事件
    btnClick(buildId, index) {
      console.log(index);
      this.isChange = index;
      this.isDestory = 0;
      this.getDestoryList(buildId);
    },
    //获取层数列表
    async getDestoryList(buildId) {
      let res = await getDestoryListApi({
        buildId: buildId,
      });
      if (res && res.code == 200) {
        console.log(res);
        this.destoryList = res.data;
        this.$nextTick(() => {
          document.querySelector("#storey0").click();
        });
      }
    },
    //获取楼栋列表
    async getBuildList() {
      let res = await getBuildListApi();
      if (res && res.code == 200) {
        this.buildList = res.data;
        //点击第一个楼栋,一定要放到 nextTick里面
        this.$nextTick(() => {
          document.querySelector("#build0").click();
        });
      }
    },
  },
};
</script>

<style lang="scss" scoped>
.build-main {
  padding-top: 0px;
}
.build-list {
  display: flex;
  flex-wrap: wrap;
}
.build-item {
  display: flex;
  padding: 8px 30px;
  margin: 10px;
  font-size: 14px;
  border: 1px solid #dedede;
  border-radius: 4px;
  cursor: pointer;
  background: #f8f8f8;
}
.isActive {
  background: #42b983;
  color: #fff;
}
.containers {
  margin-top: 20px;
  border: 1px solid #dcdfe6;
}
.leftAsside {
  border-right: 1px solid #dcdfe6;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.storey-item {
  padding: 8px 30px;
  margin: 10px 10px;
  font-size: 14px;
  border: 1px solid #dedede;
  border-radius: 4px;
  cursor: pointer;
  background-color: #f8f8f8;
}
.destoryActive {
  background: #5fb878 !important;
  border-color: #5fb878 !important;
  color: #fff;
}
.mains {
  padding-top: 10px;
}
</style>
```





#### 第66讲 编辑宿舍页面制作与对接

##### 1、setCode.js添加editApi()和deleteApi()方法

```js
import http from "@/utils/http";
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/dormRoom",parm)
}
//列表
export const getStoreyListApi = async(parm)=>{
    return await http.get("/api/dormRoom/list",parm)
}
//编辑
export const editApi = async(parm)=>{
    return await http.put("/api/dormRoom",parm)
}
//删除
export const deleteApi = async(parm)=>{
    return await http.delete("/api/dormRoom",parm)
}
```

##### 2、buildCode.vue页面

```js
<template>
  <el-main class="build-main">
    <!-- 楼栋布局 -->
    <el-divider content-position="left">楼宇</el-divider>
    <div class="build-list">
      <div
        class="build-item"
        :id="'build' + index"
        @click="btnClick(item.buildId, index)"
        v-for="(item, index) in buildList"
        :key="index"
        :class="{ isActive: isChange === index }"
      >
        {{ item.buildName }}
      </div>
    </div>
    <el-container class="containers">
      <el-aside
        class="leftAsside"
        :style="{ height: leftHeight + 'px' }"
        width="150px"
      >
        <div
          v-for="(item, index) in destoryList"
          :key="index"
          :id="'storey' + index"
          class="storey-item"
          :class="{ destoryActive: isDestory === index }"
          @click="storyClick(item.storeyId, index)"
        >
          {{ item.storeyName }}
        </div>
      </el-aside>
      <el-main class="mains">
        <el-button
          type="primary"
          icon="el-icon-plus"
          size="small"
          @click="addBtn"
          >新增</el-button
        >
        <!-- 表格 -->
        <el-table
          :height="tableHeight"
          style="margin-top: 10px"
          :data="tableList"
          border
          stripe
        >
          <el-table-column
            align="center"
            prop="roomCode"
            label="宿舍编号"
          ></el-table-column>
          <el-table-column align="center" prop="roomCode" label="宿舍类型">
            <template slot-scope="scope">
              <el-tag v-if="scope.row.rootType == '1'" size="small"
                >1人间</el-tag
              >
              <el-tag
                v-if="scope.row.rootType == '2'"
                type="danger"
                size="small"
                >2人间</el-tag
              >
              <el-tag
                v-if="scope.row.rootType == '4'"
                type="success"
                size="small"
                >4人间</el-tag
              >
              <el-tag
                v-if="scope.row.rootType == '6'"
                type="warning"
                size="small"
                >6人间</el-tag
              >
            </template>
          </el-table-column>
          <el-table-column
            align="center"
            prop="totalBed"
            label="人数"
          ></el-table-column>
          <el-table-column align="center" label="操作" width="200">
            <template slot-scope="scope">
              <el-button
                icon="el-icon-edit"
                type="primary"
                size="small"
                @click="editBtn(scope.row)"
                >编辑</el-button
              >
              <el-button
                icon="el-icon-delete"
                type="danger"
                size="small"
                @click="deleteBtn(scope.row)"
                >删除</el-button
              >
            </template>
          </el-table-column>
        </el-table>
        <!-- 分页 -->
        <el-pagination
          @size-change="sizeChange"
          @current-change="currentChange"
          :current-page.sync="listParm.currentPage"
          :page-sizes="[10, 20, 40, 80, 100]"
          :page-size="listParm.pageSize"
          layout="total, sizes, prev, pager, next, jumper"
          :total="listParm.total"
          background
        >
        </el-pagination>
      </el-main>
    </el-container>
    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="area" label="区域">
            <el-input v-model="addModel.area"></el-input>
          </el-form-item>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="start" label="起始编号">
                <el-input v-model="addModel.start"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="end" label="结束编号">
                <el-input v-model="addModel.end"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item prop="rootType" label="类型">
            <el-select
              @change="selectChange"
              v-model="addModel.rootType"
              placeholder="请选择"
            >
              <el-option
                v-for="item in options"
                :key="item.value"
                :label="item.label"
                :value="item.value"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="stuNum" label="人数">
            <el-input v-model="addModel.stuNum"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
    <!-- 编辑弹框 -->
    <sys-dialog
      :title="editDialog.title"
      :height="editDialog.height"
      :width="editDialog.width"
      :visible="editDialog.visible"
      @onClose="editClose"
      @onConfirm="editConfirm"
    >
      <div slot="content">
        <el-form
          :model="editModel"
          ref="editForm"
          :rules="editRules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="roomCode" label="宿舍编号">
            <el-input v-model="editModel.roomCode"></el-input>
          </el-form-item>
          <el-form-item prop="rootType" label="类型">
            <el-select
              style="width: 100%"
              @change="editSelectChange"
              v-model="editModel.rootType"
              placeholder="请选择"
            >
              <el-option
                v-for="item in options"
                :key="item.value"
                :label="item.label"
                :value="item.value"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="totalBed" label="容纳人数">
            <el-input v-model="editModel.totalBed"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getBuildListApi, getDestoryListApi } from "@/api/build.js";
import { addApi, getStoreyListApi, editApi, deleteApi } from "@/api/setCode.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      storeyId:'',
      //表单验证规则
      editRules: {
        rootType: [
          {
            trigger: "blur",
            required: true,
            message: "请选择类型",
          },
        ],
        roomCode: [
          {
            trigger: "blur",
            required: true,
            message: "请填写编号",
          },
        ],
        totalBed: [
          {
            trigger: "blur",
            required: true,
            message: "请填写人数",
          },
        ],
      },
      //编辑绑定的对象
      editModel: {
        roomId: "",
        storeyId: "",
        rootType: "",
        roomCode: "",
        totalBed: "",
      },
      //编辑弹框属性
      editDialog: {
        title: "",
        height: 180,
        width: 650,
        visible: false,
      },
      tableHeight: 0,
      //类型数据
      options: [
        {
          value: "1",
          label: "1人间",
        },
        {
          value: "2",
          label: "2人间",
        },
        {
          value: "4",
          label: "4人间",
        },
        {
          value: "6",
          label: "6人间",
        },
      ],
      //表单验证规则
      rules: {
        start: [
          {
            trigger: "blur",
            required: true,
            message: "请填写起始编号",
          },
        ],
        end: [
          {
            trigger: "blur",
            required: true,
            message: "请填写结束编号",
          },
        ],
        stuNum: [
          {
            trigger: "blur",
            required: true,
            message: "请填写人数",
          },
        ],
        rootType: [
          {
            trigger: "blur",
            required: true,
            message: "请选择类型",
          },
        ],
      },
      //新增弹框绑定的对象
      addModel: {
        area: "",
        start: "",
        end: "",
        stuNum: "",
        storeyId: "",
        rootType: "",
      },
      //新增弹框属性
      addDialog: {
        title: "",
        height: 250,
        width: 650,
        visible: false,
      },
      //点击颜色切换状态
      isDestory: 0,
      isChange: 0,
      buildList: [],
      destoryList: [],
      leftHeight: 0,
      rightHeight: 0,
      listParm: {
        currentPage: 1,
        pageSize: 10,
        total: 0,
        storeyId: "",
      },
      tableList: [],
    };
  },
  created() {
    this.getBuildList();
  },
  mounted() {
    this.$nextTick(() => {
      this.leftHeight = window.innerHeight - 230;
      this.rightHeight = window.innerHeight - 230;
      this.tableHeight = window.innerHeight - 350;
    });
  },
  methods: {
    editSelectChange(val) {
      this.editModel.totalBed = val;
    },
    //编辑确定
    editConfirm() {
      this.$refs.editForm.validate(async (valid) => {
        if (valid) {
          let res = await editApi(this.editModel);
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.getList();
            this.editDialog.visible = false;
          }
        }
      });
    },
    //编辑关闭
    editClose() {
      this.editDialog.visible = false;
    },
    async deleteBtn(row) {
      let confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteApi({
          roomId: row.roomId,
        });
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          this.getList();
        }
      }
    },
    editBtn(row) {
      //清空表单
      this.$resetForm("editForm", this.editModel);
      //设置弹框属性
      this.editDialog.title = "编辑编号";
      this.editDialog.visible = true;
      //设置编辑 数据回显
      this.$objCoppy(row, this.editModel);
      console.log(this.editModel);
    },
    //页数改变时触发
    currentChange(val) {
      this.listParm.currentPage = val;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.listParm.pageSize = val;
      this.listParm.currentPage = 1;
      this.getList();
    },
    //获取表格数据
    async getList() {
      let res = await getStoreyListApi(this.listParm);
      if (res && res.code == 200) {
        //设置表格数据
        this.tableList = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    selectChange(val) {
      this.addModel.stuNum = val;
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置弹框属性
      this.addDialog.title = "设置编号";
      this.addDialog.visible = true;
      this.addModel.storeyId = this.storeyId;
    },
    //新增弹框确定
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = await addApi(this.addModel);
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.getList();
            this.addDialog.visible = false;
          }
        }
      });
    },
    //新增弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //层数点击事件
    storyClick(storeyId, index) {
      console.log("层数点击");
      this.isDestory = index;
      this.storeyId = storeyId;
      this.listParm.storeyId = storeyId;
      this.getList();
    },
    //楼栋点击事件
    btnClick(buildId, index) {
      console.log(index);
      this.isChange = index;
      this.isDestory = 0;
      this.getDestoryList(buildId);
    },
    //获取层数列表
    async getDestoryList(buildId) {
      let res = await getDestoryListApi({
        buildId: buildId,
      });
      if (res && res.code == 200) {
        console.log(res);
        this.destoryList = res.data;
        this.$nextTick(() => {
          document.querySelector("#storey0").click();
        });
      }
    },
    //获取楼栋列表
    async getBuildList() {
      let res = await getBuildListApi();
      if (res && res.code == 200) {
        this.buildList = res.data;
        //点击第一个楼栋,一定要放到 nextTick里面
        this.$nextTick(() => {
          document.querySelector("#build0").click();
        });
      }
    },
  },
};
</script>

<style lang="scss" scoped>
.build-main {
  padding-top: 0px;
}
.build-list {
  display: flex;
  flex-wrap: wrap;
}
.build-item {
  display: flex;
  padding: 8px 30px;
  margin: 10px;
  font-size: 14px;
  border: 1px solid #dedede;
  border-radius: 4px;
  cursor: pointer;
  background: #f8f8f8;
}
.isActive {
  background: #42b983;
  color: #fff;
}
.containers {
  margin-top: 20px;
  border: 1px solid #dcdfe6;
}
.leftAsside {
  border-right: 1px solid #dcdfe6;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.storey-item {
  padding: 8px 30px;
  margin: 10px 10px;
  font-size: 14px;
  border: 1px solid #dedede;
  border-radius: 4px;
  cursor: pointer;
  background-color: #f8f8f8;
}
.destoryActive {
  background: #5fb878 !important;
  border-color: #5fb878 !important;
  color: #fff;
}
.mains {
  padding-top: 10px;
}
</style>
```









#### 第67讲 初始化床位对接

##### 1、新建全局异常处理器

###### 1.1、新建BusinessExceptionEnum

```js
package com.itmk.exception_advice;


public enum  BusinessExceptionEnum {
    SERVER_ERROR(500, "服务器异常！"),
    ;

    private Integer code;
    private String message;

    BusinessExceptionEnum(Integer code, String message) {
        this.code = code;
        this.message = message;
    }

    public Integer getCode() {
        return code;
    }

    public String getMessage() {
        return message;
    }
}
```

###### 1.2、新建BusinessException

```js
package com.itmk.exception_advice;

/**
 * @Author java实战基地
 * @Version 3501754007
 */

public class BusinessException extends RuntimeException {
    private Integer code;

    private String message;

    public BusinessException(Integer code, String message) {
        this.code = code;
        this.message = message;
    }

    public Integer getCode() {
        return code;
    }

    public void setCode(Integer code) {
        this.code = code;
    }

    @Override
    public String getMessage() {
        return message;
    }

    public void setMessage(String message) {
        this.message = message;
    }
}
```

###### 1.3、新建GlobalExceptionHandler

```js
package com.itmk.exception_advice;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseBody;

@ControllerAdvice
public class GlobalExceptionHandler {
     /**
     * 自定义业务异常拦截
     * BusinessException
     */
    @ExceptionHandler(BusinessException.class)
    @ResponseBody
    public ResultVo bussinessexception(BusinessException e) {

        return ResultUtils.error(e.getMessage(),e.getCode(),e.getMessage());
    }
}
```

##### 2、新建drom_room_bed模块

###### 2.1、新建实体类

```js
package com.itmk.web.drom_room_bed.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
@TableName("drom_room_bed")
public class DromRoomBed {
    @TableId(type = IdType.AUTO)
    private Long bedId;
    private Long roomId;
    private String bedCode;
}

```

###### 2.2、新建mapper层

```js
package com.itmk.web.drom_room_bed.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.drom_room_bed.entity.DromRoomBed;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface DromRoomBedMapper extends BaseMapper<DromRoomBed> {
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.drom_room_bed.mapper.DromRoomBedMapper">

</mapper>
```

###### 2.3、新建service层

```js
package com.itmk.web.drom_room_bed.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.drom_room_bed.entity.DromRoomBed;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface DromRoomBedService extends IService<DromRoomBed> {
}

```

实现类

```js
package com.itmk.web.drom_room_bed.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.drom_room_bed.entity.DromRoomBed;
import com.itmk.web.drom_room_bed.mapper.DromRoomBedMapper;
import com.itmk.web.drom_room_bed.service.DromRoomBedService;
import org.springframework.stereotype.Service;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class DromRoomBedServiceImpl extends ServiceImpl<DromRoomBedMapper, DromRoomBed> implements DromRoomBedService {
}

```

##### 3、DromStoreyService接口添加initBed()方法

```js
//初始化床位
    void initBed(DromStorey dromStorey);
```

实现类

```js
@Override
    public void initBed(DromStorey dromStorey) {
        //根据层数，查询所有的宿舍
        QueryWrapper<DormRoom> query = new QueryWrapper<>();
        query.lambda().eq(DormRoom::getStoreyId, dromStorey.getStoreyId());
        List<DormRoom> list = dormRoomService.list(query);
        if (list.size() == 0) throw new BusinessException(500, "请先新增宿舍");
        //遍历宿舍，生成床号
        List<DromRoomBed> bedList = new ArrayList<>();
        for (int i = 0; i < list.size(); i++) {
            //获取人数
            Integer totalBed = list.get(i).getTotalBed();
            for (int j = 1; j <= totalBed; j++) {
                //查询是否已经设置宿舍编号
                QueryWrapper<DromRoomBed> queryBed = new QueryWrapper<>();
                queryBed.lambda().eq(DromRoomBed::getRoomId, list.get(i).getRoomId())
                        .eq(DromRoomBed::getBedCode, list.get(i).getRoomCode() +"-" + j);
                DromRoomBed one = dromRoomBedService.getOne(queryBed);
                if (one == null) {
                    DromRoomBed bed = new DromRoomBed();
                    bed.setRoomId(list.get(i).getRoomId());
                    bed.setBedCode(list.get(i).getRoomCode()  +"-" + j);
                    bedList.add(bed);
                }
            }
        }
        if(bedList.size() >0){
            dromRoomBedService.saveBatch(bedList);
        }
    }
```

##### 4、DromStoreyController控制器添加initBed()方法

```js
//初始化床位
    @PostMapping("/initBed")
    public ResultVo initBed(@RequestBody DromStorey dromStorey){
        dromStoreyService.initBed(dromStorey);
        return ResultUtils.success("初始化床位成功");
    }
```

##### 5、setCode.js添加initBedApi()方法

```js
//初始化床位
export const initBedApi = async(parm)=>{
    return await http.post("/api/storey/initBed",parm)
}
```



##### 6、页面添加初始化床位按钮

```js
<template>
  <el-main class="build-main">
    <!-- 楼栋布局 -->
    <el-divider content-position="left">楼宇</el-divider>
    <div class="build-list">
      <div
        class="build-item"
        :id="'build' + index"
        @click="btnClick(item.buildId, index)"
        v-for="(item, index) in buildList"
        :key="index"
        :class="{ isActive: isChange === index }"
      >
        {{ item.buildName }}
      </div>
    </div>
    <el-container class="containers">
      <el-aside
        class="leftAsside"
        :style="{ height: leftHeight + 'px' }"
        width="150px"
      >
        <div
          v-for="(item, index) in destoryList"
          :key="index"
          :id="'storey' + index"
          class="storey-item"
          :class="{ destoryActive: isDestory === index }"
          @click="storyClick(item.storeyId, index)"
        >
          {{ item.storeyName }}
        </div>
      </el-aside>
      <el-main class="mains">
        <el-button
          type="primary"
          icon="el-icon-plus"
          size="small"
          @click="addBtn"
          >新增</el-button
        >
        <el-button
          type="primary"
          icon="el-icon-plus"
          size="small"
          @click="initBed"
          >初始化床位</el-button
        >
        <!-- 表格 -->
        <el-table
          :height="tableHeight"
          style="margin-top: 10px"
          :data="tableList"
          border
          stripe
        >
          <el-table-column
            align="center"
            prop="roomCode"
            label="宿舍编号"
          ></el-table-column>
          <el-table-column align="center" prop="roomCode" label="宿舍类型">
            <template slot-scope="scope">
              <el-tag v-if="scope.row.rootType == '1'" size="small"
                >1人间</el-tag
              >
              <el-tag
                v-if="scope.row.rootType == '2'"
                type="danger"
                size="small"
                >2人间</el-tag
              >
              <el-tag
                v-if="scope.row.rootType == '4'"
                type="success"
                size="small"
                >4人间</el-tag
              >
              <el-tag
                v-if="scope.row.rootType == '6'"
                type="warning"
                size="small"
                >6人间</el-tag
              >
            </template>
          </el-table-column>
          <el-table-column
            align="center"
            prop="totalBed"
            label="人数"
          ></el-table-column>
          <el-table-column align="center" label="操作" width="200">
            <template slot-scope="scope">
              <el-button
                icon="el-icon-edit"
                type="primary"
                size="small"
                @click="editBtn(scope.row)"
                >编辑</el-button
              >
              <el-button
                icon="el-icon-delete"
                type="danger"
                size="small"
                @click="deleteBtn(scope.row)"
                >删除</el-button
              >
            </template>
          </el-table-column>
        </el-table>
        <!-- 分页 -->
        <el-pagination
          @size-change="sizeChange"
          @current-change="currentChange"
          :current-page.sync="listParm.currentPage"
          :page-sizes="[10, 20, 40, 80, 100]"
          :page-size="listParm.pageSize"
          layout="total, sizes, prev, pager, next, jumper"
          :total="listParm.total"
          background
        >
        </el-pagination>
      </el-main>
    </el-container>
    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="area" label="区域">
            <el-input v-model="addModel.area"></el-input>
          </el-form-item>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="start" label="起始编号">
                <el-input v-model="addModel.start"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="end" label="结束编号">
                <el-input v-model="addModel.end"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item prop="rootType" label="类型">
            <el-select
              @change="selectChange"
              v-model="addModel.rootType"
              placeholder="请选择"
            >
              <el-option
                v-for="item in options"
                :key="item.value"
                :label="item.label"
                :value="item.value"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="stuNum" label="人数">
            <el-input v-model="addModel.stuNum"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
    <!-- 编辑弹框 -->
    <sys-dialog
      :title="editDialog.title"
      :height="editDialog.height"
      :width="editDialog.width"
      :visible="editDialog.visible"
      @onClose="editClose"
      @onConfirm="editConfirm"
    >
      <div slot="content">
        <el-form
          :model="editModel"
          ref="editForm"
          :rules="editRules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="roomCode" label="宿舍编号">
            <el-input v-model="editModel.roomCode"></el-input>
          </el-form-item>
          <el-form-item prop="rootType" label="类型">
            <el-select
              style="width: 100%"
              @change="editSelectChange"
              v-model="editModel.rootType"
              placeholder="请选择"
            >
              <el-option
                v-for="item in options"
                :key="item.value"
                :label="item.label"
                :value="item.value"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="totalBed" label="容纳人数">
            <el-input v-model="editModel.totalBed"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getBuildListApi, getDestoryListApi } from "@/api/build.js";
import { addApi, getStoreyListApi, editApi, deleteApi,initBedApi } from "@/api/setCode.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      storeyId: "",
      //表单验证规则
      editRules: {
        rootType: [
          {
            trigger: "blur",
            required: true,
            message: "请选择类型",
          },
        ],
        roomCode: [
          {
            trigger: "blur",
            required: true,
            message: "请填写编号",
          },
        ],
        totalBed: [
          {
            trigger: "blur",
            required: true,
            message: "请填写人数",
          },
        ],
      },
      //编辑绑定的对象
      editModel: {
        roomId: "",
        storeyId: "",
        rootType: "",
        roomCode: "",
        totalBed: "",
      },
      //编辑弹框属性
      editDialog: {
        title: "",
        height: 180,
        width: 650,
        visible: false,
      },
      tableHeight: 0,
      //类型数据
      options: [
        {
          value: "1",
          label: "1人间",
        },
        {
          value: "2",
          label: "2人间",
        },
        {
          value: "4",
          label: "4人间",
        },
        {
          value: "6",
          label: "6人间",
        },
      ],
      //表单验证规则
      rules: {
        start: [
          {
            trigger: "blur",
            required: true,
            message: "请填写起始编号",
          },
        ],
        end: [
          {
            trigger: "blur",
            required: true,
            message: "请填写结束编号",
          },
        ],
        stuNum: [
          {
            trigger: "blur",
            required: true,
            message: "请填写人数",
          },
        ],
        rootType: [
          {
            trigger: "blur",
            required: true,
            message: "请选择类型",
          },
        ],
      },
      //新增弹框绑定的对象
      addModel: {
        area: "",
        start: "",
        end: "",
        stuNum: "",
        storeyId: "",
        rootType: "",
      },
      //新增弹框属性
      addDialog: {
        title: "",
        height: 250,
        width: 650,
        visible: false,
      },
      //点击颜色切换状态
      isDestory: 0,
      isChange: 0,
      buildList: [],
      destoryList: [],
      leftHeight: 0,
      rightHeight: 0,
      listParm: {
        currentPage: 1,
        pageSize: 10,
        total: 0,
        storeyId: "",
      },
      tableList: [],
    };
  },
  created() {
    this.getBuildList();
  },
  mounted() {
    this.$nextTick(() => {
      this.leftHeight = window.innerHeight - 230;
      this.rightHeight = window.innerHeight - 230;
      this.tableHeight = window.innerHeight - 350;
    });
  },
  methods: {
    //初始化床位
    async initBed() {
      if (!this.storeyId) {
        this.$message.error("请选择层数");
        return;
      }
      let res = await initBedApi({
        storeyId:this.storeyId
      })
      if(res && res.code == 200){
        this.$message.success(res.msg)
        this.getList()
      }
    },
    editSelectChange(val) {
      this.editModel.totalBed = val;
    },
    //编辑确定
    editConfirm() {
      this.$refs.editForm.validate(async (valid) => {
        if (valid) {
          let res = await editApi(this.editModel);
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.getList();
            this.editDialog.visible = false;
          }
        }
      });
    },
    //编辑关闭
    editClose() {
      this.editDialog.visible = false;
    },
    async deleteBtn(row) {
      let confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteApi({
          roomId: row.roomId,
        });
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          this.getList();
        }
      }
    },
    editBtn(row) {
      //清空表单
      this.$resetForm("editForm", this.editModel);
      //设置弹框属性
      this.editDialog.title = "编辑编号";
      this.editDialog.visible = true;
      //设置编辑 数据回显
      this.$objCoppy(row, this.editModel);
      console.log(this.editModel);
    },
    //页数改变时触发
    currentChange(val) {
      this.listParm.currentPage = val;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.listParm.pageSize = val;
      this.listParm.currentPage = 1;
      this.getList();
    },
    //获取表格数据
    async getList() {
      let res = await getStoreyListApi(this.listParm);
      if (res && res.code == 200) {
        //设置表格数据
        this.tableList = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    selectChange(val) {
      this.addModel.stuNum = val;
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置弹框属性
      this.addDialog.title = "设置编号";
      this.addDialog.visible = true;
      this.addModel.storeyId = this.storeyId;
    },
    //新增弹框确定
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = await addApi(this.addModel);
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.getList();
            this.addDialog.visible = false;
          }
        }
      });
    },
    //新增弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //层数点击事件
    storyClick(storeyId, index) {
      console.log("层数点击");
      this.isDestory = index;
      this.storeyId = storeyId;
      this.listParm.storeyId = storeyId;
      this.getList();
    },
    //楼栋点击事件
    btnClick(buildId, index) {
      console.log(index);
      this.isChange = index;
      this.isDestory = 0;
      this.getDestoryList(buildId);
    },
    //获取层数列表
    async getDestoryList(buildId) {
      let res = await getDestoryListApi({
        buildId: buildId,
      });
      if (res && res.code == 200) {
        console.log(res);
        this.destoryList = res.data;
        this.$nextTick(() => {
          document.querySelector("#storey0").click();
        });
      }
    },
    //获取楼栋列表
    async getBuildList() {
      let res = await getBuildListApi();
      if (res && res.code == 200) {
        this.buildList = res.data;
        //点击第一个楼栋,一定要放到 nextTick里面
        this.$nextTick(() => {
          document.querySelector("#build0").click();
        });
      }
    },
  },
};
</script>

<style lang="scss" scoped>
.build-main {
  padding-top: 0px;
}
.build-list {
  display: flex;
  flex-wrap: wrap;
}
.build-item {
  display: flex;
  padding: 8px 30px;
  margin: 10px;
  font-size: 14px;
  border: 1px solid #dedede;
  border-radius: 4px;
  cursor: pointer;
  background: #f8f8f8;
}
.isActive {
  background: #42b983;
  color: #fff;
}
.containers {
  margin-top: 20px;
  border: 1px solid #dcdfe6;
}
.leftAsside {
  border-right: 1px solid #dcdfe6;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.storey-item {
  padding: 8px 30px;
  margin: 10px 10px;
  font-size: 14px;
  border: 1px solid #dedede;
  border-radius: 4px;
  cursor: pointer;
  background-color: #f8f8f8;
}
.destoryActive {
  background: #5fb878 !important;
  border-color: #5fb878 !important;
  color: #fff;
}
.mains {
  padding-top: 10px;
}
</style>
```







#### 第68讲 床位列表对接

##### 1、DormRoom实体类添加bedList字段

```js
package com.itmk.web.dorm_room.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import com.itmk.web.drom_room_bed.entity.DromRoomBed;
import lombok.Data;

import java.util.ArrayList;
import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
@TableName("dorm_room")
public class DormRoom {
    @TableId(type = IdType.AUTO)
    private Long roomId;
    private Long storeyId;
    private String rootType;
    private String roomCode;
    private Integer totalBed;
    //床位列表
    @TableField(exist = false)
    List<DromRoomBed> bedList = new ArrayList<>();
}

```

##### 2、DormRoomController控制器的getList()修改为如下

```js
package com.itmk.web.dorm_room.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.dorm_room.entity.DormRoom;
import com.itmk.web.dorm_room.entity.RoomListParm;
import com.itmk.web.dorm_room.entity.RoomParm;
import com.itmk.web.dorm_room.service.DormRoomService;
import com.itmk.web.drom_room_bed.entity.DromRoomBed;
import com.itmk.web.drom_room_bed.service.DromRoomBedService;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.ArrayList;
import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/dormRoom")
public class DormRoomController {
    @Autowired
    private DormRoomService dormRoomService;
    @Autowired
    private DromRoomBedService dromRoomBedService;

    //新增
    @PostMapping
    public ResultVo add(@RequestBody RoomParm parm) {
        //起始编号
        int start = parm.getStart();
        List<DormRoom> list = new ArrayList<>();
        while (start <= parm.getEnd()) {
            //房间实体类创建
            DormRoom room = new DormRoom();
            room.setTotalBed(parm.getStuNum());
            room.setRootType(parm.getRootType());
            room.setStoreyId(parm.getStoreyId());
            //构造编号 A100
            if (StringUtils.isNotEmpty(parm.getArea())) {
                room.setRoomCode(parm.getArea() + start);
            } else { // 100
                room.setRoomCode(Integer.toString(start));
            }
            //判断是否重复
            QueryWrapper<DormRoom> query = new QueryWrapper<>();
            query.lambda().eq(DormRoom::getRoomCode, room.getRoomCode());
            DormRoom one = dormRoomService.getOne(query);
            if (one == null) { //没有重复的才放入
                list.add(room);
            }
            //此条件不能少，死循环
            start = start + 1;
        }
        //保存房间
        if(list.size() > 0){
             dormRoomService.saveBatch(list);
        }
        return ResultUtils.success("设置成功");
    }

    //编辑
    @PutMapping
    public ResultVo edit(@RequestBody DormRoom room) {
        //判断编号是否重复
        QueryWrapper<DormRoom> query = new QueryWrapper<>();
        query.lambda().eq(DormRoom::getRoomCode, room.getRoomCode());
        DormRoom one = dormRoomService.getOne(query);
        if (one != null && one.getRoomId() != room.getRoomId()) {
            return ResultUtils.error("编号重复");
        }
        boolean b = dormRoomService.updateById(room);
        if (b) {
            return ResultUtils.success("编辑成功");
        }
        return ResultUtils.error("编辑失败");
    }

    //删除
    @DeleteMapping("/{roomId}")
    public ResultVo delete(@PathVariable("roomId") Long roomId){
        //判断房间下面是否住着人
        //如果没有人，才能删除
        boolean b = dormRoomService.removeById(roomId);
        if (b) {
            return ResultUtils.success("删除成功");
        }
        return ResultUtils.error("删除失败");
    }

    //列表查询
    @GetMapping("/list")
    public ResultVo getList(RoomListParm parm){
        //构造分页对象
        IPage<DormRoom> page = new Page<>(parm.getCurrentPage(),parm.getPageSize());
        QueryWrapper<DormRoom> query = new QueryWrapper<>();
        query.lambda().eq(DormRoom::getStoreyId,parm.getStoreyId());
        IPage<DormRoom> list = dormRoomService.page(page,query);
        //查询宿舍对应的床位
        if(list.getRecords().size() >0){
           for (int i=0;i<list.getRecords().size();i++){
               //获取宿舍id
               Long roomId = list.getRecords().get(i).getRoomId();
               //查询宿舍对应的床位
                QueryWrapper<DromRoomBed> queryBed = new QueryWrapper<>();
                queryBed.lambda().eq(DromRoomBed::getRoomId,roomId);
               List<DromRoomBed> bedList = dromRoomBedService.list(queryBed);
               list.getRecords().get(i).setBedList(bedList);
           }
        }
        return ResultUtils.success("查询成功",list);
    }

}

```







#### 第69讲 编辑、删除床位对接

##### 1、新建DromRoomBedController控制器

```js
package com.itmk.web.drom_room_bed.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.drom_room_bed.entity.DromRoomBed;
import com.itmk.web.drom_room_bed.service.DromRoomBedService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/roomBed")
public class DromRoomBedController {
    @Autowired
    private DromRoomBedService dromRoomBedService;

    //编辑
    @PutMapping
    public ResultVo edit(@RequestBody DromRoomBed dromRoomBed){
        //判断编号是否重复
        QueryWrapper<DromRoomBed> query = new QueryWrapper<>();
        query.lambda().eq(DromRoomBed::getBedCode,dromRoomBed.getBedCode());
        DromRoomBed one = dromRoomBedService.getOne(query);
        if(one != null && one.getBedId() != dromRoomBed.getBedId()){
            return ResultUtils.error("编号重复!");
        }
        boolean b = dromRoomBedService.updateById(dromRoomBed);
        if(b){
            return ResultUtils.success("编辑成功!");
        }
        return ResultUtils.error("编辑失败!");
    }

    //删除
    @DeleteMapping("/{bedId}")
    public ResultVo delete(@PathVariable("bedId") Long bedId){
        //判断床位是否有人住，不能删除
        boolean b = dromRoomBedService.removeById(bedId);
        if(b){
            return ResultUtils.success("删除成功");
        }
        return ResultUtils.error("删除失败!");
    }

}

```



##### 2、api/setCode.js添加editChildApi()和deleteChildApi()方法

```js
import http from "@/utils/http";
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/dormRoom",parm)
}
//列表
export const getStoreyListApi = async(parm)=>{
    return await http.get("/api/dormRoom/list",parm)
}
//编辑
export const editApi = async(parm)=>{
    return await http.put("/api/dormRoom",parm)
}
//删除
export const deleteApi = async(parm)=>{
    return await http.delete("/api/dormRoom",parm)
}
//初始化床位
export const initBedApi = async(parm)=>{
    return await http.post("/api/storey/initBed",parm)
}
//编辑
export const editChildApi = async(parm)=>{
    return await http.put("/api/roomBed",parm)
}
//删除
export const deleteChildApi = async(parm)=>{
    return await http.delete("/api/roomBed",parm)
}
```



##### 3、buildCode.vue页面

```js
<template>
  <el-main class="build-main">
    <!-- 楼栋布局 -->
    <el-divider content-position="left">楼宇</el-divider>
    <div class="build-list">
      <div
        class="build-item"
        :id="'build' + index"
        @click="btnClick(item.buildId, index)"
        v-for="(item, index) in buildList"
        :key="index"
        :class="{ isActive: isChange === index }"
      >
        {{ item.buildName }}
      </div>
    </div>
    <el-container class="containers">
      <el-aside
        class="leftAsside"
        :style="{ height: leftHeight + 'px' }"
        width="150px"
      >
        <div
          v-for="(item, index) in destoryList"
          :key="index"
          :id="'storey' + index"
          class="storey-item"
          :class="{ destoryActive: isDestory === index }"
          @click="storyClick(item.storeyId, index)"
        >
          {{ item.storeyName }}
        </div>
      </el-aside>
      <el-main class="mains">
        <el-button
          type="primary"
          icon="el-icon-plus"
          size="small"
          @click="addBtn"
          >新增</el-button
        >
        <el-button
          type="primary"
          icon="el-icon-plus"
          size="small"
          @click="initBed"
          >初始化床位</el-button
        >
        <!-- 表格 -->
        <!-- 表格 -->
        <el-table
          :data="tableList"
          :height="tableHeight"
          style="margin-top: 10px"
          border
          stripe
        >
          <el-table-column width="100" type="expand">
            <!-- 子表格
        1；type="expand"
         -->
            <template slot-scope="scope">
              <el-table border :data="scope.row.bedList">
                <el-table-column
                  label="床位编号"
                  prop="bedCode"
                ></el-table-column>
                <el-table-column label="操作" align="center" width="180">
                  <template slot-scope="scope">
                    <el-button
                      round
                      icon="el-icon-edit"
                      type="success"
                      size="mini"
                      @click="childEdit(scope.row)"
                      >编辑</el-button
                    >
                    <el-button
                      round
                      icon="el-icon-delete"
                      type="warning"
                      size="mini"
                      @click="childDelete(scope.row)"
                      >删除</el-button
                    >
                  </template>
                </el-table-column>
              </el-table>
            </template>
          </el-table-column>
          <el-table-column prop="roomCode" label="宿舍编号"></el-table-column>
          <el-table-column align="center" prop="roomCode" label="宿舍类型">
            <template slot-scope="scope">
              <el-tag v-if="scope.row.rootType == '1'" size="small"
                >1人间</el-tag
              >
              <el-tag
                v-if="scope.row.rootType == '2'"
                type="danger"
                size="small"
                >2人间</el-tag
              >
              <el-tag
                v-if="scope.row.rootType == '4'"
                type="success"
                size="small"
                >4人间</el-tag
              >
              <el-tag
                v-if="scope.row.rootType == '6'"
                type="warning"
                size="small"
                >6人间</el-tag
              >
            </template>
          </el-table-column>
          <el-table-column
            align="center"
            prop="totalBed"
            label="人数"
          ></el-table-column>
          <el-table-column align="center" label="操作" width="200">
            <template slot-scope="scope">
              <el-button
                icon="el-icon-edit"
                type="primary"
                size="small"
                @click="editBtn(scope.row)"
                >编辑</el-button
              >
              <el-button
                icon="el-icon-delete"
                type="danger"
                size="small"
                @click="deleteBtn(scope.row)"
                >删除</el-button
              >
            </template>
          </el-table-column>
        </el-table>
        <!-- <el-table
          :height="tableHeight"
          style="margin-top: 10px"
          :data="tableList"
          border
          stripe
        >
          <el-table-column
            align="center"
            prop="roomCode"
            label="宿舍编号"
          ></el-table-column>
          <el-table-column align="center" prop="roomCode" label="宿舍类型">
            <template slot-scope="scope">
              <el-tag v-if="scope.row.rootType == '1'" size="small"
                >1人间</el-tag
              >
              <el-tag
                v-if="scope.row.rootType == '2'"
                type="danger"
                size="small"
                >2人间</el-tag
              >
              <el-tag
                v-if="scope.row.rootType == '4'"
                type="success"
                size="small"
                >4人间</el-tag
              >
              <el-tag
                v-if="scope.row.rootType == '6'"
                type="warning"
                size="small"
                >6人间</el-tag
              >
            </template>
          </el-table-column>
          <el-table-column
            align="center"
            prop="totalBed"
            label="人数"
          ></el-table-column>
          <el-table-column align="center" label="操作" width="200">
            <template slot-scope="scope">
              <el-button
                icon="el-icon-edit"
                type="primary"
                size="small"
                @click="editBtn(scope.row)"
                >编辑</el-button
              >
              <el-button
                icon="el-icon-delete"
                type="danger"
                size="small"
                @click="deleteBtn(scope.row)"
                >删除</el-button
              >
            </template>
          </el-table-column>
        </el-table> -->
        <!-- 分页 -->
        <el-pagination
          @size-change="sizeChange"
          @current-change="currentChange"
          :current-page.sync="listParm.currentPage"
          :page-sizes="[10, 20, 40, 80, 100]"
          :page-size="listParm.pageSize"
          layout="total, sizes, prev, pager, next, jumper"
          :total="listParm.total"
          background
        >
        </el-pagination>
      </el-main>
    </el-container>
    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="area" label="区域">
            <el-input v-model="addModel.area"></el-input>
          </el-form-item>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="start" label="起始编号">
                <el-input v-model="addModel.start"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="end" label="结束编号">
                <el-input v-model="addModel.end"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item prop="rootType" label="类型">
            <el-select
              @change="selectChange"
              v-model="addModel.rootType"
              placeholder="请选择"
            >
              <el-option
                v-for="item in options"
                :key="item.value"
                :label="item.label"
                :value="item.value"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="stuNum" label="人数">
            <el-input v-model="addModel.stuNum"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
    <!-- 编辑弹框 -->
    <sys-dialog
      :title="editDialog.title"
      :height="editDialog.height"
      :width="editDialog.width"
      :visible="editDialog.visible"
      @onClose="editClose"
      @onConfirm="editConfirm"
    >
      <div slot="content">
        <el-form
          :model="editModel"
          ref="editForm"
          :rules="editRules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="roomCode" label="宿舍编号">
            <el-input v-model="editModel.roomCode"></el-input>
          </el-form-item>
          <el-form-item prop="rootType" label="类型">
            <el-select
              style="width: 100%"
              @change="editSelectChange"
              v-model="editModel.rootType"
              placeholder="请选择"
            >
              <el-option
                v-for="item in options"
                :key="item.value"
                :label="item.label"
                :value="item.value"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="totalBed" label="容纳人数">
            <el-input v-model="editModel.totalBed"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
    <!-- 床位编辑弹框 -->
    <sys-dialog
      :title="childDialog.title"
      :height="childDialog.height"
      :width="childDialog.width"
      :visible="childDialog.visible"
      @onClose="childClose"
      @onConfirm="childConfirm"
    >
      <div slot="content">
        <el-form
          :model="childModel"
          ref="childForm"
          :rules="childRules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="bedCode" label="床位编号">
            <el-input v-model="childModel.bedCode"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getBuildListApi, getDestoryListApi } from "@/api/build.js";
import { editChildApi, deleteChildApi } from "@/api/setCode.js";
import {
  addApi,
  getStoreyListApi,
  editApi,
  deleteApi,
  initBedApi,
} from "@/api/setCode.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      childRules: {
        bedCode: [
          {
            trigger: "blur",
            required: true,
            message: "请填写床位编号",
          },
        ],
      },
      childModel: {
        bedId: "",
        roomId: "",
        bedCode: "",
      },
      //编辑弹框
      childDialog: {
        title: "",
        height: 100,
        width: 650,
        visible: false,
      },
      storeyId: "",
      //表单验证规则
      editRules: {
        rootType: [
          {
            trigger: "blur",
            required: true,
            message: "请选择类型",
          },
        ],
        roomCode: [
          {
            trigger: "blur",
            required: true,
            message: "请填写编号",
          },
        ],
        totalBed: [
          {
            trigger: "blur",
            required: true,
            message: "请填写人数",
          },
        ],
      },
      //编辑绑定的对象
      editModel: {
        roomId: "",
        storeyId: "",
        rootType: "",
        roomCode: "",
        totalBed: "",
      },
      //编辑弹框属性
      editDialog: {
        title: "",
        height: 180,
        width: 650,
        visible: false,
      },
      tableHeight: 0,
      //类型数据
      options: [
        {
          value: "1",
          label: "1人间",
        },
        {
          value: "2",
          label: "2人间",
        },
        {
          value: "4",
          label: "4人间",
        },
        {
          value: "6",
          label: "6人间",
        },
      ],
      //表单验证规则
      rules: {
        start: [
          {
            trigger: "blur",
            required: true,
            message: "请填写起始编号",
          },
        ],
        end: [
          {
            trigger: "blur",
            required: true,
            message: "请填写结束编号",
          },
        ],
        stuNum: [
          {
            trigger: "blur",
            required: true,
            message: "请填写人数",
          },
        ],
        rootType: [
          {
            trigger: "blur",
            required: true,
            message: "请选择类型",
          },
        ],
      },
      //新增弹框绑定的对象
      addModel: {
        area: "",
        start: "",
        end: "",
        stuNum: "",
        storeyId: "",
        rootType: "",
      },
      //新增弹框属性
      addDialog: {
        title: "",
        height: 250,
        width: 650,
        visible: false,
      },
      //点击颜色切换状态
      isDestory: 0,
      isChange: 0,
      buildList: [],
      destoryList: [],
      leftHeight: 0,
      rightHeight: 0,
      listParm: {
        currentPage: 1,
        pageSize: 10,
        total: 0,
        storeyId: "",
      },
      tableList: [],
    };
  },
  created() {
    this.getBuildList();
  },
  mounted() {
    this.$nextTick(() => {
      this.leftHeight = window.innerHeight - 230;
      this.rightHeight = window.innerHeight - 230;
      this.tableHeight = window.innerHeight - 350;
    });
  },
  methods: {
    childClose() {
      this.childDialog.visible = false;
    },
    childConfirm() {
      this.$refs.childForm.validate(async (valid) => {
        if (valid) {
          let res = await editChildApi(this.childModel);
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.getList();
            this.childDialog.visible = false;
          }
        }
      });
    },
    //床位删除
    async childDelete(row) {
      const confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteChildApi({
          bedId: row.bedId,
        });
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          this.getList();
        }
      }
    },
    //床位编辑
    childEdit(row) {
      this.childDialog.title = "编辑";
      this.childDialog.visible = true;
      //把编辑的数据回显
      this.$objCoppy(row, this.childModel);
    },
    //初始化床位
    async initBed() {
      if (!this.storeyId) {
        this.$message.error("请选择层数");
        return;
      }
      let res = await initBedApi({
        storeyId: this.storeyId,
      });
      if (res && res.code == 200) {
        this.$message.success(res.msg);
        this.getList();
      }
    },
    editSelectChange(val) {
      this.editModel.totalBed = val;
    },
    //编辑确定
    editConfirm() {
      this.$refs.editForm.validate(async (valid) => {
        if (valid) {
          let res = await editApi(this.editModel);
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.getList();
            this.editDialog.visible = false;
          }
        }
      });
    },
    //编辑关闭
    editClose() {
      this.editDialog.visible = false;
    },
    async deleteBtn(row) {
      let confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteApi({
          roomId: row.roomId,
        });
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          this.getList();
        }
      }
    },
    editBtn(row) {
      //清空表单
      this.$resetForm("editForm", this.editModel);
      //设置弹框属性
      this.editDialog.title = "编辑编号";
      this.editDialog.visible = true;
      //设置编辑 数据回显
      this.$objCoppy(row, this.editModel);
      console.log(this.editModel);
    },
    //页数改变时触发
    currentChange(val) {
      this.listParm.currentPage = val;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.listParm.pageSize = val;
      this.listParm.currentPage = 1;
      this.getList();
    },
    //获取表格数据
    async getList() {
      let res = await getStoreyListApi(this.listParm);
      if (res && res.code == 200) {
        //设置表格数据
        this.tableList = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    selectChange(val) {
      this.addModel.stuNum = val;
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置弹框属性
      this.addDialog.title = "设置编号";
      this.addDialog.visible = true;
      this.addModel.storeyId = this.storeyId;
    },
    //新增弹框确定
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = await addApi(this.addModel);
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.getList();
            this.addDialog.visible = false;
          }
        }
      });
    },
    //新增弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    //层数点击事件
    storyClick(storeyId, index) {
      console.log("层数点击");
      this.isDestory = index;
      this.storeyId = storeyId;
      this.listParm.storeyId = storeyId;
      this.getList();
    },
    //楼栋点击事件
    btnClick(buildId, index) {
      console.log(index);
      this.isChange = index;
      this.isDestory = 0;
      this.getDestoryList(buildId);
    },
    //获取层数列表
    async getDestoryList(buildId) {
      let res = await getDestoryListApi({
        buildId: buildId,
      });
      if (res && res.code == 200) {
        console.log(res);
        this.destoryList = res.data;
        this.$nextTick(() => {
          document.querySelector("#storey0").click();
        });
      }
    },
    //获取楼栋列表
    async getBuildList() {
      let res = await getBuildListApi();
      if (res && res.code == 200) {
        this.buildList = res.data;
        //点击第一个楼栋,一定要放到 nextTick里面
        this.$nextTick(() => {
          document.querySelector("#build0").click();
        });
      }
    },
  },
};
</script>

<style lang="scss" scoped>
.build-main {
  padding-top: 0px;
}
.build-list {
  display: flex;
  flex-wrap: wrap;
}
.build-item {
  display: flex;
  padding: 8px 30px;
  margin: 10px;
  font-size: 14px;
  border: 1px solid #dedede;
  border-radius: 4px;
  cursor: pointer;
  background: #f8f8f8;
}
.isActive {
  background: #42b983;
  color: #fff;
}
.containers {
  margin-top: 20px;
  border: 1px solid #dcdfe6;
}
.leftAsside {
  border-right: 1px solid #dcdfe6;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.storey-item {
  padding: 8px 30px;
  margin: 10px 10px;
  font-size: 14px;
  border: 1px solid #dedede;
  border-radius: 4px;
  cursor: pointer;
  background-color: #f8f8f8;
}
.destoryActive {
  background: #5fb878 !important;
  border-color: #5fb878 !important;
  color: #fff;
}
.mains {
  padding-top: 10px;
}
</style>
```







#### 第70讲  宿舍管理页面布局

##### 1、houseList.vue页面

```js
<template>
  <el-main class="build-main">
    <!-- 楼栋布局 -->
    <div class="build-list">
      <div
        class="build-item"
        :id="'build' + index"
        @click="btnClick(item.buildId, index)"
        v-for="(item, index) in buildList"
        :key="index"
        :class="{ isActive: isChange === index }"
      >
        {{ item.buildName }}
      </div>
    </div>
    <el-container class="containers">
      <el-aside
        class="leftAsside"
        :style="{ height: leftHeight + 'px' }"
        width="150px"
      >
        <div
          v-for="(item, index) in destoryList"
          :key="index"
          :id="'storey' + index"
          class="storey-item"
          :class="{ destoryActive: isDestory === index }"
          @click="storyClick(item.storeyId, index)"
        >
          {{ item.storeyName }}
        </div>
      </el-aside>
      <el-main class="mains">
        <!-- 表格 -->
        <el-collapse
          style="overflow-y: auto"
          accordion
          :style="{ height: accordionHeight + 'px' }"
        >
          <el-collapse-item
            class="collapse-main"
            v-for="(item, index) in tableList"
            :key="index"
          >
            <template slot="title" class="room-title-header">
              <span class="room-title">{{ item.roomCode }}宿舍</span>
              <span class="room-type" v-if="item.rootType == '1'">1人间</span>
              <span class="room-type" v-if="item.rootType == '2'">2人间</span>
              <span class="room-type" v-if="item.rootType == '4'">4人间</span>
              <span class="room-type" v-if="item.rootType == '6'">6人间</span>
              <span class="room-type">(共{{ item.totalBed }}个床位)</span>
            </template>
            <!-- 床位列表 -->
            <div class="bedList">
              <div
                class="bed-item"
                v-for="(bed, bindex) in item.bedList"
                :key="bindex"
              >
                <span class="num-text">{{ bed.bedCode }}</span>
                <div class="bed-main">
                  <svg-icon class="bed-svg" icon-class="bed-no" />
                  <!-- <div style="color: #aeb5b5">暂未分配</div> -->
                  <div class="stuInfo">
                    <div>
                      <div>
                        <span>姓名：</span>
                        <span>杨明</span>
                      </div>
                      <div>
                        <span>班级：</span>
                        <span>软件工程1班</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </el-collapse-item>
        </el-collapse>
        <!-- 分页 -->
        <el-pagination
          @size-change="sizeChange"
          @current-change="currentChange"
          :current-page.sync="listParm.currentPage"
          :page-sizes="[10, 20, 40, 80, 100]"
          :page-size="listParm.pageSize"
          layout="total, sizes, prev, pager, next, jumper"
          :total="listParm.total"
          background
        >
        </el-pagination>
      </el-main>
    </el-container>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getBuildListApi, getDestoryListApi } from "@/api/build.js";
import { editChildApi, deleteChildApi } from "@/api/setCode.js";
import { getStoreyListApi, editApi, deleteApi } from "@/api/setCode.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      accordionHeight: 0,
      storeyId: "",
      //点击颜色切换状态
      isDestory: 0,
      isChange: 0,
      buildList: [],
      destoryList: [],
      leftHeight: 0,
      rightHeight: 0,
      listParm: {
        currentPage: 1,
        pageSize: 10,
        total: 0,
        storeyId: "",
      },
      tableList: [],
    };
  },
  created() {
    this.getBuildList();
  },
  mounted() {
    this.$nextTick(() => {
      this.leftHeight = window.innerHeight - 230;
      this.rightHeight = window.innerHeight - 230;
      this.tableHeight = window.innerHeight - 350;
      this.accordionHeight = window.innerHeight - 300;
    });
  },
  methods: {
    //页数改变时触发
    currentChange(val) {
      this.listParm.currentPage = val;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.listParm.pageSize = val;
      this.listParm.currentPage = 1;
      this.getList();
    },
    //获取表格数据
    async getList() {
      let res = await getStoreyListApi(this.listParm);
      if (res && res.code == 200) {
        //设置表格数据
        this.tableList = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    selectChange(val) {
      this.addModel.stuNum = val;
    },

    //层数点击事件
    storyClick(storeyId, index) {
      console.log("层数点击");
      this.isDestory = index;
      this.storeyId = storeyId;
      this.listParm.storeyId = storeyId;
      this.getList();
    },
    //楼栋点击事件
    btnClick(buildId, index) {
      console.log(index);
      this.isChange = index;
      this.isDestory = 0;
      this.getDestoryList(buildId);
    },
    //获取层数列表
    async getDestoryList(buildId) {
      let res = await getDestoryListApi({
        buildId: buildId,
      });
      if (res && res.code == 200) {
        console.log(res);
        this.destoryList = res.data;
        this.$nextTick(() => {
          document.querySelector("#storey0").click();
        });
      }
    },
    //获取楼栋列表
    async getBuildList() {
      let res = await getBuildListApi();
      if (res && res.code == 200) {
        this.buildList = res.data;
        //点击第一个楼栋,一定要放到 nextTick里面
        this.$nextTick(() => {
          document.querySelector("#build0").click();
        });
      }
    },
  },
};
</script>

<style lang="scss" scoped>
.room-title-header {
  display: flex;
  background: #f8f8f8;
}
.collapse-main {
  background: #f8f8f8;
  border: 1px solid #dcdfe6;
  margin: 5px 0px;
}
.stuInfo {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
.bedList {
  display: flex;
  flex-wrap: wrap;
}
.room-type {
  color: #ff7670;
  flex-grow: 1;
}
.bed-main {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
.bed-item {
  border: 1px solid #dedede;
  border-radius: 4px;
  background-color: #f8f8f8;
  height: 180px;
  width: 180px;
  margin: 15px 15px;
  display: flex;
  flex-direction: column;
}
.bed-item-active {
  background: #f2feff;
  border: 1px solid #ddeff1;
  border-radius: 4px;
  height: 180px;
  width: 180px;
  margin: 15px 15px;
  display: flex;
  flex-direction: column;
}
.num-text {
  color: #8a8a8a;
}
.active-num-text {
  color: #42b983;
  font-weight: 600;
}
.bed-svg {
  font-size: 100px;
}
.build-main {
  padding-top: 25px;
  background: #f3f3f4;
}
.build-list {
  display: flex;
  flex-wrap: wrap;
  background: #fff;
}
.build-item {
  display: flex;
  padding: 8px 30px;
  margin: 10px;
  font-size: 14px;
  border: 1px solid #dedede;
  border-radius: 4px;
  cursor: pointer;
  background: #fff;
}
.isActive {
  background: #42b983;
  color: #fff;
}
.containers {
  margin-top: 20px;
  border: 1px solid #dcdfe6;
}
.room-title {
  padding-left: 15px;
  color: #5fb878;
  font-size: 13px;
  font-weight: 600;
  flex-grow: 1;
}
.leftAsside {
  border-right: 1px solid #dcdfe6;
  display: flex;
  flex-direction: column;
  align-items: center;
  background: #fff;
}
.storey-item {
  padding: 8px 30px;
  margin: 10px 10px;
  font-size: 14px;
  border: 1px solid #dedede;
  border-radius: 4px;
  cursor: pointer;
  background-color: #f8f8f8;
}
.destoryActive {
  background: #5fb878 !important;
  border-color: #5fb878 !important;
  color: #fff;
}
.mains {
  padding-top: 10px;
  background: #fff;
}
</style>
```





#### 第71讲 菜单录入讲解



#### 第72讲 登录对接改进

##### 1、修改LoginController的login方法如下

```js
package com.itmk.web.sys_login.controller;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.itmk.config.jwt.JwtUtils;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.school_student.entity.SchoolStudent;
import com.itmk.web.school_student.service.SchoolStudentService;
import com.itmk.web.sys_login.entity.LoginParm;
import com.itmk.web.sys_login.entity.LoginResult;
import com.itmk.web.sys_user.entity.SysUser;
import com.itmk.web.sys_user.service.SysUserService;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.DigestUtils;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.HashMap;
import java.util.Map;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/login")
public class LoginController {
    @Autowired
    private SysUserService sysUserService;
    @Autowired
    private JwtUtils jwtUtils;
    @Autowired
    private SchoolStudentService schoolStudentService;

    //登录
    @PostMapping("/login")
    public ResultVo login(@RequestBody LoginParm parm) {
        if (StringUtils.isEmpty(parm.getUsername()) || StringUtils.isEmpty(parm.getPassword()) || StringUtils.isEmpty(parm.getUserType())) {
            return ResultUtils.error("用户名或密码不能为空!");
        }
        //获取密码
        String password = DigestUtils.md5DigestAsHex(parm.getPassword().getBytes());
        //判断是管理员还是学生
        if (parm.getUserType().equals("1")) {
            //构造查询条件
            QueryWrapper<SysUser> query = new QueryWrapper<>();
            query.lambda().eq(SysUser::getUsername, parm.getUsername()).eq(SysUser::getPassword, password);
            SysUser user = sysUserService.getOne(query);
            if (user == null) {
                return ResultUtils.error("用户名或密码错误!");
            }
            //生成token
            Map<String, String> map = new HashMap<>();
            map.put("userId", Long.toString(user.getUserId()));
            map.put("username", user.getUsername());
            String token = jwtUtils.generateToken(map);
            //设置返回值
            LoginResult result = new LoginResult();
            result.setUserId(user.getUserId());
            result.setToken(token);
            result.setUsername(user.getUsername());
            return ResultUtils.success("登录成功", result);
        } else {
            //构造查询条件
            QueryWrapper<SchoolStudent> query = new QueryWrapper<>();
            query.lambda().eq(SchoolStudent::getStuNum,parm.getUsername())
                    .eq(SchoolStudent::getPassword,password);
            SchoolStudent student = schoolStudentService.getOne(query);
            if(student == null){
                return ResultUtils.error("用户名或密码错误!");
            }
             //生成token
            Map<String, String> map = new HashMap<>();
            map.put("userId", Long.toString(student.getStuId()));
            map.put("username", student.getStuName());
            String token = jwtUtils.generateToken(map);
            //设置返回值
            LoginResult result = new LoginResult();
            result.setUserId(student.getStuId());
            result.setToken(token);
            result.setUsername(student.getStuName());
            return ResultUtils.success("登录成功", result);
        }
    }
}

```





#### 第73讲  获取用户信息接口开发

##### 1、新建UserInfo实体类

```js
package com.itmk.web.sys_login.entity;

import lombok.Data;

@Data
public class UserInfo {
    private String name;
    private String avatar;
    private String introduction;
    private Object[] roles;
}

```

##### 2、SysMenuMapper添加getStuMenuByUserId()方法

```js
package com.itmk.web.sys_menu.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.sys_menu.entity.SysMenu;
import org.apache.ibatis.annotations.Param;

import java.util.List;

public interface SysMenuMapper extends BaseMapper<SysMenu> {
    //根据用户id查询权限
    List<SysMenu> getMenuByUserId(@Param("userId") Long userId);
    //根据角色id查询权限
    List<SysMenu> getMenuByRoleId(@Param("roleId") Long roleId);
    //根据学生id查询权限
    List<SysMenu> getStuMenuByUserId(@Param("stuId") Long stuId);
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.sys_menu.mapper.SysMenuMapper">
    <select id="getMenuByUserId" resultType="com.itmk.web.sys_menu.entity.SysMenu">
        select m.* from sys_user_role as ur
        left join sys_role as r on ur.role_id = r.role_id
        left join sys_role_menu as rm on r.role_id = rm.role_id
        left join sys_menu as m on rm.menu_id = m.menu_id
        where ur.user_id =#{userId}
    </select>
    <select id="getMenuByRoleId" resultType="com.itmk.web.sys_menu.entity.SysMenu">
        select m.* from sys_role_menu as rm ,sys_menu as m
        where rm.menu_id = m.menu_id
        and rm.role_id =#{roleId}
    </select>
    <select id="getStuMenuByUserId" resultType="com.itmk.web.sys_menu.entity.SysMenu">
        select m.* from stu_role as ur
        left join sys_role as r on ur.role_id = r.role_id
        left join sys_role_menu as rm on r.role_id = rm.role_id
        left join sys_menu as m on rm.menu_id = m.menu_id
        where ur.stu_id =#{stuId}
    </select>
</mapper>
```

##### 3、SysMenuService接口添加getStuMenuByUserId()方法

```js
package com.itmk.web.sys_menu.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.sys_menu.entity.SysMenu;

import java.util.List;

public interface SysMenuService extends IService<SysMenu> {
    List<SysMenu> getList();
    List<SysMenu> getParentList();
    //根据用户id查询权限
    List<SysMenu> getMenuByUserId(Long userId);
    //根据角色id查询权限
    List<SysMenu> getMenuByRoleId(Long roleId);
    //根据学生id查询权限
    List<SysMenu> getStuMenuByUserId(Long stuId);
}

```

实现类

```js
package com.itmk.web.sys_menu.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.sys_menu.entity.MakeTree;
import com.itmk.web.sys_menu.entity.SysMenu;
import com.itmk.web.sys_menu.mapper.SysMenuMapper;
import com.itmk.web.sys_menu.service.SysMenuService;
import org.springframework.stereotype.Service;

import java.util.Arrays;
import java.util.List;

@Service
public class SysMenuServiceImpl extends ServiceImpl<SysMenuMapper, SysMenu> implements SysMenuService {
//    @Autowired
//    private SysMenuMapper sysMenuMapper;

    @Override
    public List<SysMenu> getList() {
        //查询出所有的菜单
        QueryWrapper<SysMenu> query = new QueryWrapper<>();
        query.lambda().orderByAsc(SysMenu::getOrderNum);
        List<SysMenu> menuList = this.baseMapper.selectList(query);
        //组装树
        List<SysMenu> sysMenus = MakeTree.makeMenuTree(menuList, 0L);
        return sysMenus;
    }

    @Override
    public List<SysMenu> getParentList() {
        //查询类型,只查类型为目录和菜单的
        String[] types = {"0","1"};
        //构造查询条件
        QueryWrapper<SysMenu> query = new QueryWrapper<>();
        query.lambda().in(SysMenu::getType,Arrays.asList(types)).orderByAsc(SysMenu::getOrderNum);
        List<SysMenu> menuList = this.baseMapper.selectList(query);
        //构造一个顶级菜单
        SysMenu menu = new SysMenu();
        menu.setMenuId(0L);
        menu.setTitle("顶级菜单");
        menu.setParentId(-1L);
        menuList.add(menu);
        //组装数据
        List<SysMenu> sysMenus = MakeTree.makeMenuTree(menuList, -1L);
        return sysMenus;
    }

    @Override
    public List<SysMenu> getMenuByUserId(Long userId) {
        return this.baseMapper.getMenuByUserId(userId);
    }

    @Override
    public List<SysMenu> getMenuByRoleId(Long roleId) {
        return this.baseMapper.getMenuByRoleId(roleId);
    }

    @Override
    public List<SysMenu> getStuMenuByUserId(Long stuId) {
        return this.baseMapper.getStuMenuByUserId(stuId);
    }
}

```

##### 4、LoginController添加getInfo()方法

```js
package com.itmk.web.sys_login.controller;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.itmk.config.jwt.JwtUtils;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.school_student.entity.SchoolStudent;
import com.itmk.web.school_student.service.SchoolStudentService;
import com.itmk.web.sys_login.entity.LoginParm;
import com.itmk.web.sys_login.entity.LoginResult;
import com.itmk.web.sys_login.entity.UserInfo;
import com.itmk.web.sys_menu.entity.SysMenu;
import com.itmk.web.sys_menu.service.SysMenuService;
import com.itmk.web.sys_user.entity.SysUser;
import com.itmk.web.sys_user.service.SysUserService;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.DigestUtils;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/login")
public class LoginController {
    @Autowired
    private SysUserService sysUserService;
    @Autowired
    private JwtUtils jwtUtils;
    @Autowired
    private SchoolStudentService schoolStudentService;
    @Autowired
    private SysMenuService sysMenuService;

    //登录
    @PostMapping("/login")
    public ResultVo login(@RequestBody LoginParm parm) {
        if (StringUtils.isEmpty(parm.getUsername()) || StringUtils.isEmpty(parm.getPassword()) || StringUtils.isEmpty(parm.getUserType())) {
            return ResultUtils.error("用户名或密码不能为空!");
        }
        //获取密码
        String password = DigestUtils.md5DigestAsHex(parm.getPassword().getBytes());
        //判断是管理员还是学生
        if (parm.getUserType().equals("1")) {
            //构造查询条件
            QueryWrapper<SysUser> query = new QueryWrapper<>();
            query.lambda().eq(SysUser::getUsername, parm.getUsername()).eq(SysUser::getPassword, password);
            SysUser user = sysUserService.getOne(query);
            if (user == null) {
                return ResultUtils.error("用户名或密码错误!");
            }
            //生成token
            Map<String, String> map = new HashMap<>();
            map.put("userId", Long.toString(user.getUserId()));
            map.put("username", user.getUsername());
            String token = jwtUtils.generateToken(map);
            //设置返回值
            LoginResult result = new LoginResult();
            result.setUserId(user.getUserId());
            result.setToken(token);
            result.setUsername(user.getUsername());
            result.setUserType(parm.getUserType());
            return ResultUtils.success("登录成功", result);
        } else {
            //构造查询条件
            QueryWrapper<SchoolStudent> query = new QueryWrapper<>();
            query.lambda().eq(SchoolStudent::getStuNum,parm.getUsername())
                    .eq(SchoolStudent::getPassword,password);
            SchoolStudent student = schoolStudentService.getOne(query);
            if(student == null){
                return ResultUtils.error("用户名或密码错误!");
            }
             //生成token
            Map<String, String> map = new HashMap<>();
            map.put("userId", Long.toString(student.getStuId()));
            map.put("username", student.getStuName());
            String token = jwtUtils.generateToken(map);
            //设置返回值
            LoginResult result = new LoginResult();
            result.setUserId(student.getStuId());
            result.setToken(token);
            result.setUsername(student.getStuName());
            result.setUserType(parm.getUserType());
            return ResultUtils.success("登录成功", result);
        }
    }

    //获取用户权限信息
    @GetMapping("/getInfo")
    public ResultVo getInfo(String userType,Long userId){
        if(userType.equals("0")){ // 0：学生
            //获取学生信息
            SchoolStudent student = schoolStudentService.getById(userId);
            UserInfo userInfo = new UserInfo();
            userInfo.setName(student.getStuName());
            userInfo.setIntroduction(student.getStuName());
            userInfo.setAvatar("https://wpimg.wallstcn.com/f778738c-e4f8-4870-b634-56703b4acafe.gif");
            //获取学生权限字段
            List<SysMenu> menuList = sysMenuService.getStuMenuByUserId(userId);
            List<String> collect = menuList.stream().filter(item -> item != null && item.getCode() != null && StringUtils.isNotEmpty(item.getCode()))
                    .map(item -> item.getCode()).collect(Collectors.toList());
            if(collect.size() == 0){
                return ResultUtils.error("未分配权限，请联系管理员!");
            }
            String[] array = collect.toArray(new String[collect.size()]);
            userInfo.setRoles(array);
            return ResultUtils.success("查询成功",userInfo);
        }else{
            //获取管理员信息
            SysUser user = sysUserService.getById(userId);
            //设置用户信息
            UserInfo userInfo = new UserInfo();
            userInfo.setName(user.getUsername());
            userInfo.setIntroduction(user.getNickName());
            userInfo.setAvatar("https://wpimg.wallstcn.com/f778738c-e4f8-4870-b634-56703b4acafe.gif");
            List<SysMenu> menuList = null;
            if(user.getIsAdmin().equals("1")){
                 menuList = sysMenuService.list();
            }else{
                menuList = sysMenuService.getMenuByUserId(userId);
            }
            List<String> collect = menuList.stream().filter(item -> item != null && item.getCode() != null && StringUtils.isNotEmpty(item.getCode()))
                    .map(item -> item.getCode()).collect(Collectors.toList());
            if(collect.size() == 0){
                return ResultUtils.error("未分配权限，请联系管理员!");
            }
            String[] array = collect.toArray(new String[collect.size()]);
            userInfo.setRoles(array);
            return ResultUtils.success("查询成功",userInfo);
        }
    }
}

```





#### 第74讲 动态菜单接口开发

##### 1、新建实体类

```js
package com.itmk.web.sys_menu.entity;


import com.fasterxml.jackson.annotation.JsonInclude;
import lombok.AllArgsConstructor;
import lombok.Data;

import java.util.ArrayList;
import java.util.List;

/**
 * 路由需要的数据格式
 */
@Data
@JsonInclude(JsonInclude.Include.NON_EMPTY)
public class RouterVO {

    private String path;

    private String component;

    private boolean alwaysShow;

    private String name;

    private Meta meta;

    @Data
    @AllArgsConstructor
    public class Meta {
        private String title;
        private String icon;
        private Object[] roles;
    }
    private List<RouterVO> children =new ArrayList<>();

}
```

##### 2、MakeTree工具新增生成路由的方法makeRouter()

```js
package com.itmk.web.sys_menu.entity;

import org.springframework.beans.BeanUtils;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
//生成树的工具类
public class MakeTree {
    public static List<SysMenu> makeMenuTree(List<SysMenu> menuList, Long pid) {
        //定义一个组装树的容器
        List<SysMenu> list = new ArrayList<>();
        Optional.ofNullable(menuList).orElse(new ArrayList<>())
                .stream()
                .filter(item -> item != null && item.getParentId() == pid)
                .forEach(dom -> {
                    SysMenu menu = new SysMenu();
                    BeanUtils.copyProperties(dom, menu);
                    //查询下级菜单，递归调用
                    List<SysMenu> children = makeMenuTree(menuList, dom.getMenuId());
                    menu.setChildren(children);
                    list.add(menu);
                });
        return list;
    }

     /**
     * 生成路由数据格式
     */
    public static List<RouterVO> makeRouter(List<SysMenu> menuList, Long pid){
        //接受生产的路由数据
        List<RouterVO> list = new ArrayList<>();
        //组装数据
        Optional.ofNullable(menuList).orElse(new ArrayList<>())
                .stream()
                .filter(item ->item != null && item.getParentId() == pid)
                .forEach(item ->{
                    RouterVO router = new RouterVO();
                    router.setName(item.getName());
                    router.setPath(item.getPath());
                    //判断是否是一级菜单
                    if(item.getParentId() == 0L){
                        router.setComponent("Layout");
                        router.setAlwaysShow(true);
                    }else{
                        router.setComponent(item.getUrl());
                        router.setAlwaysShow(false);
                    }
                    //设置meta
                    router.setMeta(router.new Meta(
                            item.getTitle(),
                            item.getIcon(),
                            item.getCode().split(",")
                    ));
                    //设置children
                    List<RouterVO> children = makeRouter(menuList, item.getMenuId());
                    router.setChildren(children);
                    if(router.getChildren().size() > 0){
                        router.setAlwaysShow(true);
                    }
                    list.add(router);
                });
        return list;
    }
}

```

##### 3、LoginController控制器添加getMenuList()方法

```js
package com.itmk.web.sys_login.controller;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.itmk.config.jwt.JwtUtils;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.school_student.entity.SchoolStudent;
import com.itmk.web.school_student.service.SchoolStudentService;
import com.itmk.web.sys_login.entity.LoginParm;
import com.itmk.web.sys_login.entity.LoginResult;
import com.itmk.web.sys_login.entity.UserInfo;
import com.itmk.web.sys_menu.entity.MakeTree;
import com.itmk.web.sys_menu.entity.RouterVO;
import com.itmk.web.sys_menu.entity.SysMenu;
import com.itmk.web.sys_menu.service.SysMenuService;
import com.itmk.web.sys_user.entity.SysUser;
import com.itmk.web.sys_user.service.SysUserService;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.DigestUtils;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/login")
public class LoginController {
    @Autowired
    private SysUserService sysUserService;
    @Autowired
    private JwtUtils jwtUtils;
    @Autowired
    private SchoolStudentService schoolStudentService;
    @Autowired
    private SysMenuService sysMenuService;

    //登录
    @PostMapping("/login")
    public ResultVo login(@RequestBody LoginParm parm) {
        if (StringUtils.isEmpty(parm.getUsername()) || StringUtils.isEmpty(parm.getPassword()) || StringUtils.isEmpty(parm.getUserType())) {
            return ResultUtils.error("用户名或密码不能为空!");
        }
        //获取密码
        String password = DigestUtils.md5DigestAsHex(parm.getPassword().getBytes());
        //判断是管理员还是学生
        if (parm.getUserType().equals("1")) {
            //构造查询条件
            QueryWrapper<SysUser> query = new QueryWrapper<>();
            query.lambda().eq(SysUser::getUsername, parm.getUsername()).eq(SysUser::getPassword, password);
            SysUser user = sysUserService.getOne(query);
            if (user == null) {
                return ResultUtils.error("用户名或密码错误!");
            }
            //生成token
            Map<String, String> map = new HashMap<>();
            map.put("userId", Long.toString(user.getUserId()));
            map.put("username", user.getUsername());
            String token = jwtUtils.generateToken(map);
            //设置返回值
            LoginResult result = new LoginResult();
            result.setUserId(user.getUserId());
            result.setToken(token);
            result.setUsername(user.getUsername());
            result.setUserType(parm.getUserType());
            return ResultUtils.success("登录成功", result);
        } else {
            //构造查询条件
            QueryWrapper<SchoolStudent> query = new QueryWrapper<>();
            query.lambda().eq(SchoolStudent::getStuNum,parm.getUsername())
                    .eq(SchoolStudent::getPassword,password);
            SchoolStudent student = schoolStudentService.getOne(query);
            if(student == null){
                return ResultUtils.error("用户名或密码错误!");
            }
             //生成token
            Map<String, String> map = new HashMap<>();
            map.put("userId", Long.toString(student.getStuId()));
            map.put("username", student.getStuName());
            String token = jwtUtils.generateToken(map);
            //设置返回值
            LoginResult result = new LoginResult();
            result.setUserId(student.getStuId());
            result.setToken(token);
            result.setUsername(student.getStuName());
            result.setUserType(parm.getUserType());
            return ResultUtils.success("登录成功", result);
        }
    }

    //获取用户权限信息
    @GetMapping("/getInfo")
    public ResultVo getInfo(String userType,Long userId){
        if(userType.equals("0")){ // 0：学生
            //获取学生信息
            SchoolStudent student = schoolStudentService.getById(userId);
            UserInfo userInfo = new UserInfo();
            userInfo.setName(student.getStuName());
            userInfo.setIntroduction(student.getStuName());
            userInfo.setAvatar("https://wpimg.wallstcn.com/f778738c-e4f8-4870-b634-56703b4acafe.gif");
            //获取学生权限字段
            List<SysMenu> menuList = sysMenuService.getStuMenuByUserId(userId);
            List<String> collect = menuList.stream().filter(item -> item != null && item.getCode() != null && StringUtils.isNotEmpty(item.getCode()))
                    .map(item -> item.getCode()).collect(Collectors.toList());
            if(collect.size() == 0){
                return ResultUtils.error("未分配权限，请联系管理员!");
            }
            String[] array = collect.toArray(new String[collect.size()]);
            userInfo.setRoles(array);
            return ResultUtils.success("查询成功",userInfo);
        }else{
            //获取管理员信息
            SysUser user = sysUserService.getById(userId);
            //设置用户信息
            UserInfo userInfo = new UserInfo();
            userInfo.setName(user.getUsername());
            userInfo.setIntroduction(user.getNickName());
            userInfo.setAvatar("https://wpimg.wallstcn.com/f778738c-e4f8-4870-b634-56703b4acafe.gif");
            List<SysMenu> menuList = null;
            if(user.getIsAdmin().equals("1")){
                 menuList = sysMenuService.list();
            }else{
                menuList = sysMenuService.getMenuByUserId(userId);
            }
            List<String> collect = menuList.stream().filter(item -> item != null && item.getCode() != null && StringUtils.isNotEmpty(item.getCode()))
                    .map(item -> item.getCode()).collect(Collectors.toList());
            if(collect.size() == 0){
                return ResultUtils.error("未分配权限，请联系管理员!");
            }
            String[] array = collect.toArray(new String[collect.size()]);
            userInfo.setRoles(array);
            return ResultUtils.success("查询成功",userInfo);
        }
    }

    @GetMapping("/getMenuList")
    public ResultVo getMenuList(Long userId,String userType){
        //根据用户id查询菜单
        List<SysMenu> menuList = null;
        if(userType.equals("1")){
            menuList = sysMenuService.getMenuByUserId(userId);
        }else{
            menuList = sysMenuService.getStuMenuByUserId(userId);
        }
        if(menuList == null || menuList.size() == 0){
            return ResultUtils.error("未分配权限，请联系管理员!");
        }
        List<SysMenu> collect = menuList.stream().filter(item -> item != null && !item.getType().equals("2")).collect(Collectors.toList());
        //组装路由格式的数据
        List<RouterVO> router = MakeTree.makeRouter(collect, 0L);
        return ResultUtils.success("查询成功",router);
    }
}

```





#### 第75讲  动态菜单、动态路由对接讲解



#### 第76讲 分配宿舍页面制作1

##### 1、添加分配菜单的数据  

 assignRoom     /drom/assignRoom

##### 2、新建实体类

```js
package com.itmk.web.school_class.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class AssignClass {
    private Long classId;
    private Long majorId;
    private String className;
    private String classYear;
    private Integer orderNum;
    private Integer stuCount;
    private Integer manCount;
    private Integer girlCount;
}

```

```js
package com.itmk.web.school_class.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class AssignClassParm {
    private Long currentPage;
    private Long pageSize;
    private String className;
    private String classYear;
}

```

##### 3、SchoolClassMapper层添加getAssignClass()方法

```js
package com.itmk.web.school_class.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.web.school_class.entity.AssignClass;
import com.itmk.web.school_class.entity.AssignClassParm;
import com.itmk.web.school_class.entity.ListParm;
import com.itmk.web.school_class.entity.SchoolClass;
import org.apache.ibatis.annotations.Param;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface SchoolClassMapper extends BaseMapper<SchoolClass> {
    //编辑回显
    SchoolClass getSchoolClassById(@Param("classId") Long classId);
    //查询列表
    IPage<SchoolClass> getList(IPage<SchoolClass> page, @Param("parm")ListParm parm);
    //分配宿舍，班级列表
    IPage<AssignClass> getAssignClass(IPage<AssignClass> page,@Param("parm") AssignClassParm parm);
}

```

SchoolClassMapper.xml映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.school_class.mapper.SchoolClassMapper">
    <select id="getSchoolClassById" resultType="com.itmk.web.school_class.entity.SchoolClass">
        SELECT sc.* ,scc.collage_id FROM  school_class as sc
        left join school_major as sm  on sm.major_id = sc.major_id
        left join school_collage as scc on scc.collage_id = sm.collage_id
        where  sc.class_id =#{classId}
    </select>

    <select id="getList" resultType="com.itmk.web.school_class.entity.SchoolClass">
        SELECT sc.* ,scc.collage_name,sm.major_name FROM  school_class as sc
        left join school_major as sm  on sm.major_id = sc.major_id
        left join school_collage as scc on scc.collage_id = sm.collage_id
        where  1=1
        <if test="parm.className != null and parm.className !=''">
           and sc.class_name like concat('%',#{parm.className},'%')
        </if>
        <if test="parm.majorName != null and parm.majorName !=''">
           and sm.major_name like concat('%',#{parm.majorName},'%')
        </if>
        <if test="parm.collageName != null and parm.collageName !=''">
          and  scc.collage_name like concat('%',#{parm.collageName},'%')
        </if>
    </select>

    <select id="getAssignClass" resultType="com.itmk.web.school_class.entity.AssignClass">
        select sc.*, count(ss.class_id) as stu_count,sum(case when ss.sex ='0' then 1 else 0 end) as man_count,sum(case when ss.sex ='1' then 1 else 0 end) as girl_count
        from school_class as sc  left join school_student as ss on ss.class_id = sc.class_id
        where 1=1
        <if test="parm.classYear != null and parm.classYear != ''">
            and sc.class_year =#{parm.classYear}
        </if>
        <if test="parm.className != null and parm.className != ''">
             and sc.class_name like concat('%',#{parm.className},'%')
        </if>
        group by sc.class_id
        order by sc.class_year desc
    </select>
</mapper>
```

##### 4、SchoolClassService接口添加getAssignClass()方法

```js
package com.itmk.web.school_class.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.school_class.entity.AssignClass;
import com.itmk.web.school_class.entity.AssignClassParm;
import com.itmk.web.school_class.entity.ListParm;
import com.itmk.web.school_class.entity.SchoolClass;


/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface SchoolClassService extends IService<SchoolClass> {
    SchoolClass getSchoolClassById(Long classId);
      //查询列表
    IPage<SchoolClass> getList(ListParm parm);
    //分配宿舍，班级列表
    IPage<AssignClass> getAssignClass(AssignClassParm parm);
}

```

实现类

```js
package com.itmk.web.school_class.service.impl;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.school_class.entity.AssignClass;
import com.itmk.web.school_class.entity.AssignClassParm;
import com.itmk.web.school_class.entity.ListParm;
import com.itmk.web.school_class.entity.SchoolClass;
import com.itmk.web.school_class.mapper.SchoolClassMapper;
import com.itmk.web.school_class.service.SchoolClassService;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class SchoolClassServiceImpl extends ServiceImpl<SchoolClassMapper, SchoolClass> implements SchoolClassService {
    @Override
    public SchoolClass getSchoolClassById(Long classId) {
        return this.baseMapper.getSchoolClassById(classId);
    }

    @Override
    public IPage<SchoolClass> getList(ListParm parm) {
        //构造分页对象
        IPage<SchoolClass> page = new Page<>(parm.getCurrentPage(),parm.getPageSize());
        return this.baseMapper.getList(page,parm);
    }

    @Override
    public IPage<AssignClass> getAssignClass(AssignClassParm parm) {
        IPage<AssignClass> page = new Page<>(parm.getCurrentPage(),parm.getPageSize());
        return this.baseMapper.getAssignClass(page,parm);
    }
}

```

##### 5、SchoolClassController控制器添加getAssignClass()方法

```js
	//分配宿舍，班级列表
    @GetMapping("/getAssignClass")
    public ResultVo getAssignClass(AssignClassParm parm){
        IPage<AssignClass> classes = schoolClassService.getAssignClass(parm);
        return ResultUtils.success("查询成功",classes);
    }
```

##### 6、classes.js添加getAssignClassApi()方法

```js
import http from "@/utils/http";
//根据学院id查询专业列表
export const getMajorListApi = async(parm)=>{
    return http.get("/api/class/getMajorList",parm)
}
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/class",parm)
}
//列表
export const getListApi = async(parm)=>{
    return await http.get("/api/class/list",parm)
}
//编辑
export const editApi = async(parm)=>{
    return await http.put("/api/class",parm)
}
//删除
export const deleteApi = async(parm)=>{
    return await http.delete("/api/class",parm)
}
//根据id查询编辑的数据
export const getClassByIdApi = async(parm)=>{
    return await http.get("/api/class/getClassById",parm)
}
//分配宿舍，查询班级
export const getAssignClassApi = async(parm)=>{
    return await http.get("/api/class/getAssignClass",parm)
}
```

##### 7、drom目录下新建assignRoom.vue页面

```js
<template>
  <el-container>
    <el-header class="header">
      <el-form :model="searchModel" :inline="true" size="small">
        <el-form-item style="margin-top: 0px; margin-bottom: 0px">
          <el-date-picker
            style="width: 100%"
            v-model="searchModel.classYear"
            type="year"
            placeholder="选择年份"
            value-format="yyyy"
          >
          </el-date-picker>
        </el-form-item>
        <el-form-item style="margin-top: 0px; margin-bottom: 0px">
          <el-input
            v-model="searchModel.className"
            placeholder="请输入班级名称"
            size="small"
          ></el-input>
        </el-form-item>
        <el-form-item style="margin-top: 0px; margin-bottom: 0px">
          <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
          <el-button
            @click="resetBtn"
            style="color: #ff7670"
            icon="el-icon-close"
            >重置</el-button
          >
        </el-form-item>
      </el-form>
    </el-header>
    <el-container>
      <el-aside class="leftside" width="230px">
        <div class="item-container" :style="{ height: assideHeight + 'px' }">
          <div
            v-for="(item, index) in classList"
            :key="index"
            class="side-item"
            @click="itemClick(item, index)"
            :class="{ isActive: isChange === index }"
          >
            <div class="item-left">
              <div class="class-title">{{ item.className }}</div>
              <div class="class-sex">
                <div class="man">男:{{ item.manCount }}人</div>
                <div class="girl">女:{{ item.girlCount }}人</div>
              </div>
            </div>
            <i class="el-icon-arrow-right item-right"></i>
          </div>
        </div>
        <!-- 分页 -->
        <el-pagination
          class="pages"
          @size-change="sizeChange"
          @current-change="currentChange"
          :current-page.sync="searchModel.currentPage"
          :page-sizes="[10, 20, 40, 80, 100]"
          :page-size="searchModel.pageSize"
          layout="prev, next"
          prev-text="上一页"
          next-text="下一页"
          :total="searchModel.total"
          small
        >
        </el-pagination>
      </el-aside>
      <el-main>Main</el-main>
    </el-container>
  </el-container>
</template>

<script>
import { getAssignClassApi } from "@/api/classes.js";
export default {
  data() {
    return {
      isChange: 0,
      searchModel: {
        classYear: "",
        currentPage: 1,
        pageSize: 10,
        className: "",
        classYear: "",
        total: 0,
      },
      assideHeight: 0,
      classList: [],
    };
  },
  created() {
    this.getAssignClass();
  },
  methods: {
    itemClick(item, index) {
      this.isChange = index;
    },
    currentChange(val) {
      this.searchModel.currentPage = val;
      this.getAssignClass();
    },
    sizeChange(val) {
      this.searchModel.pageSize = val;
      this.getAssignClass();
    },
    //重置按钮
    resetBtn() {
      this.searchModel.classYear = "";
      this.searchModel.className = "";
      this.searchModel.currentPage = 1;
      this.getAssignClass();
    },
    //搜索按钮
    searchBtn() {
      this.getAssignClass();
    },
    async getAssignClass() {
      let res = await getAssignClassApi(this.searchModel);
      if (res && res.code == 200) {
        console.log(res);
        this.classList = res.data.records;
        this.searchModel.total = res.data.total;
      }
    },
  },
  mounted() {
    this.$nextTick(() => {
      this.assideHeight = window.innerHeight - 200;
    });
  },
};
</script>

<style lang="scss" scoped>
.header {
  // height: 50px !important;
  border-bottom: 1px solid #dcdfe6;
  display: flex;
  align-items: center;
}
.item-container {
  display: flex;
  flex-direction: column;
}
.leftside {
  border-right: 1px solid #dcdfe6;
  border-bottom: 1px solid #dcdfe6;
  display: flex;
  flex-direction: column;
  .side-item {
    display: flex;
    height: 55px;
    border-bottom: 1px solid #dcdfe6;
    align-items: center;
    cursor: pointer;
    .item-left {
      padding-left: 10px;
      flex-grow: 1;
      .class-title {
        color: #686868;
        font-size: 13px;
      }
      .class-sex {
        display: flex;
        color: #999;
        font-size: 12px;
        padding-top: 8px;
        .man {
          flex-grow: 1;
        }
        .girl {
          flex-grow: 1;
        }
      }
    }
    .item-right {
      padding-right: 10px;
      color: #b2b2b2;
    }
  }
}
.pages {
  text-align: center;
}
.isActive {
  background: #f8f8f8;
}
</style>
```





#### 第77讲 分配宿舍页面制作2

##### 1、DromBuildController控制器添加getBuildListBySex()方法

```js
 //获取楼栋列表,根据学生性别 0 1
    @GetMapping("/getBuildListBySex")
    public ResultVo getBuildListBySex(String type){
        QueryWrapper<DromBuild> query = new QueryWrapper<>();
        query.lambda().eq(DromBuild::getSex,type);
        List<DromBuild> list = dromBuildService.list(query);
        return ResultUtils.success("查询成功",list);
    }
```

##### 2、build.js添加getBuildListBySexApi()方法

```js
//根据性别获取楼栋列表
export const getBuildListBySexApi = async(parm)=>{
    return await http.get("/api/build/getBuildListBySex",parm)
}
```

##### 3、assignRoom.vue页面

```js
<template>
  <el-container>
    <el-header class="header">
      <el-form :model="searchModel" :inline="true" size="small">
        <el-form-item style="margin-top: 0px; margin-bottom: 0px">
          <el-date-picker
            style="width: 100%"
            v-model="searchModel.classYear"
            type="year"
            placeholder="选择年份"
            value-format="yyyy"
          >
          </el-date-picker>
        </el-form-item>
        <el-form-item style="margin-top: 0px; margin-bottom: 0px">
          <el-input
            v-model="searchModel.className"
            placeholder="请输入班级"
          ></el-input>
        </el-form-item>
        <el-form-item style="margin-top: 0px; margin-bottom: 0px">
          <el-button icon="el-icon-search">搜索</el-button>
          <el-button style="color: #ff7670" icon="el-icon-close"
            >重置</el-button
          >
          <el-button icon="el-icon-plus" type="primary" @click="assignBtn('0')"
            >分配男生宿舍</el-button
          >
          <el-button icon="el-icon-plus" type="success" @click="assignBtn('1')"
            >分配女生宿舍</el-button
          >
        </el-form-item>
      </el-form>
    </el-header>
    <el-container>
      <el-aside width="270px" class="leftside">
        <div class="item-container" :style="{ height: assideHeight + 'px' }">
          <div
            v-for="(item, index) in classList"
            :key="index"
            class="side-item"
            :id="'class' + index"
            @click="itemClick(item, index)"
            :class="{ isActive: isChange === index }"
          >
            <div class="item-left">
              <div class="class-title">
                {{ item.className
                }}<span style="margin-left: 10px; font-size: 12px"
                  >(总共:{{ item.stuCount }}人)</span
                >
              </div>
              <div class="class-sex">
                <div class="man">男:{{ item.manCount }}人</div>
                <div class="girl">女:{{ item.girlCount }}人</div>
              </div>
            </div>
            <i class="el-icon-arrow-right item-right"></i>
          </div>
        </div>
        <!-- 分页 -->
        <el-pagination
          class="pages"
          @size-change="sizeChange"
          @current-change="currentChange"
          :current-page.sync="searchModel.currentPage"
          :page-sizes="[10, 20, 40, 80, 100]"
          :page-size="searchModel.pageSize"
          layout="prev, next"
          prev-text="上一页"
          next-text="下一页"
          :total="searchModel.total"
          small
        >
        </el-pagination>
      </el-aside>
      <el-main>Main</el-main>
    </el-container>
    <!-- 分配弹框 -->
    <sys-dialog
      :title="assignDialog.title"
      :width="assignDialog.width"
      :height="assignDialog.height"
      :visible="assignDialog.visible"
      @onConfirm="onConfirm"
      @onClose="onClose"
    >
      <div slot="content">
        <el-form :inline="true" size="small">
          <el-form-item label="楼栋">
            <el-select @change="selectBuildChange" v-model="parms.buildId" placeholder="请选择楼栋">
              <el-option
                v-for="item in buildList"
                :key="item.buildId"
                :label="item.buildName"
                :value="item.buildId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="楼层">
            <el-select  v-model="parms.storeyId" placeholder="请选择楼层">
              <el-option
                v-for="item in storeyList"
                :key="item.storeyId"
                :label="item.storeyName"
                :value="item.storeyId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item>
            <el-button icon="el-icon-search">查询</el-button>
            <el-button style="color:#FF7670;" icon="el-icon-close">取消</el-button>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-container>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getAssignClassApi } from "@/api/classes.js";
import { getBuildListBySexApi, getDestoryListApi } from "@/api/build.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      storeyList:[],
      parms: {
        buildId: "",
        storeyId:""
      },
      buildList: [],
      bed: {
        classId: "",
        className: "",
        girlCount: 0,
        manCount: 0,
        total: 0,
        sex: "",
      },
      //弹框属性
      assignDialog: {
        title: "",
        height: 500,
        width: 800,
        visible: false,
      },
      isChange: 0,
      assideHeight: 0,
      classList: [],
      searchModel: {
        currentPage: 1,
        pageSize: 10,
        className: "",
        classYear: "",
        total: 0,
      },
    };
  },
  created() {
    this.getAssignClass();
  },
  mounted() {
    this.$nextTick(() => {
      this.assideHeight = window.innerHeight - 200;
    });
  },
  methods: {
    async selectBuildChange(val){
      //清空层数
      this.parms.storeyId = ''
      this.storeyList = []
      //查询楼栋的层数
      let res = await getDestoryListApi({
        buildId:val
      })
      if(res && res.code == 200){
        this.storeyList = res.data;
      }
    },
    //分配取消
    onClose() {
      this.assignDialog.visible = false;
    },
    //分配确定
    onConfirm() {
      this.assignDialog.visible = false;
    },
    //分配按钮点击事件
    async assignBtn(type) {
      //清空楼栋
      this.parms.buildId = ''
      this.buildList = []
      //获取楼栋列表
      let res = await getBuildListBySexApi({
        type: type,
      });
      if (res && res.code == 200) {
        this.buildList = res.data;
      }
      type == "0" ? (this.bed.sex = "男生") : (this.bed.sex = "女生");
      type == "0"
        ? (this.bed.total = this.bed.manCount)
        : (this.bed.total = this.bed.girlCount);
      //设置弹框属性
      this.assignDialog.title =
        "为【" +
        this.bed.className +
        "】分配【" +
        this.bed.sex +
        "】宿舍,需要【" +
        this.bed.total +
        "】个床位";
      this.assignDialog.visible = true;
    },
    //页数改变时触发
    currentChange(val) {
      this.searchModel.currentPage = val;
      this.getAssignClass();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.searchModel.pageSize = val;
      this.getAssignClass();
    },
    //左侧班级点击事件
    itemClick(item, index) {
      console.log("点击班级");
      this.isChange = index;
      console.log(item);
      this.bed.classId = item.classId;
      this.bed.className = item.className;
      this.bed.girlCount = item.girlCount;
      this.bed.manCount = item.manCount;
    },
    async getAssignClass() {
      let res = await getAssignClassApi(this.searchModel);
      if (res && res.code == 200) {
        console.log(res);
        this.classList = res.data.records;
        this.searchModel.total = res.data.total;
        this.$nextTick(() => {
          document.querySelector("#class0").click();
        });
      }
    },
  },
};
</script>

<style lang="scss" scoped>
.header {
  // height: 50px !important;
  border-bottom: 1px solid #dcdfe6;
  display: flex;
  align-items: center;
}
.item-container {
  display: flex;
  flex-direction: column;
}
.leftside {
  border-right: 1px solid #dcdfe6;
  border-bottom: 1px solid #dcdfe6;
  display: flex;
  flex-direction: column;
  .side-item {
    display: flex;
    height: 55px;
    border-bottom: 1px solid #dcdfe6;
    align-items: center;
    cursor: pointer;
    .item-left {
      padding-left: 10px;
      flex-grow: 1;
      .class-title {
        color: #686868;
        font-size: 13px;
      }
      .class-sex {
        display: flex;
        color: #999;
        font-size: 12px;
        padding-top: 8px;
        .man {
          flex-grow: 1;
        }
        .girl {
          flex-grow: 1;
        }
      }
    }
    .item-right {
      padding-right: 10px;
      color: #b2b2b2;
    }
  }
}
.pages {
  text-align: center;
}
.isActive {
  background: #f8f8f8;
}
</style>
```







#### 第78讲  宿舍树数据显示对接

```js
drop table if exists assign_bed;

/*==============================================================*/
/* Table: assign_bed                                            */
/*==============================================================*/
create table assign_bed
(
   assign_id            int not null auto_increment comment '主键',
   bed_id               int comment '床位id',
   class_id             int comment '班级id',
   primary key (assign_id)
);
```



##### 1、新建返回值类型

```js
package com.itmk.web.dorm_room.entity;

import lombok.Data;

import java.util.ArrayList;
import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class RoomTree {
    private Long roomId;
    private String roomCode;
    private List<RoomTree> children = new ArrayList<>();
}

```

##### 2、DormRoomMapper接口添加getRoomTree()方法

```js
package com.itmk.web.dorm_room.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.dorm_room.entity.DormRoom;
import com.itmk.web.dorm_room.entity.RoomTree;
import org.apache.ibatis.annotations.Param;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface DormRoomMapper extends BaseMapper<DormRoom> {
    List<RoomTree> getRoomTree(@Param("storeyId") Long storeyId);
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.dorm_room.mapper.DormRoomMapper">
    <select id="getRoomTree" resultType="com.itmk.web.dorm_room.entity.RoomTree">
        select t.room_id,dr.room_code from
            (select a.* from drom_room_bed  as a
            left join assign_bed as b on a.bed_id = b.bed_id
            where b.bed_id  is null)t
        left join  dorm_room as dr on dr.room_id = t.room_id
        where  dr.storey_id =#{storeyId}
        GROUP BY t.room_id,dr.room_code
    </select>
</mapper>
```



##### 3、DormRoomService接口添加getRoomTree()方法

```js
package com.itmk.web.dorm_room.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.dorm_room.entity.DormRoom;
import com.itmk.web.dorm_room.entity.RoomTree;
import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface DormRoomService extends IService<DormRoom> {
    List<RoomTree> getRoomTree(Long storeyId);
}

```

实现类

```js
package com.itmk.web.dorm_room.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.dorm_room.entity.DormRoom;
import com.itmk.web.dorm_room.entity.RoomTree;
import com.itmk.web.dorm_room.mapper.DormRoomMapper;
import com.itmk.web.dorm_room.service.DormRoomService;
import com.itmk.web.drom_room_bed.entity.DromRoomBed;
import com.itmk.web.drom_room_bed.service.DromRoomBedService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class DormRoomServiceImpl extends ServiceImpl<DormRoomMapper, DormRoom> implements DormRoomService {
    @Autowired
    private DromRoomBedService dromRoomBedService;
    @Override
    public List<RoomTree> getRoomTree(Long storeyId) {
        List<RoomTree> list = this.baseMapper.getRoomTree(storeyId);
        if(list.size() >0){
            for (int i =0;i<list.size();i++){
                List<DromRoomBed> bedList = dromRoomBedService.getBedList(list.get(i).getRoomId());
                if(bedList.size() >0){
                    for (int j=0;j<bedList.size();j++){
                        RoomTree tree = new RoomTree();
                        tree.setRoomId(bedList.get(j).getBedId());
                        tree.setRoomCode(bedList.get(j).getBedCode());
                        list.get(i).getChildren().add(tree);
                    }
                }
            }
        }
        return list;
    }
}

```

##### 4、DromRoomBedMapper接口添加getBedList()方法

```js
package com.itmk.web.drom_room_bed.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.drom_room_bed.entity.DromRoomBed;
import org.apache.ibatis.annotations.Param;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface DromRoomBedMapper extends BaseMapper<DromRoomBed> {
    List<DromRoomBed> getBedList(@Param("roomId") Long roomId);
}

```

DromRoomBedMapper.xml 映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.drom_room_bed.mapper.DromRoomBedMapper">
    <select id="getBedList" resultType="com.itmk.web.drom_room_bed.entity.DromRoomBed">
        select t.* from
        (select a.* from drom_room_bed  as a
        left join assign_bed as b on a.bed_id = b.bed_id
        where b.bed_id  is null)t
        left join  dorm_room as dr on dr.room_id = t.room_id
        where dr.room_id =#{roomId}
    </select>
</mapper>
```

##### 5、DromRoomBedService接口添加getBedList()方法

```js
package com.itmk.web.drom_room_bed.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.drom_room_bed.entity.DromRoomBed;
import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface DromRoomBedService extends IService<DromRoomBed> {
     List<DromRoomBed> getBedList(Long roomId);
}

```

实现类

```js
package com.itmk.web.drom_room_bed.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.drom_room_bed.entity.DromRoomBed;
import com.itmk.web.drom_room_bed.mapper.DromRoomBedMapper;
import com.itmk.web.drom_room_bed.service.DromRoomBedService;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class DromRoomBedServiceImpl extends ServiceImpl<DromRoomBedMapper, DromRoomBed> implements DromRoomBedService {
    @Override
    public List<DromRoomBed> getBedList(Long roomId) {
        return this.baseMapper.getBedList(roomId);
    }
}

```

##### 6、DormRoomController控制器添加getRoomByStoreyId()方法

```js
 //根据层数id查询宿舍和床位
    @GetMapping("/getRoomByStoreyId")
    public ResultVo getRoomByStoreyId(Long storeyId) {
        List<RoomTree> list = dormRoomService.getRoomTree(storeyId);
        return ResultUtils.success("查询成功",list);
    }
```

##### 7、api下新建setAssign.js

```js
import http from "@/utils/http";
//根据层数id查询宿舍
export const getRoomByStoreyIdApi = async(parm)=>{
    return await http.get("/api/dormRoom/getRoomByStoreyId",parm)
}
```

##### 8、assignRoom.vue页面

```js
<template>
  <el-container>
    <el-header class="header">
      <el-form :model="searchModel" :inline="true" size="small">
        <el-form-item style="margin-top: 0px; margin-bottom: 0px">
          <el-date-picker
            style="width: 100%"
            v-model="searchModel.classYear"
            type="year"
            placeholder="选择年份"
            value-format="yyyy"
          >
          </el-date-picker>
        </el-form-item>
        <el-form-item style="margin-top: 0px; margin-bottom: 0px">
          <el-input
            v-model="searchModel.className"
            placeholder="请输入班级"
          ></el-input>
        </el-form-item>
        <el-form-item style="margin-top: 0px; margin-bottom: 0px">
          <el-button icon="el-icon-search">搜索</el-button>
          <el-button style="color: #ff7670" icon="el-icon-close"
            >重置</el-button
          >
          <el-button icon="el-icon-plus" type="primary" @click="assignBtn('0')"
            >分配男生宿舍</el-button
          >
          <el-button icon="el-icon-plus" type="success" @click="assignBtn('1')"
            >分配女生宿舍</el-button
          >
        </el-form-item>
      </el-form>
    </el-header>
    <el-container>
      <el-aside width="270px" class="leftside">
        <div class="item-container" :style="{ height: assideHeight + 'px' }">
          <div
            v-for="(item, index) in classList"
            :key="index"
            class="side-item"
            :id="'class' + index"
            @click="itemClick(item, index)"
            :class="{ isActive: isChange === index }"
          >
            <div class="item-left">
              <div class="class-title">
                {{ item.className
                }}<span style="margin-left: 10px; font-size: 12px"
                  >(总共:{{ item.stuCount }}人)</span
                >
              </div>
              <div class="class-sex">
                <div class="man">男:{{ item.manCount }}人</div>
                <div class="girl">女:{{ item.girlCount }}人</div>
              </div>
            </div>
            <i class="el-icon-arrow-right item-right"></i>
          </div>
        </div>
        <!-- 分页 -->
        <el-pagination
          class="pages"
          @size-change="sizeChange"
          @current-change="currentChange"
          :current-page.sync="searchModel.currentPage"
          :page-sizes="[10, 20, 40, 80, 100]"
          :page-size="searchModel.pageSize"
          layout="prev, next"
          prev-text="上一页"
          next-text="下一页"
          :total="searchModel.total"
          small
        >
        </el-pagination>
      </el-aside>
      <el-main>Main</el-main>
    </el-container>
    <!-- 分配弹框 -->
    <sys-dialog
      :title="assignDialog.title"
      :width="assignDialog.width"
      :height="assignDialog.height"
      :visible="assignDialog.visible"
      @onConfirm="onConfirm"
      @onClose="onClose"
    >
      <div slot="content">
        <el-container style="height:500px;">
          <el-header style="border-bottom: 1px solid #dcdfe6; height: 40px">
            <el-form :inline="true" size="small">
              <el-form-item style="margin-buttom: 0px" label="楼栋">
                <el-select
                  @change="selectBuildChange"
                  v-model="parms.buildId"
                  placeholder="请选择楼栋"
                >
                  <el-option
                    v-for="item in buildList"
                    :key="item.buildId"
                    :label="item.buildName"
                    :value="item.buildId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
              <el-form-item style="margin-buttom: 0px" label="楼层">
                <el-select
                  @change="selectDestory"
                  v-model="parms.storeyId"
                  placeholder="请选择楼层"
                >
                  <el-option
                    v-for="item in storeyList"
                    :key="item.storeyId"
                    :label="item.storeyName"
                    :value="item.storeyId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
              <el-form-item style="margin-buttom: 0px">
                <el-button icon="el-icon-search">查询</el-button>
                <el-button style="color: #ff7670" icon="el-icon-close"
                  >取消</el-button
                >
              </el-form-item>
            </el-form>
          </el-header>
          <el-main>
            <el-tree
              default-expand-all
              :data="roomList"
              show-checkbox
              node-key="roomId"
              :props="defaultProps"
            >
            </el-tree>
          </el-main>
        </el-container>
      </div>
    </sys-dialog>
  </el-container>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getAssignClassApi } from "@/api/classes.js";
import { getBuildListBySexApi, getDestoryListApi } from "@/api/build.js";
import { getRoomByStoreyIdApi } from "@/api/setAssign.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      defaultProps: {
        children: "children",
        label: "roomCode",
      },
      roomList: [],
      storeyList: [],
      parms: {
        buildId: "",
        storeyId: "",
      },
      buildList: [],
      bed: {
        classId: "",
        className: "",
        girlCount: 0,
        manCount: 0,
        total: 0,
        sex: "",
      },
      //弹框属性
      assignDialog: {
        title: "",
        height: 500,
        width: 800,
        visible: false,
      },
      isChange: 0,
      assideHeight: 0,
      classList: [],
      searchModel: {
        currentPage: 1,
        pageSize: 10,
        className: "",
        classYear: "",
        total: 0,
      },
    };
  },
  created() {
    this.getAssignClass();
  },
  mounted() {
    this.$nextTick(() => {
      this.assideHeight = window.innerHeight - 200;
    });
  },
  methods: {
    //层数选项事件
    async selectDestory(val) {
      let res = await getRoomByStoreyIdApi({
        storeyId: val,
      });
      if (res && res.code == 200) {
        this.roomList = res.data;
      }
    },
    async selectBuildChange(val) {
      //清空层数
      this.parms.storeyId = "";
      this.storeyList = [];
      //查询楼栋的层数
      let res = await getDestoryListApi({
        buildId: val,
      });
      if (res && res.code == 200) {
        this.storeyList = res.data;
      }
    },
    //分配取消
    onClose() {
      this.assignDialog.visible = false;
    },
    //分配确定
    onConfirm() {
      this.assignDialog.visible = false;
    },
    //分配按钮点击事件
    async assignBtn(type) {
      //清空楼栋
      this.parms.buildId = "";
      this.buildList = [];
      //获取楼栋列表
      let res = await getBuildListBySexApi({
        type: type,
      });
      if (res && res.code == 200) {
        this.buildList = res.data;
      }
      type == "0" ? (this.bed.sex = "男生") : (this.bed.sex = "女生");
      type == "0"
        ? (this.bed.total = this.bed.manCount)
        : (this.bed.total = this.bed.girlCount);
      //设置弹框属性
      this.assignDialog.title =
        "为【" +
        this.bed.className +
        "】分配【" +
        this.bed.sex +
        "】宿舍,需要【" +
        this.bed.total +
        "】个床位";
      this.assignDialog.visible = true;
    },
    //页数改变时触发
    currentChange(val) {
      this.searchModel.currentPage = val;
      this.getAssignClass();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.searchModel.pageSize = val;
      this.getAssignClass();
    },
    //左侧班级点击事件
    itemClick(item, index) {
      console.log("点击班级");
      this.isChange = index;
      console.log(item);
      this.bed.classId = item.classId;
      this.bed.className = item.className;
      this.bed.girlCount = item.girlCount;
      this.bed.manCount = item.manCount;
    },
    async getAssignClass() {
      let res = await getAssignClassApi(this.searchModel);
      if (res && res.code == 200) {
        console.log(res);
        this.classList = res.data.records;
        this.searchModel.total = res.data.total;
        this.$nextTick(() => {
          document.querySelector("#class0").click();
        });
      }
    },
  },
};
</script>

<style lang="scss" scoped>
.header {
  // height: 50px !important;
  border-bottom: 1px solid #dcdfe6;
  display: flex;
  align-items: center;
}
.item-container {
  display: flex;
  flex-direction: column;
}
.leftside {
  border-right: 1px solid #dcdfe6;
  border-bottom: 1px solid #dcdfe6;
  display: flex;
  flex-direction: column;
  .side-item {
    display: flex;
    height: 55px;
    border-bottom: 1px solid #dcdfe6;
    align-items: center;
    cursor: pointer;
    .item-left {
      padding-left: 10px;
      flex-grow: 1;
      .class-title {
        color: #686868;
        font-size: 13px;
      }
      .class-sex {
        display: flex;
        color: #999;
        font-size: 12px;
        padding-top: 8px;
        .man {
          flex-grow: 1;
        }
        .girl {
          flex-grow: 1;
        }
      }
    }
    .item-right {
      padding-right: 10px;
      color: #b2b2b2;
    }
  }
}
.pages {
  text-align: center;
}
.isActive {
  background: #f8f8f8;
}
</style>
```







#### 第79讲 宿舍分配保存对接

##### 1、前端punlic/index.html添加如下样式

```js
<style>
  
  /*定义滚动条高宽及背景 高宽分别对应横竖滚动条的尺寸*/
  ::-webkit-scrollbar{
    width: 7px;
    height: 5px;
    background-color: #F5F5F5;
  }

  /*定义滚动条轨道 内阴影+圆角*/
  ::-webkit-scrollbar-track {
    box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
    -webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    background-color: #F5F5F5;
  }

  /*定义滑块 内阴影+圆角*/
  ::-webkit-scrollbar-thumb{
    border-radius: 8px;
    box-shadow: inset 0 0 6px rgba(0, 0, 0, .1);
    -webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, .1);
    background-color: #c8c8c8;
  }
</style>
```

##### 2、新建实体类

```js
package com.itmk.web.assign_bed.entity;

import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
@TableName("assign_bed")
public class AssignBed {
    private Long assignId;
    private Long bedId;
    private Long classId;
}

```

##### 3、新建mapper层

```js
package com.itmk.web.assign_bed.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.assign_bed.entity.AssignBed;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface AssignBedMapper extends BaseMapper<AssignBed> {
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.assign_bed.mapper.AssignBedMapper">

</mapper>
```

##### 4、新建service层

```js
package com.itmk.web.assign_bed.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.assign_bed.entity.AssignBed;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface AssignBedService extends IService<AssignBed> {
}

```

实现类

```js
package com.itmk.web.assign_bed.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.assign_bed.entity.AssignBed;
import com.itmk.web.assign_bed.mapper.AssignBedMapper;
import com.itmk.web.assign_bed.service.AssignBedService;
import org.springframework.stereotype.Service;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class AssignBedServiceImpl extends ServiceImpl<AssignBedMapper, AssignBed> implements AssignBedService {
}

```

##### 5、控制器

```js
package com.itmk.web.assign_bed.controller;

import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.assign_bed.entity.AssignBed;
import com.itmk.web.assign_bed.service.AssignBedService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/assingBed")
public class AssignBedController {
    @Autowired
    private AssignBedService assignBedService;
    //分配宿舍保存
    @PostMapping("/assignSaveBed")
    public ResultVo assignSaveBed(@RequestBody List<AssignBed> list){
        assignBedService.saveBatch(list);
        return ResultUtils.success("分配宿舍成功");
    }
}

```

##### 6、页面

```js
<template>
  <el-container>
    <el-header class="header">
      <el-form :model="searchModel" :inline="true" size="small">
        <el-form-item style="margin-top: 0px; margin-bottom: 0px">
          <el-date-picker
            style="width: 100%"
            v-model="searchModel.classYear"
            type="year"
            placeholder="选择年份"
            value-format="yyyy"
          >
          </el-date-picker>
        </el-form-item>
        <el-form-item style="margin-top: 0px; margin-bottom: 0px">
          <el-input
            v-model="searchModel.className"
            placeholder="请输入班级"
          ></el-input>
        </el-form-item>
        <el-form-item style="margin-top: 0px; margin-bottom: 0px">
          <el-button icon="el-icon-search">搜索</el-button>
          <el-button style="color: #ff7670" icon="el-icon-close"
            >重置</el-button
          >
          <el-button icon="el-icon-plus" type="primary" @click="assignBtn('0')"
            >分配男生宿舍</el-button
          >
          <el-button icon="el-icon-plus" type="success" @click="assignBtn('1')"
            >分配女生宿舍</el-button
          >
        </el-form-item>
      </el-form>
    </el-header>
    <el-container>
      <el-aside width="270px" class="leftside">
        <div class="item-container" :style="{ height: assideHeight + 'px' }">
          <div
            v-for="(item, index) in classList"
            :key="index"
            class="side-item"
            :id="'class' + index"
            @click="itemClick(item, index)"
            :class="{ isActive: isChange === index }"
          >
            <div class="item-left">
              <div class="class-title">
                {{ item.className
                }}<span style="margin-left: 10px; font-size: 12px"
                  >(总共:{{ item.stuCount }}人)</span
                >
              </div>
              <div class="class-sex">
                <div class="man">男:{{ item.manCount }}人</div>
                <div class="girl">女:{{ item.girlCount }}人</div>
              </div>
            </div>
            <i class="el-icon-arrow-right item-right"></i>
          </div>
        </div>
        <!-- 分页 -->
        <el-pagination
          class="pages"
          @size-change="sizeChange"
          @current-change="currentChange"
          :current-page.sync="searchModel.currentPage"
          :page-sizes="[10, 20, 40, 80, 100]"
          :page-size="searchModel.pageSize"
          layout="prev, next"
          prev-text="上一页"
          next-text="下一页"
          :total="searchModel.total"
          small
        >
        </el-pagination>
      </el-aside>
      <el-main>Main</el-main>
    </el-container>
    <!-- 分配弹框 -->
    <sys-dialog
      :title="assignDialog.title"
      :width="assignDialog.width"
      :height="assignDialog.height"
      :visible="assignDialog.visible"
      @onConfirm="onConfirm"
      @onClose="onClose"
    >
      <div slot="content">
        <el-container style="height: 500px">
          <el-header style="border-bottom: 1px solid #dcdfe6; height: 40px">
            <el-form :inline="true" size="small">
              <el-form-item style="margin-buttom: 0px" label="楼栋">
                <el-select
                  @change="selectBuildChange"
                  v-model="parms.buildId"
                  placeholder="请选择楼栋"
                >
                  <el-option
                    v-for="item in buildList"
                    :key="item.buildId"
                    :label="item.buildName"
                    :value="item.buildId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
              <el-form-item style="margin-buttom: 0px" label="楼层">
                <el-select
                  @change="selectDestory"
                  v-model="parms.storeyId"
                  placeholder="请选择楼层"
                >
                  <el-option
                    v-for="item in storeyList"
                    :key="item.storeyId"
                    :label="item.storeyName"
                    :value="item.storeyId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
              <el-form-item style="margin-buttom: 0px">
                <el-button icon="el-icon-search">查询</el-button>
                <el-button style="color: #ff7670" icon="el-icon-close"
                  >取消</el-button
                >
              </el-form-item>
            </el-form>
          </el-header>
          <el-main>
            <el-tree
              ref="assignTree"
              default-expand-all
              :data="roomList"
              show-checkbox
              node-key="roomId"
              :props="defaultProps"
            >
            </el-tree>
          </el-main>
        </el-container>
      </div>
    </sys-dialog>
  </el-container>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getAssignClassApi } from "@/api/classes.js";
import { getBuildListBySexApi, getDestoryListApi } from "@/api/build.js";
import { getRoomByStoreyIdApi, assignSaveBedApi } from "@/api/setAssign.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      defaultProps: {
        children: "children",
        label: "roomCode",
      },
      roomList: [],
      storeyList: [],
      parms: {
        buildId: "",
        storeyId: "",
      },
      buildList: [],
      bed: {
        classId: "",
        className: "",
        girlCount: 0,
        manCount: 0,
        total: 0,
        sex: "",
      },
      //弹框属性
      assignDialog: {
        title: "",
        height: 500,
        width: 800,
        visible: false,
      },
      isChange: 0,
      assideHeight: 0,
      classList: [],
      searchModel: {
        currentPage: 1,
        pageSize: 10,
        className: "",
        classYear: "",
        total: 0,
      },
    };
  },
  created() {
    this.getAssignClass();
  },
  mounted() {
    this.$nextTick(() => {
      this.assideHeight = window.innerHeight - 200;
    });
  },
  methods: {
    //层数选项事件
    async selectDestory(val) {
      let res = await getRoomByStoreyIdApi({
        storeyId: val,
      });
      if (res && res.code == 200) {
        this.roomList = res.data;
      }
    },
    async selectBuildChange(val) {
      //清空层数
      this.parms.storeyId = "";
      this.storeyList = [];
      //查询楼栋的层数
      let res = await getDestoryListApi({
        buildId: val,
      });
      if (res && res.code == 200) {
        this.storeyList = res.data;
      }
    },
    //分配取消
    onClose() {
      this.assignDialog.visible = false;
    },
    //分配确定
    async onConfirm() {
      //判断是否选择班级
      if (!this.bed.classId) {
        this.$message.warning("请选择班级");
        return;
      }
      let ids = this.$refs.assignTree.getCheckedKeys();
      if (ids.length == 0) {
        this.$message.warning("请选择宿舍");
        return;
      }
      //存放组装的数据
      let list = [];
      //组装数据
      for (let i = 0; i < ids.length; i++) {
        let obj = {};
        obj.bedId = ids[i];
        obj.classId = this.bed.classId;
        list.push(obj);
      }
      console.log(list);
      //提交数据保存
      let res = await assignSaveBedApi(list);
      if (res && res.code == 200) {
        this.$message.success(res.msg);
        this.assignDialog.visible = false;
      }
    },
    //分配按钮点击事件
    async assignBtn(type) {
      //清空楼栋
      this.parms.buildId = "";
      this.buildList = [];
      this.roomList = [];
      //获取楼栋列表
      let res = await getBuildListBySexApi({
        type: type,
      });
      if (res && res.code == 200) {
        this.buildList = res.data;
      }
      type == "0" ? (this.bed.sex = "男生") : (this.bed.sex = "女生");
      type == "0"
        ? (this.bed.total = this.bed.manCount)
        : (this.bed.total = this.bed.girlCount);
      //设置弹框属性
      this.assignDialog.title =
        "为【" +
        this.bed.className +
        "】分配【" +
        this.bed.sex +
        "】宿舍,需要【" +
        this.bed.total +
        "】个床位";
      this.assignDialog.visible = true;
    },
    //页数改变时触发
    currentChange(val) {
      this.searchModel.currentPage = val;
      this.getAssignClass();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.searchModel.pageSize = val;
      this.getAssignClass();
    },
    //左侧班级点击事件
    itemClick(item, index) {
      console.log("点击班级");
      this.isChange = index;
      console.log(item);
      this.bed.classId = item.classId;
      this.bed.className = item.className;
      this.bed.girlCount = item.girlCount;
      this.bed.manCount = item.manCount;
    },
    async getAssignClass() {
      let res = await getAssignClassApi(this.searchModel);
      if (res && res.code == 200) {
        console.log(res);
        this.classList = res.data.records;
        this.searchModel.total = res.data.total;
        this.$nextTick(() => {
          document.querySelector("#class0").click();
        });
      }
    },
  },
};
</script>

<style lang="scss" scoped>
.header {
  // height: 50px !important;
  border-bottom: 1px solid #dcdfe6;
  display: flex;
  align-items: center;
}
.item-container {
  display: flex;
  flex-direction: column;
}
.leftside {
  border-right: 1px solid #dcdfe6;
  border-bottom: 1px solid #dcdfe6;
  display: flex;
  flex-direction: column;
  .side-item {
    display: flex;
    height: 55px;
    border-bottom: 1px solid #dcdfe6;
    align-items: center;
    cursor: pointer;
    .item-left {
      padding-left: 10px;
      flex-grow: 1;
      .class-title {
        color: #686868;
        font-size: 13px;
      }
      .class-sex {
        display: flex;
        color: #999;
        font-size: 12px;
        padding-top: 8px;
        .man {
          flex-grow: 1;
        }
        .girl {
          flex-grow: 1;
        }
      }
    }
    .item-right {
      padding-right: 10px;
      color: #b2b2b2;
    }
  }
}
.pages {
  text-align: center;
}
.isActive {
  background: #f8f8f8;
}
</style>
```





#### 第80讲 分配宿舍列表对接

解决保存时，保存上级的问题

##### 1、新建实体类

```js
package com.itmk.web.assign_bed.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class BedVo {
    private Long bedId;
    private String bedCode;
}

```

```js
package com.itmk.web.assign_bed.entity;

import lombok.Data;

import java.util.ArrayList;
import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class RoomVo {
    private Long roomId;
    private String rootType;
    private String roomCode;
    private List<BedVo> children = new ArrayList<>();
}

```

##### 2、AssignBedMapper接口添加如下方法

```js
package com.itmk.web.assign_bed.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.assign_bed.entity.AssignBed;
import com.itmk.web.assign_bed.entity.BedVo;
import com.itmk.web.assign_bed.entity.RoomVo;
import org.apache.ibatis.annotations.Param;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface AssignBedMapper extends BaseMapper<AssignBed> {
    //根据班级id查询分配的宿舍
    List<RoomVo> getRoomVoList(@Param("classId") Long classId);
    //根据宿舍id查询床位
    List<BedVo> getBedVoList(@Param("roomId") Long roomId);
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.assign_bed.mapper.AssignBedMapper">
    <select id="getRoomVoList" resultType="com.itmk.web.assign_bed.entity.RoomVo">
        select dr.room_id,dr.room_code,dr.root_type from (
        select drb.room_id from assign_bed  as ab
        left join drom_room_bed  as drb on drb.bed_id = ab.bed_id
        where ab.class_id =#{classId}
        GROUP BY drb.room_id)t
        left join dorm_room as dr on dr.room_id = t.room_id
    </select>
    <select id="getBedVoList" resultType="com.itmk.web.assign_bed.entity.BedVo">
        select  drb.room_id,drb.bed_id,drb.bed_code from assign_bed  as ab
        left join drom_room_bed  as drb on drb.bed_id = ab.bed_id
        where drb.room_id =#{roomId}
    </select>
</mapper>
```

##### 3、AssignBedService接口添加如下方法

```js
package com.itmk.web.assign_bed.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.assign_bed.entity.AssignBed;
import com.itmk.web.assign_bed.entity.BedVo;
import com.itmk.web.assign_bed.entity.RoomVo;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface AssignBedService extends IService<AssignBed> {
    //根据班级id查询分配的宿舍
    List<RoomVo> getRoomVoList(Long classId);
    //根据宿舍id查询床位
    List<BedVo> getBedVoList(Long roomId);
}

```

实现类

```js
package com.itmk.web.assign_bed.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.assign_bed.entity.AssignBed;
import com.itmk.web.assign_bed.entity.BedVo;
import com.itmk.web.assign_bed.entity.RoomVo;
import com.itmk.web.assign_bed.mapper.AssignBedMapper;
import com.itmk.web.assign_bed.service.AssignBedService;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class AssignBedServiceImpl extends ServiceImpl<AssignBedMapper, AssignBed> implements AssignBedService {
    @Override
    public List<RoomVo> getRoomVoList(Long classId) {
        return this.baseMapper.getRoomVoList(classId);
    }

    @Override
    public List<BedVo> getBedVoList(Long roomId) {
        return this.baseMapper.getBedVoList(roomId);
    }
}

```

##### 4、控制器

```js
package com.itmk.web.assign_bed.controller;

import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.assign_bed.entity.AssignBed;
import com.itmk.web.assign_bed.entity.BedVo;
import com.itmk.web.assign_bed.entity.RoomVo;
import com.itmk.web.assign_bed.service.AssignBedService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/assignBed")
public class AssignBedController {
    @Autowired
    private AssignBedService assignBedService;

    @PostMapping("/assignBedSave")
    public ResultVo assignBedSave(@RequestBody List<AssignBed> listBed){
        assignBedService.saveBatch(listBed);
        return ResultUtils.success("分配成功!");
    }

    @GetMapping("/getAssignBedList")
    public ResultVo getAssignBedList(Long classId){
        List<RoomVo> roomVoList = assignBedService.getRoomVoList(classId);
        if(roomVoList.size() >0){
            for (int i =0;i<roomVoList.size();i++){
                //查询宿舍的床位
                List<BedVo> bedVoList = assignBedService.getBedVoList(roomVoList.get(i).getRoomId());
                roomVoList.get(i).setChildren(bedVoList);
            }
        }
        return ResultUtils.success("查询成功",roomVoList);
    }

}

```

##### 5、setAssign.js添加getAssignBedListApi()方法

```js
import http from "@/utils/http";
//根据层数id查询宿舍
export const getRoomByStoreyIdApi = async(parm)=>{
    return await http.get("/api/dormRoom/getRoomByStoreyId",parm)
}
//分配宿舍保存
export const assignSaveBedApi = async(parm)=>{
    return await http.post("/api/assingBed/assignSaveBed",parm)
}
//分配宿舍列表
export const getAssignBedListApi = async(parm)=>{
    return await http.get("/api/assingBed/getAssignBedList",parm)
}
```

##### 6、页面

```js
<template>
  <el-container>
    <el-header class="header">
      <el-form :model="searchModel" :inline="true" size="small">
        <el-form-item style="margin-top: 0px; margin-bottom: 0px">
          <el-date-picker
            style="width: 100%"
            v-model="searchModel.classYear"
            type="year"
            placeholder="选择年份"
            value-format="yyyy"
          >
          </el-date-picker>
        </el-form-item>
        <el-form-item style="margin-top: 0px; margin-bottom: 0px">
          <el-input
            v-model="searchModel.className"
            placeholder="请输入班级"
          ></el-input>
        </el-form-item>
        <el-form-item style="margin-top: 0px; margin-bottom: 0px">
          <el-button icon="el-icon-search">搜索</el-button>
          <el-button style="color: #ff7670" icon="el-icon-close"
            >重置</el-button
          >
          <el-button icon="el-icon-plus" type="primary" @click="assignBtn('0')"
            >分配男生宿舍</el-button
          >
          <el-button icon="el-icon-plus" type="success" @click="assignBtn('1')"
            >分配女生宿舍</el-button
          >
        </el-form-item>
      </el-form>
    </el-header>
    <el-container>
      <el-aside width="270px" class="leftside">
        <div class="item-container" :style="{ height: assideHeight + 'px' }">
          <div
            v-for="(item, index) in classList"
            :key="index"
            class="side-item"
            :id="'class' + index"
            @click="itemClick(item, index)"
            :class="{ isActive: isChange === index }"
          >
            <div class="item-left">
              <div class="class-title">
                {{ item.className
                }}<span style="margin-left: 10px; font-size: 12px"
                  >(总共:{{ item.stuCount }}人)</span
                >
              </div>
              <div class="class-sex">
                <div class="man">男:{{ item.manCount }}人</div>
                <div class="girl">女:{{ item.girlCount }}人</div>
              </div>
            </div>
            <i class="el-icon-arrow-right item-right"></i>
          </div>
        </div>
        <!-- 分页 -->
        <el-pagination
          class="pages"
          @size-change="sizeChange"
          @current-change="currentChange"
          :current-page.sync="searchModel.currentPage"
          :page-sizes="[10, 20, 40, 80, 100]"
          :page-size="searchModel.pageSize"
          layout="prev, next"
          prev-text="上一页"
          next-text="下一页"
          :total="searchModel.total"
          small
        >
        </el-pagination>
      </el-aside>
      <el-main>
        <!-- 表格 -->
        <el-table
          :data="tableList"
          :height="tableHeight"
          style="margin-top: 0px"
          border
          stripe
        >
          <el-table-column width="100" type="expand">
            <template slot-scope="scope">
              <el-table border :data="scope.row.children">
                <el-table-column
                  label="床位编号"
                  prop="bedCode"
                ></el-table-column>
                <el-table-column label="操作" align="center" width="180">
                  <template slot-scope="scope">
                    <el-button
                      round
                      icon="el-icon-delete"
                      type="warning"
                      size="mini"
                      @click="childDelete(scope.row)"
                      >删除</el-button
                    >
                  </template>
                </el-table-column>
              </el-table>
            </template>
          </el-table-column>
          <el-table-column prop="roomCode" label="宿舍编号"></el-table-column>
          <el-table-column align="center" prop="roomCode" label="宿舍类型">
            <template slot-scope="scope">
              <el-tag v-if="scope.row.rootType == '1'" size="small"
                >1人间</el-tag
              >
              <el-tag
                v-if="scope.row.rootType == '2'"
                type="danger"
                size="small"
                >2人间</el-tag
              >
              <el-tag
                v-if="scope.row.rootType == '4'"
                type="success"
                size="small"
                >4人间</el-tag
              >
              <el-tag
                v-if="scope.row.rootType == '6'"
                type="warning"
                size="small"
                >6人间</el-tag
              >
            </template>
          </el-table-column>
          <el-table-column align="center" label="操作" width="200">
            <template slot-scope="scope">
              <el-button
                icon="el-icon-delete"
                type="danger"
                size="small"
                @click="deleteBtn(scope.row)"
                >删除</el-button
              >
            </template>
          </el-table-column>
        </el-table>
      </el-main>
    </el-container>
    <!-- 分配弹框 -->
    <sys-dialog
      :title="assignDialog.title"
      :width="assignDialog.width"
      :height="assignDialog.height"
      :visible="assignDialog.visible"
      @onConfirm="onConfirm"
      @onClose="onClose"
    >
      <div slot="content">
        <el-container style="height: 500px">
          <el-header style="border-bottom: 1px solid #dcdfe6; height: 40px">
            <el-form :inline="true" size="small">
              <el-form-item style="margin-buttom: 0px" label="楼栋">
                <el-select
                  @change="selectBuildChange"
                  v-model="parms.buildId"
                  placeholder="请选择楼栋"
                >
                  <el-option
                    v-for="item in buildList"
                    :key="item.buildId"
                    :label="item.buildName"
                    :value="item.buildId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
              <el-form-item style="margin-buttom: 0px" label="楼层">
                <el-select
                  @change="selectDestory"
                  v-model="parms.storeyId"
                  placeholder="请选择楼层"
                >
                  <el-option
                    v-for="item in storeyList"
                    :key="item.storeyId"
                    :label="item.storeyName"
                    :value="item.storeyId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
              <el-form-item style="margin-buttom: 0px">
                <el-button icon="el-icon-search">查询</el-button>
                <el-button style="color: #ff7670" icon="el-icon-close"
                  >取消</el-button
                >
              </el-form-item>
            </el-form>
          </el-header>
          <el-main>
            <el-tree
              ref="assignTree"
              default-expand-all
              :data="roomList"
              show-checkbox
              node-key="roomId"
              :props="defaultProps"
            >
            </el-tree>
          </el-main>
        </el-container>
      </div>
    </sys-dialog>
  </el-container>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getAssignClassApi } from "@/api/classes.js";
import { getBuildListBySexApi, getDestoryListApi } from "@/api/build.js";
import {
  getRoomByStoreyIdApi,
  assignSaveBedApi,
  getAssignBedListApi,
} from "@/api/setAssign.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      tableHeight:0,
      tableList:[],
      defaultProps: {
        children: "children",
        label: "roomCode",
      },
      roomList: [],
      storeyList: [],
      parms: {
        buildId: "",
        storeyId: "",
      },
      buildList: [],
      bed: {
        classId: "",
        className: "",
        girlCount: 0,
        manCount: 0,
        total: 0,
        sex: "",
      },
      //弹框属性
      assignDialog: {
        title: "",
        height: 500,
        width: 800,
        visible: false,
      },
      isChange: 0,
      assideHeight: 0,
      classList: [],
      searchModel: {
        currentPage: 1,
        pageSize: 10,
        className: "",
        classYear: "",
        total: 0,
      },
    };
  },
  created() {
    this.getAssignClass();
  },
  mounted() {
    this.$nextTick(() => {
      this.assideHeight = window.innerHeight - 200;
      this.tableHeight = window.innerHeight - 200;
    });
  },
  methods: {
    deleteBtn(row){

    },
    //删除床位
    childDelete(row){

    },
    //根据班级id查询宿舍
    async getAssignBedList(classId) {
      let res = await getAssignBedListApi({
        classId: classId,
      });
      if (res && res.code == 200) {
        this.tableList = res.data;
      }
    },
    //层数选项事件
    async selectDestory(val) {
      let res = await getRoomByStoreyIdApi({
        storeyId: val,
      });
      if (res && res.code == 200) {
        this.roomList = res.data;
      }
    },
    async selectBuildChange(val) {
      //清空层数
      this.parms.storeyId = "";
      this.storeyList = [];
      this.roomList = [];
      //查询楼栋的层数
      let res = await getDestoryListApi({
        buildId: val,
      });
      if (res && res.code == 200) {
        this.storeyList = res.data;
      }
    },
    //分配取消
    onClose() {
      this.assignDialog.visible = false;
    },
    //分配确定
    async onConfirm() {
      //判断是否选择班级
      if (!this.bed.classId) {
        this.$message.warning("请选择班级");
        return;
      }
      let ids = this.$refs.assignTree.getCheckedNodes();
      if (ids.length == 0) {
        this.$message.warning("请选择宿舍");
        return;
      }
      //存放组装的数据
      let list = [];
      //组装数据
      for (let i = 0; i < ids.length; i++) {
        if (ids[i].type == "0") {
          let obj = {};
          obj.bedId = ids[i].roomId;
          obj.classId = this.bed.classId;
          list.push(obj);
        }
      }
      console.log(list);
      //提交数据保存
      let res = await assignSaveBedApi(list);
      if (res && res.code == 200) {
        this.$message.success(res.msg);
        this.assignDialog.visible = false;
      }
    },
    //分配按钮点击事件
    async assignBtn(type) {
      //清空楼栋
      this.parms.buildId = "";
      this.parms.storeyId = "";
      this.buildList = [];
      this.roomList = [];
      this.storeyList = [];
      //获取楼栋列表
      let res = await getBuildListBySexApi({
        type: type,
      });
      if (res && res.code == 200) {
        this.buildList = res.data;
      }
      type == "0" ? (this.bed.sex = "男生") : (this.bed.sex = "女生");
      type == "0"
        ? (this.bed.total = this.bed.manCount)
        : (this.bed.total = this.bed.girlCount);
      //设置弹框属性
      this.assignDialog.title =
        "为【" +
        this.bed.className +
        "】分配【" +
        this.bed.sex +
        "】宿舍,需要【" +
        this.bed.total +
        "】个床位";
      this.assignDialog.visible = true;
    },
    //页数改变时触发
    currentChange(val) {
      this.searchModel.currentPage = val;
      this.getAssignClass();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.searchModel.pageSize = val;
      this.getAssignClass();
    },
    //左侧班级点击事件
    itemClick(item, index) {
      console.log("点击班级");
      this.isChange = index;
      console.log(item);
      this.bed.classId = item.classId;
      this.bed.className = item.className;
      this.bed.girlCount = item.girlCount;
      this.bed.manCount = item.manCount;
      this.getAssignBedList(this.bed.classId)
    },
    async getAssignClass() {
      let res = await getAssignClassApi(this.searchModel);
      if (res && res.code == 200) {
        console.log(res);
        this.classList = res.data.records;
        this.searchModel.total = res.data.total;
        this.$nextTick(() => {
          document.querySelector("#class0").click();
        });
      }
    },
  },
};
</script>

<style lang="scss" scoped>
.header {
  // height: 50px !important;
  border-bottom: 1px solid #dcdfe6;
  display: flex;
  align-items: center;
}
.item-container {
  display: flex;
  flex-direction: column;
}
.leftside {
  border-right: 1px solid #dcdfe6;
  border-bottom: 1px solid #dcdfe6;
  display: flex;
  flex-direction: column;
  .side-item {
    display: flex;
    height: 55px;
    border-bottom: 1px solid #dcdfe6;
    align-items: center;
    cursor: pointer;
    .item-left {
      padding-left: 10px;
      flex-grow: 1;
      .class-title {
        color: #686868;
        font-size: 13px;
      }
      .class-sex {
        display: flex;
        color: #999;
        font-size: 12px;
        padding-top: 8px;
        .man {
          flex-grow: 1;
        }
        .girl {
          flex-grow: 1;
        }
      }
    }
    .item-right {
      padding-right: 10px;
      color: #b2b2b2;
    }
  }
}
.pages {
  text-align: center;
}
.isActive {
  background: #f8f8f8;
}
</style>
```







#### 第81讲 删除床位对接

##### 1、AssignBedController控制器添加delete()方法

```js
package com.itmk.web.assign_bed.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.assign_bed.entity.AssignBed;
import com.itmk.web.assign_bed.entity.BedVo;
import com.itmk.web.assign_bed.entity.RoomVo;
import com.itmk.web.assign_bed.service.AssignBedService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/assingBed")
public class AssignBedController {
    @Autowired
    private AssignBedService assignBedService;
    //分配宿舍保存
    @PostMapping("/assignSaveBed")
    public ResultVo assignSaveBed(@RequestBody List<AssignBed> list){
        assignBedService.saveBatch(list);
        return ResultUtils.success("分配宿舍成功");
    }

    @GetMapping("/getAssignBedList")
    public ResultVo getAssignBedList(Long classId){
        //宿舍列表
        List<RoomVo> roomVoList = assignBedService.getRoomVoList(classId);
        if(roomVoList.size() >0){
            for (int i =0;i<roomVoList.size();i++){
                //查询宿舍的床位
            List<BedVo> bedVoList = assignBedService.getBedVoList(roomVoList.get(i).getRoomId());
            //设置宿舍的床位
            roomVoList.get(i).setChildren(bedVoList);
            }
        }
        return ResultUtils.success("查询成功",roomVoList);
    }
    //删除
    @DeleteMapping("/{bedId}/{classId}")
    public ResultVo delete(@PathVariable("bedId") Long bedId,@PathVariable("classId") Long classId){
        QueryWrapper<AssignBed> query = new QueryWrapper<>();
        query.lambda().eq(AssignBed::getBedId,bedId).eq(AssignBed::getClassId,classId);
        boolean remove = assignBedService.remove(query);
        if(remove){
            return ResultUtils.success("删除成功");
        }
        return ResultUtils.error("删除失败！");
    }
}

```

##### 2、api/setAssign.js添加deleteAssignApi()方法

```js
import http from "@/utils/http";
//根据层数id查询宿舍
export const getRoomByStoreyIdApi = async(parm)=>{
    return await http.get("/api/dormRoom/getRoomByStoreyId",parm)
}
//分配宿舍保存
export const assignSaveBedApi = async(parm)=>{
    return await http.post("/api/assingBed/assignSaveBed",parm)
}
//分配宿舍列表
export const getAssignBedListApi = async(parm)=>{
    return await http.get("/api/assingBed/getAssignBedList",parm)
}
//删除
export const deleteAssignApi = async(parm)=>{
    return await http.delete("/api/assingBed",parm)
}
```

##### 3、页面

```js
<template>
  <el-container>
    <el-header class="header">
      <el-form :model="searchModel" :inline="true" size="small">
        <el-form-item style="margin-top: 0px; margin-bottom: 0px">
          <el-date-picker
            style="width: 100%"
            v-model="searchModel.classYear"
            type="year"
            placeholder="选择年份"
            value-format="yyyy"
          >
          </el-date-picker>
        </el-form-item>
        <el-form-item style="margin-top: 0px; margin-bottom: 0px">
          <el-input
            v-model="searchModel.className"
            placeholder="请输入班级"
          ></el-input>
        </el-form-item>
        <el-form-item style="margin-top: 0px; margin-bottom: 0px">
          <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
          <el-button
            @click="resetBtn"
            style="color: #ff7670"
            icon="el-icon-close"
            >重置</el-button
          >
          <el-button icon="el-icon-plus" type="primary" @click="assignBtn('0')"
            >分配男生宿舍</el-button
          >
          <el-button icon="el-icon-plus" type="success" @click="assignBtn('1')"
            >分配女生宿舍</el-button
          >
        </el-form-item>
      </el-form>
    </el-header>
    <el-container>
      <el-aside width="270px" class="leftside">
        <div class="item-container" :style="{ height: assideHeight + 'px' }">
          <div
            v-for="(item, index) in classList"
            :key="index"
            class="side-item"
            :id="'class' + index"
            @click="itemClick(item, index)"
            :class="{ isActive: isChange === index }"
          >
            <div class="item-left">
              <div class="class-title">
                {{ item.className
                }}<span style="margin-left: 10px; font-size: 12px"
                  >(总共:{{ item.stuCount }}人)</span
                >
              </div>
              <div class="class-sex">
                <div class="man">男:{{ item.manCount }}人</div>
                <div class="girl">女:{{ item.girlCount }}人</div>
              </div>
            </div>
            <i class="el-icon-arrow-right item-right"></i>
          </div>
        </div>
        <!-- 分页 -->
        <el-pagination
          class="pages"
          @size-change="sizeChange"
          @current-change="currentChange"
          :current-page.sync="searchModel.currentPage"
          :page-sizes="[10, 20, 40, 80, 100]"
          :page-size="searchModel.pageSize"
          layout="prev, next"
          prev-text="上一页"
          next-text="下一页"
          :total="searchModel.total"
          small
        >
        </el-pagination>
      </el-aside>
      <el-main>
        <!-- 表格 -->
        <el-table
          :data="tableList"
          :height="tableHeight"
          style="margin-top: 0px"
          border
          stripe
        >
          <el-table-column width="100" type="expand">
            <template slot-scope="scope">
              <el-table border :data="scope.row.children">
                <el-table-column
                  label="床位编号"
                  prop="bedCode"
                ></el-table-column>
                <el-table-column label="操作" align="center" width="180">
                  <template slot-scope="scope">
                    <el-button
                      round
                      icon="el-icon-delete"
                      type="danger"
                      size="mini"
                      @click="childDelete(scope.row)"
                      >删除</el-button
                    >
                  </template>
                </el-table-column>
              </el-table>
            </template>
          </el-table-column>
          <el-table-column prop="roomCode" label="宿舍编号"></el-table-column>
          <el-table-column align="center" prop="roomCode" label="宿舍类型">
            <template slot-scope="scope">
              <el-tag v-if="scope.row.rootType == '1'" size="small"
                >1人间</el-tag
              >
              <el-tag
                v-if="scope.row.rootType == '2'"
                type="danger"
                size="small"
                >2人间</el-tag
              >
              <el-tag
                v-if="scope.row.rootType == '4'"
                type="success"
                size="small"
                >4人间</el-tag
              >
              <el-tag
                v-if="scope.row.rootType == '6'"
                type="warning"
                size="small"
                >6人间</el-tag
              >
            </template>
          </el-table-column>
        </el-table>
      </el-main>
    </el-container>
    <!-- 分配弹框 -->
    <sys-dialog
      :title="assignDialog.title"
      :width="assignDialog.width"
      :height="assignDialog.height"
      :visible="assignDialog.visible"
      @onConfirm="onConfirm"
      @onClose="onClose"
    >
      <div slot="content">
        <el-container style="height: 500px">
          <el-header style="border-bottom: 1px solid #dcdfe6; height: 40px">
            <el-form :inline="true" size="small">
              <el-form-item style="margin-buttom: 0px" label="楼栋">
                <el-select
                  @change="selectBuildChange"
                  v-model="parms.buildId"
                  placeholder="请选择楼栋"
                >
                  <el-option
                    v-for="item in buildList"
                    :key="item.buildId"
                    :label="item.buildName"
                    :value="item.buildId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
              <el-form-item style="margin-buttom: 0px" label="楼层">
                <el-select
                  @change="selectDestory"
                  v-model="parms.storeyId"
                  placeholder="请选择楼层"
                >
                  <el-option
                    v-for="item in storeyList"
                    :key="item.storeyId"
                    :label="item.storeyName"
                    :value="item.storeyId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
              <el-form-item style="margin-buttom: 0px">
                <el-button icon="el-icon-search">查询</el-button>
                <el-button style="color: #ff7670" icon="el-icon-close"
                  >取消</el-button
                >
              </el-form-item>
            </el-form>
          </el-header>
          <el-main>
            <el-tree
              ref="assignTree"
              default-expand-all
              :data="roomList"
              show-checkbox
              node-key="roomId"
              :props="defaultProps"
            >
            </el-tree>
          </el-main>
        </el-container>
      </div>
    </sys-dialog>
  </el-container>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getAssignClassApi } from "@/api/classes.js";
import { getBuildListBySexApi, getDestoryListApi } from "@/api/build.js";
import {
  getRoomByStoreyIdApi,
  assignSaveBedApi,
  getAssignBedListApi,
  deleteAssignApi,
} from "@/api/setAssign.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      tableHeight: 0,
      tableList: [],
      defaultProps: {
        children: "children",
        label: "roomCode",
      },
      roomList: [],
      storeyList: [],
      parms: {
        buildId: "",
        storeyId: "",
      },
      buildList: [],
      bed: {
        classId: "",
        className: "",
        girlCount: 0,
        manCount: 0,
        total: 0,
        sex: "",
      },
      //弹框属性
      assignDialog: {
        title: "",
        height: 500,
        width: 800,
        visible: false,
      },
      isChange: 0,
      assideHeight: 0,
      classList: [],
      searchModel: {
        currentPage: 1,
        pageSize: 10,
        className: "",
        classYear: "",
        total: 0,
      },
    };
  },
  created() {
    this.getAssignClass();
  },
  mounted() {
    this.$nextTick(() => {
      this.assideHeight = window.innerHeight - 200;
      this.tableHeight = window.innerHeight - 200;
    });
  },
  methods: {
    //重置按钮
    resetBtn() {
      this.searchModel.className = "";
      this.searchModel.classYear = "";
      this.getAssignClass();
    },
    //搜索按钮
    searchBtn() {
      this.getAssignClass();
    },
    //删除床位
    async childDelete(row) {
      console.log(row);
      const confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let parm = {
          bedId: row.bedId,
          classId: this.bed.classId,
        };
        let res = await deleteAssignApi(parm);
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          this.getAssignBedList(this.bed.classId);
        }
      }
    },
    //根据班级id查询宿舍
    async getAssignBedList(classId) {
      let res = await getAssignBedListApi({
        classId: classId,
      });
      if (res && res.code == 200) {
        this.tableList = res.data;
      }
    },
    //层数选项事件
    async selectDestory(val) {
      let res = await getRoomByStoreyIdApi({
        storeyId: val,
      });
      if (res && res.code == 200) {
        this.roomList = res.data;
      }
    },
    async selectBuildChange(val) {
      //清空层数
      this.parms.storeyId = "";
      this.storeyList = [];
      this.roomList = [];
      //查询楼栋的层数
      let res = await getDestoryListApi({
        buildId: val,
      });
      if (res && res.code == 200) {
        this.storeyList = res.data;
      }
    },
    //分配取消
    onClose() {
      this.assignDialog.visible = false;
    },
    //分配确定
    async onConfirm() {
      //判断是否选择班级
      if (!this.bed.classId) {
        this.$message.warning("请选择班级");
        return;
      }
      let ids = this.$refs.assignTree.getCheckedNodes();
      if (ids.length == 0) {
        this.$message.warning("请选择宿舍");
        return;
      }
      //存放组装的数据
      let list = [];
      //组装数据
      for (let i = 0; i < ids.length; i++) {
        if (ids[i].type == "0") {
          let obj = {};
          obj.bedId = ids[i].roomId;
          obj.classId = this.bed.classId;
          list.push(obj);
        }
      }
      console.log(list);
      //提交数据保存
      let res = await assignSaveBedApi(list);
      if (res && res.code == 200) {
        this.$message.success(res.msg);
        this.assignDialog.visible = false;
        this.getAssignBedList(this.bed.classId);
      }
    },
    //分配按钮点击事件
    async assignBtn(type) {
      //清空楼栋
      this.parms.buildId = "";
      this.parms.storeyId = "";
      this.buildList = [];
      this.roomList = [];
      this.storeyList = [];
      //获取楼栋列表
      let res = await getBuildListBySexApi({
        type: type,
      });
      if (res && res.code == 200) {
        this.buildList = res.data;
      }
      type == "0" ? (this.bed.sex = "男生") : (this.bed.sex = "女生");
      type == "0"
        ? (this.bed.total = this.bed.manCount)
        : (this.bed.total = this.bed.girlCount);
      //设置弹框属性
      this.assignDialog.title =
        "为【" +
        this.bed.className +
        "】分配【" +
        this.bed.sex +
        "】宿舍,需要【" +
        this.bed.total +
        "】个床位";
      this.assignDialog.visible = true;
    },
    //页数改变时触发
    currentChange(val) {
      this.searchModel.currentPage = val;
      this.getAssignClass();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.searchModel.pageSize = val;
      this.getAssignClass();
    },
    //左侧班级点击事件
    itemClick(item, index) {
      console.log("点击班级");
      this.isChange = index;
      console.log(item);
      this.bed.classId = item.classId;
      this.bed.className = item.className;
      this.bed.girlCount = item.girlCount;
      this.bed.manCount = item.manCount;
      this.getAssignBedList(this.bed.classId);
    },
    async getAssignClass() {
      let res = await getAssignClassApi(this.searchModel);
      if (res && res.code == 200) {
        console.log(res);
        this.classList = res.data.records;
        this.searchModel.total = res.data.total;
        this.$nextTick(() => {
          document.querySelector("#class0").click();
        });
      }
    },
  },
};
</script>

<style lang="scss" scoped>
.header {
  // height: 50px !important;
  border-bottom: 1px solid #dcdfe6;
  display: flex;
  align-items: center;
}
.item-container {
  display: flex;
  flex-direction: column;
}
.leftside {
  border-right: 1px solid #dcdfe6;
  border-bottom: 1px solid #dcdfe6;
  display: flex;
  flex-direction: column;
  .side-item {
    display: flex;
    height: 55px;
    border-bottom: 1px solid #dcdfe6;
    align-items: center;
    cursor: pointer;
    .item-left {
      padding-left: 10px;
      flex-grow: 1;
      .class-title {
        color: #686868;
        font-size: 13px;
      }
      .class-sex {
        display: flex;
        color: #999;
        font-size: 12px;
        padding-top: 8px;
        .man {
          flex-grow: 1;
        }
        .girl {
          flex-grow: 1;
        }
      }
    }
    .item-right {
      padding-right: 10px;
      color: #b2b2b2;
    }
  }
}
.pages {
  text-align: center;
}
.isActive {
  background: #f8f8f8;
}
</style>
```







#### 第82讲 学生选择宿舍接口开发

```js
drop table if exists select_bed;

/*==============================================================*/
/* Table: select_bed                                            */
/*==============================================================*/
create table select_bed
(
   select_id            int not null auto_increment comment '主键',
   bed_id               int comment '床位id',
   stu_id               int comment '学生id',
   primary key (select_id)
);

```



##### 1、新建SelectBed 和 SelectRoom 实体类

```js
package com.itmk.web.assign_bed.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class SelectBed {
    private Long bedId;
    private String bedCode;
    private String className;
    private String stuName;
}

```

```js
package com.itmk.web.assign_bed.entity;

import lombok.Data;

import java.util.ArrayList;
import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class SelectRoom {
    private Long roomId;
    private Long classId;
    private String roomCode;
    private String rootType;
    private List<SelectBed> children = new ArrayList<>();
}

```

##### 2、AssignBedMapper接口添加getRoomByClassId()和getBedByClassId()方法

```js
package com.itmk.web.assign_bed.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.assign_bed.entity.*;
import org.apache.ibatis.annotations.Param;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface AssignBedMapper extends BaseMapper<AssignBed> {
    //根据班级id查询分配的宿舍
    List<RoomVo> getRoomVoList(@Param("classId") Long classId);
    //根据宿舍id查询床位
    List<BedVo> getBedVoList(@Param("roomId") Long roomId);
    //根据班级id查询分配的宿舍
    List<SelectRoom> getRoomByClassId(@Param("classId") Long classId);
    //查询床位
    List<SelectBed> getBedByClassId(@Param("classId") Long classId, @Param("roomId") Long roomId);
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.assign_bed.mapper.AssignBedMapper">
    <select id="getRoomVoList" resultType="com.itmk.web.assign_bed.entity.RoomVo">
        select dr.room_id,dr.room_code,dr.root_type from (
        select drb.room_id from assign_bed as ab
        left join drom_room_bed as drb on drb.bed_id = ab.bed_id
        where  ab.class_id =#{classId}
        GROUP BY drb.room_id)t
        left join dorm_room as dr on dr.room_id = t.room_id
    </select>
    <select id="getBedVoList" resultType="com.itmk.web.assign_bed.entity.BedVo">
        select drb.bed_id,drb.bed_code from assign_bed as ab
        left join drom_room_bed as drb on drb.bed_id = ab.bed_id
        where drb.room_id =#{roomId}
    </select>
    <select id="getRoomByClassId" resultType="com.itmk.web.assign_bed.entity.SelectRoom">
        select dr.room_id,dr.room_code,dr.root_type,ab.class_id  from  school_class as sc
        inner join  assign_bed as ab on ab.class_id = sc.class_id
        inner join drom_room_bed as drb on drb.bed_id = ab.bed_id
        inner join dorm_room as dr on dr.room_id = drb.room_id
        where sc.class_id =#{classId}
        GROUP BY dr.room_id,dr.room_code,dr.root_type,ab.class_id
    </select>
    <select id="getBedByClassId" resultType="com.itmk.web.assign_bed.entity.SelectBed">
        select t.*,st.stu_name from (
        select drb.bed_id,drb.bed_code,sc.class_name  from  school_class as sc
        inner join  assign_bed as ab on ab.class_id = sc.class_id
        inner join drom_room_bed as drb on drb.bed_id = ab.bed_id
        inner join dorm_room as dr on dr.room_id = drb.room_id
        where sc.class_id =#{classId} and dr.room_id =#{roomId}
        )t
        left join select_bed as sb on sb.bed_id = t.bed_id
        left join school_student as st on st.stu_id = sb.stu_id
    </select>
</mapper>
```

##### 3、AssignBedService接口新增getRoomByClassId()和getBedByClassId()方法

```js
package com.itmk.web.assign_bed.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.assign_bed.entity.*;
import org.apache.ibatis.annotations.Param;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface AssignBedService extends IService<AssignBed> {
    //根据班级id查询分配的宿舍
    List<RoomVo> getRoomVoList(Long classId);
    //根据宿舍id查询床位
    List<BedVo> getBedVoList(Long roomId);
    //根据班级id查询分配的宿舍
    List<SelectRoom> getRoomByClassId(Long classId);
    //查询床位
    List<SelectBed> getBedByClassId(Long classId, Long roomId);
}

```

实现类

```js
package com.itmk.web.assign_bed.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.assign_bed.entity.*;
import com.itmk.web.assign_bed.mapper.AssignBedMapper;
import com.itmk.web.assign_bed.service.AssignBedService;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class AssignBedServiceImpl extends ServiceImpl<AssignBedMapper, AssignBed> implements AssignBedService {
    @Override
    public List<RoomVo> getRoomVoList(Long classId) {
        return this.baseMapper.getRoomVoList(classId);
    }

    @Override
    public List<BedVo> getBedVoList(Long roomId) {
        return this.baseMapper.getBedVoList(roomId);
    }

    @Override
    public List<SelectRoom> getRoomByClassId(Long classId) {
        return this.baseMapper.getRoomByClassId(classId);
    }

    @Override
    public List<SelectBed> getBedByClassId(Long classId, Long roomId) {
        return this.baseMapper.getBedByClassId(classId,roomId);
    }
}

```

##### 4、AssignBedController控制器添加getRoomByClassId()方法

```js
package com.itmk.web.assign_bed.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.assign_bed.entity.*;
import com.itmk.web.assign_bed.service.AssignBedService;
import com.itmk.web.school_student.entity.SchoolStudent;
import com.itmk.web.school_student.service.SchoolStudentService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/assingBed")
public class AssignBedController {
    @Autowired
    private AssignBedService assignBedService;
    @Autowired
    private SchoolStudentService schoolStudentService;
    //分配宿舍保存
    @PostMapping("/assignSaveBed")
    public ResultVo assignSaveBed(@RequestBody List<AssignBed> list){
        assignBedService.saveBatch(list);
        return ResultUtils.success("分配宿舍成功");
    }

    @GetMapping("/getAssignBedList")
    public ResultVo getAssignBedList(Long classId){
        //宿舍列表
        List<RoomVo> roomVoList = assignBedService.getRoomVoList(classId);
        if(roomVoList.size() >0){
            for (int i =0;i<roomVoList.size();i++){
                //查询宿舍的床位
            List<BedVo> bedVoList = assignBedService.getBedVoList(roomVoList.get(i).getRoomId());
            //设置宿舍的床位
            roomVoList.get(i).setChildren(bedVoList);
            }
        }
        return ResultUtils.success("查询成功",roomVoList);
    }
    //删除
    @DeleteMapping("/{bedId}/{classId}")
    public ResultVo delete(@PathVariable("bedId") Long bedId,@PathVariable("classId") Long classId){
        QueryWrapper<AssignBed> query = new QueryWrapper<>();
        query.lambda().eq(AssignBed::getBedId,bedId).eq(AssignBed::getClassId,classId);
        boolean remove = assignBedService.remove(query);
        if(remove){
            return ResultUtils.success("删除成功");
        }
        return ResultUtils.error("删除失败！");
    }

    //学生查询宿舍列表
    @GetMapping("/getRoomByClassId")
    public ResultVo getRoomByClassId(Long userId,String userType){
        if(!userType.equals("0")){
            return ResultUtils.error("学生才能选择宿舍!");
        }
        SchoolStudent student = schoolStudentService.getById(userId);
        List<SelectRoom> roomList = assignBedService.getRoomByClassId(student.getClassId());
        if(roomList.size() >0){
            for (int i=0;i<roomList.size();i++){
                List<SelectBed> bedList = assignBedService.getBedByClassId(student.getClassId(),
                        roomList.get(i).getRoomId());
                if(bedList.size()>0){
                    roomList.get(i).setChildren(bedList);
                }
            }
        }
        return ResultUtils.success("查询成功",roomList);
    }
}

```





#### 第83讲 学生选择宿舍接口对接

##### 1、store/user.js的logout()方法修改为如下

```js
logout({ commit, state ,dispatch}) {
    return new Promise((resolve, reject) => {
      logout(state.token).then(() => {
        removeToken() // must remove  token  first
        resetRouter()
        commit('RESET_STATE')
        //清空tagsview里面的数据
        dispatch('tagsView/delAllViews', {}, { root: true })
        clearSession()
        resolve()
      }).catch(error => {
        reject(error)
      })
    })
  },
```

##### 2、api/setAssign.js添加getRoomByClassIdApi()方法

```js
//学生查询宿舍列表
export const getRoomByClassIdApi = async(parm)=>{
    return await http.get("/api/assingBed/getRoomByClassId",parm)
}
```

##### 3、新建selectBed.vue页面

```js
<template>
  <el-main class="mains">
    <!-- 表格 -->
    <el-collapse
      style="overflow-y: auto"
      accordion
      :style="{ height: accordionHeight + 'px' }"
    >
      <el-collapse-item
        class="collapse-main"
        v-for="(item, index) in tableList"
        :key="index"
      >
        <template slot="title" class="room-title-header">
          <span class="room-title">{{ item.roomCode }}宿舍</span>
          <span class="room-type" v-if="item.rootType == '1'">1人间</span>
          <span class="room-type" v-if="item.rootType == '2'">2人间</span>
          <span class="room-type" v-if="item.rootType == '4'">4人间</span>
          <span class="room-type" v-if="item.rootType == '6'">6人间</span>
          <span class="room-type"
            >(共{{ item.children.length }}个床位,已选{{
              item.children | getHasNum
            }})人</span
          >
        </template>
        <!-- 床位列表 -->
        <div class="bedList">
          <div v-for="(bed, bindex) in item.children" :key="bindex">
            <div @click="hasBtn()" v-if="bed.stuName" class="bed-item-active">
              <span class="num-text">{{ bed.bedCode }}</span>
              <div class="bed-main">
                <svg-icon
                  v-if="bed.stuName"
                  class="bed-svg"
                  icon-class="bed-active"
                />
                <svg-icon v-else class="bed-svg" icon-class="bed-no" />
                <div v-if="bed.stuName" class="stuInfo">
                  <div>
                    <div>
                      <span>姓名：</span>
                      <span>{{ bed.stuName }}</span>
                    </div>
                    <div>
                      <span>班级：</span>
                      <span>{{ bed.className }}</span>
                    </div>
                  </div>
                </div>
                <div v-else style="color: #aeb5b5">暂未选择</div>
              </div>
            </div>
            <dir @click="selectBtn(bed)" v-else class="bed-item">
              <span class="num-text">{{ bed.bedCode }}</span>
              <div class="bed-main">
                <svg-icon class="bed-svg" icon-class="bed-no" />
                <div style="color: #aeb5b5">暂未选择</div>
              </div>
            </dir>
          </div>
        </div>
      </el-collapse-item>
    </el-collapse>
  </el-main>
</template>

<script>
import { getRoomByClassIdApi } from "@/api/setAssign.js";
import { getUserId, getUserType } from "@/utils/auth.js";
export default {
  data() {
    return {
      tableList: [],
      accordionHeight: 0,
    };
  },
  filters: {
    getHasNum(children) {
      let num = 0;
      if (children && children.length > 0) {
        for (let i = 0; i < children.length; i++) {
          if (children[i].stuName) {
            num = num + 1;
          }
        }
      }
      return num;
    },
  },
  created() {
    this.getRoomByClassId();
  },
  mounted() {
    this.$nextTick(() => {
      this.accordionHeight = window.innerHeight - 200;
    });
  },
  methods: {
    hasBtn() {
      this.$message.success("该床位已经被选择!");
      return;
    },
    //床位点击事件
    selectBtn(bed) {
      console.log(bed);
    },
    async getRoomByClassId() {
      let res = await getRoomByClassIdApi({
        userId: getUserId(),
        userType: getUserType(),
      });
      console.log(res);
      if (res && res.code == 200) {
        this.tableList = res.data;
      }
    },
  },
};
</script>


<style lang="scss" scoped>
.room-title-header {
  display: flex;
  background: #f8f8f8;
}
.collapse-main {
  background: #f8f8f8;
  border: 1px solid #dcdfe6;
  margin: 5px 0px;
}
.stuInfo {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
.bedList {
  display: flex;
  flex-wrap: wrap;
}
.room-type {
  //   color: #ff7670;
  flex-grow: 1;
  font-weight: 600;
}
.bed-main {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
.bed-item {
  border: 1px solid #dedede;
  border-radius: 4px;
  background-color: #f8f8f8;
  height: 180px;
  width: 180px;
  margin: 15px 15px;
  padding-left: 0px !important;
  display: flex;
  flex-direction: column;
  cursor: pointer;
}
.bed-item-active {
  background: #f2feff;
  border: 1px solid #ddeff1;
  border-radius: 4px;
  height: 180px;
  width: 180px;
  margin: 15px 15px;
  display: flex;
  flex-direction: column;
  cursor: pointer;
}
.num-text {
  color: #8a8a8a;
}
.active-num-text {
  color: #42b983;
  font-weight: 600;
}
.bed-svg {
  font-size: 100px;
}
.build-main {
  padding-top: 25px;
  background: #f3f3f4;
}
.build-list {
  display: flex;
  flex-wrap: wrap;
  background: #fff;
}
.build-item {
  display: flex;
  padding: 8px 30px;
  margin: 10px;
  font-size: 14px;
  border: 1px solid #dedede;
  border-radius: 4px;
  cursor: pointer;
  background: #fff;
}
.isActive {
  background: #42b983;
  color: #fff;
}
.containers {
  margin-top: 20px;
  border: 1px solid #dcdfe6;
}
.room-title {
  padding-left: 15px;
  //   color: #5fb878;
  font-size: 13px;
  font-weight: 600;
  flex-grow: 1;
}
.leftAsside {
  border-right: 1px solid #dcdfe6;
  display: flex;
  flex-direction: column;
  align-items: center;
  background: #fff;
}
.storey-item {
  padding: 8px 30px;
  margin: 10px 10px;
  font-size: 14px;
  border: 1px solid #dedede;
  border-radius: 4px;
  cursor: pointer;
  background-color: #f8f8f8;
}
.destoryActive {
  background: #5fb878 !important;
  border-color: #5fb878 !important;
  color: #fff;
}
.mains {
  padding-top: 10px;
  background: #fff;
}
</style>
```







#### 第84讲 学生选宿舍保存

##### 1、新建实体类

```js
package com.itmk.web.select_bed.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
@TableName("select_bed")
public class StuBed {
    @TableId(type = IdType.AUTO)
    private Long selectId;
    private Long bedId;
    private Long stuId;
}

```

##### 2、新建mapper层

```js
package com.itmk.web.select_bed.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.select_bed.entity.StuBed;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface StuBedMapper extends BaseMapper<StuBed> {
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.select_bed.mapper.StuBedMapper">

</mapper>
```

##### 3、service层

```js
package com.itmk.web.select_bed.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.select_bed.entity.StuBed;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface StuBedService extends IService<StuBed> {
}

```

实现类

```js
package com.itmk.web.select_bed.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.select_bed.entity.StuBed;
import com.itmk.web.select_bed.mapper.StuBedMapper;
import com.itmk.web.select_bed.service.StuBedService;
import org.springframework.stereotype.Service;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class StuBedServiceImpl extends ServiceImpl<StuBedMapper, StuBed> implements StuBedService {
}

```

##### 4、控制器

```js
package com.itmk.web.select_bed.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.select_bed.entity.StuBed;
import com.itmk.web.select_bed.service.StuBedService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;


/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/stuBed")
public class StuBedController {
    @Autowired
    private StuBedService stuBedService;

    @PostMapping("/selectBedSave")
    public ResultVo selectBedSave(@RequestBody StuBed stuBed){
        //根据床位查询，是否被选选
        QueryWrapper<StuBed> query = new QueryWrapper<>();
        query.lambda().eq(StuBed::getBedId,stuBed.getBedId());
        StuBed bed = stuBedService.getOne(query);
        if(bed != null){
            return ResultUtils.error("该床位已经被占用!");
        }
        //查询学生是否已经选择床位
        QueryWrapper<StuBed> stuQuery = new QueryWrapper<>();
        stuQuery.lambda().eq(StuBed::getStuId,stuBed.getStuId());
        StuBed stu = stuBedService.getOne(stuQuery);
        if(stu != null){
            return ResultUtils.error("您已经选择宿舍，不用重复选择!");
        }
        //保存选择的宿舍
        boolean save = stuBedService.save(stuBed);
        if(save){
            return ResultUtils.success("选择成功!");
        }
        return ResultUtils.error("选择失败!");
    }
}

```

##### 5、setAssign.js添加saveSelectBedApi()方法

```js
import http from "@/utils/http";
//根据层数id查询宿舍
export const getRoomByStoreyIdApi = async(parm)=>{
    return await http.get("/api/dormRoom/getRoomByStoreyId",parm)
}
//分配宿舍保存
export const assignSaveBedApi = async(parm)=>{
    return await http.post("/api/assingBed/assignSaveBed",parm)
}
//分配宿舍列表
export const getAssignBedListApi = async(parm)=>{
    return await http.get("/api/assingBed/getAssignBedList",parm)
}
//删除
export const deleteAssignApi = async(parm)=>{
    return await http.delete("/api/assingBed",parm)
}
//学生查询宿舍列表
export const getRoomByClassIdApi = async(parm)=>{
    return await http.get("/api/assingBed/getRoomByClassId",parm)
}
//保存选择宿舍
export const saveSelectBedApi = async(parm)=>{
    return await http.post("/api/stuBed/selectBedSave",parm);
}
```

##### 6、selectBed.vue页面

```js
<template>
  <el-main class="mains">
    <!-- 表格 -->
    <el-collapse
      style="overflow-y: auto"
      accordion
      :style="{ height: accordionHeight + 'px' }"
    >
      <el-collapse-item
        class="collapse-main"
        v-for="(item, index) in tableList"
        :key="index"
      >
        <template slot="title" class="room-title-header">
          <span class="room-title">{{ item.roomCode }}宿舍</span>
          <span class="room-type" v-if="item.rootType == '1'">1人间</span>
          <span class="room-type" v-if="item.rootType == '2'">2人间</span>
          <span class="room-type" v-if="item.rootType == '4'">4人间</span>
          <span class="room-type" v-if="item.rootType == '6'">6人间</span>
          <span class="room-type"
            >(共{{ item.children.length }}个床位,已选{{
              item.children | getHasNum
            }})人</span
          >
        </template>
        <!-- 床位列表 -->
        <div class="bedList">
          <div v-for="(bed, bindex) in item.children" :key="bindex">
            <div @click="hasBtn()" v-if="bed.stuName" class="bed-item-active">
              <span class="num-text">{{ bed.bedCode }}</span>
              <div class="bed-main">
                <svg-icon
                  v-if="bed.stuName"
                  class="bed-svg"
                  icon-class="bed-active"
                />
                <svg-icon v-else class="bed-svg" icon-class="bed-no" />
                <div v-if="bed.stuName" class="stuInfo">
                  <div>
                    <div>
                      <span>姓名：</span>
                      <span>{{ bed.stuName }}</span>
                    </div>
                    <div>
                      <span>班级：</span>
                      <span>{{ bed.className }}</span>
                    </div>
                  </div>
                </div>
                <div v-else style="color: #aeb5b5">暂未选择</div>
              </div>
            </div>
            <dir @click="selectBtn(bed)" v-else class="bed-item">
              <span class="num-text">{{ bed.bedCode }}</span>
              <div class="bed-main">
                <svg-icon class="bed-svg" icon-class="bed-no" />
                <div style="color: #aeb5b5">暂未选择</div>
              </div>
            </dir>
          </div>
        </div>
      </el-collapse-item>
    </el-collapse>
  </el-main>
</template>

<script>
import { getRoomByClassIdApi, saveSelectBedApi } from "@/api/setAssign.js";
import { getUserId, getUserType } from "@/utils/auth.js";
export default {
  data() {
    return {
      tableList: [],
      accordionHeight: 0,
    };
  },
  filters: {
    getHasNum(children) {
      let num = 0;
      if (children && children.length > 0) {
        for (let i = 0; i < children.length; i++) {
          if (children[i].stuName) {
            num = num + 1;
          }
        }
      }
      return num;
    },
  },
  created() {
    this.getRoomByClassId();
  },
  mounted() {
    this.$nextTick(() => {
      this.accordionHeight = window.innerHeight - 200;
    });
  },
  methods: {
    hasBtn() {
      this.$message.success("该床位已经被选择!");
      return;
    },
    //床位点击事件
    async selectBtn(bed) {
      console.log(bed);
      const confirm = await this.$myconfirm("确定选择该宿舍吗?");
      if (confirm) {
        let res = await saveSelectBedApi({
          bedId: bed.bedId,
          stuId: getUserId(),
        });
        if(res && res.code == 200){
          this.$message.success(res.msg)
          this.getRoomByClassId()
        }
      }
    },
    async getRoomByClassId() {
      let res = await getRoomByClassIdApi({
        userId: getUserId(),
        userType: getUserType(),
      });
      console.log(res);
      if (res && res.code == 200) {
        this.tableList = res.data;
      }
    },
  },
};
</script>


<style lang="scss" scoped>
.room-title-header {
  display: flex;
  background: #f8f8f8;
}
.collapse-main {
  background: #f8f8f8;
  border: 1px solid #dcdfe6;
  margin: 5px 0px;
}
.stuInfo {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
.bedList {
  display: flex;
  flex-wrap: wrap;
}
.room-type {
  //   color: #ff7670;
  flex-grow: 1;
  font-weight: 600;
}
.bed-main {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
.bed-item {
  border: 1px solid #dedede;
  border-radius: 4px;
  background-color: #f8f8f8;
  height: 180px;
  width: 180px;
  margin: 15px 15px;
  padding-left: 0px !important;
  display: flex;
  flex-direction: column;
  cursor: pointer;
}
.bed-item-active {
  background: #f2feff;
  border: 1px solid #ddeff1;
  border-radius: 4px;
  height: 180px;
  width: 180px;
  margin: 15px 15px;
  display: flex;
  flex-direction: column;
  cursor: pointer;
}
.num-text {
  color: #8a8a8a;
}
.active-num-text {
  color: #42b983;
  font-weight: 600;
}
.bed-svg {
  font-size: 100px;
}
.build-main {
  padding-top: 25px;
  background: #f3f3f4;
}
.build-list {
  display: flex;
  flex-wrap: wrap;
  background: #fff;
}
.build-item {
  display: flex;
  padding: 8px 30px;
  margin: 10px;
  font-size: 14px;
  border: 1px solid #dedede;
  border-radius: 4px;
  cursor: pointer;
  background: #fff;
}
.isActive {
  background: #42b983;
  color: #fff;
}
.containers {
  margin-top: 20px;
  border: 1px solid #dcdfe6;
}
.room-title {
  padding-left: 15px;
  //   color: #5fb878;
  font-size: 13px;
  font-weight: 600;
  flex-grow: 1;
}
.leftAsside {
  border-right: 1px solid #dcdfe6;
  display: flex;
  flex-direction: column;
  align-items: center;
  background: #fff;
}
.storey-item {
  padding: 8px 30px;
  margin: 10px 10px;
  font-size: 14px;
  border: 1px solid #dedede;
  border-radius: 4px;
  cursor: pointer;
  background-color: #f8f8f8;
}
.destoryActive {
  background: #5fb878 !important;
  border-color: #5fb878 !important;
  color: #fff;
}
.mains {
  padding-top: 10px;
  background: #fff;
}
</style>
```





#### 第85讲 我的宿舍列表开发

##### 1、新建实体类StuBedVo

```js
package com.itmk.web.select_bed.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class StuBedVo {
    private Long stuId;
    private Long bedId;
    private Long roomId;
    private String roomCode;
    private String rootType;
    private String bedCode;
    private String storeyName;
    private String buildName;
    private String stuName;
    private String className;
}

```

##### 2、StuBedMapper接口添加getStuBedList()方法

```js
package com.itmk.web.select_bed.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.select_bed.entity.StuBed;
import com.itmk.web.select_bed.entity.StuBedVo;
import org.apache.ibatis.annotations.Param;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface StuBedMapper extends BaseMapper<StuBed> {
    List<StuBedVo> getStuBedList(@Param("stuId") Long stuId);
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.select_bed.mapper.StuBedMapper">
    <select id="getStuBedList" resultType="com.itmk.web.select_bed.entity.StuBedVo">
        select sb.stu_id,sb.bed_id,dr.room_id,dr.room_code,dr.root_type,drb.bed_code,ds.storey_name,db.build_name,ss.stu_name,scs.class_name from select_bed as sb
        inner join drom_room_bed as drb on drb.bed_id = sb.bed_id
        inner join dorm_room as dr on dr.room_id = drb.room_id
        inner join drom_storey as ds on ds.storey_id = dr.storey_id
        inner join drom_build as db on db.build_id = ds.build_id
        inner join school_student as ss on ss.stu_id = sb.stu_id
        inner join school_class as scs on scs.class_id = ss.class_id
        where sb.stu_id =#{stuId}
    </select>
</mapper>
```

##### 3、StuBedService添加getStuBedList()方法

```js
package com.itmk.web.select_bed.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.select_bed.entity.StuBed;
import com.itmk.web.select_bed.entity.StuBedVo;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface StuBedService extends IService<StuBed> {
    List<StuBedVo> getStuBedList(Long stuId);
}

```

实现类

```js
package com.itmk.web.select_bed.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.select_bed.entity.StuBed;
import com.itmk.web.select_bed.entity.StuBedVo;
import com.itmk.web.select_bed.mapper.StuBedMapper;
import com.itmk.web.select_bed.service.StuBedService;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class StuBedServiceImpl extends ServiceImpl<StuBedMapper, StuBed> implements StuBedService {
    @Override
    public List<StuBedVo> getStuBedList(Long stuId) {
        return this.baseMapper.getStuBedList(stuId);
    }
}

```

##### 4、控制器

```js
package com.itmk.web.select_bed.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.select_bed.entity.StuBed;
import com.itmk.web.select_bed.entity.StuBedVo;
import com.itmk.web.select_bed.service.StuBedService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;


/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/stuBed")
public class StuBedController {
    @Autowired
    private StuBedService stuBedService;

    @PostMapping("/selectBedSave")
    public ResultVo selectBedSave(@RequestBody StuBed stuBed){
        //根据床位查询，是否被选选
        QueryWrapper<StuBed> query = new QueryWrapper<>();
        query.lambda().eq(StuBed::getBedId,stuBed.getBedId());
        StuBed bed = stuBedService.getOne(query);
        if(bed != null){
            return ResultUtils.error("该床位已经被占用!");
        }
        //查询学生是否已经选择床位
        QueryWrapper<StuBed> stuQuery = new QueryWrapper<>();
        stuQuery.lambda().eq(StuBed::getStuId,stuBed.getStuId());
        StuBed stu = stuBedService.getOne(stuQuery);
        if(stu != null){
            return ResultUtils.error("您已经选择宿舍，不用重复选择!");
        }
        //保存选择的宿舍
        boolean save = stuBedService.save(stuBed);
        if(save){
            return ResultUtils.success("选择成功!");
        }
        return ResultUtils.error("选择失败!");
    }

    //查询学生宿舍
    @GetMapping("/getStuBedList")
    public ResultVo getStuBedList(Long stuId){
        List<StuBedVo> stuBedList = stuBedService.getStuBedList(stuId);
        return ResultUtils.success("查询成功",stuBedList);
    }
}

```

##### 5、api下新建mybed.js

```js
import http from "@/utils/http";
//查询我的宿舍列表
export const getStuBedListApi = async(parm)=>{
    return await http.get("/api/stuBed/getStuBedList",parm)
}
```

##### 6、drom目录下新建myBed.vue

```js
<template>
  <el-main>
    <el-table :data="tableList" border stripe>
      <el-table-column prop="stuName" label="姓名"></el-table-column>
      <el-table-column prop="className" label="班级"></el-table-column>
      <el-table-column prop="buildName" label="栋数"></el-table-column>
      <el-table-column prop="storeyName" label="层数"></el-table-column>
      <el-table-column prop="roomCode" label="宿舍"></el-table-column>
      <el-table-column prop="bedCode" label="床位"></el-table-column>
      <el-table-column prop="bedCode" label="床位">
        <template slot-scope="scope">
          <span class="room-type" v-if="scope.row.rootType == '1'">1人间</span>
          <span class="room-type" v-if="scope.row.rootType == '2'">2人间</span>
          <span class="room-type" v-if="scope.row.rootType == '4'">4人间</span>
          <span class="room-type" v-if="scope.row.rootType == '6'">6人间</span>
        </template>
      </el-table-column>
      <el-table-column prop="bedCode" label="操作" align="center" width="150">
        <template slot-scope="scope">
          <el-button icon="el-icon-plus" type="primary" size="small" @click="applyBtn(scope.row)">调换宿舍</el-button>
        </template>
      </el-table-column>
    </el-table>
  </el-main>
</template>

<script>
import { getStuBedListApi } from "@/api/mybed.js";
import { getUserId } from "@/utils/auth.js";
export default {
  data() {
    return {
      tableList: [],
    };
  },
  created() {
    this.getStuBedList();
  },
  methods: {
    applyBtn(row){

    },
    async getStuBedList() {
      let res = await getStuBedListApi({
        stuId: getUserId(),
      });
      if (res && res.code == 200) {
        this.tableList = res.data;
      }
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```









#### 第86讲 申请调换宿舍页面制作

##### 1、新建实体类ChangeStu

```js
package com.itmk.web.select_bed.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class ChangeStu {
    private Long stuId;
    private String stuName;
}

```

##### 2、StuBedMapper接口新增getStuList()方法

```js
package com.itmk.web.select_bed.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.select_bed.entity.ChangeStu;
import com.itmk.web.select_bed.entity.StuBed;
import com.itmk.web.select_bed.entity.StuBedVo;
import org.apache.ibatis.annotations.Param;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface StuBedMapper extends BaseMapper<StuBed> {
    List<StuBedVo> getStuBedList(@Param("stuId") Long stuId);
    List<ChangeStu> getStuList(@Param("classId") Long classId);
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.select_bed.mapper.StuBedMapper">
    <select id="getStuBedList" resultType="com.itmk.web.select_bed.entity.StuBedVo">
        select sb.stu_id,sb.bed_id,dr.room_id,dr.room_code,dr.root_type,drb.bed_code,ds.storey_name,db.build_name,ss.stu_name,scs.class_name from select_bed as sb
        inner join drom_room_bed as drb on drb.bed_id = sb.bed_id
        inner join dorm_room as dr on dr.room_id = drb.room_id
        inner join drom_storey as ds on ds.storey_id = dr.storey_id
        inner join drom_build as db on db.build_id = ds.build_id
        inner join school_student as ss on ss.stu_id = sb.stu_id
        inner join school_class as scs on scs.class_id = ss.class_id
        where sb.stu_id =#{stuId}
    </select>
    <select id="getStuList" resultType="com.itmk.web.select_bed.entity.ChangeStu">
        select st.stu_id ,st.stu_name from select_bed  as sb
        inner join school_student as st on st.stu_id = sb.stu_id
        where st.class_id =#{classId}
    </select>
</mapper>
```

##### 3、StuBedService接口添加getStuList方法

```js
package com.itmk.web.select_bed.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.select_bed.entity.ChangeStu;
import com.itmk.web.select_bed.entity.StuBed;
import com.itmk.web.select_bed.entity.StuBedVo;
import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface StuBedService extends IService<StuBed> {
    List<StuBedVo> getStuBedList(Long stuId);
    List<ChangeStu> getStuList(Long classId);
}

```

实现类

```js
package com.itmk.web.select_bed.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.select_bed.entity.ChangeStu;
import com.itmk.web.select_bed.entity.StuBed;
import com.itmk.web.select_bed.entity.StuBedVo;
import com.itmk.web.select_bed.mapper.StuBedMapper;
import com.itmk.web.select_bed.service.StuBedService;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class StuBedServiceImpl extends ServiceImpl<StuBedMapper, StuBed> implements StuBedService {
    @Override
    public List<StuBedVo> getStuBedList(Long stuId) {
        return this.baseMapper.getStuBedList(stuId);
    }

    @Override
    public List<ChangeStu> getStuList(Long classId) {
        return this.baseMapper.getStuList(classId);
    }
}

```

##### 4、控制器添加getStuList()方法

```js
package com.itmk.web.select_bed.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.school_student.entity.SchoolStudent;
import com.itmk.web.school_student.service.SchoolStudentService;
import com.itmk.web.select_bed.entity.ChangeStu;
import com.itmk.web.select_bed.entity.StuBed;
import com.itmk.web.select_bed.entity.StuBedVo;
import com.itmk.web.select_bed.service.StuBedService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;


/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/stuBed")
public class StuBedController {
    @Autowired
    private StuBedService stuBedService;
    @Autowired
    private SchoolStudentService schoolStudentService;

    @PostMapping("/selectBedSave")
    public ResultVo selectBedSave(@RequestBody StuBed stuBed){
        //根据床位查询，是否被选选
        QueryWrapper<StuBed> query = new QueryWrapper<>();
        query.lambda().eq(StuBed::getBedId,stuBed.getBedId());
        StuBed bed = stuBedService.getOne(query);
        if(bed != null){
            return ResultUtils.error("该床位已经被占用!");
        }
        //查询学生是否已经选择床位
        QueryWrapper<StuBed> stuQuery = new QueryWrapper<>();
        stuQuery.lambda().eq(StuBed::getStuId,stuBed.getStuId());
        StuBed stu = stuBedService.getOne(stuQuery);
        if(stu != null){
            return ResultUtils.error("您已经选择宿舍，不用重复选择!");
        }
        //保存选择的宿舍
        boolean save = stuBedService.save(stuBed);
        if(save){
            return ResultUtils.success("选择成功!");
        }
        return ResultUtils.error("选择失败!");
    }

    //查询学生宿舍
    @GetMapping("/getStuBedList")
    public ResultVo getStuBedList(Long stuId){
        List<StuBedVo> stuBedList = stuBedService.getStuBedList(stuId);
        return ResultUtils.success("查询成功",stuBedList);
    }

    //查询学生列表
    @GetMapping("/getStuList")
    public ResultVo getStuList(Long stuId){
        SchoolStudent student = schoolStudentService.getById(stuId);
        List<ChangeStu> stuList = stuBedService.getStuList(student.getClassId());
        return ResultUtils.success("查询成功",stuList);
    }
}

```

##### 5、api/mybed.js添加getStuListApi()方法

```js
import http from "@/utils/http";
//查询我的宿舍列表
export const getStuBedListApi = async(parm)=>{
    return await http.get("/api/stuBed/getStuBedList",parm)
}
//查询学生列表
export const getStuListApi = async(parm)=>{
    return await http.get("/api/stuBed/getStuList",parm)
}
```

##### 6、页面

```js
<template>
  <el-main>
    <el-table :data="tableList" border stripe>
      <el-table-column prop="stuName" label="姓名"></el-table-column>
      <el-table-column prop="className" label="班级"></el-table-column>
      <el-table-column prop="buildName" label="栋数"></el-table-column>
      <el-table-column prop="storeyName" label="层数"></el-table-column>
      <el-table-column prop="roomCode" label="宿舍"></el-table-column>
      <el-table-column prop="bedCode" label="床位"></el-table-column>
      <el-table-column prop="bedCode" label="床位">
        <template slot-scope="scope">
          <span class="room-type" v-if="scope.row.rootType == '1'">1人间</span>
          <span class="room-type" v-if="scope.row.rootType == '2'">2人间</span>
          <span class="room-type" v-if="scope.row.rootType == '4'">4人间</span>
          <span class="room-type" v-if="scope.row.rootType == '6'">6人间</span>
        </template>
      </el-table-column>
      <el-table-column prop="bedCode" label="操作" align="center" width="150">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-plus"
            type="primary"
            size="small"
            @click="applyBtn(scope.row)"
            >调换宿舍</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 弹框 -->
    <sys-dialog
      :title="dialog.title"
      :height="dialog.height"
      :width="dialog.width"
      :visible="dialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-transfer
          v-model="value"
          :data="stuList"
          :props="{
            key: 'stuId',
            label: 'stuName',
          }"
          filterable
          :filter-method="filterMethod"
          filter-placeholder="请输入姓名"
          @left-check-change="leftChange"
          @change="btnChange"
        ></el-transfer>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getStuBedListApi, getStuListApi } from "@/api/mybed.js";
import { getUserId } from "@/utils/auth.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      value: [],
      //弹框的属性
      dialog: {
        title: "",
        height: 320,
        width: 620,
        visible: false,
      },
      tableList: [],
      stuList: [],
    };
  },
  created() {
    this.getStuBedList();
  },
  methods: {
    btnChange(select, index) {
      let item = this.value;
      if (item.length > 0) {
        for (let i = 0; i < item.length; i++) {
          for (let j = 0; j < select.length; j++) {
            if (item[i] != select[j]) {
              item.splice(i, 1);
            }
          }
        }
      }
    },
    leftChange(item, index) {
      if (item.length > 0) {
        for (let i = 0; i < item.length; i++) {
          for (let j = 0; j < index.length; j++) {
            if (item[i] != index[j]) {
              item.splice(i, 1);
            }
          }
        }
      }
    },
    filterMethod(query, item) {
      return item.stuName.indexOf(query) > -1;
    },
    onConfirm() {
      console.log(this.value)
      // this.dialog.visible = false;
    },
    onClose() {
      this.dialog.visible = false;
    },
    applyBtn(row) {
      //查询学生信息
      this.getStuList();
      this.dialog.title = "申请调换";
      this.dialog.visible = true;
    },
    //查询调换的学生信息
    async getStuList() {
      let res = await getStuListApi({
        stuId: getUserId(),
      });
      if (res && res.code == 200) {
        this.stuList = res.data;
        console.log(this.stuList);
      }
    },
    async getStuBedList() {
      let res = await getStuBedListApi({
        stuId: getUserId(),
      });
      if (res && res.code == 200) {
        this.tableList = res.data;
      }
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```







#### 第87讲 申请调宿舍接口开发

```js
drop table if exists apply_change;

/*==============================================================*/
/* Table: apply_change                                          */
/*==============================================================*/
create table apply_change
(
   apply_id             int not null auto_increment comment '调换id',
   apply_user_id        int comment '申请人id',
   apply_user_name      varchar(64) comment '申请人姓名',
   apply_bed_id         int comment '申请人床位id',
   apply_bed_code       varchar(36) comment '申请人床位编号',
   change_user_id       int comment '调换人id',
   change_user_name     varchar(64) comment '调换人姓名',
   change_bed_id        int comment '调换人的床位id',
   change_bed_code      varchar(36) comment '调换人的床位编号',
   status               varchar(2) comment '0：待审核 1：审核通过 2：拒绝',
   primary key (apply_id)
);

```



##### 1、新建实体类

```js
package com.itmk.web.apply_change.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
@TableName("apply_change")
public class ApplyChange {
    @TableId(type = IdType.AUTO)
    private Long applyId;
    private Long applyUserId;
    private Long applyBedId;
    private Long changeUserId;
    private Long changeBedId;
    private String applyUserName;
    private String applyBedCode;
    private String changeUserName;
    private String changeBedCode;
    private String status;
}

```

```js
package com.itmk.web.apply_change.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class ApplyParm {
    private Long applyId;
    private Long changeId;
}

```

```js
package com.itmk.web.apply_change.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class StuInfoVo {
    private Long stuId;
    private Long bedId;
    private String bedCode;
    private String stuName;
}

```

##### 2、新建mapper层

```js
package com.itmk.web.apply_change.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.apply_change.entity.ApplyChange;
import com.itmk.web.apply_change.entity.StuInfoVo;
import org.apache.ibatis.annotations.Param;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface ApplyChangeMapper extends BaseMapper<ApplyChange> {
    StuInfoVo getStuInfo(@Param("stuId") Long stuId);
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.apply_change.mapper.ApplyChangeMapper">
    <select id="getStuInfo" resultType="com.itmk.web.apply_change.entity.StuInfoVo">
        select sb.stu_id,drb.bed_code,sb.bed_id,st.stu_name from select_bed as sb
        inner join drom_room_bed as drb on drb.bed_id = sb.bed_id
        inner join school_student as st on st.stu_id = sb.stu_id
        where sb.stu_id =#{stuId}
    </select>
</mapper>
```

##### 3、新建service层

```js
package com.itmk.web.apply_change.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.apply_change.entity.ApplyChange;
import com.itmk.web.apply_change.entity.ApplyParm;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface ApplyChangeService extends IService<ApplyChange> {
    void applySave(ApplyParm parm);
}

```

实现类

```js
package com.itmk.web.apply_change.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.apply_change.entity.ApplyChange;
import com.itmk.web.apply_change.entity.ApplyParm;
import com.itmk.web.apply_change.entity.StuInfoVo;
import com.itmk.web.apply_change.mapper.ApplyChangeMapper;
import com.itmk.web.apply_change.service.ApplyChangeService;
import org.springframework.stereotype.Service;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class ApplyChangeServiceImpl extends ServiceImpl<ApplyChangeMapper, ApplyChange> implements ApplyChangeService {
    @Override
    public void applySave(ApplyParm parm) {
        ApplyChange changeStu = new ApplyChange();
        //查询申请人信息
        StuInfoVo stuInfo = this.baseMapper.getStuInfo(parm.getApplyId());
        changeStu.setApplyUserId(stuInfo.getStuId());
        changeStu.setApplyBedId(stuInfo.getBedId());
        changeStu.setApplyBedCode(stuInfo.getBedCode());
        changeStu.setApplyUserName(stuInfo.getStuName());
        //调换人信息
        StuInfoVo change = this.baseMapper.getStuInfo(parm.getChangeId());
        changeStu.setChangeBedCode(change.getBedCode());
        changeStu.setChangeBedId(change.getBedId());
        changeStu.setChangeUserId(change.getStuId());
        changeStu.setChangeUserName(change.getStuName());
        changeStu.setStatus("0"); //待审核
        this.baseMapper.insert(changeStu);
    }
}

```

##### 4、新建控制器

```js
package com.itmk.web.apply_change.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.apply_change.entity.ApplyChange;
import com.itmk.web.apply_change.entity.ApplyParm;
import com.itmk.web.apply_change.service.ApplyChangeService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/applyChange")
public class ApplyChangeController {
    @Autowired
    private ApplyChangeService applyChangeService;
    //申请提交
    @PostMapping("/applySave")
    public ResultVo applySave(@RequestBody ApplyParm parm){
        QueryWrapper<ApplyChange> query = new QueryWrapper<>();
        query.lambda().eq(ApplyChange::getApplyUserId,parm.getApplyId())
                .eq(ApplyChange::getStatus,"0");
        ApplyChange one = applyChangeService.getOne(query);
        if(one != null){
            return ResultUtils.error("申请正在审批中，不用重复提交申请!");
        }
        applyChangeService.applySave(parm);
        return ResultUtils.success("申请成功");
    }
}

```

##### 5、api/mybed.js添加applySaveApi()方法

```js
import http from "@/utils/http";
//查询我的宿舍列表
export const getStuBedListApi = async(parm)=>{
    return await http.get("/api/stuBed/getStuBedList",parm)
}
//查询班级下的学生
export const getStuListApi = async(parm)=>{
    return await http.get("/api/stuBed/getStuList",parm)
}
//申请提交
export const applySaveApi = async(parm)=>{
    return await http.post("/api/applyChange/applySave",parm)
}
```

##### 6、myBed.vue页面

```js
<template>
  <el-main>
    <el-table :data="tableList" border stripe>
      <el-table-column prop="stuName" label="姓名"></el-table-column>
      <el-table-column prop="className" label="班级"></el-table-column>
      <el-table-column prop="buildName" label="栋数"></el-table-column>
      <el-table-column prop="storeyName" label="层数"></el-table-column>
      <el-table-column prop="roomCode" label="宿舍"></el-table-column>
      <el-table-column prop="bedCode" label="床位"></el-table-column>
      <el-table-column prop="bedCode" label="床位">
        <template slot-scope="scope">
          <span class="room-type" v-if="scope.row.rootType == '1'">1人间</span>
          <span class="room-type" v-if="scope.row.rootType == '2'">2人间</span>
          <span class="room-type" v-if="scope.row.rootType == '4'">4人间</span>
          <span class="room-type" v-if="scope.row.rootType == '6'">6人间</span>
        </template>
      </el-table-column>
      <el-table-column prop="bedCode" label="操作" align="center" width="150">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-plus"
            type="primary"
            size="small"
            @click="applyBtn(scope.row)"
            >调换宿舍</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 弹框 -->
    <sys-dialog
      :title="dialog.title"
      :height="dialog.height"
      :width="dialog.width"
      :visible="dialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-transfer
          v-model="value"
          :data="stuList"
          :props="{
            key: 'stuId',
            label: 'stuName',
          }"
          filterable
          :filter-method="filterMethod"
          filter-placeholder="请输入姓名"
          @left-check-change="leftChange"
          @change="btnChange"
        ></el-transfer>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getStuBedListApi, getStuListApi, applySaveApi } from "@/api/mybed.js";
import { getUserId } from "@/utils/auth.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      value: [],
      //弹框的属性
      dialog: {
        title: "",
        height: 320,
        width: 620,
        visible: false,
      },
      tableList: [],
      stuList: [],
    };
  },
  created() {
    this.getStuBedList();
  },
  methods: {
    btnChange(select, index) {
      let item = this.value;
      if (item.length > 0) {
        for (let i = 0; i < item.length; i++) {
          for (let j = 0; j < select.length; j++) {
            if (item[i] != select[j]) {
              item.splice(i, 1);
            }
          }
        }
      }
    },
    leftChange(item, index) {
      if (item.length > 0) {
        for (let i = 0; i < item.length; i++) {
          for (let j = 0; j < index.length; j++) {
            if (item[i] != index[j]) {
              item.splice(i, 1);
            }
          }
        }
      }
    },
    filterMethod(query, item) {
      return item.stuName.indexOf(query) > -1;
    },
    async onConfirm() {
      console.log(this.value);
      let res = await applySaveApi({
        applyId: getUserId(),
        changeId: this.value[0],
      });
      if (res && res.code == 200) {
        this.$message.success(res.msg);
        this.dialog.visible = false;
      }
    },
    onClose() {
      this.dialog.visible = false;
    },
    applyBtn(row) {
      //查询学生信息
      this.getStuList();
      this.dialog.title = "申请调换";
      this.dialog.visible = true;
    },
    //查询调换的学生信息
    async getStuList() {
      let res = await getStuListApi({
        stuId: getUserId(),
      });
      if (res && res.code == 200) {
        this.stuList = res.data;
        console.log(this.stuList);
      }
    },
    async getStuBedList() {
      let res = await getStuBedListApi({
        stuId: getUserId(),
      });
      if (res && res.code == 200) {
        this.tableList = res.data;
      }
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```







#### 第88讲 调换申请列表开发

##### 1、新建实体类

```js
package com.itmk.web.apply_change.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class ApplyListParm {
    private Long currentPage;
    private Long pageSize;
    private String userType;
    private Long userId;
}

```

```js
package com.itmk.web.apply_change.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class ApplyDoParm {
   private Long applyId;
   private String type;
}

```

##### 2、ApplyChangeController控制器添加getList()方法和applyDo()方法

```js
package com.itmk.web.apply_change.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.apply_change.entity.ApplyChange;
import com.itmk.web.apply_change.entity.ApplyDoParm;
import com.itmk.web.apply_change.entity.ApplyListParm;
import com.itmk.web.apply_change.entity.ApplyParm;
import com.itmk.web.apply_change.service.ApplyChangeService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/applyChange")
public class ApplyChangeController {
    @Autowired
    private ApplyChangeService applyChangeService;

    //保存申请
    @PostMapping("/applySave")
    public ResultVo applySave(@RequestBody ApplyParm parm) {
        //查询该学生是否已经申请
        QueryWrapper<ApplyChange> query = new QueryWrapper<>();
        query.lambda().eq(ApplyChange::getApplyUserId, parm.getApplyId())
                .eq(ApplyChange::getStatus, "0");
        ApplyChange one = applyChangeService.getOne(query);
        if (one != null) {
            return ResultUtils.error("您已经提交申请，不重复提交!");
        }
        applyChangeService.applySave(parm);
        return ResultUtils.success("申请成功!");
    }

    //列表查询
    @GetMapping("/getList")
    public ResultVo getList(ApplyListParm parm) {
        IPage<ApplyChange> page = new Page<>(parm.getCurrentPage(), parm.getPageSize());
        if (parm.getUserType().equals("0")) {
            QueryWrapper<ApplyChange> query = new QueryWrapper<>();
            query.lambda().eq(ApplyChange::getApplyUserId, parm.getUserId());
            IPage<ApplyChange> list = applyChangeService.page(page, query);
            return ResultUtils.success("查询成功", list);
        } else {
            IPage<ApplyChange> list = applyChangeService.page(page);
            return ResultUtils.success("查询成功", list);
        }
    }

    @PostMapping("/applyDo")
    public ResultVo applyDo(@RequestBody ApplyDoParm change) {
        ApplyChange applyChange = new ApplyChange();
        applyChange.setStatus(change.getType());
        applyChange.setApplyId(change.getApplyId());
        boolean b = applyChangeService.updateById(applyChange);
        if(b){
            return ResultUtils.success("操作成功");
        }
        return ResultUtils.error("操作失败");
    }
}

```

##### 3、mybed.js添加applyDoApi()方法

```js
import http from "@/utils/http";
//查询我的宿舍列表
export const getStuBedListApi = async(parm)=>{
    return await http.get("/api/stuBed/getStuBedList",parm)
}
//查询班级下的学生
export const getStuListApi = async(parm)=>{
    return await http.get("/api/stuBed/getStuList",parm)
}
//申请提交
export const applySaveApi = async(parm)=>{
    return await http.post("/api/applyChange/applySave",parm)
}
//申请列表
export const getListApi = async(parm)=>{
    return await http.get("/api/applyChange/getList",parm)
}
//处理申请
export const applyDoApi = async(parm)=>{
    return await http.post("/api/applyChange/applyDo",parm)
}

```

##### 4、drom目录下新建applyList.vue页面

```js
<template>
  <el-main>
    <el-table :data="tableList" border stripe>
      <el-table-column prop="applyUserName" label="申请人"></el-table-column>
      <el-table-column prop="applyBedCode" label="申请人床位"></el-table-column>
      <el-table-column prop="changeUserName" label="调换人"></el-table-column>
      <el-table-column prop="changeBedCode" label="调换床位"></el-table-column>
      <el-table-column prop="status" label="申请状态">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.status == '2'" type="danger" size="normal"
            >拒绝</el-tag
          >
          <el-tag v-if="scope.row.status == '1'" type="success" size="normal"
            >审核通过</el-tag
          >
          <el-tag v-if="scope.row.status == '0'" type="warning" size="normal"
            >审核中</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column label="操作" align="center" width="220">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="applyBtn(scope.row)"
            >同意</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="returnBtn(scope.row)"
            >拒绝</el-button
          >
        </template>
      </el-table-column>
    </el-table>
  </el-main>
</template>

<script>
import { getListApi, applyDoApi } from "@/api/mybed.js";
import { getUserType, getUserId } from "@/utils/auth.js";
export default {
  data() {
    return {
      tableList: [],
      parm: {
        currentPage: 1,
        pageSize: 10,
        userType: getUserType(),
        userId: getUserId(),
        total: 0,
      },
    };
  },
  created() {
    this.getList();
  },
  methods: {
    async returnBtn(row) {
      const confirm = await this.$myconfirm("确定拒绝吗?");
      if (confirm) {
        this.applyDo("2", row.applyId);
      }
    },
    async applyBtn(row) {
      const confirm = await this.$myconfirm("确定同意吗?");
      if (confirm) {
        this.applyDo("1", row.applyId);
      }
    },
    async applyDo(type, applyId) {
      let res = await applyDoApi({
        applyId: applyId,
        type: type,
      });
      if (res && res.code == 200) {
        this.$message.success(res.msg);
        this.getList();
      }
    },
    async getList() {
      let res = await getListApi(this.parm);
      if (res && res.code == 200) {
        console.log(res);
        this.tableList = res.data.records;
        this.parm.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第89讲 申请保存对接

##### 1、ApplyDoParm实体类修改为如下

```js
package com.itmk.web.apply_change.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class ApplyDoParm {
   private Long applyId;
   private String type;
   private String userType;
}

```

##### 2、ApplyChangeService接口添加applyDo()方法

```js
package com.itmk.web.apply_change.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.apply_change.entity.ApplyChange;
import com.itmk.web.apply_change.entity.ApplyDoParm;
import com.itmk.web.apply_change.entity.ApplyParm;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface ApplyChangeService extends IService<ApplyChange> {
     void applySave(ApplyParm parm);
     void applyDo(ApplyDoParm change);
}

```

实现类

```js
package com.itmk.web.apply_change.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.apply_change.entity.ApplyChange;
import com.itmk.web.apply_change.entity.ApplyDoParm;
import com.itmk.web.apply_change.entity.ApplyParm;
import com.itmk.web.apply_change.entity.StuInfoVo;
import com.itmk.web.apply_change.mapper.ApplyChangeMapper;
import com.itmk.web.apply_change.service.ApplyChangeService;
import com.itmk.web.select_bed.entity.StuBed;
import com.itmk.web.select_bed.service.StuBedService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class ApplyChangeServiceImpl extends ServiceImpl<ApplyChangeMapper, ApplyChange> implements ApplyChangeService {
    @Autowired
    private StuBedService  stuBedService;
    @Override
    public void applySave(ApplyParm parm) {
        ApplyChange changeStu = new ApplyChange();
        //查询申请人的信息
        StuInfoVo stuInfo = this.baseMapper.getStuInfo(parm.getApplyId());
        changeStu.setApplyUserId(stuInfo.getStuId());
        changeStu.setApplyBedId(stuInfo.getBedId());
        changeStu.setApplyBedCode(stuInfo.getBedCode());
        changeStu.setApplyUserName(stuInfo.getStuName());
        //查询调换人的信息
        StuInfoVo change = this.baseMapper.getStuInfo(parm.getChangeId());
        changeStu.setChangeBedCode(change.getBedCode());
        changeStu.setChangeBedId(change.getBedId());
        changeStu.setChangeUserId(change.getStuId());
        changeStu.setChangeUserName(change.getStuName());
        changeStu.setStatus("0"); //待审核
        this.baseMapper.insert(changeStu);
    }

    @Override
    @Transactional
    public void applyDo(ApplyDoParm change) {
        //查询申请信息
        ApplyChange select = this.baseMapper.selectById(change.getApplyId());
        if(change.getType().equals("1")){
            //更新审核的状态
            ApplyChange apply = new ApplyChange();
            apply.setApplyId(change.getApplyId());
            apply.setStatus("1");
            int i = this.baseMapper.updateById(apply);
            if(i>0){
               //更换床位
                //1.申请人信息
                Long applyUserId = select.getApplyUserId();
                Long applyBedId = select.getApplyBedId();
                //2.跟换人信息
                Long changeUserId = select.getChangeUserId();
                Long changeBedId = select.getChangeBedId();
                //申请人
                StuBed applyBed = new StuBed();
                applyBed.setStuId(applyUserId);
                applyBed.setBedId(changeBedId);
                //调换人
                StuBed changeBed = new StuBed();
                changeBed.setStuId(changeUserId);
                changeBed.setBedId(applyBedId);
                //删除原来的
                QueryWrapper<StuBed> applyQuery = new QueryWrapper<>();
                applyQuery.lambda().eq(StuBed::getStuId,applyUserId);
                stuBedService.remove(applyQuery);
                QueryWrapper<StuBed> changeQuery = new QueryWrapper<>();
                changeQuery.lambda().eq(StuBed::getStuId,changeUserId);
                stuBedService.remove(changeQuery);
                stuBedService.save(applyBed);
                stuBedService.save(changeBed);
            }
        }else {
            //更新审核的状态
            ApplyChange apply = new ApplyChange();
            apply.setApplyId(change.getApplyId());
            apply.setStatus("2");
            this.baseMapper.updateById(apply);
        }
    }
}

```

##### 3、ApplyChangeController的applyDo()方法修改为如下

```js
package com.itmk.web.apply_change.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.apply_change.entity.ApplyChange;
import com.itmk.web.apply_change.entity.ApplyDoParm;
import com.itmk.web.apply_change.entity.ApplyListParm;
import com.itmk.web.apply_change.entity.ApplyParm;
import com.itmk.web.apply_change.service.ApplyChangeService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/applyChange")
public class ApplyChangeController {
    @Autowired
    private ApplyChangeService applyChangeService;

    //保存申请
    @PostMapping("/applySave")
    public ResultVo applySave(@RequestBody ApplyParm parm) {
        //查询该学生是否已经申请
        QueryWrapper<ApplyChange> query = new QueryWrapper<>();
        query.lambda().eq(ApplyChange::getApplyUserId, parm.getApplyId())
                .eq(ApplyChange::getStatus, "0");
        ApplyChange one = applyChangeService.getOne(query);
        if (one != null) {
            return ResultUtils.error("您已经提交申请，不重复提交!");
        }
        applyChangeService.applySave(parm);
        return ResultUtils.success("申请成功!");
    }

    //列表查询
    @GetMapping("/getList")
    public ResultVo getList(ApplyListParm parm) {
        IPage<ApplyChange> page = new Page<>(parm.getCurrentPage(), parm.getPageSize());
        if (parm.getUserType().equals("0")) {
            QueryWrapper<ApplyChange> query = new QueryWrapper<>();
            query.lambda().eq(ApplyChange::getApplyUserId, parm.getUserId());
            IPage<ApplyChange> list = applyChangeService.page(page, query);
            return ResultUtils.success("查询成功", list);
        } else {
            IPage<ApplyChange> list = applyChangeService.page(page);
            return ResultUtils.success("查询成功", list);
        }
    }

    @PostMapping("/applyDo")
    public ResultVo applyDo(@RequestBody ApplyDoParm change) {
        if(change.getUserType().equals("0")){
            return ResultUtils.error("您无权限操作!");
        }
        applyChangeService.applyDo(change);
        return ResultUtils.success("操作成功");
    }
}

```

##### 4、applyListy页面

```js
<template>
  <el-main>
    <el-table :data="tableList" border stripe>
      <el-table-column prop="applyUserName" label="申请人"></el-table-column>
      <el-table-column prop="applyBedCode" label="申请人床位"></el-table-column>
      <el-table-column prop="changeUserName" label="调换人"></el-table-column>
      <el-table-column prop="changeBedCode" label="调换床位"></el-table-column>
      <el-table-column prop="status" label="申请状态">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.status == '2'" type="danger" size="normal"
            >拒绝</el-tag
          >
          <el-tag v-if="scope.row.status == '1'" type="success" size="normal"
            >审核通过</el-tag
          >
          <el-tag v-if="scope.row.status == '0'" type="warning" size="normal"
            >审核中</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column label="操作" align="center" width="220">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="applyBtn(scope.row)"
            >同意</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="returnBtn(scope.row)"
            >拒绝</el-button
          >
        </template>
      </el-table-column>
    </el-table>
  </el-main>
</template>

<script>
import { getListApi, applyDoApi } from "@/api/mybed.js";
import { getUserType, getUserId } from "@/utils/auth.js";
export default {
  data() {
    return {
      tableList: [],
      parm: {
        currentPage: 1,
        pageSize: 10,
        userType: getUserType(),
        userId: getUserId(),
        total: 0,
      },
    };
  },
  created() {
    this.getList();
  },
  methods: {
    async returnBtn(row) {
      if (row.status != "0") {
        this.$message.warning("您已经处理了，无需再次操作!");
        return;
      }
      const confirm = await this.$myconfirm("确定拒绝吗?");
      if (confirm) {
        this.applyDo("2", row.applyId);
      }
    },
    async applyBtn(row) {
      if (row.status != "0") {
        this.$message.warning("您已经处理了，无需再次操作!");
        return;
      }
      const confirm = await this.$myconfirm("确定同意吗?");
      if (confirm) {
        this.applyDo("1", row.applyId);
      }
    },
    async applyDo(type, applyId) {
      let res = await applyDoApi({
        applyId: applyId,
        type: type,
        userType:getUserType()
      });
      if (res && res.code == 200) {
        this.$message.success(res.msg);
        this.getList();
      }
    },
    async getList() {
      let res = await getListApi(this.parm);
      if (res && res.code == 200) {
        console.log(res);
        this.tableList = res.data.records;
        this.parm.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第90讲 宿舍管理模块功能优化

##### 1、新建实体类DromRoomVo

```js
package com.itmk.web.drom_room_bed.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class DromRoomVo {
    private Long bedId;
    private Long roomId;
    private Long stuId;
    private String bedCode;
    private String stuName;
    private String className;
}

```

##### 2、DromRoomBedMapper接口添加getSelectBedList()方法

```js
package com.itmk.web.drom_room_bed.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.drom_room_bed.entity.DromRoomBed;
import com.itmk.web.drom_room_bed.entity.DromRoomVo;
import org.apache.ibatis.annotations.Param;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface DromRoomBedMapper extends BaseMapper<DromRoomBed> {
     List<DromRoomBed> getBedList(@Param("roomId") Long roomId);
     List<DromRoomVo> getSelectBedList(@Param("roomId") Long roomId);
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.drom_room_bed.mapper.DromRoomBedMapper">
    <select id="getBedList" resultType="com.itmk.web.drom_room_bed.entity.DromRoomBed">
        select * from (
        select a.* from drom_room_bed  as a
        left join assign_bed  as b on a.bed_id = b.bed_id
            where b.bed_id is null)t
        where t.room_id =#{roomId}
    </select>
    <select id="getSelectBedList" resultType="com.itmk.web.drom_room_bed.entity.DromRoomVo">
            select drb.*,st.stu_id,st.stu_name,scc.class_name from drom_room_bed as drb
            left join select_bed as sb on sb.bed_id = drb.bed_id
            left join school_student as st on st.stu_id = sb.stu_id
            left join school_class as  scc on scc.class_id = st.class_id
            where drb.room_id =#{roomId}
    </select>
</mapper>
```

##### 3、DromRoomBedService接口添加getSelectBedList()方法

```js
package com.itmk.web.drom_room_bed.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.drom_room_bed.entity.DromRoomBed;
import com.itmk.web.drom_room_bed.entity.DromRoomVo;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface DromRoomBedService extends IService<DromRoomBed> {
     List<DromRoomBed> getBedList(Long roomId);
      List<DromRoomVo> getSelectBedList(Long roomId);
}

```

实现类

```js
package com.itmk.web.drom_room_bed.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.drom_room_bed.entity.DromRoomBed;
import com.itmk.web.drom_room_bed.entity.DromRoomVo;
import com.itmk.web.drom_room_bed.mapper.DromRoomBedMapper;
import com.itmk.web.drom_room_bed.service.DromRoomBedService;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class DromRoomBedServiceImpl extends ServiceImpl<DromRoomBedMapper, DromRoomBed> implements DromRoomBedService {
    @Override
    public List<DromRoomBed> getBedList(Long roomId) {
        return this.baseMapper.getBedList(roomId);
    }

    @Override
    public List<DromRoomVo> getSelectBedList(Long roomId) {
        return this.baseMapper.getSelectBedList(roomId);
    }
}

```

##### 4、DormRoomController控制器的getList()方法修改为如下

```js
package com.itmk.web.dorm_room.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.dorm_room.entity.DormRoom;
import com.itmk.web.dorm_room.entity.RoomListParm;
import com.itmk.web.dorm_room.entity.RoomParm;
import com.itmk.web.dorm_room.entity.RoomTree;
import com.itmk.web.dorm_room.service.DormRoomService;
import com.itmk.web.drom_room_bed.entity.DromRoomBed;
import com.itmk.web.drom_room_bed.entity.DromRoomVo;
import com.itmk.web.drom_room_bed.service.DromRoomBedService;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.ArrayList;
import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/dormRoom")
public class DormRoomController {
    @Autowired
    private DormRoomService dormRoomService;
    @Autowired
    private DromRoomBedService dromRoomBedService;

    //新增
    @PostMapping
    public ResultVo add(@RequestBody RoomParm parm) {
        //起始编号
        int start = parm.getStart();
        List<DormRoom> list = new ArrayList<>();
        while (start <= parm.getEnd()) {
            //房间实体类创建
            DormRoom room = new DormRoom();
            room.setTotalBed(parm.getStuNum());
            room.setRootType(parm.getRootType());
            room.setStoreyId(parm.getStoreyId());
            //构造编号 A100
            if (StringUtils.isNotEmpty(parm.getArea())) {
                room.setRoomCode(parm.getArea() + start);
            } else { // 100
                room.setRoomCode(Integer.toString(start));
            }
            //判断是否重复
            QueryWrapper<DormRoom> query = new QueryWrapper<>();
            query.lambda().eq(DormRoom::getRoomCode, room.getRoomCode());
            DormRoom one = dormRoomService.getOne(query);
            if (one == null) { //没有重复的才放入
                list.add(room);
            }
            //此条件不能少，死循环
            start = start + 1;
        }
        //保存房间
        if (list.size() > 0) {
            dormRoomService.saveBatch(list);
        }
        return ResultUtils.success("设置成功");
    }

    //编辑
    @PutMapping
    public ResultVo edit(@RequestBody DormRoom room) {
        //判断编号是否重复
        QueryWrapper<DormRoom> query = new QueryWrapper<>();
        query.lambda().eq(DormRoom::getRoomCode, room.getRoomCode());
        DormRoom one = dormRoomService.getOne(query);
        if (one != null && one.getRoomId() != room.getRoomId()) {
            return ResultUtils.error("编号重复");
        }
        boolean b = dormRoomService.updateById(room);
        if (b) {
            return ResultUtils.success("编辑成功");
        }
        return ResultUtils.error("编辑失败");
    }

    //删除
    @DeleteMapping("/{roomId}")
    public ResultVo delete(@PathVariable("roomId") Long roomId) {
        //判断房间下面是否住着人
        //如果没有人，才能删除
        boolean b = dormRoomService.removeById(roomId);
        if (b) {
            return ResultUtils.success("删除成功");
        }
        return ResultUtils.error("删除失败");
    }

    //列表查询
//    @GetMapping("/list")
//    public ResultVo getList(RoomListParm parm) {
//        //构造分页对象
//        IPage<DormRoom> page = new Page<>(parm.getCurrentPage(), parm.getPageSize());
//        QueryWrapper<DormRoom> query = new QueryWrapper<>();
//        query.lambda().eq(DormRoom::getStoreyId, parm.getStoreyId());
//        IPage<DormRoom> list = dormRoomService.page(page, query);
//        //查询宿舍对应的床位
//        if (list.getRecords().size() > 0) {
//            for (int i = 0; i < list.getRecords().size(); i++) {
//                //获取宿舍id
//                Long roomId = list.getRecords().get(i).getRoomId();
//                //查询宿舍对应的床位
//                QueryWrapper<DromRoomBed> queryBed = new QueryWrapper<>();
//                queryBed.lambda().eq(DromRoomBed::getRoomId, roomId);
//                List<DromRoomBed> bedList = dromRoomBedService.list(queryBed);
//                list.getRecords().get(i).setBedList(bedList);
//            }
//        }
//        return ResultUtils.success("查询成功", list);
//    }

    @GetMapping("/list")
    public ResultVo getList(RoomListParm parm) {
        //构造分页对象
        IPage<DormRoom> page = new Page<>(parm.getCurrentPage(), parm.getPageSize());
        QueryWrapper<DormRoom> query = new QueryWrapper<>();
        query.lambda().eq(DormRoom::getStoreyId, parm.getStoreyId());
        IPage<DormRoom> list = dormRoomService.page(page, query);
        //查询宿舍对应的床位
        if (list.getRecords().size() > 0) {
            for (int i = 0; i < list.getRecords().size(); i++) {
                //获取宿舍id
                Long roomId = list.getRecords().get(i).getRoomId();
                //查询宿舍对应的床位
                QueryWrapper<DromRoomBed> queryBed = new QueryWrapper<>();
                queryBed.lambda().eq(DromRoomBed::getRoomId, roomId);
                List<DromRoomVo> bedList = dromRoomBedService.getSelectBedList(roomId);
                list.getRecords().get(i).setBedList(bedList);
            }
        }
        return ResultUtils.success("查询成功", list);
    }
    //根据层数id查询宿舍和床位
    @GetMapping("/getRoomByStoreyId")
    public ResultVo getRoomByStoreyId(Long storeyId) {
        List<RoomTree> list = dormRoomService.getRoomTree(storeyId);
        return ResultUtils.success("查询成功",list);
    }

}

```

##### 5、houseList.vue页面

```js
<template>
  <el-main class="build-main">
    <!-- 楼栋布局 -->
    <div class="build-list">
      <div
        class="build-item"
        :id="'build' + index"
        @click="btnClick(item.buildId, index)"
        v-for="(item, index) in buildList"
        :key="index"
        :class="{ isActive: isChange === index }"
      >
        {{ item.buildName }}
      </div>
    </div>
    <el-container class="containers">
      <el-aside
        class="leftAsside"
        :style="{ height: leftHeight + 'px' }"
        width="150px"
      >
        <div
          v-for="(item, index) in destoryList"
          :key="index"
          :id="'storey' + index"
          class="storey-item"
          :class="{ destoryActive: isDestory === index }"
          @click="storyClick(item.storeyId, index)"
        >
          {{ item.storeyName }}
        </div>
      </el-aside>
      <el-main class="mains">
        <!-- 表格 -->
        <el-collapse
          style="overflow-y: auto"
          accordion
          :style="{ height: accordionHeight + 'px' }"
        >
          <el-collapse-item
            class="collapse-main"
            v-for="(item, index) in tableList"
            :key="index"
          >
            <template slot="title" class="room-title-header">
              <span class="room-title">{{ item.roomCode }}宿舍</span>
              <span class="room-type" v-if="item.rootType == '1'">1人间</span>
              <span class="room-type" v-if="item.rootType == '2'">2人间</span>
              <span class="room-type" v-if="item.rootType == '4'">4人间</span>
              <span class="room-type" v-if="item.rootType == '6'">6人间</span>
              <span class="room-type">(共{{ item.totalBed }}个床位)</span>
            </template>
            <!-- 床位列表 -->
            <div class="bedList">
              <div v-for="(bed, bindex) in item.bedList" :key="bindex">
                <!-- 已经入住 -->
                <div v-if="bed.stuId" class="bed-item-active">
                  <div class="name-icon">
                    <div class="num-text">{{ bed.bedCode }}</div>
                    <i
                      @click="deleteBtn(bed)"
                      style="color: #ff7670; font-size: 14px"
                      class="el-icon-delete"
                    ></i>
                  </div>
                  <div class="bed-main">
                    <svg-icon
                      v-if="bed.stuName"
                      class="bed-svg"
                      icon-class="bed-active"
                    />
                    <svg-icon v-else class="bed-svg" icon-class="bed-no" />
                    <div v-if="bed.stuName" class="stuInfo">
                      <div>
                        <div>
                          <span>姓名：</span>
                          <span>{{ bed.stuName }}</span>
                        </div>
                        <div>
                          <span>班级：</span>
                          <span>{{ bed.className }}</span>
                        </div>
                      </div>
                    </div>
                    <div v-else style="color: #aeb5b5">暂未入住</div>
                  </div>
                </div>
                <!-- 未入住 -->
                <dir v-else class="bed-item">
                  <div class="no-into">
                    <span class="num-text">{{ bed.bedCode }}</span>
                    <i
                      @click="addBtn(bed)"
                      style="color: #FF7670 ; font-size: 14px"
                      class="el-icon-plus"
                    ></i>
                  </div>
                  <div class="bed-main">
                    <svg-icon class="bed-svg" icon-class="bed-no" />
                    <div style="color: #aeb5b5">暂未入住</div>
                  </div>
                </dir>
              </div>
            </div>
          </el-collapse-item>
        </el-collapse>
        <!-- 分页 -->
        <el-pagination
          @size-change="sizeChange"
          @current-change="currentChange"
          :current-page.sync="listParm.currentPage"
          :page-sizes="[10, 20, 40, 80, 100]"
          :page-size="listParm.pageSize"
          layout="total, sizes, prev, pager, next, jumper"
          :total="listParm.total"
          background
        >
        </el-pagination>
      </el-main>
    </el-container>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getBuildListApi, getDestoryListApi } from "@/api/build.js";
import { editChildApi, deleteChildApi } from "@/api/setCode.js";
import { getStoreyListApi, editApi, deleteApi } from "@/api/setCode.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      accordionHeight: 0,
      storeyId: "",
      //点击颜色切换状态
      isDestory: 0,
      isChange: 0,
      buildList: [],
      destoryList: [],
      leftHeight: 0,
      rightHeight: 0,
      listParm: {
        currentPage: 1,
        pageSize: 10,
        total: 0,
        storeyId: "",
      },
      tableList: [],
    };
  },
  created() {
    this.getBuildList();
  },
  mounted() {
    this.$nextTick(() => {
      this.leftHeight = window.innerHeight - 230;
      this.rightHeight = window.innerHeight - 230;
      this.tableHeight = window.innerHeight - 350;
      this.accordionHeight = window.innerHeight - 300;
    });
  },
  methods: {
    addBtn(item) {
      console.log(item);
    },
    deleteBtn(item) {
      console.log(item);
    },
    //页数改变时触发
    currentChange(val) {
      this.listParm.currentPage = val;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.listParm.pageSize = val;
      this.listParm.currentPage = 1;
      this.getList();
    },
    //获取表格数据
    async getList() {
      let res = await getStoreyListApi(this.listParm);
      if (res && res.code == 200) {
        //设置表格数据
        this.tableList = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    selectChange(val) {
      this.addModel.stuNum = val;
    },

    //层数点击事件
    storyClick(storeyId, index) {
      console.log("层数点击");
      this.isDestory = index;
      this.storeyId = storeyId;
      this.listParm.storeyId = storeyId;
      this.getList();
    },
    //楼栋点击事件
    btnClick(buildId, index) {
      console.log(index);
      this.isChange = index;
      this.isDestory = 0;
      this.getDestoryList(buildId);
    },
    //获取层数列表
    async getDestoryList(buildId) {
      let res = await getDestoryListApi({
        buildId: buildId,
      });
      if (res && res.code == 200) {
        console.log(res);
        this.destoryList = res.data;
        this.$nextTick(() => {
          document.querySelector("#storey0").click();
        });
      }
    },
    //获取楼栋列表
    async getBuildList() {
      let res = await getBuildListApi();
      if (res && res.code == 200) {
        this.buildList = res.data;
        //点击第一个楼栋,一定要放到 nextTick里面
        this.$nextTick(() => {
          document.querySelector("#build0").click();
        });
      }
    },
  },
};
</script>

<style lang="scss" scoped>
.no-into {
  display: flex;
  justify-content: space-between;
  padding: 5px;
}
.name-icon {
  display: flex;
  justify-content: space-between;
  padding: 5px;
}
.room-title-header {
  display: flex;
  background: #f8f8f8;
}
.collapse-main {
  background: #f8f8f8;
  border: 1px solid #dcdfe6;
  margin: 5px 0px;
}
.stuInfo {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
.bedList {
  display: flex;
  flex-wrap: wrap;
}
.room-type {
  //   color: #ff7670;
  flex-grow: 1;
  font-weight: 600;
}
.bed-main {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
.bed-item {
  border: 1px solid #dedede;
  border-radius: 4px;
  background-color: #f8f8f8;
  height: 180px;
  width: 180px;
  margin: 15px 15px;
  padding-left: 0px !important;
  display: flex;
  flex-direction: column;
  cursor: pointer;
}
.bed-item-active {
  background: #f2feff;
  border: 1px solid #ddeff1;
  border-radius: 4px;
  height: 180px;
  width: 180px;
  margin: 15px 15px;
  display: flex;
  flex-direction: column;
  cursor: pointer;
}
.num-text {
  color: #8a8a8a;
}
.active-num-text {
  color: #42b983;
  font-weight: 600;
}
.bed-svg {
  font-size: 100px;
}
.build-main {
  padding-top: 25px;
  background: #f3f3f4;
}
.build-list {
  display: flex;
  flex-wrap: wrap;
  background: #fff;
}
.build-item {
  display: flex;
  padding: 8px 30px;
  margin: 10px;
  font-size: 14px;
  border: 1px solid #dedede;
  border-radius: 4px;
  cursor: pointer;
  background: #fff;
}
.isActive {
  background: #42b983;
  color: #fff;
}
.containers {
  margin-top: 20px;
  border: 1px solid #dcdfe6;
}
.room-title {
  padding-left: 15px;
  //   color: #5fb878;
  font-size: 13px;
  font-weight: 600;
  flex-grow: 1;
}
.leftAsside {
  border-right: 1px solid #dcdfe6;
  display: flex;
  flex-direction: column;
  align-items: center;
  background: #fff;
}
.storey-item {
  padding: 8px 30px;
  margin: 10px 10px;
  font-size: 14px;
  border: 1px solid #dedede;
  border-radius: 4px;
  cursor: pointer;
  background-color: #f8f8f8;
}
.destoryActive {
  background: #5fb878 !important;
  border-color: #5fb878 !important;
  color: #fff;
}
.mains {
  padding-top: 10px;
  background: #fff;
}
</style>
```









#### 第91讲 宿舍管理删除学生

##### 1、StuBedController控制器添加deleteBed()方法

```js
package com.itmk.web.select_bed.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.assign_bed.entity.SelectBed;
import com.itmk.web.school_student.entity.SchoolStudent;
import com.itmk.web.school_student.service.SchoolStudentService;
import com.itmk.web.select_bed.entity.ChangeStu;
import com.itmk.web.select_bed.entity.StuBed;
import com.itmk.web.select_bed.entity.StuBedVo;
import com.itmk.web.select_bed.service.StuBedService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;


/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/stuBed")
public class StuBedController {
    @Autowired
    private StuBedService stuBedService;
    @Autowired
    private SchoolStudentService schoolStudentService;

    @PostMapping("/selectBedSave")
    public ResultVo selectBedSave(@RequestBody StuBed stuBed){
        //根据床位查询，是否被选选
        QueryWrapper<StuBed> query = new QueryWrapper<>();
        query.lambda().eq(StuBed::getBedId,stuBed.getBedId());
        StuBed bed = stuBedService.getOne(query);
        if(bed != null){
            return ResultUtils.error("该床位已经被占用!");
        }
        //查询学生是否已经选择床位
        QueryWrapper<StuBed> stuQuery = new QueryWrapper<>();
        stuQuery.lambda().eq(StuBed::getStuId,stuBed.getStuId());
        StuBed stu = stuBedService.getOne(stuQuery);
        if(stu != null){
            return ResultUtils.error("您已经选择宿舍，不用重复选择!");
        }
        //保存选择的宿舍
        boolean save = stuBedService.save(stuBed);
        if(save){
            return ResultUtils.success("选择成功!");
        }
        return ResultUtils.error("选择失败!");
    }

    //查询学生宿舍
    @GetMapping("/getStuBedList")
    public ResultVo getStuBedList(Long stuId,String userType){
        if(userType.equals("1")){
            return ResultUtils.success("查询成功",null);
        }
        List<StuBedVo> stuBedList = stuBedService.getStuBedList(stuId);
        return ResultUtils.success("查询成功",stuBedList);
    }

     //查询调换的学生
    @GetMapping("/getStuList")
    public ResultVo getStuList(Long stuId){
        //根据学生id查询班级
        SchoolStudent student = schoolStudentService.getById(stuId);
        //根据班级id查询学生
        List<ChangeStu> stuList = stuBedService.getStuList(student.getClassId());
        return ResultUtils.success("查询成功",stuList);
    }
    //删除
    @DeleteMapping("/{stuId}/{bedId}")
    public ResultVo deleteBed(@PathVariable("stuId") Long stuId,@PathVariable("bedId") Long bedId){
        QueryWrapper<StuBed> query = new QueryWrapper<>();
        query.lambda().eq(StuBed::getStuId,stuId)
                .eq(StuBed::getBedId,bedId);
        boolean remove = stuBedService.remove(query);
        if(remove){
            return ResultUtils.success("删除成功!");
        }
        return ResultUtils.error("删除失败!");
    }
}

```

##### 2、mybed.js添加deleteBedApi()方法

```js
import http from "@/utils/http";
//查询我的宿舍列表
export const getStuBedListApi = async(parm)=>{
    return await http.get("/api/stuBed/getStuBedList",parm)
}
//查询班级下的学生
export const getStuListApi = async(parm)=>{
    return await http.get("/api/stuBed/getStuList",parm)
}
//申请提交
export const applySaveApi = async(parm)=>{
    return await http.post("/api/applyChange/applySave",parm)
}
//申请列表
export const getListApi = async(parm)=>{
    return await http.get("/api/applyChange/getList",parm)
}
//处理申请
export const applyDoApi = async(parm)=>{
    return await http.post("/api/applyChange/applyDo",parm)
}
//删除学生
export const deleteBedApi = async(parm)=>{
    return await http.delete("/api/stuBed",parm)
}
```



##### 3、houseList.vue

```js
<template>
  <el-main class="build-main">
    <!-- 楼栋布局 -->
    <div class="build-list">
      <div
        class="build-item"
        :id="'build' + index"
        @click="btnClick(item.buildId, index)"
        v-for="(item, index) in buildList"
        :key="index"
        :class="{ isActive: isChange === index }"
      >
        <span>{{ item.buildName }}</span>
        <div>
          (<span v-if="item.sex == '0'">男</span>
          <span v-if="item.sex == '1'">女</span>)
        </div>
      </div>
    </div>
    <el-container class="containers">
      <el-aside
        class="leftAsside"
        :style="{ height: leftHeight + 'px' }"
        width="150px"
      >
        <div
          v-for="(item, index) in destoryList"
          :key="index"
          :id="'storey' + index"
          class="storey-item"
          :class="{ destoryActive: isDestory === index }"
          @click="storyClick(item.storeyId, index)"
        >
          {{ item.storeyName }}
        </div>
      </el-aside>
      <el-main class="mains">
        <!-- 表格 -->
        <el-collapse
          style="overflow-y: auto"
          accordion
          :style="{ height: accordionHeight + 'px' }"
        >
          <el-collapse-item
            class="collapse-main"
            v-for="(item, index) in tableList"
            :key="index"
          >
            <template slot="title" class="room-title-header">
              <span class="room-title">{{ item.roomCode }}宿舍</span>
              <span class="room-type" v-if="item.rootType == '1'">1人间</span>
              <span class="room-type" v-if="item.rootType == '2'">2人间</span>
              <span class="room-type" v-if="item.rootType == '4'">4人间</span>
              <span class="room-type" v-if="item.rootType == '6'">6人间</span>
              <span class="room-type"
                >(共{{ item.totalBed }}个床位,已入住{{
                  item.bedList | getHasNum
                }}人)</span
              >
            </template>
            <!-- 床位列表 -->
            <div class="bedList">
              <div v-for="(bed, bindex) in item.bedList" :key="bindex">
                <!-- 已经入住 -->
                <div v-if="bed.stuId" class="bed-item-active">
                  <div class="name-icon">
                    <div class="num-text">{{ bed.bedCode }}</div>
                    <i
                      @click="deleteBtn(bed)"
                      style="color: #ff7670; font-size: 14px"
                      class="el-icon-delete"
                    ></i>
                  </div>
                  <div class="bed-main">
                    <svg-icon
                      v-if="bed.stuName"
                      class="bed-svg"
                      icon-class="bed-active"
                    />
                    <svg-icon v-else class="bed-svg" icon-class="bed-no" />
                    <div v-if="bed.stuName" class="stuInfo">
                      <div>
                        <div>
                          <span>姓名：</span>
                          <span>{{ bed.stuName }}</span>
                        </div>
                        <div>
                          <span>班级：</span>
                          <span>{{ bed.className }}</span>
                        </div>
                      </div>
                    </div>
                    <div v-else style="color: #aeb5b5">暂未入住</div>
                  </div>
                </div>
                <!-- 未入住 -->
                <dir v-else class="bed-item">
                  <div class="no-into">
                    <span class="num-text">{{ bed.bedCode }}</span>
                    <i
                      @click="addBtn(bed)"
                      style="color: #ff7670; font-size: 14px"
                      class="el-icon-plus"
                    ></i>
                  </div>
                  <div class="bed-main">
                    <svg-icon class="bed-svg" icon-class="bed-no" />
                    <div style="color: #aeb5b5">暂未入住</div>
                  </div>
                </dir>
              </div>
            </div>
          </el-collapse-item>
        </el-collapse>
        <!-- 分页 -->
        <el-pagination
          @size-change="sizeChange"
          @current-change="currentChange"
          :current-page.sync="listParm.currentPage"
          :page-sizes="[10, 20, 40, 80, 100]"
          :page-size="listParm.pageSize"
          layout="total, sizes, prev, pager, next, jumper"
          :total="listParm.total"
          background
        >
        </el-pagination>
      </el-main>
    </el-container>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getBuildListApi, getDestoryListApi } from "@/api/build.js";
import { deleteBedApi } from "@/api/mybed";
import { getStoreyListApi, editApi, deleteApi } from "@/api/setCode.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      accordionHeight: 0,
      storeyId: "",
      //点击颜色切换状态
      isDestory: 0,
      isChange: 0,
      buildList: [],
      destoryList: [],
      leftHeight: 0,
      rightHeight: 0,
      listParm: {
        currentPage: 1,
        pageSize: 10,
        total: 0,
        storeyId: "",
      },
      tableList: [],
    };
  },
  created() {
    this.getBuildList();
  },
  filters: {
    getHasNum(children) {
      let num = 0;
      if (children && children.length > 0) {
        for (let i = 0; i < children.length; i++) {
          if (children[i].stuId) {
            num = num + 1;
          }
        }
      }
      return num;
    },
  },
  mounted() {
    this.$nextTick(() => {
      this.leftHeight = window.innerHeight - 230;
      this.rightHeight = window.innerHeight - 230;
      this.tableHeight = window.innerHeight - 350;
      this.accordionHeight = window.innerHeight - 300;
    });
  },
  methods: {
    addBtn(item) {
      console.log(item);
    },
    async deleteBtn(item) {
      console.log(item);
      const confirm = await this.$myconfirm("确定删除该学生吗?");
      if (confirm) {
        let res = await deleteBedApi({
          stuId: item.stuId,
          bedId: item.bedId,
        });
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          this.getList();
        }
      }
    },
    //页数改变时触发
    currentChange(val) {
      this.listParm.currentPage = val;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.listParm.pageSize = val;
      this.listParm.currentPage = 1;
      this.getList();
    },
    //获取表格数据
    async getList() {
      let res = await getStoreyListApi(this.listParm);
      if (res && res.code == 200) {
        //设置表格数据
        this.tableList = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    selectChange(val) {
      this.addModel.stuNum = val;
    },

    //层数点击事件
    storyClick(storeyId, index) {
      console.log("层数点击");
      this.isDestory = index;
      this.storeyId = storeyId;
      this.listParm.storeyId = storeyId;
      this.getList();
    },
    //楼栋点击事件
    btnClick(buildId, index) {
      console.log(index);
      this.isChange = index;
      this.isDestory = 0;
      this.getDestoryList(buildId);
    },
    //获取层数列表
    async getDestoryList(buildId) {
      let res = await getDestoryListApi({
        buildId: buildId,
      });
      if (res && res.code == 200) {
        console.log(res);
        this.destoryList = res.data;
        this.$nextTick(() => {
          document.querySelector("#storey0").click();
        });
      }
    },
    //获取楼栋列表
    async getBuildList() {
      let res = await getBuildListApi();
      if (res && res.code == 200) {
        this.buildList = res.data;
        //点击第一个楼栋,一定要放到 nextTick里面
        this.$nextTick(() => {
          document.querySelector("#build0").click();
        });
      }
    },
  },
};
</script>

<style lang="scss" scoped>
.no-into {
  display: flex;
  justify-content: space-between;
  padding: 5px;
}
.name-icon {
  display: flex;
  justify-content: space-between;
  padding: 5px;
}
.room-title-header {
  display: flex;
  background: #f8f8f8;
}
.collapse-main {
  background: #f8f8f8;
  border: 1px solid #dcdfe6;
  margin: 5px 0px;
}
.stuInfo {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
.bedList {
  display: flex;
  flex-wrap: wrap;
}
.room-type {
  //   color: #ff7670;
  flex-grow: 1;
  font-weight: 600;
}
.bed-main {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
.bed-item {
  border: 1px solid #dedede;
  border-radius: 4px;
  background-color: #f8f8f8;
  height: 180px;
  width: 180px;
  margin: 15px 15px;
  padding-left: 0px !important;
  display: flex;
  flex-direction: column;
  cursor: pointer;
}
.bed-item-active {
  background: #f2feff;
  border: 1px solid #ddeff1;
  border-radius: 4px;
  height: 180px;
  width: 180px;
  margin: 15px 15px;
  display: flex;
  flex-direction: column;
  cursor: pointer;
}
.num-text {
  color: #8a8a8a;
}
.active-num-text {
  color: #42b983;
  font-weight: 600;
}
.bed-svg {
  font-size: 100px;
}
.build-main {
  padding-top: 25px;
  background: #f3f3f4;
}
.build-list {
  display: flex;
  flex-wrap: wrap;
  background: #fff;
}
.build-item {
  display: flex;
  padding: 8px 30px;
  margin: 10px;
  font-size: 14px;
  border: 1px solid #dedede;
  border-radius: 4px;
  cursor: pointer;
  background: #fff;
}
.isActive {
  background: #42b983;
  color: #fff;
}
.containers {
  margin-top: 20px;
  border: 1px solid #dcdfe6;
}
.room-title {
  padding-left: 15px;
  //   color: #5fb878;
  font-size: 13px;
  font-weight: 600;
  flex-grow: 1;
}
.leftAsside {
  border-right: 1px solid #dcdfe6;
  display: flex;
  flex-direction: column;
  align-items: center;
  background: #fff;
}
.storey-item {
  padding: 8px 30px;
  margin: 10px 10px;
  font-size: 14px;
  border: 1px solid #dedede;
  border-radius: 4px;
  cursor: pointer;
  background-color: #f8f8f8;
}
.destoryActive {
  background: #5fb878 !important;
  border-color: #5fb878 !important;
  color: #fff;
}
.mains {
  padding-top: 10px;
  background: #fff;
}
</style>
```









#### 第92讲 宿舍管理新增学生

##### 1、SchoolStudentController控制器添加getClassByClassId()方法

```js
	//根据班级Id查询学生列表
    @GetMapping("/getClassByClassId")
    public ResultVo getClassByClassId(Long  classId){
        QueryWrapper<SchoolStudent> query = new QueryWrapper<>();
        query.lambda().eq(SchoolStudent::getClassId,classId);
        List<SchoolStudent> list = schoolStudentService.list(query.select("stu_id","stu_name"));
        return ResultUtils.success("查询成功",list);
    }
```

##### 2、api/student.js添加getClassByClassIdApi()方法

```js
//根据班级id查询学生列表
export const getClassByClassIdApi = async(parm)=>{
    return await http.get("/api/student/getClassByClassId",parm)
}
```

##### 3、houseList.vue页面

```js
<template>
  <el-main class="build-main">
    <!-- 楼栋布局 -->
    <div class="build-list">
      <div
        class="build-item"
        :id="'build' + index"
        @click="btnClick(item.buildId, index)"
        v-for="(item, index) in buildList"
        :key="index"
        :class="{ isActive: isChange === index }"
      >
        <span>{{ item.buildName }}</span>
        <div>
          (<span v-if="item.sex == '0'">男</span>
          <span v-if="item.sex == '1'">女</span>)
        </div>
      </div>
    </div>
    <el-container class="containers">
      <el-aside
        class="leftAsside"
        :style="{ height: leftHeight + 'px' }"
        width="150px"
      >
        <div
          v-for="(item, index) in destoryList"
          :key="index"
          :id="'storey' + index"
          class="storey-item"
          :class="{ destoryActive: isDestory === index }"
          @click="storyClick(item.storeyId, index)"
        >
          {{ item.storeyName }}
        </div>
      </el-aside>
      <el-main class="mains">
        <!-- 表格 -->
        <el-collapse
          style="overflow-y: auto"
          accordion
          :style="{ height: accordionHeight + 'px' }"
        >
          <el-collapse-item
            class="collapse-main"
            v-for="(item, index) in tableList"
            :key="index"
          >
            <template slot="title" class="room-title-header">
              <span class="room-title">{{ item.roomCode }}宿舍</span>
              <span class="room-type" v-if="item.rootType == '1'">1人间</span>
              <span class="room-type" v-if="item.rootType == '2'">2人间</span>
              <span class="room-type" v-if="item.rootType == '4'">4人间</span>
              <span class="room-type" v-if="item.rootType == '6'">6人间</span>
              <span class="room-type"
                >(共{{ item.totalBed }}个床位,已入住{{
                  item.bedList | getHasNum
                }}人)</span
              >
            </template>
            <!-- 床位列表 -->
            <div class="bedList">
              <div v-for="(bed, bindex) in item.bedList" :key="bindex">
                <!-- 已经入住 -->
                <div v-if="bed.stuId" class="bed-item-active">
                  <div class="name-icon">
                    <div class="num-text">{{ bed.bedCode }}</div>
                    <i
                      @click="deleteBtn(bed)"
                      style="color: #ff7670; font-size: 14px"
                      class="el-icon-delete"
                    ></i>
                  </div>
                  <div class="bed-main">
                    <svg-icon
                      v-if="bed.stuName"
                      class="bed-svg"
                      icon-class="bed-active"
                    />
                    <svg-icon v-else class="bed-svg" icon-class="bed-no" />
                    <div v-if="bed.stuName" class="stuInfo">
                      <div>
                        <div>
                          <span>姓名：</span>
                          <span>{{ bed.stuName }}</span>
                        </div>
                        <div>
                          <span>班级：</span>
                          <span>{{ bed.className }}</span>
                        </div>
                      </div>
                    </div>
                    <div v-else style="color: #aeb5b5">暂未入住</div>
                  </div>
                </div>
                <!-- 未入住 -->
                <dir v-else class="bed-item">
                  <div class="no-into">
                    <span class="num-text">{{ bed.bedCode }}</span>
                    <i
                      @click="addBtn(bed)"
                      style="color: #ff7670; font-size: 14px"
                      class="el-icon-plus"
                    ></i>
                  </div>
                  <div class="bed-main">
                    <svg-icon class="bed-svg" icon-class="bed-no" />
                    <div style="color: #aeb5b5">暂未入住</div>
                  </div>
                </dir>
              </div>
            </div>
          </el-collapse-item>
        </el-collapse>
        <!-- 分页 -->
        <el-pagination
          @size-change="sizeChange"
          @current-change="currentChange"
          :current-page.sync="listParm.currentPage"
          :page-sizes="[10, 20, 40, 80, 100]"
          :page-size="listParm.pageSize"
          layout="total, sizes, prev, pager, next, jumper"
          :total="listParm.total"
          background
        >
        </el-pagination>
      </el-main>
    </el-container>
    <!-- 学生入住弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form label-width="50px" size="small">
          <el-form-item label="班级">
            <el-select
              @change="selectStu"
              style="width: 100%"
              v-model="classId"
              placeholder="请选择班级"
            >
              <el-option
                v-for="item in options"
                :key="item.classId"
                :label="item.className"
                :value="item.classId"
              >
              </el-option>
            </el-select>
          </el-form-item>
        </el-form>
        <el-transfer
          v-model="value"
          :data="studentList"
          :props="{
            key: 'stuId',
            label: 'stuName',
          }"
          filterable
          :filter-method="filterMethod"
          filter-placeholder="请输入姓名"
          @left-check-change="leftChange"
          @change="btnChange"
        ></el-transfer>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getListForAssignApi } from "@/api/classes.js";
import { getClassByClassIdApi } from "@/api/student.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getBuildListApi, getDestoryListApi } from "@/api/build.js";
import { deleteBedApi } from "@/api/mybed";
import { saveSelectBedApi } from "@/api/setAssign.js";
import { getStoreyListApi } from "@/api/setCode.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      bedId: "",
      value: [],
      studentList: [],
      classId: "",
      options: [],
      //新增弹框属性
      addDialog: {
        title: "",
        height: 400,
        width: 750,
        visible: false,
      },
      accordionHeight: 0,
      storeyId: "",
      //点击颜色切换状态
      isDestory: 0,
      isChange: 0,
      buildList: [],
      destoryList: [],
      leftHeight: 0,
      rightHeight: 0,
      listParm: {
        currentPage: 1,
        pageSize: 10,
        total: 0,
        storeyId: "",
      },
      tableList: [],
    };
  },
  created() {
    this.getBuildList();
  },
  filters: {
    getHasNum(children) {
      let num = 0;
      if (children && children.length > 0) {
        for (let i = 0; i < children.length; i++) {
          if (children[i].stuId) {
            num = num + 1;
          }
        }
      }
      return num;
    },
  },
  mounted() {
    this.$nextTick(() => {
      this.leftHeight = window.innerHeight - 230;
      this.rightHeight = window.innerHeight - 230;
      this.tableHeight = window.innerHeight - 350;
      this.accordionHeight = window.innerHeight - 300;
    });
  },
  methods: {
    btnChange(select, index) {
      let item = this.value;
      if (item.length > 0) {
        for (let i = 0; i < item.length; i++) {
          for (let j = 0; j < select.length; j++) {
            if (item[i] != select[j]) {
              item.splice(i, 1);
            }
          }
        }
      }
    },
    leftChange(item, index) {
      if (item.length > 0) {
        for (let i = 0; i < item.length; i++) {
          for (let j = 0; j < index.length; j++) {
            if (item[i] != index[j]) {
              item.splice(i, 1);
            }
          }
        }
      }
    },
    filterMethod(query, item) {
      return item.stuName.indexOf(query) > -1;
    },
    async selectStu(val) {
      console.log(val);
      let res = await getClassByClassIdApi({
        classId: val,
      });
      if (res && res.code == 200) {
        console.log(res);
        this.studentList = res.data;
        console.log(this.studentList);
      }
    },
    //获取班级列表
    async getListForAssign() {
      let res = await getListForAssignApi();
      if (res && res.code == 200) {
        console.log(res);
        this.options = res.data;
      }
    },
    async onConfirm() {
      console.log(this.value[0]);
      let parm = {
        bedId: this.bedId,
        stuId: this.value[0],
      };
      console.log(parm);
      let res = await saveSelectBedApi(parm);
      if (res && res.code == 200) {
        this.$message.success(res.msg);
        this.getList();
        this.addDialog.visible = false;
      }
    },
    onClose() {
      this.addDialog.visible = false;
    },
    addBtn(item) {
      console.log(item);
      this.bedId = item.bedId;
      this.value = [];
      this.studentList = [];
      this.classId = '';
      //获取班级列表
      this.getListForAssign();
      // console.log(item);
      //设置弹框属性
      this.addDialog.title = "分配宿舍";
      this.addDialog.visible = true;
    },
    async deleteBtn(item) {
      console.log(item);
      const confirm = await this.$myconfirm("确定删除该学生吗?");
      if (confirm) {
        let res = await deleteBedApi({
          stuId: item.stuId,
          bedId: item.bedId,
        });
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          this.getList();
        }
      }
    },
    //页数改变时触发
    currentChange(val) {
      this.listParm.currentPage = val;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.listParm.pageSize = val;
      this.listParm.currentPage = 1;
      this.getList();
    },
    //获取表格数据
    async getList() {
      let res = await getStoreyListApi(this.listParm);
      if (res && res.code == 200) {
        //设置表格数据
        this.tableList = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    selectChange(val) {
      this.addModel.stuNum = val;
    },

    //层数点击事件
    storyClick(storeyId, index) {
      console.log("层数点击");
      this.isDestory = index;
      this.storeyId = storeyId;
      this.listParm.storeyId = storeyId;
      this.getList();
    },
    //楼栋点击事件
    btnClick(buildId, index) {
      console.log(index);
      this.isChange = index;
      this.isDestory = 0;
      this.getDestoryList(buildId);
    },
    //获取层数列表
    async getDestoryList(buildId) {
      let res = await getDestoryListApi({
        buildId: buildId,
      });
      if (res && res.code == 200) {
        console.log(res);
        this.destoryList = res.data;
        this.$nextTick(() => {
          document.querySelector("#storey0").click();
        });
      }
    },
    //获取楼栋列表
    async getBuildList() {
      let res = await getBuildListApi();
      if (res && res.code == 200) {
        this.buildList = res.data;
        //点击第一个楼栋,一定要放到 nextTick里面
        this.$nextTick(() => {
          document.querySelector("#build0").click();
        });
      }
    },
  },
};
</script>

<style lang="scss" scoped>
.no-into {
  display: flex;
  justify-content: space-between;
  padding: 5px;
}
.name-icon {
  display: flex;
  justify-content: space-between;
  padding: 5px;
}
.room-title-header {
  display: flex;
  background: #f8f8f8;
}
.collapse-main {
  background: #f8f8f8;
  border: 1px solid #dcdfe6;
  margin: 5px 0px;
}
.stuInfo {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
.bedList {
  display: flex;
  flex-wrap: wrap;
}
.room-type {
  //   color: #ff7670;
  flex-grow: 1;
  font-weight: 600;
}
.bed-main {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
.bed-item {
  border: 1px solid #dedede;
  border-radius: 4px;
  background-color: #f8f8f8;
  height: 180px;
  width: 180px;
  margin: 15px 15px;
  padding-left: 0px !important;
  display: flex;
  flex-direction: column;
  cursor: pointer;
}
.bed-item-active {
  background: #f2feff;
  border: 1px solid #ddeff1;
  border-radius: 4px;
  height: 180px;
  width: 180px;
  margin: 15px 15px;
  display: flex;
  flex-direction: column;
  cursor: pointer;
}
.num-text {
  color: #8a8a8a;
}
.active-num-text {
  color: #42b983;
  font-weight: 600;
}
.bed-svg {
  font-size: 100px;
}
.build-main {
  padding-top: 25px;
  background: #f3f3f4;
}
.build-list {
  display: flex;
  flex-wrap: wrap;
  background: #fff;
}
.build-item {
  display: flex;
  padding: 8px 30px;
  margin: 10px;
  font-size: 14px;
  border: 1px solid #dedede;
  border-radius: 4px;
  cursor: pointer;
  background: #fff;
}
.isActive {
  background: #42b983;
  color: #fff;
}
.containers {
  margin-top: 20px;
  border: 1px solid #dcdfe6;
}
.room-title {
  padding-left: 15px;
  //   color: #5fb878;
  font-size: 13px;
  font-weight: 600;
  flex-grow: 1;
}
.leftAsside {
  border-right: 1px solid #dcdfe6;
  display: flex;
  flex-direction: column;
  align-items: center;
  background: #fff;
}
.storey-item {
  padding: 8px 30px;
  margin: 10px 10px;
  font-size: 14px;
  border: 1px solid #dedede;
  border-radius: 4px;
  cursor: pointer;
  background-color: #f8f8f8;
}
.destoryActive {
  background: #5fb878 !important;
  border-color: #5fb878 !important;
  color: #fff;
}
.mains {
  padding-top: 10px;
  background: #fff;
}
</style>
```







#### 第93讲 清空宿舍功能开发

##### 1、StuBedService接口添加clearBed()方法

```js
package com.itmk.web.select_bed.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.select_bed.entity.ChangeStu;
import com.itmk.web.select_bed.entity.StuBed;
import com.itmk.web.select_bed.entity.StuBedVo;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface StuBedService extends IService<StuBed> {
    List<StuBedVo> getStuBedList(Long stuId);
    List<ChangeStu> getStuList(Long classId);
    void clearBed(Long classId);
}

```

实现类

```js
package com.itmk.web.select_bed.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.assign_bed.entity.AssignBed;
import com.itmk.web.assign_bed.service.AssignBedService;
import com.itmk.web.school_student.entity.SchoolStudent;
import com.itmk.web.school_student.service.SchoolStudentService;
import com.itmk.web.select_bed.entity.ChangeStu;
import com.itmk.web.select_bed.entity.StuBed;
import com.itmk.web.select_bed.entity.StuBedVo;
import com.itmk.web.select_bed.mapper.StuBedMapper;
import com.itmk.web.select_bed.service.StuBedService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class StuBedServiceImpl extends ServiceImpl<StuBedMapper, StuBed> implements StuBedService {
    @Autowired
    private AssignBedService assignBedService;
    @Autowired
    private SchoolStudentService schoolStudentService;

    @Override
    public List<StuBedVo> getStuBedList(Long stuId) {
        return this.baseMapper.getStuBedList(stuId);
    }

    @Override
    public List<ChangeStu> getStuList(Long classId) {
        return this.baseMapper.getStuList(classId);
    }

    @Override
    @Transactional
    public void clearBed(Long classId) {
        //清空管理员分配的表
        QueryWrapper<AssignBed> query = new QueryWrapper<>();
        query.lambda().eq(AssignBed::getClassId,classId);
        assignBedService.remove(query);
        //清空学生选择的表数据
        QueryWrapper<SchoolStudent> stuQuery = new QueryWrapper<>();
        stuQuery.lambda().eq(SchoolStudent::getClassId,classId);
        List<SchoolStudent> list = schoolStudentService.list(stuQuery.select("stu_id"));
        List<Long> ids = new ArrayList<>();
        if(list.size() >0){
            for (int i=0;i<list.size();i++){
                ids.add(list.get(i).getStuId());
            }
        }
        QueryWrapper<StuBed> qs = new QueryWrapper<>();
        qs.lambda().in(StuBed::getStuId,ids);
        this.baseMapper.delete(qs);
    }
}

```

##### 2、AssignBedController控制器添加clearBed()方法

```js
	//清空宿舍
    @PostMapping("/clearBed")
    public ResultVo clearBed(@RequestBody ClearBed clearBed){
        stuBedService.clearBed(clearBed.getClassId());
        return ResultUtils.success("清空成功");
    }
```

##### 3、setAssign.js添加clearBedApi()方法

```js
//清空宿舍
export const clearBedApi = async(parm)=>{
    return await http.post("/api/assingBed/clearBed",parm)
}
```

##### 4、assignRoom.vue页面

```js
<template>
  <el-container>
    <el-header class="header">
      <el-form :model="searchModel" :inline="true" size="small">
        <el-form-item style="margin-top: 0px; margin-bottom: 0px">
          <el-date-picker
            style="width: 100%"
            v-model="searchModel.classYear"
            type="year"
            placeholder="选择年份"
            value-format="yyyy"
          >
          </el-date-picker>
        </el-form-item>
        <el-form-item style="margin-top: 0px; margin-bottom: 0px">
          <el-input
            v-model="searchModel.className"
            placeholder="请输入班级"
          ></el-input>
        </el-form-item>
        <el-form-item style="margin-top: 0px; margin-bottom: 0px">
          <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
          <el-button
            @click="resetBtn"
            style="color: #ff7670"
            icon="el-icon-close"
            >重置</el-button
          >
          <el-button icon="el-icon-plus" type="primary" @click="assignBtn('0')"
            >分配男生宿舍</el-button
          >
          <el-button icon="el-icon-plus" type="success" @click="assignBtn('1')"
            >分配女生宿舍</el-button
          >
          <el-button icon="el-icon-plus" type="danger" @click="clearBtn()"
            >清空宿舍</el-button
          >
        </el-form-item>
      </el-form>
    </el-header>
    <el-container>
      <el-aside width="270px" class="leftside">
        <div class="item-container" :style="{ height: assideHeight + 'px' }">
          <div
            v-for="(item, index) in classList"
            :key="index"
            class="side-item"
            :id="'class' + index"
            @click="itemClick(item, index)"
            :class="{ isActive: isChange === index }"
          >
            <div class="item-left">
              <div class="class-title">
                {{ item.className
                }}<span style="margin-left: 10px; font-size: 12px"
                  >(总共:{{ item.stuCount }}人)</span
                >
              </div>
              <div class="class-sex">
                <div class="man">男:{{ item.manCount }}人</div>
                <div class="girl">女:{{ item.girlCount }}人</div>
              </div>
            </div>
            <i class="el-icon-arrow-right item-right"></i>
          </div>
        </div>
        <!-- 分页 -->
        <el-pagination
          class="pages"
          @size-change="sizeChange"
          @current-change="currentChange"
          :current-page.sync="searchModel.currentPage"
          :page-sizes="[10, 20, 40, 80, 100]"
          :page-size="searchModel.pageSize"
          layout="prev, next"
          prev-text="上一页"
          next-text="下一页"
          :total="searchModel.total"
          small
        >
        </el-pagination>
      </el-aside>
      <el-main>
        <!-- 表格 -->
        <el-table
          :data="tableList"
          :height="tableHeight"
          style="margin-top: 0px"
          border
          stripe
        >
          <el-table-column width="100" type="expand">
            <template slot-scope="scope">
              <el-table border :data="scope.row.children">
                <el-table-column
                  label="床位编号"
                  prop="bedCode"
                ></el-table-column>
                <el-table-column label="操作" align="center" width="180">
                  <template slot-scope="scope">
                    <el-button
                      round
                      icon="el-icon-delete"
                      type="danger"
                      size="mini"
                      @click="childDelete(scope.row)"
                      >删除</el-button
                    >
                  </template>
                </el-table-column>
              </el-table>
            </template>
          </el-table-column>
          <el-table-column prop="roomCode" label="宿舍编号"></el-table-column>
          <el-table-column align="center" prop="roomCode" label="宿舍类型">
            <template slot-scope="scope">
              <el-tag v-if="scope.row.rootType == '1'" size="small"
                >1人间</el-tag
              >
              <el-tag
                v-if="scope.row.rootType == '2'"
                type="danger"
                size="small"
                >2人间</el-tag
              >
              <el-tag
                v-if="scope.row.rootType == '4'"
                type="success"
                size="small"
                >4人间</el-tag
              >
              <el-tag
                v-if="scope.row.rootType == '6'"
                type="warning"
                size="small"
                >6人间</el-tag
              >
            </template>
          </el-table-column>
        </el-table>
      </el-main>
    </el-container>
    <!-- 分配弹框 -->
    <sys-dialog
      :title="assignDialog.title"
      :width="assignDialog.width"
      :height="assignDialog.height"
      :visible="assignDialog.visible"
      @onConfirm="onConfirm"
      @onClose="onClose"
    >
      <div slot="content">
        <el-container style="height: 500px">
          <el-header style="border-bottom: 1px solid #dcdfe6; height: 40px">
            <el-form :inline="true" size="small">
              <el-form-item style="margin-buttom: 0px" label="楼栋">
                <el-select
                  @change="selectBuildChange"
                  v-model="parms.buildId"
                  placeholder="请选择楼栋"
                >
                  <el-option
                    v-for="item in buildList"
                    :key="item.buildId"
                    :label="item.buildName"
                    :value="item.buildId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
              <el-form-item style="margin-buttom: 0px" label="楼层">
                <el-select
                  @change="selectDestory"
                  v-model="parms.storeyId"
                  placeholder="请选择楼层"
                >
                  <el-option
                    v-for="item in storeyList"
                    :key="item.storeyId"
                    :label="item.storeyName"
                    :value="item.storeyId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
              <el-form-item style="margin-buttom: 0px">
                <el-button icon="el-icon-search">查询</el-button>
                <el-button style="color: #ff7670" icon="el-icon-close"
                  >取消</el-button
                >
              </el-form-item>
            </el-form>
          </el-header>
          <el-main>
            <el-tree
              ref="assignTree"
              default-expand-all
              :data="roomList"
              show-checkbox
              node-key="roomId"
              :props="defaultProps"
            >
            </el-tree>
          </el-main>
        </el-container>
      </div>
    </sys-dialog>
  </el-container>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getAssignClassApi } from "@/api/classes.js";
import { getBuildListBySexApi, getDestoryListApi } from "@/api/build.js";
import {
  getRoomByStoreyIdApi,
  assignSaveBedApi,
  getAssignBedListApi,
  deleteAssignApi,
  clearBedApi,
} from "@/api/setAssign.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      tableHeight: 0,
      tableList: [],
      defaultProps: {
        children: "children",
        label: "roomCode",
      },
      roomList: [],
      storeyList: [],
      parms: {
        buildId: "",
        storeyId: "",
      },
      buildList: [],
      bed: {
        classId: "",
        className: "",
        girlCount: 0,
        manCount: 0,
        total: 0,
        sex: "",
      },
      //弹框属性
      assignDialog: {
        title: "",
        height: 500,
        width: 800,
        visible: false,
      },
      isChange: 0,
      assideHeight: 0,
      classList: [],
      searchModel: {
        currentPage: 1,
        pageSize: 10,
        className: "",
        classYear: "",
        total: 0,
      },
    };
  },
  created() {
    this.getAssignClass();
  },
  mounted() {
    this.$nextTick(() => {
      this.assideHeight = window.innerHeight - 200;
      this.tableHeight = window.innerHeight - 200;
    });
  },
  methods: {
    //清空宿舍
    async clearBtn() {
      if (!this.bed.classId) {
        this.$message.warning("请选择要清空宿舍的班级!");
        return;
      }
      const confirm = await this.$myconfirm(
        "确定清空【" + this.bed.className + "】的宿舍吗?"
      );
      if (confirm) {
        let parm = {
          classId: this.bed.classId,
        };
        let res = await clearBedApi(parm);
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          this.getAssignBedList(this.bed.classId);
        }
        console.log(parm);
      }
    },
    //重置按钮
    resetBtn() {
      this.searchModel.className = "";
      this.searchModel.classYear = "";
      this.getAssignClass();
    },
    //搜索按钮
    searchBtn() {
      this.getAssignClass();
    },
    //删除床位
    async childDelete(row) {
      console.log(row);
      const confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let parm = {
          bedId: row.bedId,
          classId: this.bed.classId,
        };
        let res = await deleteAssignApi(parm);
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          this.getAssignBedList(this.bed.classId);
        }
      }
    },
    //根据班级id查询宿舍
    async getAssignBedList(classId) {
      let res = await getAssignBedListApi({
        classId: classId,
      });
      if (res && res.code == 200) {
        this.tableList = res.data;
      }
    },
    //层数选项事件
    async selectDestory(val) {
      let res = await getRoomByStoreyIdApi({
        storeyId: val,
      });
      if (res && res.code == 200) {
        this.roomList = res.data;
      }
    },
    async selectBuildChange(val) {
      //清空层数
      this.parms.storeyId = "";
      this.storeyList = [];
      this.roomList = [];
      //查询楼栋的层数
      let res = await getDestoryListApi({
        buildId: val,
      });
      if (res && res.code == 200) {
        this.storeyList = res.data;
      }
    },
    //分配取消
    onClose() {
      this.assignDialog.visible = false;
    },
    //分配确定
    async onConfirm() {
      //判断是否选择班级
      if (!this.bed.classId) {
        this.$message.warning("请选择班级");
        return;
      }
      let ids = this.$refs.assignTree.getCheckedNodes();
      if (ids.length == 0) {
        this.$message.warning("请选择宿舍");
        return;
      }
      //存放组装的数据
      let list = [];
      //组装数据
      for (let i = 0; i < ids.length; i++) {
        if (ids[i].type == "0") {
          let obj = {};
          obj.bedId = ids[i].roomId;
          obj.classId = this.bed.classId;
          list.push(obj);
        }
      }
      console.log(list);
      //提交数据保存
      let res = await assignSaveBedApi(list);
      if (res && res.code == 200) {
        this.$message.success(res.msg);
        this.assignDialog.visible = false;
        this.getAssignBedList(this.bed.classId);
      }
    },
    //分配按钮点击事件
    async assignBtn(type) {
      //清空楼栋
      this.parms.buildId = "";
      this.parms.storeyId = "";
      this.buildList = [];
      this.roomList = [];
      this.storeyList = [];
      //获取楼栋列表
      let res = await getBuildListBySexApi({
        type: type,
      });
      if (res && res.code == 200) {
        this.buildList = res.data;
      }
      type == "0" ? (this.bed.sex = "男生") : (this.bed.sex = "女生");
      type == "0"
        ? (this.bed.total = this.bed.manCount)
        : (this.bed.total = this.bed.girlCount);
      //设置弹框属性
      this.assignDialog.title =
        "为【" +
        this.bed.className +
        "】分配【" +
        this.bed.sex +
        "】宿舍,需要【" +
        this.bed.total +
        "】个床位";
      this.assignDialog.visible = true;
    },
    //页数改变时触发
    currentChange(val) {
      this.searchModel.currentPage = val;
      this.getAssignClass();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.searchModel.pageSize = val;
      this.getAssignClass();
    },
    //左侧班级点击事件
    itemClick(item, index) {
      console.log("点击班级");
      this.isChange = index;
      console.log(item);
      this.bed.classId = item.classId;
      this.bed.className = item.className;
      this.bed.girlCount = item.girlCount;
      this.bed.manCount = item.manCount;
      this.getAssignBedList(this.bed.classId);
    },
    async getAssignClass() {
      let res = await getAssignClassApi(this.searchModel);
      if (res && res.code == 200) {
        console.log(res);
        this.classList = res.data.records;
        this.searchModel.total = res.data.total;
        this.$nextTick(() => {
          document.querySelector("#class0").click();
        });
      }
    },
  },
};
</script>

<style lang="scss" scoped>
.header {
  // height: 50px !important;
  border-bottom: 1px solid #dcdfe6;
  display: flex;
  align-items: center;
}
.item-container {
  display: flex;
  flex-direction: column;
}
.leftside {
  border-right: 1px solid #dcdfe6;
  border-bottom: 1px solid #dcdfe6;
  display: flex;
  flex-direction: column;
  .side-item {
    display: flex;
    height: 55px;
    border-bottom: 1px solid #dcdfe6;
    align-items: center;
    cursor: pointer;
    .item-left {
      padding-left: 10px;
      flex-grow: 1;
      .class-title {
        color: #686868;
        font-size: 13px;
      }
      .class-sex {
        display: flex;
        color: #999;
        font-size: 12px;
        padding-top: 8px;
        .man {
          flex-grow: 1;
        }
        .girl {
          flex-grow: 1;
        }
      }
    }
    .item-right {
      padding-right: 10px;
      color: #b2b2b2;
    }
  }
}
.pages {
  text-align: center;
}
.isActive {
  background: #f8f8f8;
}
</style>
```





#### 第94讲 考勤管理模块接口开发

##### 1、数据库脚本

```js
drop table if exists drom_leave;

/*==============================================================*/
/* Table: drom_leave                                            */
/*==============================================================*/
create table drom_leave
(
   leave_id             int not null auto_increment comment '主键',
   classes              varchar(64) comment '班级',
   stu_name             varchar(64) comment '姓名',
   drom_name            varchar(64) comment '宿舍名称',
   leave_time           varchar(32) comment '缺勤时间',
   primary key (leave_id)
);

```

##### 2、新建实体类

```js
package com.itmk.web.drom_leave.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class DromLeave {
    @TableId(type = IdType.AUTO)
    private Long leaveId;
    private String classes;
    private String stuName;
    private String dromName;
    private String leaveTime;
}

```

```js
package com.itmk.web.drom_leave.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class LeaveParm {
    private String classes;
    private String stuName;
    private String dromName;
    private Long currentPage;
    private Long pageSize;
}

```

##### 3、新建mapper层

```js
package com.itmk.web.drom_leave.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.drom_leave.entity.DromLeave;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface DromLeaveMapper extends BaseMapper<DromLeave> {
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.drom_leave.mapper.DromLeaveMapper">

</mapper>
```

##### 4、新建service层

```js
package com.itmk.web.drom_leave.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.drom_leave.entity.DromLeave;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface DromLeaveService extends IService<DromLeave> {
}

```

实现类

```js
package com.itmk.web.drom_leave.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.drom_leave.entity.DromLeave;
import com.itmk.web.drom_leave.mapper.DromLeaveMapper;
import com.itmk.web.drom_leave.service.DromLeaveService;
import org.springframework.stereotype.Service;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class DromLeaveServiceImpl extends ServiceImpl<DromLeaveMapper, DromLeave> implements DromLeaveService {
}

```

##### 5、新建控制器

```js
package com.itmk.web.drom_leave.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.drom_leave.entity.DromLeave;
import com.itmk.web.drom_leave.entity.LeaveParm;
import com.itmk.web.drom_leave.service.DromLeaveService;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/leave")
public class DromLeaveController {
    @Autowired
    private DromLeaveService dromLeaveService;

    //新增
    @PostMapping
    public ResultVo add(@RequestBody DromLeave dromLeave){
        boolean save = dromLeaveService.save(dromLeave);
        if(save){
            return ResultUtils.success("新增成功!");
        }
        return ResultUtils.error("新增失败!");
    }

    //编辑
    @PutMapping
    public ResultVo edit(@RequestBody DromLeave dromLeave){
        boolean save = dromLeaveService.updateById(dromLeave);
        if(save){
            return ResultUtils.success("编辑成功!");
        }
        return ResultUtils.error("编辑失败!");
    }

    //删除
    @DeleteMapping("/{leaveId}")
    public ResultVo delete(@PathVariable("leaveId") Long leaveId){
        boolean b = dromLeaveService.removeById(leaveId);
        if(b){
            return ResultUtils.success("删除成功!");
        }
        return ResultUtils.error("删除失败!");
    }

    //列表
    @GetMapping("/list")
    public ResultVo list(LeaveParm parm){
        //构造分页对象
        IPage<DromLeave> page = new Page<>(parm.getCurrentPage(),parm.getPageSize());
        //构造查询条件
        QueryWrapper<DromLeave> query = new QueryWrapper<>();
        if(StringUtils.isNotEmpty(parm.getClasses())){
            query.lambda().like(DromLeave::getClasses,parm.getClasses());
        }
        if(StringUtils.isNotEmpty(parm.getDromName())){
            query.lambda().like(DromLeave::getDromName,parm.getDromName());
        }
        if(StringUtils.isNotEmpty(parm.getStuName())){
            query.lambda().like(DromLeave::getStuName,parm.getStuName());
        }
        IPage<DromLeave> list = dromLeaveService.page(page, query);
        return ResultUtils.success("查询成功",list);
    }
}

```





#### 第95  新增考勤页面制作

##### 1、api下新建leave.js

```js
import http from "@/utils/http";
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/leave",parm)
}
```



##### 2、views下新建leave目录，目录下新建index.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchModel.classes"
          placeholder="请输入班级"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.stuName"
          placeholder="请输入姓名"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.dromName"
          placeholder="请输入宿舍名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search">搜索</el-button>
        <el-button icon="el-icon-close" style="color: #ff7670">重置</el-button>
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          style="margin: 0px 10px"
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="50px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="classes" label="班级">
            <el-input v-model="addModel.classes"></el-input>
          </el-form-item>
          <el-form-item prop="stuName" label="姓名">
            <el-input v-model="addModel.stuName"></el-input>
          </el-form-item>
          <el-form-item prop="dromName" label="宿舍">
            <el-input v-model="addModel.dromName"></el-input>
          </el-form-item>
          <el-form-item prop="leaveTime" label="日期">
            <el-date-picker
              style="width: 100%"
              value-format="yyyy-MM-dd"
              v-model="addModel.leaveTime"
              type="date"
              placeholder="选择日期"
            >
            </el-date-picker>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { addApi } from "@/api/leave.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      addModel: {
        type: "",
        leaveId: "",
        classes: "",
        stuName: "",
        dromName: "",
        leaveTime: "",
      },
      rules: {
        leaveTime: [
          {
            trigger: "blur",
            required: true,
            message: "请选择日期",
          },
        ],
        stuName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写姓名",
          },
        ],
        classes: [
          {
            trigger: "blur",
            required: true,
            message: "请填写班级",
          },
        ],
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 230,
        width: 650,
        visible: false,
      },
      searchModel: {
        classes: "",
        stuName: "",
        dromName: "",
        currentPage: 1,
        pageSize: 10,
      },
    };
  },
  methods: {
    //确定
    onConfirm() {
      console.log(this.addModel);
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    //关闭
    onClose() {
      this.addDialog.visible = false;
    },
    addBtn() {
      //设置弹框属性
      this.addDialog.title = "新增缺勤";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```









#### 第96讲 考勤列表页面制作与对接

##### 1、api/leave.js添加listApi()方法

```js
import http from "@/utils/http";
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/leave",parm)
}
//列表
export const listApi = async(parm)=>{
    return await http.get("/api/leave/list",parm)
}
```

##### 2、页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchModel.classes"
          placeholder="请输入班级"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.stuName"
          placeholder="请输入姓名"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.dromName"
          placeholder="请输入宿舍名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button @click="searchBtn" icon="el-icon-search">搜索</el-button>
        <el-button @click="resetBtn" icon="el-icon-close" style="color: #ff7670"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="classes" label="班级"></el-table-column>
      <el-table-column prop="stuName" label="姓名"></el-table-column>
      <el-table-column prop="dromName" label="宿舍"></el-table-column>
      <el-table-column prop="leaveTime" label="缺勤时间"></el-table-column>
      <el-table-column label="操作" align="center" width="220">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchModel.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchModel.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchModel.total"
      background
    >
    </el-pagination>

    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          style="margin: 0px 10px"
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="50px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="classes" label="班级">
            <el-input v-model="addModel.classes"></el-input>
          </el-form-item>
          <el-form-item prop="stuName" label="姓名">
            <el-input v-model="addModel.stuName"></el-input>
          </el-form-item>
          <el-form-item prop="dromName" label="宿舍">
            <el-input v-model="addModel.dromName"></el-input>
          </el-form-item>
          <el-form-item prop="leaveTime" label="日期">
            <el-date-picker
              style="width: 100%"
              value-format="yyyy-MM-dd"
              v-model="addModel.leaveTime"
              type="date"
              placeholder="选择日期"
            >
            </el-date-picker>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { addApi, listApi } from "@/api/leave.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      tableHeight: 0,
      addModel: {
        type: "",
        leaveId: "",
        classes: "",
        stuName: "",
        dromName: "",
        leaveTime: "",
      },
      rules: {
        leaveTime: [
          {
            trigger: "blur",
            required: true,
            message: "请选择日期",
          },
        ],
        stuName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写姓名",
          },
        ],
        classes: [
          {
            trigger: "blur",
            required: true,
            message: "请填写班级",
          },
        ],
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 230,
        width: 650,
        visible: false,
      },
      searchModel: {
        classes: "",
        stuName: "",
        dromName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      tableList: [],
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  methods: {
    resetBtn() {
      this.searchModel.stuName = "";
      this.searchModel.dromName = "";
      this.searchModel.classes = "";
      this.searchModel.currentPage = 1;
      this.getList();
    },
    searchBtn() {
      this.getList();
    },
    currentChange(val) {
      this.searchModel.currentPage = val;
      this.getList();
    },
    sizeChange(val) {
      this.searchModel.pageSize = val;
      this.getList();
    },
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {},
    //列表获取
    async getList() {
      let res = await listApi(this.searchModel);
      if (res && res.code == 200) {
        //设置表格数据
        this.tableList = res.data.records;
        this.searchModel.total = res.data.total;
      }
    },
    //确定
    onConfirm() {
      console.log(this.addModel);
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    //关闭
    onClose() {
      this.addDialog.visible = false;
    },
    addBtn() {
      //设置弹框属性
      this.addDialog.title = "新增缺勤";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```







#### 第97讲 编辑、删除考勤对接

##### 1、api/leave.js添加editApi()和deleteApi()方法

```js
import http from "@/utils/http";
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/leave",parm)
}
//列表
export const listApi = async(parm)=>{
    return await http.get("/api/leave/list",parm)
}
//编辑
export const editApi = async(parm)=>{
    return await http.put("/api/leave",parm)
}
//删除
export const deleteApi = async(parm)=>{
    return await http.delete("/api/leave",parm)
}
```

##### 2、页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchModel.classes"
          placeholder="请输入班级"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.stuName"
          placeholder="请输入姓名"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.dromName"
          placeholder="请输入宿舍名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button @click="searchBtn" icon="el-icon-search">搜索</el-button>
        <el-button @click="resetBtn" icon="el-icon-close" style="color: #ff7670"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="classes" label="班级"></el-table-column>
      <el-table-column prop="stuName" label="姓名"></el-table-column>
      <el-table-column prop="dromName" label="宿舍"></el-table-column>
      <el-table-column prop="leaveTime" label="缺勤时间"></el-table-column>
      <el-table-column label="操作" align="center" width="220">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchModel.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchModel.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchModel.total"
      background
    >
    </el-pagination>

    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          style="margin: 0px 10px"
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="50px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="classes" label="班级">
            <el-input v-model="addModel.classes"></el-input>
          </el-form-item>
          <el-form-item prop="stuName" label="姓名">
            <el-input v-model="addModel.stuName"></el-input>
          </el-form-item>
          <el-form-item prop="dromName" label="宿舍">
            <el-input v-model="addModel.dromName"></el-input>
          </el-form-item>
          <el-form-item prop="leaveTime" label="日期">
            <el-date-picker
              style="width: 100%"
              value-format="yyyy-MM-dd"
              v-model="addModel.leaveTime"
              type="date"
              placeholder="选择日期"
            >
            </el-date-picker>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { addApi, listApi, editApi, deleteApi } from "@/api/leave.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      tableHeight: 0,
      addModel: {
        type: "",
        leaveId: "",
        classes: "",
        stuName: "",
        dromName: "",
        leaveTime: "",
      },
      rules: {
        leaveTime: [
          {
            trigger: "blur",
            required: true,
            message: "请选择日期",
          },
        ],
        stuName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写姓名",
          },
        ],
        classes: [
          {
            trigger: "blur",
            required: true,
            message: "请填写班级",
          },
        ],
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 230,
        width: 650,
        visible: false,
      },
      searchModel: {
        classes: "",
        stuName: "",
        dromName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      tableList: [],
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  methods: {
    resetBtn() {
      this.searchModel.stuName = "";
      this.searchModel.dromName = "";
      this.searchModel.classes = "";
      this.searchModel.currentPage = 1;
      this.getList();
    },
    searchBtn() {
      this.getList();
    },
    currentChange(val) {
      this.searchModel.currentPage = val;
      this.getList();
    },
    sizeChange(val) {
      this.searchModel.pageSize = val;
      this.getList();
    },
    //删除按钮
    async deleteBtn(row) {
      const confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteApi({
          leaveId: row.leaveId,
        });
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          this.getList();
        }
      }
    },
    //编辑按钮
    editBtn(row) {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      this.$objCoppy(row, this.addModel);
      //设置弹框属性
      this.addDialog.title = "编辑考勤";
      this.addDialog.visible = true;
      this.addModel.type = "1";
    },
    //列表获取
    async getList() {
      let res = await listApi(this.searchModel);
      if (res && res.code == 200) {
        //设置表格数据
        this.tableList = res.data.records;
        this.searchModel.total = res.data.total;
      }
    },
    //确定
    onConfirm() {
      console.log(this.addModel);
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.getList();
            this.addDialog.visible = false;
          }
        }
      });
    },
    //关闭
    onClose() {
      this.addDialog.visible = false;
    },
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置弹框属性
      this.addDialog.title = "新增缺勤";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第98讲 报修管理模块接口开发

##### 1、数据库脚本

```js
drop table if exists drom_repair;

/*==============================================================*/
/* Table: drom_repair                                           */
/*==============================================================*/
create table drom_repair
(
   repair_id            int not null auto_increment comment '主键',
   username             varchar(36) comment '联系人',
   phone                varchar(18) comment '联系电话',
   drom_name            varchar(36) comment '宿舍名称',
   repair_text          text comment '维修说明',
   repair_time          datetime comment '报修时间',
   status               varchar(2) comment '维修状态',
   primary key (repair_id)
);

```

##### 2、新建实体类

```js
package com.itmk.web.drom_repair.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.util.Date;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
@TableName("drom_repair")
public class DromRepair {
    @TableId(type = IdType.AUTO)
    private Long repairId;
    private String username;
    private String phone;
    private String dromName;
    private String repairText;
    private String status; //0 ： 待维修 1： 已维修
    private Date repairTime;
}

```

```js
package com.itmk.web.drom_repair.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class RepairParm {
    private String dromName;
    private Long currentPage;
    private Long pageSize;
}

```

##### 3、新建mapper层

```js
package com.itmk.web.drom_repair.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.drom_repair.entity.DromRepair;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface DromRepairMapper extends BaseMapper<DromRepair> {
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.drom_repair.mapper.DromRepairMapper">

</mapper>
```

##### 4、新建service层

```js
package com.itmk.web.drom_repair.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.drom_repair.entity.DromRepair;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface DromRepairService extends IService<DromRepair> {
}

```

实现类

```js
package com.itmk.web.drom_repair.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.drom_repair.entity.DromRepair;
import com.itmk.web.drom_repair.mapper.DromRepairMapper;
import com.itmk.web.drom_repair.service.DromRepairService;
import org.springframework.stereotype.Service;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class DromRepairServiceImpl extends ServiceImpl<DromRepairMapper, DromRepair> implements DromRepairService {
}

```

##### 5、控制器层

```js
package com.itmk.web.drom_repair.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.drom_repair.entity.DromRepair;
import com.itmk.web.drom_repair.entity.RepairParm;
import com.itmk.web.drom_repair.service.DromRepairService;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.Date;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/repair")
public class DromRepairController {
    @Autowired
    private DromRepairService dromRepairService;

    //新增
    @PostMapping
    public ResultVo add(@RequestBody DromRepair dromRepair){
        dromRepair.setRepairTime(new Date());
        boolean save = dromRepairService.save(dromRepair);
        if(save){
            return ResultUtils.success("报修成功!");
        }
        return ResultUtils.error("报修失败!");
    }

    //编辑
    @PutMapping
    public ResultVo edit(@RequestBody DromRepair dromRepair){
        boolean save = dromRepairService.updateById(dromRepair);
        if(save){
            return ResultUtils.success("编辑成功!");
        }
        return ResultUtils.error("编辑失败!");
    }

    @DeleteMapping("/{repairId}")
    public ResultVo delete(@PathVariable("repairId") Long repairId){
        boolean save = dromRepairService.removeById(repairId);
        if(save){
            return ResultUtils.success("删除成功!");
        }
        return ResultUtils.error("删除失败!");
    }

    @GetMapping("/list")
    public ResultVo list(RepairParm parm){
        //构造分页对象
        IPage<DromRepair> page = new Page<>(parm.getCurrentPage(),parm.getPageSize());
        //构造查询条件
        QueryWrapper<DromRepair> query = new QueryWrapper<>();
        if(StringUtils.isNotEmpty(parm.getDromName())){
            query.lambda().like(DromRepair::getDromName,parm.getDromName());
        }
        IPage<DromRepair> list = dromRepairService.page(page, query);
        return ResultUtils.success("查询成功",list);
    }
}

```





#### 第99讲 新增报修页面与对接

##### 1、api下新建repair.js文件

```js
import http from "@/utils/http";
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/repair",parm)
}
```

##### 2、views目录下新建repair目录，然后新建index.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏-->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchModel.dromName"
          placeholder="宿舍名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button icon="el-icon-close" @click="resetBtn">重置</el-button>
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :width="addDialog.width"
      :height="addDialog.height"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="dromName" label="宿舍名称">
            <el-input v-model="addModel.dromName"></el-input>
          </el-form-item>
          <el-form-item prop="username" label="联系人">
            <el-input v-model="addModel.username"></el-input>
          </el-form-item>
          <el-form-item prop="phone" label="联系电话">
            <el-input v-model="addModel.phone"></el-input>
          </el-form-item>
          <el-form-item prop="repairText" label="报修内容">
            <el-input type="textarea" v-model="addModel.repairText"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { addApi } from "@/api/repair.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      rules: {
        username: [
          {
            trigger: "blur",
            required: true,
            message: "请填写联系人",
          },
        ],
        phone: [
          {
            trigger: "blur",
            required: true,
            message: "请填写联系电话",
          },
        ],
        dromName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写宿舍名称",
          },
        ],
        repairText: [
          {
            trigger: "blur",
            required: true,
            message: "请填写报修内容",
          },
        ],
      },
      addModel: {
        repairId: "",
        username: "",
        phone: "",
        dromName: "",
        repairText: "",
        type: "",
      },
      addDialog: {
        title: "",
        width: 650,
        height: 230,
        visible: false,
      },
      searchModel: {
        dromName: "",
      },
    };
  },
  methods: {
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    onClose() {
      this.addDialog.visible = false;
    },
    addBtn() {
      //清空表单数据
      this.$resetForm("addForm", this.addModel);
      //设置弹框属性
      this.addDialog.title = "新增报修";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    resetBtn() {},
    searchBtn() {},
  },
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第100讲 报修列表制作与对接

##### 1、api/repair.js添加listApi()方法

```js
import http from "@/utils/http";
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/repair",parm)
}
//列表
export const listApi = async(parm)=>{
    return await http.get("/api/repair/list",parm)
}
```

##### 2、页面

```js
<template>
  <el-main>
    <!-- 搜索栏-->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchModel.dromName"
          placeholder="宿舍名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button icon="el-icon-close" @click="resetBtn">重置</el-button>
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="dromName" label="宿舍名称"></el-table-column>
      <el-table-column prop="username" label="联系人"></el-table-column>
      <el-table-column prop="phone" label="联系电话"></el-table-column>
      <el-table-column prop="repairText" label="维修说明"></el-table-column>
      <el-table-column prop="status" label="维修状态">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.status == '0'" type="danger" size="small">未处理</el-tag>
          <el-tag v-if="scope.row.status == '1'" type="success" size="small">已处理</el-tag>
        </template>
      </el-table-column>
      <el-table-column label="操作" align="center" width="280">
        <template slot-scope="scope">
          <el-button
            type="primary"
            size="small"
            icon="el-icon-edit"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
           <el-button
            type="success"
            size="small"
            icon="el-icon-edit"
            @click="doBtn(scope.row)"
            >处理</el-button
          >
          <el-button
            type="danger"
            size="small"
            icon="el-icon-delete"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchModel.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchModel.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchModel.total"
      background
    >
    </el-pagination>

    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :width="addDialog.width"
      :height="addDialog.height"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="dromName" label="宿舍名称">
            <el-input v-model="addModel.dromName"></el-input>
          </el-form-item>
          <el-form-item prop="username" label="联系人">
            <el-input v-model="addModel.username"></el-input>
          </el-form-item>
          <el-form-item prop="phone" label="联系电话">
            <el-input v-model="addModel.phone"></el-input>
          </el-form-item>
          <el-form-item prop="repairText" label="报修内容">
            <el-input type="textarea" v-model="addModel.repairText"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { addApi, listApi } from "@/api/repair.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      tableHeight: 0,
      rules: {
        username: [
          {
            trigger: "blur",
            required: true,
            message: "请填写联系人",
          },
        ],
        phone: [
          {
            trigger: "blur",
            required: true,
            message: "请填写联系电话",
          },
        ],
        dromName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写宿舍名称",
          },
        ],
        repairText: [
          {
            trigger: "blur",
            required: true,
            message: "请填写报修内容",
          },
        ],
      },
      addModel: {
        repairId: "",
        username: "",
        phone: "",
        dromName: "",
        repairText: "",
        type: "",
      },
      addDialog: {
        title: "",
        width: 650,
        height: 230,
        visible: false,
      },
      searchModel: {
        dromName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      tableList: [],
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  methods: {
    doBtn(row){

    },
    currentChange(val) {
      this.searchModel.currentPage = val;
      this.getList();
    },
    sizeChange(val) {
      this.searchModel.pageSize = val;
      this.getList();
    },
    deleteBtn(row) {},
    editBtn(row) {},
    //获取列表
    async getList() {
      let res = await listApi(this.searchModel);
      if (res && res.code == 200) {
        console.log(res);
        this.tableList = res.data.records;
        this.searchModel.total = res.data.total;
      }
    },
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.getList()
            this.addDialog.visible = false;
          }
        }
      });
    },
    onClose() {
      this.addDialog.visible = false;
    },
    addBtn() {
      //清空表单数据
      this.$resetForm("addForm", this.addModel);
      //设置弹框属性
      this.addDialog.title = "新增报修";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    resetBtn() {
      this.searchModel.dromName = "";
      this.searchModel.currentPage = 1;
      this.getList();
    },
    searchBtn() {
      this.getList();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第101讲 维修编辑、删除对接

##### 1、api/repair.js添加editApi()和deleteApi()方法

```js
import http from "@/utils/http";
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/repair",parm)
}
//列表
export const listApi = async(parm)=>{
    return await http.get("/api/repair/list",parm)
}
//编辑
export const editApi = async(parm)=>{
    return await http.put("/api/repair",parm)
}
//删除
export const deleteApi = async(parm)=>{
    return await http.delete("/api/repair",parm)
}
```

##### 2、页面

```js
<template>
  <el-main>
    <!-- 搜索栏-->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchModel.dromName"
          placeholder="宿舍名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button icon="el-icon-close" @click="resetBtn">重置</el-button>
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="dromName" label="宿舍名称"></el-table-column>
      <el-table-column prop="username" label="联系人"></el-table-column>
      <el-table-column prop="phone" label="联系电话"></el-table-column>
      <el-table-column prop="repairText" label="维修说明"></el-table-column>
      <el-table-column prop="status" label="维修状态">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.status == '0'" type="danger" size="small"
            >未处理</el-tag
          >
          <el-tag v-if="scope.row.status == '1'" type="success" size="small"
            >已处理</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column label="操作" align="center" width="280">
        <template slot-scope="scope">
          <el-button
            type="primary"
            size="small"
            icon="el-icon-edit"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="success"
            size="small"
            icon="el-icon-edit"
            @click="doBtn(scope.row)"
            >处理</el-button
          >
          <el-button
            type="danger"
            size="small"
            icon="el-icon-delete"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchModel.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchModel.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchModel.total"
      background
    >
    </el-pagination>

    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :width="addDialog.width"
      :height="addDialog.height"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="dromName" label="宿舍名称">
            <el-input v-model="addModel.dromName"></el-input>
          </el-form-item>
          <el-form-item prop="username" label="联系人">
            <el-input v-model="addModel.username"></el-input>
          </el-form-item>
          <el-form-item prop="phone" label="联系电话">
            <el-input v-model="addModel.phone"></el-input>
          </el-form-item>
          <el-form-item prop="repairText" label="报修内容">
            <el-input type="textarea" v-model="addModel.repairText"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { addApi, listApi, editApi, deleteApi } from "@/api/repair.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      tableHeight: 0,
      rules: {
        username: [
          {
            trigger: "blur",
            required: true,
            message: "请填写联系人",
          },
        ],
        phone: [
          {
            trigger: "blur",
            required: true,
            message: "请填写联系电话",
          },
        ],
        dromName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写宿舍名称",
          },
        ],
        repairText: [
          {
            trigger: "blur",
            required: true,
            message: "请填写报修内容",
          },
        ],
      },
      addModel: {
        repairId: "",
        username: "",
        phone: "",
        dromName: "",
        repairText: "",
        type: "",
      },
      addDialog: {
        title: "",
        width: 650,
        height: 230,
        visible: false,
      },
      searchModel: {
        dromName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      tableList: [],
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  methods: {
    async doBtn(row) {
      if (row.status != "0") {
        this.$message.warning("该报修已经处理，不用重复处理!");
        return;
      }
      const confirm = await this.$myconfirm("确定处理该维修?");
      if (confirm) {
        let parm = {
          repairId: row.repairId,
          status: "1",
        };
        let res = await editApi(parm);
        if (res && res.code == 200) {
          this.$message.success("处理成功");
          this.getList();
        }
      }
    },
    currentChange(val) {
      this.searchModel.currentPage = val;
      this.getList();
    },
    sizeChange(val) {
      this.searchModel.pageSize = val;
      this.getList();
    },
    async deleteBtn(row) {
      const confirm = await this.$myconfirm("确定删除该维修?");
      if (confirm) {
        let res = await deleteApi({
          repairId: row.repairId,
        });
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          this.getList();
        }
      }
    },
    editBtn(row) {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      this.$objCoppy(row, this.addModel);
      this.addModel.type = "1";
      //设置弹框属性
      this.addDialog.title = "编辑报修";
      this.addDialog.visible = true;
    },
    //获取列表
    async getList() {
      let res = await listApi(this.searchModel);
      if (res && res.code == 200) {
        console.log(res);
        this.tableList = res.data.records;
        this.searchModel.total = res.data.total;
      }
    },
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.getList();
            this.addDialog.visible = false;
          }
        }
      });
    },
    onClose() {
      this.addDialog.visible = false;
    },
    addBtn() {
      //清空表单数据
      this.$resetForm("addForm", this.addModel);
      //设置弹框属性
      this.addDialog.title = "新增报修";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    resetBtn() {
      this.searchModel.dromName = "";
      this.searchModel.currentPage = 1;
      this.getList();
    },
    searchBtn() {
      this.getList();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```







#### 第102讲 物品出入登录接口开发

##### 1、数据库脚本

```js
drop table if exists drom_into;

/*==============================================================*/
/* Table: drom_into                                             */
/*==============================================================*/
create table drom_into
(
   into_id              int not null auto_increment comment '主键',
   into_time            varchar(36) comment '出入时间',
   name                 varchar(64) comment '物品名称',
   into_text            text comment '备注',
   user_name            varchar(64) comment '联系人',
   phone                varchar(15) comment '联系电话',
   leader               varchar(36) comment '值班人',
   status               varchar(2) comment '类型 ： 1：进楼 2：出楼',
   primary key (into_id)
);

```

##### 2、新建实体类

```js
package com.itmk.web.drom_into.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
@TableName("drom_into")
public class DromInto {
    @TableId(type = IdType.AUTO)
    private Long intoId;
    private String intoTime;
    private String name;
    private String intoText;
    private String userName;
    private String phone;
    private String leader;
    private String status;
}

```

```js
package com.itmk.web.drom_into.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class DromIntoParm {
    private String name;
    private String userName;
    private Long currentPage;
    private Long pageSize;
}

```

##### 3、新建mapper层

```js
package com.itmk.web.drom_into.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.drom_into.entity.DromInto;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface DromIntoMapper extends BaseMapper<DromInto> {
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.drom_into.mapper.DromIntoMapper">

</mapper>
```

##### 4、新建service层

```js
package com.itmk.web.drom_into.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.drom_into.entity.DromInto;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface DromIntoService extends IService<DromInto> {
}

```

实现类

```js
package com.itmk.web.drom_into.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.drom_into.entity.DromInto;
import com.itmk.web.drom_into.mapper.DromIntoMapper;
import com.itmk.web.drom_into.service.DromIntoService;
import org.springframework.stereotype.Service;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class DromIntoServiceImpl extends ServiceImpl<DromIntoMapper, DromInto> implements DromIntoService {
}

```

##### 5、控制器

```js
package com.itmk.web.drom_into.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.drom_into.entity.DromInto;
import com.itmk.web.drom_into.entity.DromIntoParm;
import com.itmk.web.drom_into.service.DromIntoService;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/into")
public class DromIntoController {
    @Autowired
    private DromIntoService dromIntoService;

    //新增
    @PostMapping
    public ResultVo add(@RequestBody DromInto dromInto){
        boolean save = dromIntoService.save(dromInto);
        if(save){
            return ResultUtils.success("保存成功!");
        }
        return ResultUtils.error("操作失败!");
    }

     //编辑
    @PutMapping
    public ResultVo edit(@RequestBody DromInto dromInto){
        boolean save = dromIntoService.updateById(dromInto);
        if(save){
            return ResultUtils.success("编辑成功!");
        }
        return ResultUtils.error("编辑失败!");
    }

    //删除
    @DeleteMapping("/{intoId}")
    public ResultVo delete(@PathVariable("intoId") Long intoId){
        boolean save = dromIntoService.removeById(intoId);
         if(save){
            return ResultUtils.success("删除成功!");
        }
        return ResultUtils.error("删除失败!");
    }
    //列表
    @GetMapping("/list")
    public ResultVo list(DromIntoParm drom){
        //构造分页对象
        IPage<DromInto> page = new Page<>(drom.getCurrentPage(),drom.getPageSize());
        //构造查询条件
        QueryWrapper<DromInto> query = new QueryWrapper<>();
        if(StringUtils.isNotEmpty(drom.getName())){
            query.lambda().like(DromInto::getName,drom.getName());
        }
        if(StringUtils.isNotEmpty(drom.getUserName())){
            query.lambda().like(DromInto::getUserName,drom.getUserName());
        }
        query.lambda().orderByDesc(DromInto::getIntoTime);
        //查询列表
        IPage<DromInto> list = dromIntoService.page(page, query);
        return ResultUtils.success("查询成功",list);
    }
}

```





#### 第103讲 新增物品出入登记页面

##### 1、api下新增into.js

```js
import http from "@/utils/http";
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/into",parm)
}
```



##### 2、view目录下新建into目录，然后新建things.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          placeholder="请输入物品名称"
          v-model="searchModel.name"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          placeholder="请输入用户名称"
          v-model="searchModel.userName"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="intoTime" label="来访时间">
                <el-date-picker
                  value-format="yyyy-MM-dd HH:mm:ss"
                  v-model="addModel.intoTime"
                  type="datetime"
                  placeholder="选择日期时间"
                >
                </el-date-picker>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="类型" prop="status">
                <el-select v-model="addModel.status" placeholder="请选择">
                  <el-option
                    v-for="item in options"
                    :key="item.value"
                    :label="item.label"
                    :value="item.value"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item label="物品名称" prop="name">
            <el-input v-model="addModel.name"></el-input>
          </el-form-item>
          <el-form-item label="备注" prop="intoText">
            <el-input v-model="addModel.intoText"></el-input>
          </el-form-item>
          <el-form-item label="联系人" prop="userName">
            <el-input v-model="addModel.userName"></el-input>
          </el-form-item>
          <el-form-item label="联系电话" prop="phone">
            <el-input v-model="addModel.phone"></el-input>
          </el-form-item>
          <el-form-item label="值班人" prop="leader">
            <el-input v-model="addModel.leader"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { addApi } from "@/api/into.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      options: [
        {
          value: "1",
          label: "进楼",
        },
        {
          value: "2",
          label: "出楼",
        },
      ],
      addModel: {
        type: "",
        intoId: "",
        intoTime: "",
        name: "",
        intoText: "",
        userName: "",
        phone: "",
        leader: "",
        status: "",
      },
      rules: {
        intoTime: [
          {
            trigger: "blur",
            required: true,
            message: "请选择出入时间",
          },
        ],
        status: [
          {
            trigger: "blur",
            required: true,
            message: "请选择出入类型",
          },
        ],
        name: [
          {
            trigger: "blur",
            required: true,
            message: "请填写物品名称",
          },
        ],
        intoText: [
          {
            trigger: "blur",
            required: true,
            message: "请填写备注",
          },
        ],
        userName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写联系人",
          },
        ],
        phone: [
          {
            trigger: "blur",
            required: true,
            message: "请填写联系电话",
          },
        ],
        leader: [
          {
            trigger: "blur",
            required: true,
            message: "请填写值班人",
          },
        ],
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 330,
        width: 650,
        visible: false,
      },
      searchModel: {
        name: "",
        userName: "",
      },
    };
  },
  methods: {
    onConfirm() {
      console.log(this.addModel);
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    onClose() {
      this.addDialog.visible = false;
    },
    addBtn() {
      //设置弹框属性
      this.addDialog.title = "新增登记";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    resetBtn() {},
    searchBtn() {},
  },
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第104讲 物品出入登录列表对接

##### 1、api/into.js添加listApi()方法

```js
import http from "@/utils/http";
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/into",parm)
}
//列表
export const listApi = async(parm)=>{
    return await http.get("/api/into/list",parm)
}
```

##### 2、页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          placeholder="请输入物品名称"
          v-model="searchModel.name"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          placeholder="请输入用户名称"
          v-model="searchModel.userName"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column label="出入时间" prop="intoTime"></el-table-column>
      <el-table-column label="物品名称" prop="name"></el-table-column>
      <el-table-column label="备注" prop="intoText"></el-table-column>
      <el-table-column label="联系人" prop="userName"></el-table-column>
      <el-table-column label="联系电话" prop="phone"></el-table-column>
      <el-table-column label="值班人" prop="leader"></el-table-column>
      <el-table-column label="类型" prop="status">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.status == '2'" type="danger" size="normal"
            >出楼</el-tag
          >
          <el-tag v-if="scope.row.status == '1'" type="success" size="normal"
            >进楼</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column label="操作" align="center" width="220">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchModel.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchModel.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchModel.total"
      background
    >
    </el-pagination>

    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="intoTime" label="来访时间">
                <el-date-picker
                  value-format="yyyy-MM-dd HH:mm:ss"
                  v-model="addModel.intoTime"
                  type="datetime"
                  placeholder="选择日期时间"
                >
                </el-date-picker>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="类型" prop="status">
                <el-select v-model="addModel.status" placeholder="请选择">
                  <el-option
                    v-for="item in options"
                    :key="item.value"
                    :label="item.label"
                    :value="item.value"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item label="物品名称" prop="name">
            <el-input v-model="addModel.name"></el-input>
          </el-form-item>
          <el-form-item label="备注" prop="intoText">
            <el-input v-model="addModel.intoText"></el-input>
          </el-form-item>
          <el-form-item label="联系人" prop="userName">
            <el-input v-model="addModel.userName"></el-input>
          </el-form-item>
          <el-form-item label="联系电话" prop="phone">
            <el-input v-model="addModel.phone"></el-input>
          </el-form-item>
          <el-form-item label="值班人" prop="leader">
            <el-input v-model="addModel.leader"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { addApi, listApi } from "@/api/into.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      tableHeight: 0,
      tableList: [],
      options: [
        {
          value: "1",
          label: "进楼",
        },
        {
          value: "2",
          label: "出楼",
        },
      ],
      addModel: {
        type: "",
        intoId: "",
        intoTime: "",
        name: "",
        intoText: "",
        userName: "",
        phone: "",
        leader: "",
        status: "",
      },
      rules: {
        intoTime: [
          {
            trigger: "blur",
            required: true,
            message: "请选择出入时间",
          },
        ],
        status: [
          {
            trigger: "blur",
            required: true,
            message: "请选择出入类型",
          },
        ],
        name: [
          {
            trigger: "blur",
            required: true,
            message: "请填写物品名称",
          },
        ],
        intoText: [
          {
            trigger: "blur",
            required: true,
            message: "请填写备注",
          },
        ],
        userName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写联系人",
          },
        ],
        phone: [
          {
            trigger: "blur",
            required: true,
            message: "请填写联系电话",
          },
        ],
        leader: [
          {
            trigger: "blur",
            required: true,
            message: "请填写值班人",
          },
        ],
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 330,
        width: 650,
        visible: false,
      },
      searchModel: {
        name: "",
        userName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 230;
    });
  },
  methods: {
    currentChange(val) {
      this.searchModel.currentPage = val;
      this.getList();
    },
    sizeChange(val) {
      this.searchModel.pageSize = val;
      this.getList();
    },
    deleteBtn(row) {},
    editBtn(row) {},
    //获取数据
    async getList() {
      let res = await listApi(this.searchModel);
      if (res && res.code == 200) {
        this.tableList = res.data.records;
        this.searchModel.total = res.data.total;
      }
    },
    onConfirm() {
      console.log(this.addModel);
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.getList()
            this.addDialog.visible = false;
          }
        }
      });
    },
    onClose() {
      this.addDialog.visible = false;
    },
    addBtn() {
      //设置弹框属性
      this.addDialog.title = "新增登记";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    resetBtn() {
      this.searchModel.name = "";
      this.searchModel.userName = "";
      this.searchModel.currentPage = 1
      this.getList();
    },
    searchBtn() {
      this.getList();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```









#### 第105讲 编辑、删除登记对接

##### 1、into.js添加editApi()和deleteApi()方法

```js
import http from "@/utils/http";
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/into",parm)
}
//列表
export const listApi = async(parm)=>{
    return await http.get("/api/into/list",parm)
}
//编辑
export const editApi = async(parm)=>{
    return await http.put("/api/into",parm)
}
//删除
export const deleteApi = async(parm)=>{
    return await http.delete("/api/into",parm)
}
```

##### 2、页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          placeholder="请输入物品名称"
          v-model="searchModel.name"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          placeholder="请输入用户名称"
          v-model="searchModel.userName"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column label="出入时间" prop="intoTime"></el-table-column>
      <el-table-column label="物品名称" prop="name"></el-table-column>
      <el-table-column label="备注" prop="intoText"></el-table-column>
      <el-table-column label="联系人" prop="userName"></el-table-column>
      <el-table-column label="联系电话" prop="phone"></el-table-column>
      <el-table-column label="值班人" prop="leader"></el-table-column>
      <el-table-column label="类型" prop="status">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.status == '2'" type="danger" size="normal"
            >出楼</el-tag
          >
          <el-tag v-if="scope.row.status == '1'" type="success" size="normal"
            >进楼</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column label="操作" align="center" width="220">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchModel.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchModel.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchModel.total"
      background
    >
    </el-pagination>

    <!-- 新增弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="intoTime" label="来访时间">
                <el-date-picker
                  value-format="yyyy-MM-dd HH:mm:ss"
                  v-model="addModel.intoTime"
                  type="datetime"
                  placeholder="选择日期时间"
                >
                </el-date-picker>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="类型" prop="status">
                <el-select v-model="addModel.status" placeholder="请选择">
                  <el-option
                    v-for="item in options"
                    :key="item.value"
                    :label="item.label"
                    :value="item.value"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item label="物品名称" prop="name">
            <el-input v-model="addModel.name"></el-input>
          </el-form-item>
          <el-form-item label="备注" prop="intoText">
            <el-input v-model="addModel.intoText"></el-input>
          </el-form-item>
          <el-form-item label="联系人" prop="userName">
            <el-input v-model="addModel.userName"></el-input>
          </el-form-item>
          <el-form-item label="联系电话" prop="phone">
            <el-input v-model="addModel.phone"></el-input>
          </el-form-item>
          <el-form-item label="值班人" prop="leader">
            <el-input v-model="addModel.leader"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { addApi, listApi, editApi, deleteApi } from "@/api/into.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      tableHeight: 0,
      tableList: [],
      options: [
        {
          value: "1",
          label: "进楼",
        },
        {
          value: "2",
          label: "出楼",
        },
      ],
      addModel: {
        type: "",
        intoId: "",
        intoTime: "",
        name: "",
        intoText: "",
        userName: "",
        phone: "",
        leader: "",
        status: "",
      },
      rules: {
        intoTime: [
          {
            trigger: "blur",
            required: true,
            message: "请选择出入时间",
          },
        ],
        status: [
          {
            trigger: "blur",
            required: true,
            message: "请选择出入类型",
          },
        ],
        name: [
          {
            trigger: "blur",
            required: true,
            message: "请填写物品名称",
          },
        ],
        intoText: [
          {
            trigger: "blur",
            required: true,
            message: "请填写备注",
          },
        ],
        userName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写联系人",
          },
        ],
        phone: [
          {
            trigger: "blur",
            required: true,
            message: "请填写联系电话",
          },
        ],
        leader: [
          {
            trigger: "blur",
            required: true,
            message: "请填写值班人",
          },
        ],
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 330,
        width: 650,
        visible: false,
      },
      searchModel: {
        name: "",
        userName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 230;
    });
  },
  methods: {
    currentChange(val) {
      this.searchModel.currentPage = val;
      this.getList();
    },
    sizeChange(val) {
      this.searchModel.pageSize = val;
      this.getList();
    },
    async deleteBtn(row) {
      const confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteApi({
          intoId: row.intoId,
        });
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          this.getList();
        }
      }
    },
    editBtn(row) {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      this.$objCoppy(row, this.addModel);
      //设置弹框属性
      this.addDialog.title = "编辑登记";
      this.addDialog.visible = true;
      this.addModel.type = "1";
    },
    //获取数据
    async getList() {
      let res = await listApi(this.searchModel);
      if (res && res.code == 200) {
        this.tableList = res.data.records;
        this.searchModel.total = res.data.total;
      }
    },
    onConfirm() {
      console.log(this.addModel);
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.getList();
            this.addDialog.visible = false;
          }
        }
      });
    },
    onClose() {
      this.addDialog.visible = false;
    },
    addBtn() {
      //设置弹框属性
      this.addDialog.title = "新增登记";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    resetBtn() {
      this.searchModel.name = "";
      this.searchModel.userName = "";
      this.searchModel.currentPage = 1;
      this.getList();
    },
    searchBtn() {
      this.getList();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```







#### 第106讲 来访人员接口开发

##### 1、数据库脚本

```js
drop table if exists drom_look;

/*==============================================================*/
/* Table: drom_look                                             */
/*==============================================================*/
create table drom_look
(
   look_id              int not null auto_increment comment '主键',
   look_time            varchar(36) comment '来访时间',
   user_name            varchar(64) comment '来访人姓名',
   phone                varchar(15) comment '来访人电话',
   look_name            varchar(64) comment '被访人姓名',
   look_room            varchar(64) comment '被访人宿舍',
   leader               varchar(64) comment '值班人',
   look_text            text comment '备注',
   primary key (look_id)
);

```

##### 2、实体类

```js
package com.itmk.web.drom_look.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
@TableName("drom_look")
public class DromLook {
    @TableId(type = IdType.AUTO)
    private Long lookId;
    private String lookTime;
    private String userName;
    private String phone;
    private String lookName;
    private String lookRoom;
    private String leader;
    private String lookText;
}

```

```js
package com.itmk.web.drom_look.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class LookParm {
     private String lookRoom;
    private String userName;
    private Long currentPage;
    private Long pageSize;
}

```

##### 3、新建mapper层

```js
package com.itmk.web.drom_look.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.drom_look.entity.DromLook;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface DromLookMapper extends BaseMapper<DromLook> {
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.drom_look.mapper.DromLookMapper">

</mapper>
```

##### 4、service层

```js
package com.itmk.web.drom_look.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.drom_look.entity.DromLook;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface DromLookService extends IService<DromLook> {
}

```

实现类

```js
package com.itmk.web.drom_look.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.drom_look.entity.DromLook;
import com.itmk.web.drom_look.mapper.DromLookMapper;
import com.itmk.web.drom_look.service.DromLookService;
import org.springframework.stereotype.Service;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class DromLookServiceImpl extends ServiceImpl<DromLookMapper, DromLook> implements DromLookService {
}

```

##### 5、控制器

```js
package com.itmk.web.drom_look.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.drom_look.entity.DromLook;
import com.itmk.web.drom_look.entity.LookParm;
import com.itmk.web.drom_look.service.DromLookService;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/look")
public class DromLookController {
    @Autowired
    private DromLookService dromLookService;

    //新增
    @PostMapping
    public ResultVo add(@RequestBody DromLook dromLook){
        boolean save = dromLookService.save(dromLook);
        if(save){
            return ResultUtils.success("录入成功");
        }
        return ResultUtils.error("录入失败!");
    }

    //编辑
    @PutMapping
    public ResultVo edit(@RequestBody DromLook dromLook){
        boolean save = dromLookService.updateById(dromLook);
        if(save){
            return ResultUtils.success("编辑成功");
        }
        return ResultUtils.error("编辑失败!");
    }

    //删除
    @DeleteMapping("/{lookId}")
    public ResultVo delete(@PathVariable("lookId") Long lookId){
        boolean save = dromLookService.removeById(lookId);
        if(save){
            return ResultUtils.success("删除成功");
        }
        return ResultUtils.error("删除失败!");
    }

    //列表
    @GetMapping("/list")
    public ResultVo list(LookParm parm){
        //构造分页对象
        IPage<DromLook> page = new Page<>(parm.getCurrentPage(),parm.getPageSize());
        //构造查询条件
        QueryWrapper<DromLook> query = new QueryWrapper<>();
        if(StringUtils.isNotEmpty(parm.getLookRoom())){
            query.lambda().like(DromLook::getLookRoom,parm.getLookRoom());
        }
        if(StringUtils.isNotEmpty(parm.getUserName())){
            query.lambda().like(DromLook::getUserName,parm.getUserName());
        }
        IPage<DromLook> list = dromLookService.page(page, query);
        return ResultUtils.success("查询成功",list);
    }
}

```





#### 第107讲 新增来访人员制作

##### 1、api下新建look.js

```js
import http from "@/utils/http";
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/look",parm)
}
```

##### 2、页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchModel.userName"
          placeholder="请输入来访人姓名"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.lookRoom"
          placeholder="请输入被访人宿舍"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="100px"
          :inline="false"
          size="small"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="lookTime" label="来访时间">
                <el-date-picker
                  value-format="yyyy-MM-dd HH:mm:ss"
                  v-model="addModel.lookTime"
                  type="datetime"
                  placeholder="选择日期时间"
                >
                </el-date-picker>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="来访人姓名" prop="userName">
                <el-input v-model="addModel.userName"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="来访人电话" prop="phone">
                <el-input v-model="addModel.phone"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="被访人姓名" prop="lookName">
                <el-input v-model="addModel.lookName"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="被访宿舍" prop="lookRoom">
                <el-input v-model="addModel.lookRoom"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="值班员" prop="leader">
                <el-input v-model="addModel.leader"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="备注" prop="lookText">
                <el-input
                  type="textarea"
                  v-model="addModel.lookText"
                ></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { addApi } from "@/api/look.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      addModel: {
        type: "",
        lookId: "",
        lookTime: "",
        userName: "",
        phone: "",
        lookName: "",
        lookRoom: "",
        leader: "",
        lookText: "",
      },
      rules: {
        lookTime: [
          {
            trigger: "blur",
            required: true,
            message: "来访时间",
          },
        ],
        userName: [
          {
            trigger: "blur",
            required: true,
            message: "来访人姓名",
          },
        ],
        phone: [
          {
            trigger: "blur",
            required: true,
            message: "来访人电话",
          },
        ],
        lookName: [
          {
            trigger: "blur",
            required: true,
            message: "被访人姓名",
          },
        ],
        lookRoom: [
          {
            trigger: "blur",
            required: true,
            message: "被访人宿舍",
          },
        ],
        leader: [
          {
            trigger: "blur",
            required: true,
            message: "值班员",
          },
        ],
      },
      addDialog: {
        title: "",
        height: 230,
        width: 680,
        visible: false,
      },
      searchModel: {
        lookRoom: "",
        userName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
    };
  },
  methods: {
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    onClose() {
      this.addDialog.visible = false;
    },
    addBtn() {
      this.$resetForm("addForm", this.addModel);
      //弹框属性
      this.addDialog.title = "新增来访";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    resetBtn() {},
    searchBtn() {},
  },
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第108讲 来访人员列表开发对接

##### 1、look.js添加listApi()方法

```js
import http from "@/utils/http";
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/look",parm)
}
//列表
export const listApi = async(parm)=>{
    return await http.get("/api/look/list",parm)
}
```

##### 2、页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchModel.userName"
          placeholder="请输入来访人姓名"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.lookRoom"
          placeholder="请输入被访人宿舍"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 列表查询 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="lookTime" label="来访时间"></el-table-column>
      <el-table-column prop="userName" label="来访人姓名"></el-table-column>
      <el-table-column prop="phone" label="来访人电话"></el-table-column>
      <el-table-column prop="lookName" label="被访人姓名"></el-table-column>
      <el-table-column prop="lookRoom" label="被访宿舍"></el-table-column>
      <el-table-column prop="leader" label="值班人"></el-table-column>
      <el-table-column prop="lookText" label="备注"></el-table-column>
      <el-table-column label="操作" align="center" width="220">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchModel.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchModel.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchModel.total"
      background
    >
    </el-pagination>

    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="100px"
          :inline="false"
          size="small"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="lookTime" label="来访时间">
                <el-date-picker
                  value-format="yyyy-MM-dd HH:mm:ss"
                  v-model="addModel.lookTime"
                  type="datetime"
                  placeholder="选择日期时间"
                >
                </el-date-picker>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="来访人姓名" prop="userName">
                <el-input v-model="addModel.userName"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="来访人电话" prop="phone">
                <el-input v-model="addModel.phone"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="被访人姓名" prop="lookName">
                <el-input v-model="addModel.lookName"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="被访宿舍" prop="lookRoom">
                <el-input v-model="addModel.lookRoom"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="值班员" prop="leader">
                <el-input v-model="addModel.leader"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="备注" prop="lookText">
                <el-input
                  type="textarea"
                  v-model="addModel.lookText"
                ></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { addApi, listApi } from "@/api/look.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      tableHeight: 0,
      addModel: {
        type: "",
        lookId: "",
        lookTime: "",
        userName: "",
        phone: "",
        lookName: "",
        lookRoom: "",
        leader: "",
        lookText: "",
      },
      rules: {
        lookTime: [
          {
            trigger: "blur",
            required: true,
            message: "来访时间",
          },
        ],
        userName: [
          {
            trigger: "blur",
            required: true,
            message: "来访人姓名",
          },
        ],
        phone: [
          {
            trigger: "blur",
            required: true,
            message: "来访人电话",
          },
        ],
        lookName: [
          {
            trigger: "blur",
            required: true,
            message: "被访人姓名",
          },
        ],
        lookRoom: [
          {
            trigger: "blur",
            required: true,
            message: "被访人宿舍",
          },
        ],
        leader: [
          {
            trigger: "blur",
            required: true,
            message: "值班员",
          },
        ],
      },
      addDialog: {
        title: "",
        height: 230,
        width: 680,
        visible: false,
      },
      searchModel: {
        lookRoom: "",
        userName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      tableList: [],
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  methods: {
    currentChange(val) {
      this.searchModel.currentPage = val;
      this.getList();
    },
    sizeChange(val) {
      this.searchModel.pageSize = val;
      this.getList();
    },
    deleteBtn(row) {},
    editBtn(row) {},
    //列表查询
    async getList() {
      let res = await listApi(this.searchModel);
      if (res && res.code == 200) {
        console.log(res);
        this.tableList = res.data.records;
        this.searchModel.total = res.data.total;
      }
    },
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.getList();
            this.addDialog.visible = false;
          }
        }
      });
    },
    onClose() {
      this.addDialog.visible = false;
    },
    addBtn() {
      this.$resetForm("addForm", this.addModel);
      //弹框属性
      this.addDialog.title = "新增来访";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    resetBtn() {
      this.searchModel.lookRoom = "";
      this.searchModel.userName = "";
      this.searchModel.currentPage = 1;
      this.getList();
    },
    searchBtn() {
      this.getList();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```







#### 第109讲 来访编辑、删除对接

##### 1、api/look.js添加editApi()和deleteApi()方法

```js
import http from "@/utils/http";
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/look",parm)
}
//列表
export const listApi = async(parm)=>{
    return await http.get("/api/look/list",parm)
}
//编辑
export const editApi = async(parm)=>{
    return await http.put("/api/look",parm)
}
//删除
export const deleteApi = async(parm)=>{
    return await http.delete("/api/look",parm)
}
```

##### 2、页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchModel.userName"
          placeholder="请输入来访人姓名"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.lookRoom"
          placeholder="请输入被访人宿舍"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 列表查询 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="lookTime" label="来访时间"></el-table-column>
      <el-table-column prop="userName" label="来访人姓名"></el-table-column>
      <el-table-column prop="phone" label="来访人电话"></el-table-column>
      <el-table-column prop="lookName" label="被访人姓名"></el-table-column>
      <el-table-column prop="lookRoom" label="被访宿舍"></el-table-column>
      <el-table-column prop="leader" label="值班人"></el-table-column>
      <el-table-column prop="lookText" label="备注"></el-table-column>
      <el-table-column label="操作" align="center" width="220">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchModel.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchModel.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchModel.total"
      background
    >
    </el-pagination>

    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="100px"
          :inline="false"
          size="small"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="lookTime" label="来访时间">
                <el-date-picker
                  value-format="yyyy-MM-dd HH:mm:ss"
                  v-model="addModel.lookTime"
                  type="datetime"
                  placeholder="选择日期时间"
                >
                </el-date-picker>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="来访人姓名" prop="userName">
                <el-input v-model="addModel.userName"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="来访人电话" prop="phone">
                <el-input v-model="addModel.phone"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="被访人姓名" prop="lookName">
                <el-input v-model="addModel.lookName"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="被访宿舍" prop="lookRoom">
                <el-input v-model="addModel.lookRoom"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="值班员" prop="leader">
                <el-input v-model="addModel.leader"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="备注" prop="lookText">
                <el-input
                  type="textarea"
                  v-model="addModel.lookText"
                ></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { addApi, listApi, editApi, deleteApi } from "@/api/look.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      tableHeight: 0,
      addModel: {
        type: "",
        lookId: "",
        lookTime: "",
        userName: "",
        phone: "",
        lookName: "",
        lookRoom: "",
        leader: "",
        lookText: "",
      },
      rules: {
        lookTime: [
          {
            trigger: "blur",
            required: true,
            message: "来访时间",
          },
        ],
        userName: [
          {
            trigger: "blur",
            required: true,
            message: "来访人姓名",
          },
        ],
        phone: [
          {
            trigger: "blur",
            required: true,
            message: "来访人电话",
          },
        ],
        lookName: [
          {
            trigger: "blur",
            required: true,
            message: "被访人姓名",
          },
        ],
        lookRoom: [
          {
            trigger: "blur",
            required: true,
            message: "被访人宿舍",
          },
        ],
        leader: [
          {
            trigger: "blur",
            required: true,
            message: "值班员",
          },
        ],
      },
      addDialog: {
        title: "",
        height: 230,
        width: 680,
        visible: false,
      },
      searchModel: {
        lookRoom: "",
        userName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      tableList: [],
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  methods: {
    currentChange(val) {
      this.searchModel.currentPage = val;
      this.getList();
    },
    sizeChange(val) {
      this.searchModel.pageSize = val;
      this.getList();
    },
    async deleteBtn(row) {
      const confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteApi({
          lookId: row.lookId,
        });
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          this.getList();
        }
      }
    },
    editBtn(row) {
      this.$resetForm("addForm", this.addModel);
      this.$objCoppy(row, this.addModel);
      //弹框属性
      this.addDialog.title = "编辑来访";
      this.addDialog.visible = true;
      this.addModel.type = "1";
    },
    //列表查询
    async getList() {
      let res = await listApi(this.searchModel);
      if (res && res.code == 200) {
        console.log(res);
        this.tableList = res.data.records;
        this.searchModel.total = res.data.total;
      }
    },
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.getList();
            this.addDialog.visible = false;
          }
        }
      });
    },
    onClose() {
      this.addDialog.visible = false;
    },
    addBtn() {
      this.$resetForm("addForm", this.addModel);
      //弹框属性
      this.addDialog.title = "新增来访";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    resetBtn() {
      this.searchModel.lookRoom = "";
      this.searchModel.userName = "";
      this.searchModel.currentPage = 1;
      this.getList();
    },
    searchBtn() {
      this.getList();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```









#### 第110讲 公告管理模块接口开发

##### 1、时间转换

```js
@JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss",timezone = "GMT+8")
```

##### 2、数据库脚本

```js
drop table if exists sys_notice;

/*==============================================================*/
/* Table: sys_notice                                            */
/*==============================================================*/
create table sys_notice
(
   notice_id            int not null auto_increment comment '主键',
   notice_title         varchar(128) comment '公告标题',
   notice_text          text comment '公告内容',
   create_time          datetime comment '创建时间',
   primary key (notice_id)
);

```

##### 3、新建实体类

```js
package com.itmk.web.sys_notice.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import com.fasterxml.jackson.annotation.JsonFormat;
import lombok.Data;

import java.util.Date;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
@TableName("sys_notice")
public class SysNotice {
    @TableId(type = IdType.AUTO)
    private Long noticeId;
    private String noticeTitle;
    private String noticeText;
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss",timezone = "GMT+8")
    private Date createTime;
}

```

```js
package com.itmk.web.sys_notice.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class NoticeParm {
    private Long currentPage;
    private Long pageSize;
    private String noticeTitle;
}

```

##### 4、新建mapper层

```js
package com.itmk.web.sys_notice.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.sys_notice.entity.SysNotice;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface SysNoticeMapper extends BaseMapper<SysNotice> {
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.sys_notice.mapper.SysNoticeMapper">

</mapper>
```

##### 5、service层

```js
package com.itmk.web.sys_notice.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.sys_notice.entity.SysNotice;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface SysNoticeService extends IService<SysNotice> {
}

```

实现类

```js
package com.itmk.web.sys_notice.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.sys_notice.entity.SysNotice;
import com.itmk.web.sys_notice.mapper.SysNoticeMapper;
import com.itmk.web.sys_notice.service.SysNoticeService;
import org.springframework.stereotype.Service;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class SysNoticeServiceImpl extends ServiceImpl<SysNoticeMapper, SysNotice> implements SysNoticeService {
}

```

##### 6、控制器

```js
package com.itmk.web.sys_notice.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.sys_notice.entity.NoticeParm;
import com.itmk.web.sys_notice.entity.SysNotice;
import com.itmk.web.sys_notice.service.SysNoticeService;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/notice")
public class SysNoticeController {
    @Autowired
    private SysNoticeService sysNoticeService;
    //新增
    @PostMapping
    public ResultVo add(@RequestBody SysNotice sysNotice){
        boolean save = sysNoticeService.save(sysNotice);
        if(save){
            return ResultUtils.success("新增成功");
        }
        return ResultUtils.error("新增失败!");
    }
    //编辑
    @PutMapping
    public ResultVo edit(@RequestBody SysNotice sysNotice){
        boolean save = sysNoticeService.updateById(sysNotice);
        if(save){
            return ResultUtils.success("编辑成功");
        }
        return ResultUtils.error("编辑失败!");
    }

    //删除
    @DeleteMapping("/{noticeId}")
    public ResultVo delete(@PathVariable("noticeId") Long noticeId){
        boolean b = sysNoticeService.removeById(noticeId);
        if(b){
            return ResultUtils.success("删除成功");
        }
        return ResultUtils.error("删除失败!");
    }
    //列表查询
    @GetMapping("/list")
    public ResultVo list(NoticeParm parm){
        //构造分页对象
        IPage<SysNotice> page = new Page<>(parm.getCurrentPage(),parm.getPageSize());
        //查询条件
        QueryWrapper<SysNotice> query = new QueryWrapper<>();
        if(StringUtils.isNotEmpty(parm.getNoticeTitle())){
            query.lambda().like(SysNotice::getNoticeTitle,parm.getNoticeTitle());
        }
        query.lambda().orderByDesc(SysNotice::getCreateTime);
        IPage<SysNotice> list = sysNoticeService.page(page, query);
        return ResultUtils.success("查询成功",list);
    }
}

```







#### 第111讲 新增公告页面制作对接

##### 1、api下新建notice.js

```js
import http from "@/utils/http";
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/notice",parm)
}
```

##### 2、view下新建notice/index.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchModel.noticeTitle"
          placeholder="请输入公告标题"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="noticeTitle" label="标题">
            <el-input v-model="addModel.noticeTitle"></el-input>
          </el-form-item>
          <el-form-item prop="noticeText" label="公告内容">
            <el-input type="textarea" v-model="addModel.noticeText"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { addApi } from "@/api/notice.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      rules: {
        noticeTitle: [
          {
            trigger: "blur",
            message: "请输入公告标题",
            required: true,
          },
        ],
        noticeText: [
          {
            trigger: "blur",
            message: "请输入公告内容",
            required: true,
          },
        ],
      },
      addModel: {
        type: "",
        noticeId: "",
        noticeTitle: "",
        noticeText: "",
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 180,
        width: 650,
        visible: false,
      },
      searchModel: {
        currentPage: 1,
        pageSize: 10,
        noticeTitle: "",
      },
    };
  },
  methods: {
    onConfirm() {
      this.$refs.addForm.validate(async(valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.addDialog.visible = false;
          }
        }
      });
    },
    onClose() {
      this.addDialog.visible = false;
    },
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置弹框属性
      this.addDialog.title = "新增公告";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    searchBtn() {},
    resetBtn() {},
  },
};
</script>

<style lang="scss" scoped>
</style>
```







#### 第112讲 公告列表制作对接

##### 1、api/notice.js添加listApi()方法

```js
import http from "@/utils/http";
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/notice",parm)
}
//列表
export const listApi = async(parm)=>{
    return await http.get("/api/notice/list",parm)
}
```

##### 2、页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchModel.noticeTitle"
          placeholder="请输入公告标题"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="noticeTitle" label="标题"></el-table-column>
      <el-table-column prop="noticeText" label="内容"></el-table-column>
      <el-table-column prop="createTime" label="发布时间"></el-table-column>
      <el-table-column label="操作" align="center" width="220">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchModel.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchModel.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchModel.total"
      background
    >
    </el-pagination>

    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="noticeTitle" label="标题">
            <el-input v-model="addModel.noticeTitle"></el-input>
          </el-form-item>
          <el-form-item prop="noticeText" label="公告内容">
            <el-input type="textarea" v-model="addModel.noticeText"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { addApi, listApi } from "@/api/notice.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      tableHeight: 0,
      tableList: [],
      rules: {
        noticeTitle: [
          {
            trigger: "blur",
            message: "请输入公告标题",
            required: true,
          },
        ],
        noticeText: [
          {
            trigger: "blur",
            message: "请输入公告内容",
            required: true,
          },
        ],
      },
      addModel: {
        type: "",
        noticeId: "",
        noticeTitle: "",
        noticeText: "",
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 180,
        width: 650,
        visible: false,
      },
      searchModel: {
        currentPage: 1,
        pageSize: 10,
        noticeTitle: "",
        total: 0,
      },
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  methods: {
    currentChange(val) {
      this.searchModel.currentPage = val;
      this.getList();
    },
    sizeChange(val) {
      this.searchModel.pageSize = val;
      this.getList();
    },
    deleteBtn(row) {},
    editBtn(row) {},
    async getList() {
      let res = await listApi(this.searchModel);
      if (res && res.code == 200) {
        this.tableList = res.data.records;
        this.searchModel.total = res.data.total;
      }
    },
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.getList()
            this.addDialog.visible = false;
          }
        }
      });
    },
    onClose() {
      this.addDialog.visible = false;
    },
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置弹框属性
      this.addDialog.title = "新增公告";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    searchBtn() {
      this.getList();
    },
    resetBtn() {
      this.searchModel.noticeTitle = "";
      this.searchModel.currentPage = 1;
      this.getList();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第113 公告编辑、删除对接

##### 1、api/notice.js添加editApi()和deleteApi()方法

```js
import http from "@/utils/http";
//新增
export const addApi = async(parm)=>{
    return await http.post("/api/notice",parm)
}
//列表
export const listApi = async(parm)=>{
    return await http.get("/api/notice/list",parm)
}
//编辑
export const editApi = async(parm)=>{
    return await http.put("/api/notice",parm)
}
//删除
export const deleteApi = async(parm)=>{
    return await http.delete("/api/notice",parm)
}
```

##### 2、页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchModel.noticeTitle"
          placeholder="请输入公告标题"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="noticeTitle" label="标题"></el-table-column>
      <el-table-column prop="noticeText" label="内容"></el-table-column>
      <el-table-column prop="createTime" label="发布时间"></el-table-column>
      <el-table-column label="操作" align="center" width="220">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchModel.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchModel.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchModel.total"
      background
    >
    </el-pagination>

    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="noticeTitle" label="标题">
            <el-input v-model="addModel.noticeTitle"></el-input>
          </el-form-item>
          <el-form-item prop="noticeText" label="公告内容">
            <el-input type="textarea" v-model="addModel.noticeText"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { addApi, listApi, editApi, deleteApi } from "@/api/notice.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      tableHeight: 0,
      tableList: [],
      rules: {
        noticeTitle: [
          {
            trigger: "blur",
            message: "请输入公告标题",
            required: true,
          },
        ],
        noticeText: [
          {
            trigger: "blur",
            message: "请输入公告内容",
            required: true,
          },
        ],
      },
      addModel: {
        type: "",
        noticeId: "",
        noticeTitle: "",
        noticeText: "",
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 180,
        width: 650,
        visible: false,
      },
      searchModel: {
        currentPage: 1,
        pageSize: 10,
        noticeTitle: "",
        total: 0,
      },
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  methods: {
    currentChange(val) {
      this.searchModel.currentPage = val;
      this.getList();
    },
    sizeChange(val) {
      this.searchModel.pageSize = val;
      this.getList();
    },
    async deleteBtn(row) {
      const confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteApi({
          noticeId: row.noticeId,
        });
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          this.getList();
        }
      }
    },
    editBtn(row) {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      this.$objCoppy(row, this.addModel);
      //设置弹框属性
      this.addDialog.title = "编辑公告";
      this.addDialog.visible = true;
      this.addModel.type = "1";
    },
    async getList() {
      let res = await listApi(this.searchModel);
      if (res && res.code == 200) {
        this.tableList = res.data.records;
        this.searchModel.total = res.data.total;
      }
    },
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.getList();
            this.addDialog.visible = false;
          }
        }
      });
    },
    onClose() {
      this.addDialog.visible = false;
    },
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置弹框属性
      this.addDialog.title = "新增公告";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    searchBtn() {
      this.getList();
    },
    resetBtn() {
      this.searchModel.noticeTitle = "";
      this.searchModel.currentPage = 1;
      this.getList();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```







#### 第114 首页布局讲解

##### 1、头部修改颜色

```js
background: #009688;
头像 commit('SET_AVATAR', require('@/assets/images/login_bg.png'))
```

##### 2、安装echarts

```js
官网  https://echarts.apache.org/zh/index.html

npm install echarts -S
```

##### 3、在main.js中引入

```js
import * as echarts from 'echarts';
Vue.prototype.$echarts = echarts
```

##### 4、首页布局

```js
<template>
  <el-main>
    <!-- 管理员统计 -->
    <el-row
      :gutter="20"
      type="flex"
      class="row-bg"
      justify="center"
      style="margin-bottom: 80px"
    >
      <el-col :span="6">
        <div class="show-header" style="background: rgb(45, 183, 245)">
          <div class="show-num">0</div>
          <div class="bottom-text">学生总数</div>
        </div>
      </el-col>
      <el-col :span="6">
        <div class="show-header" style="background: rgb(237, 64, 20)">
          <div class="show-num">0</div>
          <div class="bottom-text">班级总数</div>
        </div>
      </el-col>
      <el-col :span="6">
        <div class="show-header">
          <div class="show-num">0</div>
          <div class="bottom-text">待维修数</div>
        </div>
      </el-col>
      <el-col :span="6">
        <div class="show-header" style="background: rgb(255, 153, 0)">
          <div class="show-num">0</div>
          <div class="bottom-text">楼宇总数</div>
        </div>
      </el-col>
    </el-row>
    <div style="display: flex">
      <div id="main1" style="width: 800px; height: 300px; flex-grow: 1"></div>
    </div>
    <el-card class="box-card" style="margin-top: 30px">
      <div slot="header" class="clearfix">
        <span style="color: #000000; font-weight: 600">公告列表</span>
      </div>
      <div class="text item">
        <span style="font-weight: 600; font-size: 14px">放假通知</span
        ><span style="margin-left: 30px; font-size: 14px"
          >放假时间为 2022-01-10放到 2022-3-03-01，大家关好门窗。</span
        >
        <el-divider></el-divider>
      </div>
    </el-card>
  </el-main>
</template>

<script>
export default {
  mounted() {
    this.myecharts1();
  },
  methods: {
    myecharts1() {
      var myChart = this.$echarts.init(document.getElementById("main1"));
      // 指定图表的配置项和数据
      var option = {
        title: {
          text: "学生统计",
        },
        tooltip: {},
        legend: {
          data: ["分类"],
        },
        xAxis: {
          data: ["1栋", "2栋", "3栋", "4栋", "5栋", "6栋","7栋","8栋","9栋","10栋"],
        },
        yAxis: {},
        series: [
          {
            name: "销量",
            type: "bar",
            data: [5, 20, 36, 10, 10, 20,7,8,9,10],
          },
        ],
      };
      // 使用刚指定的配置项和数据显示图表。
      myChart.setOption(option);
    },
  },
};
</script>


<style lang="scss" scoped>
.bottom-text {
  bottom: 0;
  width: 100%;
  background: rgba(0, 0, 0, 0.1);
  height: 25px;
  line-height: 25px;
  text-align: center;
  position: absolute;
  font-weight: 600;
}
.show-header {
  background: #00c0ef;
  color: #fff;
  height: 80px;
  border-radius: 5px;
  position: relative;
}
.show-num {
  font-size: 38px;
  font-weight: 600;
  padding: 5px;
}
</style>

```







#### 第115讲 首页数据对接1

##### 1、新建实体类

```js
package com.itmk.web.sys_user.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class TotalVo {
    private Integer stuCount;
    private Integer classCount;
    private Integer repairCount;
    private Integer buildCount;
}

```

##### 2、新建SysHomeController控制器

```js
package com.itmk.web.sys_user.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.drom_build.service.DromBuildService;
import com.itmk.web.drom_repair.entity.DromRepair;
import com.itmk.web.drom_repair.service.DromRepairService;
import com.itmk.web.school_class.service.SchoolClassService;
import com.itmk.web.school_student.service.SchoolStudentService;
import com.itmk.web.sys_user.entity.TotalVo;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@RestController
@RequestMapping("/api/home")
public class SysHomeController {
    @Autowired
    private SchoolClassService schoolClassService;
    @Autowired
    private SchoolStudentService schoolStudentService;
    @Autowired
    private DromRepairService dromRepairService;
    @Autowired
    private DromBuildService dromBuildService;

    @GetMapping("/getTotal")
    public ResultVo getTotal(){
        TotalVo vo = new TotalVo();
        //班级总数
        int count = schoolClassService.count();
        vo.setClassCount(count);
        //学生
        int count1 = schoolStudentService.count();
        vo.setStuCount(count1);
        //待维修
        QueryWrapper<DromRepair> query = new QueryWrapper<>();
        query.lambda().eq(DromRepair::getStatus,"0");
        int count2 = dromRepairService.count(query);
        vo.setRepairCount(count2);
        //；楼宇
        int count3 = dromBuildService.count();
        vo.setBuildCount(count3);
        ;return ResultUtils.success("查询成功",vo);
    }
}

```

##### 3、api/user.js添加getTotalApi()方法

```js
//首页统计
export const getTotalApi = async()=>{
  return await http.get("/api/home/getTotal",null)
}
```

##### 4、首页页面

```js
<template>
  <el-main>
    <!-- 统计 -->
    <el-row
      :gutter="20"
      type="flex"
      class="row-bg"
      justify="center"
      style="margin-bottom: 80px"
    >
      <el-col :span="6">
        <div class="show-header" style="background: rgb(45, 183, 245)">
          <div class="show-num">{{stuCount}}</div>
          <div class="bottom-text">学生总数</div>
        </div>
      </el-col>
      <el-col :span="6">
        <div class="show-header" style="background: rgb(237, 64, 20)">
          <div class="show-num">{{classCount}}</div>
          <div class="bottom-text">班级总数</div>
        </div>
      </el-col>
      <el-col :span="6">
        <div class="show-header">
          <div class="show-num">{{repairCount}}</div>
          <div class="bottom-text">待维修数</div>
        </div>
      </el-col>
      <el-col :span="6">
        <div class="show-header" style="background: rgb(255, 153, 0)">
          <div class="show-num">{{buildCount}}</div>
          <div class="bottom-text">楼宇总数</div>
        </div>
      </el-col>
    </el-row>
    <!-- echarts -->
    <div style="display: flex">
      <!-- 为 ECharts 准备一个定义了高宽的 DOM 容器 -->
      <div id="main" style="width: 800px; height: 300px; flex-grow: 1"></div>
    </div>
    <el-card class="box-card" style="margin-top: 30px">
      <div slot="header" class="clearfix">
        <span style="color: #000000; font-weight: 600">公告列表</span>
      </div>
      <div v-for="(item, index) in noticeList" :key="index" class="text item">
        <span style="font-weight: 600; font-size: 14px">{{
          item.noticeTitle
        }}</span>
        <span style="margin-left: 30px; font-size: 14px">{{
          item.noticeText
        }}</span>
        <span style="margin-left: 30px; font-size: 14px">{{
          item.createTime
        }}</span>
        <el-divider></el-divider>
      </div>
    </el-card>
  </el-main>
</template>

<script>
import { getTopListApi } from "@/api/notice.js";
import { getTotalApi } from "@/api/user.js";
export default {
  data() {
    return {
      noticeList: [],
      buildCount: 0,
      classCount: 0,
      repairCount: 0,
      stuCount: 0,
    };
  },
  mounted() {
    this.getTotal();
    this.getTopList();
    this.myecharts1();
  },
  methods: {
    //获取公告列表
    async getTotal() {
      let res = await getTotalApi();
      if (res && res.code == 200) {
        console.log(res);
        this.classCount = res.data.classCount
        this.buildCount = res.data.buildCount
        this.repairCount = res.data.repairCount
        this.stuCount = res.data.stuCount
      }
    },
    //获取公告列表
    async getTopList() {
      let res = await getTopListApi();
      if (res && res.code == 200) {
        this.noticeList = res.data;
        console.log(this.noticeList);
      }
    },
    myecharts1() {
      //初始化echarts
      var myChart = this.$echarts.init(document.getElementById("main"));
      // 指定图表的配置项和数据
      var option = {
        title: {
          text: "学生统计",
        },
        tooltip: {},
        legend: {
          data: ["分类"],
        },
        xAxis: {
          data: [
            "1栋",
            "2栋",
            "3栋",
            "4栋",
            "5栋",
            "6栋",
            "7栋",
            "8栋",
            "9栋",
            "10栋",
          ],
        },
        yAxis: {},
        series: [
          {
            name: "销量",
            type: "bar",
            data: [5, 20, 36, 10, 10, 20, 7, 8, 9, 10],
          },
        ],
      };
      // 使用刚指定的配置项和数据显示图表。
      myChart.setOption(option);
    },
  },
};
</script>


<style lang="scss" scoped>
.bottom-text {
  bottom: 0;
  width: 100%;
  background: rgba(0, 0, 0, 0.1);
  height: 25px;
  line-height: 25px;
  text-align: center;
  position: absolute;
  font-weight: 600;
}
.show-header {
  background: #00c0ef;
  color: #fff;
  height: 80px;
  border-radius: 5px;
  position: relative;
}
.show-num {
  font-size: 38px;
  font-weight: 600;
  padding: 5px;
}
</style>

```









#### 第116讲 首页数据对接2

##### 1、新建实体类

```js
package com.itmk.web.drom_build.entity;

import lombok.Data;

import java.util.ArrayList;
import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class BuildEcharts {
    private List<String> names = new ArrayList<>();
    private List<Integer> counts = new ArrayList<>();
}

```

```js
package com.itmk.web.drom_build.entity;

import lombok.Data;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Data
public class BuildVo {
    private String buildName;
    private Integer stuCount;
}

```

##### 2、DromBuildMapper接口添加getListBuild()方法

```js
package com.itmk.web.drom_build.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.drom_build.entity.BuildVo;
import com.itmk.web.drom_build.entity.DromBuild;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface DromBuildMapper extends BaseMapper<DromBuild> {
    List<BuildVo> getListBuild();
}

```

映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.drom_build.mapper.DromBuildMapper">
    <select id="getListBuild" resultType="com.itmk.web.drom_build.entity.BuildVo">
        select db.build_name,count(sb.stu_id)  as stu_count from drom_build as db
        inner join drom_storey as ds on ds.build_id = db.build_id
        inner join dorm_room as dm on dm.storey_id = ds.storey_id
        inner join drom_room_bed as drm on drm.room_id = dm.room_id
        inner join select_bed as sb on sb.bed_id = drm.bed_id
        group by db.build_id,db.build_name
    </select>
</mapper>
```

##### 3、DromBuildService接口添加getListBuild()方法

```js
package com.itmk.web.drom_build.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.drom_build.entity.BuildEcharts;
import com.itmk.web.drom_build.entity.BuildVo;
import com.itmk.web.drom_build.entity.DromBuild;

import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
public interface DromBuildService extends IService<DromBuild> {
    //新增
    void addBuild(DromBuild dromBuild);
    BuildEcharts getListBuild();
}

```

实现类

```js
package com.itmk.web.drom_build.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.drom_build.entity.BuildEcharts;
import com.itmk.web.drom_build.entity.BuildVo;
import com.itmk.web.drom_build.entity.DromBuild;
import com.itmk.web.drom_build.mapper.DromBuildMapper;
import com.itmk.web.drom_build.service.DromBuildService;
import com.itmk.web.drom_storey.entity.DromStorey;
import com.itmk.web.drom_storey.service.DromStoreyService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.List;

/**
 * @Author java实战基地
 * @Version 3501754007
 */
@Service
public class DromBuildServiceImpl extends ServiceImpl<DromBuildMapper, DromBuild> implements DromBuildService {
    @Autowired
    private DromStoreyService dromStoreyService;

    @Override
    @Transactional
    public void addBuild(DromBuild dromBuild) {
        //新增栋数
        int insert = this.baseMapper.insert(dromBuild);
        //新增层数
        if (insert > 0) {
            String[] storey = {"一层", "二层", "三层", "四层", "五层", "六层", "七层", "八层", "九层", "十层", "十一层", "十二层"};
            //存放构建的层数
            List<DromStorey> list = new ArrayList<>();
            for (int i = 0; i < dromBuild.getBuildStorey(); i++) {
                DromStorey dromStorey = new DromStorey();
                dromStorey.setBuildId(dromBuild.getBuildId());
                dromStorey.setStoreyName(storey[i]);
                dromStorey.setOrderNum(i + 1);
                list.add(dromStorey);
            }
            //插入层数表
            dromStoreyService.addDrom(list);
        }
    }

    @Override
    public BuildEcharts getListBuild() {
        BuildEcharts echarts = new BuildEcharts();
        List<BuildVo> listBuild = this.baseMapper.getListBuild();
        List<String> names = new ArrayList<>();
        List<Integer> counts = new ArrayList<>();
        if (listBuild.size() > 0) {
            for (int i = 0; i < listBuild.size(); i++) {
                names.add(listBuild.get(i).getBuildName());
                counts.add(listBuild.get(i).getStuCount());
            }
        }
        echarts.setCounts(counts);
        echarts.setNames(names);
        return echarts;
    }
}

```

##### 4、DromBuildController控制器添加getTotal()方法

```js
	//获取首页统计
    @GetMapping("/getTotal")
    public ResultVo getTotal(){
        BuildEcharts listBuild = dromBuildService.getListBuild();
        return ResultUtils.success("查询成功",listBuild);
    }
```

##### 5、api/build.js添加getTotalBuildApi()方法

```js
//获取首页统计
export const getTotalBuildApi = async()=>{
    return await http.get("/api/build/getTotal",null)
}
```



##### 6、首页页面

```js
<template>
  <el-main>
    <!-- 统计 -->
    <el-row
      :gutter="20"
      type="flex"
      class="row-bg"
      justify="center"
      style="margin-bottom: 80px"
    >
      <el-col :span="6">
        <div class="show-header" style="background: rgb(45, 183, 245)">
          <div class="show-num">{{ stuCount }}</div>
          <div class="bottom-text">学生总数</div>
        </div>
      </el-col>
      <el-col :span="6">
        <div class="show-header" style="background: rgb(237, 64, 20)">
          <div class="show-num">{{ classCount }}</div>
          <div class="bottom-text">班级总数</div>
        </div>
      </el-col>
      <el-col :span="6">
        <div class="show-header">
          <div class="show-num">{{ repairCount }}</div>
          <div class="bottom-text">待维修数</div>
        </div>
      </el-col>
      <el-col :span="6">
        <div class="show-header" style="background: rgb(255, 153, 0)">
          <div class="show-num">{{ buildCount }}</div>
          <div class="bottom-text">楼宇总数</div>
        </div>
      </el-col>
    </el-row>
    <!-- echarts -->
    <div style="display: flex">
      <!-- 为 ECharts 准备一个定义了高宽的 DOM 容器 -->
      <div id="main" style="width: 800px; height: 300px; flex-grow: 1"></div>
    </div>
    <el-card class="box-card" style="margin-top: 30px">
      <div slot="header" class="clearfix">
        <span style="color: #000000; font-weight: 600">公告列表</span>
      </div>
      <div v-for="(item, index) in noticeList" :key="index" class="text item">
        <span style="font-weight: 600; font-size: 14px">{{
          item.noticeTitle
        }}</span>
        <span style="margin-left: 30px; font-size: 14px">{{
          item.noticeText
        }}</span>
        <span style="margin-left: 30px; font-size: 14px">{{
          item.createTime
        }}</span>
        <el-divider></el-divider>
      </div>
    </el-card>
  </el-main>
</template>

<script>
import { getTopListApi } from "@/api/notice.js";
import { getTotalApi } from "@/api/user.js";
import { getTotalBuildApi } from "@/api/build.js";
export default {
  data() {
    return {
      noticeList: [],
      buildCount: 0,
      classCount: 0,
      repairCount: 0,
      stuCount: 0,
    };
  },
  mounted() {
    this.getTotal();
    this.getTopList();
    this.myecharts1();
  },
  methods: {
    //获取公告列表
    async getTotal() {
      let res = await getTotalApi();
      if (res && res.code == 200) {
        console.log(res);
        this.classCount = res.data.classCount;
        this.buildCount = res.data.buildCount;
        this.repairCount = res.data.repairCount;
        this.stuCount = res.data.stuCount;
      }
    },
    //获取公告列表
    async getTopList() {
      let res = await getTopListApi();
      if (res && res.code == 200) {
        this.noticeList = res.data;
        console.log(this.noticeList);
      }
    },
    async myecharts1() {
      //初始化echarts
      var myChart = this.$echarts.init(document.getElementById("main"));
      // 指定图表的配置项和数据
      var option = {
        title: {
          text: "学生统计",
        },
        tooltip: {},
        legend: {
          data: ["分类"],
        },
        xAxis: {
          data: [],
        },
        yAxis: {},
        series: [
          {
            name: "销量",
            type: "bar",
            data: [],
          },
        ],
      };
      //动态获取数据
      let res = await getTotalBuildApi();
      console.log(res)
      if (res && res.code == 200) {
        option.xAxis.data = res.data.names;
        option.series[0].data = res.data.counts;
      }
      // 使用刚指定的配置项和数据显示图表。
      myChart.setOption(option);
    },
  },
};
</script>


<style lang="scss" scoped>
.bottom-text {
  bottom: 0;
  width: 100%;
  background: rgba(0, 0, 0, 0.1);
  height: 25px;
  line-height: 25px;
  text-align: center;
  position: absolute;
  font-weight: 600;
}
.show-header {
  background: #00c0ef;
  color: #fff;
  height: 80px;
  border-radius: 5px;
  position: relative;
}
.show-num {
  font-size: 38px;
  font-weight: 600;
  padding: 5px;
}
</style>

```









#### 第117讲 按钮权限讲解

##### 1、把vue-element-admin的src下的directive复制到项目src目录下

##### 2、把vue-element-admin的utils下的permission.js复制到项目的utils下

##### 3、main.js里面引入

```js
import permission from '@/directive/permission/index.js' // 权限判断指令
import checkPermission from '@/utils/permission' // 权限判断函数

Vue.directive('permission',permission)
Vue.prototype.$checkPermission = checkPermission
```

##### 4、使用

```js
v-permission="['sys:sysNotice:add']"

v-if="$checkPermission(['sys:sysNotice:edit','sys:sysNotice:delete'])"
```





#### 第118讲 重置密码功能

##### 1、SchoolStudentController添加resetPassword()方法

```js
@PostMapping("/resetPassword")
    public ResultVo resetPassword(@RequestBody SchoolStudent schoolStudent){
        schoolStudent.setPassword(DigestUtils.md5DigestAsHex(schoolStudent.getPassword().getBytes()));
        boolean b = schoolStudentService.updateById(schoolStudent);
        if(b){
            return ResultUtils.success("密码重置成功!");
        }
        return ResultUtils.error("密码重置失败!");
    }
```

##### 2、api/student.js添加resetPasswordApi()方法

```js
//重置密码
export const resetPasswordApi = async(parm)=>{
    return await http.post("/api/student/resetPassword",parm)
}
```

##### 3、页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-select
          @change="serchCollogeChange"
          style="width: 100%"
          v-model="searchModel.collageId"
          placeholder="请选择学院"
        >
          <el-option
            v-for="item in searchCollogeList"
            :key="item.collageId"
            :label="item.collageName"
            :value="item.collageId"
          >
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-select
          @change="selectSearchMajorChangeEdit"
          style="width: 100%"
          v-model="searchModel.majorId"
          placeholder="请选择专业"
        >
          <el-option
            v-for="item in searchMajorList"
            :key="item.majorId"
            :label="item.majorName"
            :value="item.majorId"
          >
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-select
          style="width: 100%"
          v-model="searchModel.classId"
          placeholder="请选择专业"
        >
          <el-option
            v-for="item in searchClassList"
            :key="item.classId"
            :label="item.className"
            :value="item.classId"
          >
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-input
          v-model="searchModel.stuName"
          placeholder="请输入学生姓名"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button icon="el-icon-close" @click="resetBtn" style="color: #ff7670"
          >重置</el-button
        >
        <el-button
          v-permission="['sys:stuList:add']"
          type="primary"
          icon="el-icon-plus"
          @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格数据 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column label="学生姓名" prop="stuName"></el-table-column>
      <el-table-column label="学号" prop="stuNum"></el-table-column>
      <el-table-column label="性别" prop="stuName">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.sex == '0'" type="danger" size="small"
            >男</el-tag
          >
          <el-tag v-if="scope.row.sex == '1'" type="blue" size="small"
            >女</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column label="学生电话" prop="phone"></el-table-column>
      <el-table-column label="身份证号" prop="idCard"></el-table-column>
      <el-table-column label="班级" prop="className"></el-table-column>
      <el-table-column label="专业" prop="majorName"></el-table-column>
      <el-table-column label="学院" prop="collageName"></el-table-column>
      <el-table-column
        v-if="$checkPermission(['sys:stuList:edit', 'sys:stuList:delete'])"
        label="操作"
        align="center"
        width="300"
      >
        <template slot-scope="scope">
          <el-button
            v-permission="['sys:stuList:edit']"
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            v-permission="['sys:stuList:reset']"
            icon="el-icon-edit"
            type="success"
            size="small"
            @click="resetPasBtn(scope.row)"
            >重置密码</el-button
          >
          <el-button
            v-permission="['sys:stuList:delete']"
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchModel.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchModel.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchModel.total"
      background
    >
    </el-pagination>

    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :width="addDialog.width"
      :height="addDialog.height"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="collageId" label="所属学院">
                <el-select
                  @change="selectChange"
                  style="width: 100%"
                  v-model="addModel.collageId"
                  placeholder="请选择学院"
                >
                  <el-option
                    v-for="item in collogeList"
                    :key="item.collageId"
                    :label="item.collageName"
                    :value="item.collageId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="majorId" label="所属专业">
                <el-select
                  @change="selectMajorChange"
                  style="width: 100%"
                  v-model="addModel.majorId"
                  placeholder="请选择专业"
                >
                  <el-option
                    v-for="item in majorList"
                    :key="item.majorId"
                    :label="item.majorName"
                    :value="item.majorId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="classId" label="所属班级">
                <el-select
                  style="width: 100%"
                  v-model="addModel.classId"
                  placeholder="请选择专业"
                >
                  <el-option
                    v-for="item in classList"
                    :key="item.classId"
                    :label="item.className"
                    :value="item.classId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="姓名" prop="stuName">
                <el-input v-model="addModel.stuName"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="学号" prop="stuNum">
                <el-input v-model="addModel.stuNum"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="性别" prop="sex">
                <el-radio-group v-model="addModel.sex">
                  <el-radio :label="'0'">男</el-radio>
                  <el-radio :label="'1'">女</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="身份证" prop="idCard">
                <el-input v-model="addModel.idCard"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="电话" prop="phone">
                <el-input v-model="addModel.phone"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="roleId" label="角色">
                <el-select
                  style="width: 100%"
                  v-model="addModel.roleId"
                  placeholder="请选择角色"
                >
                  <el-option
                    v-for="item in roleList"
                    :key="item.roleId"
                    :label="item.roleName"
                    :value="item.roleId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col v-if="addModel.type == '0'" :span="12" :offset="0">
              <el-form-item label="密码" prop="password">
                <el-input v-model="addModel.password"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getCollegeListApi } from "@/api/major.js";
import { getMajorListApi } from "@/api/classes.js";
import {
  getClassListApi,
  addApi,
  listApi,
  getByIdApi,
  editApi,
  deleteApi,
  getRoleListApi,
  resetPasswordApi
} from "@/api/student.js";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      searchClassList: [],
      searchMajorList: [],
      searchCollogeList: [],
      //表格高度
      tableHeight: 0,
      //表格数据
      tableList: [],
      //学院数据
      collogeList: [],
      //专业数据
      majorList: [],
      //班级数据
      classList: [],
      //表单验证规则
      rules: {
        collageId: [
          {
            trigger: "blur",
            required: true,
            message: "请选择学院",
          },
        ],
        majorId: [
          {
            trigger: "blur",
            required: true,
            message: "请选择专业",
          },
        ],
        classId: [
          {
            trigger: "blur",
            required: true,
            message: "请选择班级",
          },
        ],
        stuName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写姓名",
          },
        ],
        sex: [
          {
            trigger: "blur",
            required: true,
            message: "请选择性别",
          },
        ],
        stuNum: [
          {
            trigger: "blur",
            required: true,
            message: "请填写学号",
          },
        ],
        idCard: [
          {
            trigger: "blur",
            required: true,
            message: "请填写身份证",
          },
        ],
        phone: [
          {
            trigger: "blur",
            required: true,
            message: "请填写电话",
          },
        ],
      },
      //表单绑定的对象
      addModel: {
        type: "",
        stuId: "",
        roleId: "",
        password: "",
        classId: "",
        collageId: "",
        majorId: "",
        stuName: "",
        sex: "",
        stuNum: "",
        idCard: "",
        phone: "",
      },
      //弹框属性
      addDialog: {
        title: "",
        width: 680,
        height: 260,
        visible: false,
      },
      //搜索参数
      searchModel: {
        collageName: "",
        majorName: "",
        className: "",
        stuName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
        classId: "",
        collageId: "",
        majorId: "",
      },
      roleList: [],
    };
  },
  created() {
    this.getLsit();
    this.getRoleList();
    this.getSearchCollogeList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  methods: {
    //搜索查询学院
    async getSearchCollogeList() {
      let res = await getCollegeListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.searchCollogeList = res.data;
      }
    },
    async serchCollogeChange(val) {
      //清空数据
      this.searchModel.majorId = "";
      this.searchMajorList = [];
      this.searchModel.classId = "";
      this.searchClassList = [];
      // console.log(val);
      let res = await getMajorListApi({
        collageId: val,
      });
      if (res && res.code == 200) {
        //设置专业数据
        this.searchMajorList = res.data;
      }
    },
    async selectSearchMajorChangeEdit(val) {
      this.searchClassList = [];
      let res = await getClassListApi({
        major: val,
      });
      if (res && res.code == 200) {
        this.searchClassList = res.data;
      }
    },
    //角色列表
    async getRoleList() {
      let res = await getRoleListApi();
      if (res && res.code == 200) {
        this.roleList = res.data;
      }
    },
    //页数改变触发
    currentChange(val) {
      this.searchModel.currentPage = val;
      this.getLsit();
    },
    //页容量
    sizeChange(val) {
      this.searchModel.pageSize = val;
      this.getLsit();
    },
    //删除
    async deleteBtn(row) {
      const confrim = await this.$myconfirm("确定删除该数据吗?");
      if (confrim) {
        let res = await deleteApi({
          stuId: row.stuId,
        });
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          this.getLsit();
        }
      }
    },
    //编辑
    editBtn(row) {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //查询编辑的信息
      this.getIfById(row.stuId);
      //查询学院
      this.collogeList = [];
      this.getCollogeList();
      //设置弹框属性
      this.addDialog.title = "编辑学生";
      this.addDialog.visible = true;
      this.addModel.type = "1";
      //密码清空
      this.addModel.password = "";
    },
    //根据学生id查询学生信息
    async getIfById(stuId) {
      let res = await getByIdApi({
        stuId: stuId,
      });
      if (res && res.code == 200) {
        //设置编辑的信息
        this.$objCoppy(res.data, this.addModel);
        this.selectChangeEdit(res.data.collageId);
        this.selectMajorChangeEdit(res.data.majorId);
      }
    },
    async selectMajorChangeEdit(val) {
      this.classList = [];
      let res = await getClassListApi({
        major: val,
      });
      if (res && res.code == 200) {
        this.classList = res.data;
      }
    },
    async selectChangeEdit(val) {
      //清空数据
      this.majorList = [];
      let res = await getMajorListApi({
        collageId: val,
      });
      if (res && res.code == 200) {
        //设置专业数据
        this.majorList = res.data;
      }
    },
    //获取表格数据
    async getLsit() {
      let res = await listApi(this.searchModel);
      if (res && res.code == 200) {
        //设置表格数据
        this.tableList = res.data.records;
        this.searchModel.total = res.data.total;
      }
    },
    //专业选择事件
    async selectMajorChange(val) {
      this.addModel.classId = "";
      this.classList = [];
      let res = await getClassListApi({
        major: val,
      });
      if (res && res.code == 200) {
        this.classList = res.data;
      }
      // console.log(this.classList);
    },
    //选用选择事件,返回专业列表
    async selectChange(val) {
      //清空数据
      this.addModel.majorId = "";
      this.majorList = [];
      this.addModel.classId = "";
      this.classList = [];
      // console.log(val);
      let res = await getMajorListApi({
        collageId: val,
      });
      if (res && res.code == 200) {
        //设置专业数据
        this.majorList = res.data;
      }
    },
    //弹框确定
    onConfirm() {
      this.$refs.addForm.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            //刷新列表
            this.getLsit();
            this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    async resetPasBtn(row) {
      const conirm = await this.$myconfirm(
        "确定重置密码吗？重置之后密码为【666666】"
      );
      if (conirm) {
        let res = await resetPasswordApi({
          stuId: row.stuId,
          password: "666666",
        });
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          this.addDialog.visible = false;
        }
      }
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //查询学院
      this.collogeList = [];
      this.getCollogeList();
      //设置弹框属性
      this.addDialog.title = "新增学生";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    //查询学院
    async getCollogeList() {
      let res = await getCollegeListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.collogeList = res.data;
      }
    },
    //重置按钮
    resetBtn() {
      this.searchModel.collageId = "";
      this.searchModel.classId = "";
      this.searchModel.majorId = "";
      this.searchModel.stuName = "";
      this.searchModel.currentPage = 1;
      this.getLsit();
    },
    //搜索按钮
    searchBtn() {
      console.log(this.searchModel);
      this.getLsit();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```











#### 第119讲 登录验证码功能

##### 1、添加验证码依赖

```js
<!--图片验证码-->
<dependency>
    <groupId>com.github.penggle</groupId>
    <artifactId>kaptcha</artifactId>
</dependency>
```

##### 2、添加验证码配置类

```js
package com.itmk.config.imagecode;

/**
 * @Author java实战基地
 * @Version 2383404558
 */

import com.google.code.kaptcha.Constants;
import com.google.code.kaptcha.impl.DefaultKaptcha;
import com.google.code.kaptcha.util.Config;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.Properties;

@Configuration
public class ImageConfig {
    @Bean
    public DefaultKaptcha getDefaultKaptcha(){
        DefaultKaptcha defaultKaptcha = new DefaultKaptcha();
        Properties properties = new Properties();
        //验证码是否有边框
        properties.setProperty(Constants.KAPTCHA_BORDER, "yes");
        //边框颜色
        properties.setProperty(Constants.KAPTCHA_BORDER_COLOR, "105,179,90");
        //字体颜色
        properties.setProperty(Constants.KAPTCHA_TEXTPRODUCER_FONT_COLOR, "blue");
        //验证码图片宽度
        properties.setProperty(Constants.KAPTCHA_IMAGE_WIDTH, "200");
        //验证码图片高度
        properties.setProperty(Constants.KAPTCHA_IMAGE_HEIGHT, "36");
        //生成验证码的字符
        properties.setProperty(Constants.KAPTCHA_TEXTPRODUCER_CHAR_STRING, "0123456789");
        //去掉干扰线
        properties.setProperty(Constants.KAPTCHA_NOISE_IMPL,"com.google.code.kaptcha.impl.NoNoise");
        //字体大小
        properties.setProperty(Constants.KAPTCHA_TEXTPRODUCER_FONT_SIZE, "34");
        //字体样式
        properties.setProperty(Constants.KAPTCHA_TEXTPRODUCER_FONT_NAMES, "楷体");
        //验证码位数
        properties.setProperty(Constants.KAPTCHA_TEXTPRODUCER_CHAR_LENGTH, "4");
        // 图片效果
        properties.setProperty(Constants.KAPTCHA_OBSCURIFICATOR_IMPL, "com.google.code.kaptcha.impl.ShadowGimpy");
        Config config = new Config(properties);
        defaultKaptcha.setConfig(config);
        return defaultKaptcha;
    }
}

```

##### 3、LoginController控制器添加imageCode()方法

```js
//生成验证码
    @PostMapping("/image")
    public ResultVo imageCode(HttpServletRequest request){
        //生成验证码的文文字
        String text = defaultKaptcha.createText();
        //获取session
        HttpSession session = request.getSession();
        //把生成的验证码放到session里面
        session.setAttribute("code",text);
        //生成图片的格式，返回给前端
        BufferedImage bufferedImage = defaultKaptcha.createImage(text);
        ByteArrayOutputStream outputStream = null;
        try {
            outputStream = new ByteArrayOutputStream();
            ImageIO.write(bufferedImage, "jpg", outputStream);
            BASE64Encoder encoder = new BASE64Encoder();
            String base64 = encoder.encode(outputStream.toByteArray());
            String captchaBase64 = "data:image/jpeg;base64," + base64.replaceAll("\r\n", "");
            ResultVo result = new ResultVo("生成成功", 200, captchaBase64);
            return result;
        } catch (IOException e) {
            e.printStackTrace();
        } finally {
            try {
                if (outputStream != null) {
                    outputStream.close();
                }
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
        return null;
    }
```

##### 4、登录方法修改为如下

```js
 //登录
    @PostMapping("/login")
    public ResultVo login(HttpServletRequest request,@RequestBody LoginParm parm) {
        if (StringUtils.isEmpty(parm.getUsername()) || StringUtils.isEmpty(parm.getPassword()) || StringUtils.isEmpty(parm.getUserType())) {
            return ResultUtils.error("用户名或密码不能为空!");
        }
        //获取前端传递的验证码
        String code = parm.getCode();
        //从session里面获取验证码
        HttpSession session = request.getSession();
        String scode =  (String)session.getAttribute("code");
        //判断验证码是否正确
        if(StringUtils.isEmpty(scode)){
            return ResultUtils.error("验证码过期!");
        }
        if(!scode.equals(code)){
            return ResultUtils.error("验证码错误!");
        }
        //获取密码
        String password = DigestUtils.md5DigestAsHex(parm.getPassword().getBytes());
        if (parm.getUserType().equals("1")) {
            //构造查询条件
            QueryWrapper<SysUser> query = new QueryWrapper<>();
            query.lambda().eq(SysUser::getUsername, parm.getUsername()).eq(SysUser::getPassword, password);
            SysUser user = sysUserService.getOne(query);
            if (user == null) {
                return ResultUtils.error("用户名或密码错误!");
            }
            //生成token
            Map<String, String> map = new HashMap<>();
            map.put("userId", Long.toString(user.getUserId()));
            map.put("username", user.getUsername());
            String token = jwtUtils.generateToken(map);
            //设置返回值
            LoginResult result = new LoginResult();
            result.setUserId(user.getUserId());
            result.setToken(token);
            result.setUsername(user.getUsername());
            result.setUserType(parm.getUserType());
            return ResultUtils.success("登录成功", result);
        } else {
            //构造查询条件
            QueryWrapper<SchoolStudent> query = new QueryWrapper<>();
            query.lambda().eq(SchoolStudent::getStuNum, parm.getUsername())
                    .eq(SchoolStudent::getPassword, password);
            //查询学生信息
            SchoolStudent student = schoolStudentService.getOne(query);
            if (student == null) {
                return ResultUtils.error("用户名或密码错误!");
            }
            //生成token
            Map<String, String> map = new HashMap<>();
            map.put("userId", Long.toString(student.getStuId()));
            map.put("username", student.getStuName());
            String token = jwtUtils.generateToken(map);
            //设置返回值
            LoginResult result = new LoginResult();
            result.setUserId(student.getStuId());
            result.setToken(token);
            result.setUsername(student.getStuName());
            result.setUserType(parm.getUserType());
            return ResultUtils.success("登录成功", result);
        }

    }
```

##### 5、登录页面

```js
<template>
  <div class="logincontainer">
    <el-form
      class="loginform"
      :model="addModel"
      ref="loginForm"
      :rules="rules"
      :inline="false"
      size="medium"
    >
      <el-form-item style="margin-bottom:15px;">
        <span class="loginTitle">高校宿舍管理系统</span>
      </el-form-item>
      <el-form-item prop="username">
        <el-input
          v-model="addModel.username"
          placeholder="请输入账户"
        ></el-input>
      </el-form-item>
      <el-form-item prop="password">
        <el-input
          type="password"
          v-model="addModel.password"
          placeholder="请输入密码"
        ></el-input>
      </el-form-item>
      <el-form-item prop="code" style="margin-bottom:10px;">
        <el-row :gutter="20">
          <el-col :span="16" :offset="0">
            <el-input
              size="large"
              v-model="addModel.code"
              placeholder="请输入验证码"
            ></el-input>
          </el-col>
          <el-col :span="8" :offset="0">
            <img :src="imgSrc" class="image" @click="getImage" />
          </el-col>
        </el-row>
      </el-form-item>
      <el-form-item prop="userType" >
        <el-radio-group v-model="addModel.userType">
          <el-radio :label="0">学生</el-radio>
          <el-radio :label="1">管理员</el-radio>
        </el-radio-group>
      </el-form-item>
      <el-form-item>
        <el-row :gutter="20">
          <el-col :span="12" :offset="0">
            <el-button class="loginbtn" type="primary" @click="onSubmit"
              >登录</el-button
            >
          </el-col>
          <el-col :span="12" :offset="0">
            <el-button class="loginbtn">取消</el-button>
          </el-col>
        </el-row>
      </el-form-item>
    </el-form>
  </div>
</template>

<script>
import { getImageApi } from "@/api/user";
export default {
  data() {
    return {
      imgSrc: "",
      //表单数据
      addModel: {
        username: "admin",
        password: "123456",
        userType: "",
        code: ""
      },
      //表单验证规则
      rules: {
        username: [
          {
            trigger: "change",
            required: true,
            message: "请输入账户"
          }
        ],
        password: [
          {
            trigger: "change",
            required: true,
            message: "请输入密码"
          }
        ],
        userType: [
          {
            trigger: "change",
            required: true,
            message: "请选择用户类型"
          }
        ],
        code: [
          {
            trigger: "change",
            required: true,
            message: "请填写验证码"
          }
        ]
      }
    };
  },
  methods: {
    onSubmit() {
      this.$refs.loginForm.validate(valid => {
        if (valid) {
          this.$store.dispatch("user/login", this.addModel).then(() => {
            //登录成功
            this.$router.push({ path: this.redirect || "/" });
            this.loading = false;
          });
        }
      });
    },
    async getImage() {
      let res = await getImageApi();
      if (res && res.code == 200) {
        this.imgSrc = res.data;
      }
    }
  },
  created() {
    this.getImage();
  }
};
</script>

<style lang="scss" scoped>
.logincontainer {
  height: 100%;
  background: #fff;
  background-image: url("../../assets/images/login_bg.png");
  display: flex;
  align-items: center;
  justify-content: center;
  background-size: 100% 100%;
  .loginform {
    height: 350px;
    width: 480px;
    background: #fff;
    padding: 15px 20px;
    border-radius: 10px;
    .loginTitle {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: #409eff;
      font-weight: 600;
      // margin-bottom: 10px;
    }
    .loginbtn {
      width: 100%;
    }
  }
}
.image {
  height: 40px;
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
}
</style>

```









#### 第120讲 修改密码功能

##### 1、LoginController控制器添加updatePassword()方法

```js
@PostMapping("/updatePassword")
public ResultVo updatePassword(@RequestBody UpdatePasswordParm parm, HttpServletRequest request) {
    //获取token
    String userType = parm.getUserType();
    //原密码
    String old = DigestUtils.md5DigestAsHex(parm.getOldPassword().getBytes());
    if (userType.equals("1")) { //管理员
        SysUser user = sysUserService.getById(parm.getUserId());
        //密码对比
        if (!old.equals(user.getPassword())) {
            return ResultUtils.error("原密码错误!");
        }
        SysUser sysReader = new SysUser();
        sysReader.setPassword(DigestUtils.md5DigestAsHex(parm.getPassword().getBytes()));
        sysReader.setUserId(parm.getUserId());
        boolean b = sysUserService.updateById(sysReader);
        if (b) {
            return ResultUtils.success("密码修改成功!");
        }
    } else { // 学生
        SchoolStudent user = schoolStudentService.getById(parm.getUserId());
        if (!user.getPassword().equals(old)) {
            return ResultUtils.error("原密码错误!");
        }
        SchoolStudent sysReader = new SchoolStudent();
        sysReader.setPassword(DigestUtils.md5DigestAsHex(parm.getPassword().getBytes()));
        sysReader.setStuId(parm.getUserId());
        boolean b = schoolStudentService.updateById(sysReader);
        if (b) {
            return ResultUtils.success("密码修改成功!");
        }
    }
    return ResultUtils.error("密码修改失败!");
}
```

##### 2、前端layout/components/Navbar.vue页面修改为如下

```js
<template>
  <div class="navbar">
    <hamburger :is-active="sidebar.opened" class="hamburger-container" @toggleClick="toggleSideBar" />

    <breadcrumb class="breadcrumb-container" />

    <div class="right-menu">
      <el-dropdown class="avatar-container" trigger="click">
        <div class="avatar-wrapper">
          <img :src="avatar+'?imageView2/1/w/80/h/80'" class="user-avatar">
          <i class="el-icon-caret-bottom" />
        </div>
        <el-dropdown-menu slot="dropdown" class="user-dropdown">
          <!-- <router-link to="/">
            <el-dropdown-item>
              Home
            </el-dropdown-item>
          </router-link>
          <a target="_blank" href="https://github.com/PanJiaChen/vue-admin-template/">
            <el-dropdown-item>Github</el-dropdown-item>
          </a> -->
          <el-dropdown-item divided @click.native="updatePwd">
            <span style="display: block">密码修改</span>
          </el-dropdown-item>
          <el-dropdown-item divided @click.native="logout">
            <span style="display:block;">退出登录</span>
          </el-dropdown-item>
        </el-dropdown-menu>
      </el-dropdown>
    </div>
    <!-- 修改密码弹框 -->
    <sys-dialog
      :title="dialog.title"
      :height="dialog.height"
      :width="dialog.width"
      :visible="dialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addModel"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="oldPassword" label="原密码">
            <el-input v-model="addModel.oldPassword"></el-input>
          </el-form-item>
          <el-form-item prop="password" label="新密码">
            <el-input v-model="addModel.password"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </div>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { mapGetters } from 'vuex'
import Breadcrumb from '@/components/Breadcrumb'
import Hamburger from '@/components/Hamburger'
import { getUserType,getUserId} from '@/utils/auth'
import { updatePasswordApi } from "@/api/user";
export default {
  components: {
    Breadcrumb,
    Hamburger,
    SysDialog
  },
  data() {
    return {
      rules: {
        oldPassword: [
          { trigger: "blur", required: true, message: "原密码不能为空!" },
        ],
        password: [
          { trigger: "blur", required: true, message: "新密码不能为空!" },
        ],
      },
      addModel: {
        userId: "",
        oldPassword: "",
        password: "",
        userType:''
      },
      dialog: {
        title: "密码修改",
        height: 150,
        width: 650,
        visible: false,
      },
    };
  },
  computed: {
    ...mapGetters([
      'sidebar',
      'avatar'
    ])
  },
  methods: {
    onConfirm() {
      this.$refs.addModel.validate(async (valid) => {
        if (valid) {
          this.addModel.userId = getUserId();
          this.addModel.userType = getUserType();
          let res = await updatePasswordApi(this.addModel);
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.dialog.visible = false;
          }
        }
      });
    },
    onClose() {
      this.dialog.visible = false;
    },
    updatePwd() {
      this.dialog.visible = true;
    },
    toggleSideBar() {
      this.$store.dispatch('app/toggleSideBar')
    },
    async logout() {
      await this.$store.dispatch('user/logout')
      this.$router.push(`/login?redirect=${this.$route.fullPath}`)
    }
  }
}
</script>

<style lang="scss" scoped>
.navbar {
  height: 50px;
  overflow: hidden;
  position: relative;
  background: #009688;
  // box-shadow: 0 1px 4px rgba(0,21,41,.08);

  .hamburger-container {
    
    line-height: 46px;
    height: 100%;
    float: left;
    cursor: pointer;
    transition: background .3s;
    -webkit-tap-highlight-color:transparent;

    &:hover {
      background: rgba(0, 0, 0, .025)
    }
  }

  .breadcrumb-container {
    float: left;
  }

  .right-menu {
    float: right;
    height: 100%;
    line-height: 50px;

    &:focus {
      outline: none;
    }

    .right-menu-item {
      display: inline-block;
      padding: 0 8px;
      height: 100%;
      font-size: 18px;
      color: #5a5e66;
      vertical-align: text-bottom;

      &.hover-effect {
        cursor: pointer;
        transition: background .3s;

        &:hover {
          background: rgba(0, 0, 0, .025)
        }
      }
    }

    .avatar-container {
      margin-right: 30px;

      .avatar-wrapper {
        margin-top: 5px;
        position: relative;

        .user-avatar {
          cursor: pointer;
          width: 40px;
          height: 40px;
          border-radius: 10px;
        }

        .el-icon-caret-bottom {
          cursor: pointer;
          position: absolute;
          right: -20px;
          top: 25px;
          font-size: 12px;
        }
      }
    }
  }
}
</style>

```









#### 第121讲 导入导出学生功能

##### 1、添加导入导出依赖

```js
<dependency>
    <groupId>cn.afterturn</groupId>
    <artifactId>easypoi-spring-boot-starter</artifactId>
</dependency>
```

##### 2、SchoolStudentController控制器添加方法

```js
//导入学生
@RequestMapping("/importStuINfo")
public ResultVo importStuINfo(@RequestParam("file") MultipartFile file, StuParm parm) throws Exception {
    ImportParams importParams = new ImportParams();
    // 数据处理
    importParams.setHeadRows(1);
    ExcelImportResult<StuExcel> result = ExcelImportUtil.importExcelMore(file.getInputStream(), StuExcel.class, importParams);
    List<StuExcel> list = result.getList();
    if (list.size() == 0) {
        return ResultUtils.error("请录入学生信息");
    }
    List<SchoolStudent> studentList = new ArrayList<>();
    //查询学生
    for (int i = 0; i < list.size(); i++) {
        SchoolStudent student = new SchoolStudent();
        BeanUtils.copyProperties(list.get(i),student);
        student.setClassId(Long.parseLong(parm.getClassId()));
        student.setPassword(DigestUtils.md5DigestAsHex("666666".getBytes()));
        studentList.add(student);
    }
    schoolStudentService.importStu(studentList);
    return ResultUtils.success("导入成功!");
}
//导入学生excel模板
@RequestMapping("/importStuTemplate")
public void importStuTemplate(HttpServletResponse response) throws Exception {
    //导出excel，组装数据
    List<StuExcel> list = new ArrayList<>();
    //导出
    String fileName = "学生信息模板.xlsx";
    ExportParams exportParams = new ExportParams();
    exportParams.setType(ExcelType.XSSF);
    Workbook workbook = ExcelExportUtil.exportExcel(exportParams, StuExcel.class, list);
    downloadExcel(fileName, workbook, response);
}
//导出学生
@RequestMapping("/exportStuInfo")
public void exportStuInfo(HttpServletResponse response,StuParm parm) throws Exception {
    SchoolClass aClass = schoolClassService.getById(parm.getClassId());
    //查询学生信息
    QueryWrapper<SchoolStudent> query = new QueryWrapper<>();
    query.lambda().eq(SchoolStudent::getClassId,parm.getClassId());
    List<SchoolStudent> list1 = schoolStudentService.exportStu(parm);
     //导出excel，组装数据
    List<StuExport> list = new ArrayList<>();
    if(list1.size()>0){
        for (int i=0;i<list1.size();i++){
            StuExport excel = new StuExport();
            BeanUtils.copyProperties(list1.get(i),excel);
            list.add(excel);
        }
    }
    //导出
    String fileName = aClass.getClassName()+ "学生信息.xlsx";
    ExportParams exportParams = new ExportParams();
    exportParams.setType(ExcelType.XSSF);
    Workbook workbook = ExcelExportUtil.exportExcel(exportParams, StuExport.class, list);
    downloadExcel(fileName, workbook, response);
}
public static void downloadExcel(String fileName, Workbook workbook, HttpServletResponse response) throws Exception {
    try {
        if (StringUtils.isEmpty(fileName)) {
            throw new RuntimeException("导出文件名不能为空");
        }
        String encodeFileName = URLEncoder.encode(fileName, "UTF-8");
        response.setHeader("content-Type", "application/vnd.ms-excel; charset=utf-8");
        response.setHeader("Content-Disposition", "attachment;filename=" + encodeFileName);
        response.setHeader("FileName", encodeFileName);
        response.setHeader("Access-Control-Expose-Headers", "FileName");
        workbook.write(response.getOutputStream());
        workbook.close();
    } catch (Exception e) {
        workbook.close();
    }
}
```



##### 3、api/suudent.js添加如下方法

```js
//重置密码
export const resetPasswordApi = async(parm)=>{
    return await http.post("/api/student/resetPassword",parm)
}
//导入
export const importStuINfoApi = async(parm)=>{
    return await http.upload("/api/student/importStuINfo",parm)
}
```

##### 4、stuList.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-row :gutter="20">
        <el-col :span="24" :offset="0">
          <el-form-item>
            <el-select
              @change="serchCollogeChange"
              style="width: 100%"
              v-model="searchModel.collageId"
              placeholder="请选择学院"
            >
              <el-option
                v-for="item in searchCollogeList"
                :key="item.collageId"
                :label="item.collageName"
                :value="item.collageId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item>
            <el-select
              @change="selectSearchMajorChangeEdit"
              style="width: 100%"
              v-model="searchModel.majorId"
              placeholder="请选择专业"
            >
              <el-option
                v-for="item in searchMajorList"
                :key="item.majorId"
                :label="item.majorName"
                :value="item.majorId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item>
            <el-select
              style="width: 100%"
              v-model="searchModel.classId"
              placeholder="请选择专业"
            >
              <el-option
                v-for="item in searchClassList"
                :key="item.classId"
                :label="item.className"
                :value="item.classId"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item>
            <el-input
              v-model="searchModel.stuName"
              placeholder="请输入学生姓名"
            ></el-input>
          </el-form-item>
        </el-col>
      </el-row>
      <div style="margin-bottom:20px;display: flex;">
        <el-button icon="el-icon-search" style="margin-left:15px;" size="small" @click="searchBtn">搜索</el-button>
        <el-button icon="el-icon-close"  size="small" @click="resetBtn" style="color: #ff7670;margin-left:15px;"
          >重置</el-button
        >
        <el-button
          v-permission="['sys:stuList:add']"
          style="margin-left:15px;"
          type="primary"
          size="small"
          icon="el-icon-plus"
          @click="addBtn"
          >新增</el-button
        >
        <el-button
          style="margin-right:15px;"
          type="success"
          size="small"
          icon="el-icon-bottom"
          @click="exportStu()"
          >导入模板</el-button
        >
        <el-upload
          action=""
          :auto-upload="true"
          :multiple="false"
          :show-file-list="false"
          :http-request="uploadFileFn"
          :file-list="fileList"
        >
          <el-button type="warning" icon="el-icon-plus"  size="small"
            >导入学生</el-button
          >
        </el-upload>
        <el-button
          style="margin-left:15px;"
          type="primary"
          size="small"
          icon="el-icon-bottom"
          @click="getStuInfo()"
          >导出学生</el-button
        >
      </div>
    </el-form>
    <!-- 表格数据 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column label="学生姓名" prop="stuName"></el-table-column>
      <el-table-column label="学号" prop="stuNum"></el-table-column>
      <el-table-column label="性别" prop="stuName">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.sex == '0'" type="danger" size="small"
            >男</el-tag
          >
          <el-tag v-if="scope.row.sex == '1'" type="blue" size="small"
            >女</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column label="学生电话" prop="phone"></el-table-column>
      <!-- <el-table-column label="身份证号" prop="idCard"></el-table-column> -->
      <el-table-column label="班级" prop="className"></el-table-column>
      <el-table-column label="专业" prop="majorName"></el-table-column>
      <el-table-column label="学院" prop="collageName"></el-table-column>
      <el-table-column label="宿舍" prop="roomCode"></el-table-column>
      <el-table-column label="床位" prop="bedCode"></el-table-column>
      <el-table-column
        v-if="$checkPermission(['sys:stuList:edit', 'sys:stuList:delete'])"
        label="操作"
        align="center"
        width="300"
      >
        <template slot-scope="scope">
          <el-button
            v-permission="['sys:stuList:edit']"
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            v-permission="['sys:stuList:reset']"
            icon="el-icon-edit"
            type="success"
            size="small"
            @click="resetPasBtn(scope.row)"
            >重置密码</el-button
          >
          <el-button
            v-permission="['sys:stuList:delete']"
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchModel.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchModel.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchModel.total"
      background
    >
    </el-pagination>

    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :width="addDialog.width"
      :height="addDialog.height"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="collageId" label="所属学院">
                <el-select
                  @change="selectChange"
                  style="width: 100%"
                  v-model="addModel.collageId"
                  placeholder="请选择学院"
                >
                  <el-option
                    v-for="item in collogeList"
                    :key="item.collageId"
                    :label="item.collageName"
                    :value="item.collageId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="majorId" label="所属专业">
                <el-select
                  @change="selectMajorChange"
                  style="width: 100%"
                  v-model="addModel.majorId"
                  placeholder="请选择专业"
                >
                  <el-option
                    v-for="item in majorList"
                    :key="item.majorId"
                    :label="item.majorName"
                    :value="item.majorId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="classId" label="所属班级">
                <el-select
                  style="width: 100%"
                  v-model="addModel.classId"
                  placeholder="请选择专业"
                >
                  <el-option
                    v-for="item in classList"
                    :key="item.classId"
                    :label="item.className"
                    :value="item.classId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="姓名" prop="stuName">
                <el-input v-model="addModel.stuName"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="学号" prop="stuNum">
                <el-input v-model="addModel.stuNum"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="性别" prop="sex">
                <el-radio-group v-model="addModel.sex">
                  <el-radio :label="'0'">男</el-radio>
                  <el-radio :label="'1'">女</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="身份证" prop="idCard">
                <el-input v-model="addModel.idCard"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="电话" prop="phone">
                <el-input v-model="addModel.phone"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="roleId" label="角色">
                <el-select
                  style="width: 100%"
                  v-model="addModel.roleId"
                  placeholder="请选择角色"
                >
                  <el-option
                    v-for="item in roleList"
                    :key="item.roleId"
                    :label="item.roleName"
                    :value="item.roleId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col v-if="addModel.type == '0'" :span="12" :offset="0">
              <el-form-item label="密码" prop="password">
                <el-input v-model="addModel.password"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getCollegeListApi } from "@/api/major.js";
import { getMajorListApi } from "@/api/classes.js";
import {
  getClassListApi,
  addApi,
  listApi,
  getByIdApi,
  editApi,
  deleteApi,
  getRoleListApi,
  resetPasswordApi,
  importStuINfoApi
} from "@/api/student.js";
export default {
  components: {
    SysDialog
  },
  data() {
    return {
      fileList: [],
      searchClassList: [],
      searchMajorList: [],
      searchCollogeList: [],
      //表格高度
      tableHeight: 0,
      //表格数据
      tableList: [],
      //学院数据
      collogeList: [],
      //专业数据
      majorList: [],
      //班级数据
      classList: [],
      //表单验证规则
      rules: {
        collageId: [
          {
            trigger: "blur",
            required: true,
            message: "请选择学院"
          }
        ],
        majorId: [
          {
            trigger: "blur",
            required: true,
            message: "请选择专业"
          }
        ],
        classId: [
          {
            trigger: "blur",
            required: true,
            message: "请选择班级"
          }
        ],
        stuName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写姓名"
          }
        ],
        sex: [
          {
            trigger: "blur",
            required: true,
            message: "请选择性别"
          }
        ],
        stuNum: [
          {
            trigger: "blur",
            required: true,
            message: "请填写学号"
          }
        ],
        idCard: [
          {
            trigger: "blur",
            required: true,
            message: "请填写身份证"
          }
        ],
        phone: [
          {
            trigger: "blur",
            required: true,
            message: "请填写电话"
          }
        ]
      },
      //表单绑定的对象
      addModel: {
        type: "",
        stuId: "",
        roleId: "",
        password: "",
        classId: "",
        collageId: "",
        majorId: "",
        stuName: "",
        sex: "",
        stuNum: "",
        idCard: "",
        phone: ""
      },
      //弹框属性
      addDialog: {
        title: "",
        width: 680,
        height: 260,
        visible: false
      },
      //搜索参数
      searchModel: {
        collageName: "",
        majorName: "",
        className: "",
        stuName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
        classId: "",
        collageId: "",
        majorId: ""
      },
      roleList: []
    };
  },
  created() {
    this.getLsit();
    this.getRoleList();
    this.getSearchCollogeList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  methods: {
    //导入学生
    async uploadFileFn(param) {
      if (!this.searchModel.collageId) {
        this.$message.warning("请选择学院!");
        return false;
      }
      if (!this.searchModel.majorId) {
        this.$message.warning("请选择专业!");
        return false;
      }
      //判断是否选择班级
      if (!this.searchModel.classId) {
        this.$message.warning("请选择班级!");
        return false;
      }

      const file = param.file;

      // 通过split方法和fileArr方法获取到文件的后缀名
      let fileArr = file.name.split(".");
      let suffix = fileArr[fileArr.length - 1];
      //只能导入.xls和.xlsx文件
      if (!/(xls|xlsx)/i.test(suffix)) {
        this.$message.warning("文件格式不正确");
        return false;
      }
      //不能导入大小超过2Mb的文件
      if (file.size > 2 * 1024 * 1024) {
        this.$message("文件过大,请上传小于2MB的文件〜");
        return false;
      }
      const formData = new FormData();
      formData.append("file", file);
      formData.append("classId", this.searchModel.classId);
      formData.append("collageId", this.searchModel.collageId);
      formData.append("majorId", this.searchModel.majorId);
      let res = await importStuINfoApi(formData);
      if (res && res.code == 200) {
        this.$message.success(res.msg);
        this.getLsit();
      }
    },
    //导出学生
    getStuInfo() {
      if (!this.searchModel.collageId) {
        this.$message.warning("请选择学院!");
        return false;
      }
      if (!this.searchModel.majorId) {
        this.$message.warning("请选择专业!");
        return false;
      }
      //判断是否选择班级
      if (!this.searchModel.classId) {
        this.$message.warning("请选择班级!");
        return false;
      }
      const abtn = document.createElement("a");
      abtn.href =
        process.env.VUE_APP_BASE_API_PRO +
        "/api/student/exportStuInfo?classId=" +
        this.searchModel.classId+"&collageId="+this.searchModel.collageId+
        +"&majorId="+this.searchModel.majorId
      abtn.click();
    },
    //下载模板
    exportStu() {
      const abtn = document.createElement("a");
      abtn.href =
        process.env.VUE_APP_BASE_API_PRO + "/api/student/importStuTemplate";
      abtn.click();
    },
    //搜索查询学院
    async getSearchCollogeList() {
      let res = await getCollegeListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.searchCollogeList = res.data;
      }
    },
    async serchCollogeChange(val) {
      //清空数据
      this.searchModel.majorId = "";
      this.searchMajorList = [];
      this.searchModel.classId = "";
      this.searchClassList = [];
      // console.log(val);
      let res = await getMajorListApi({
        collageId: val
      });
      if (res && res.code == 200) {
        //设置专业数据
        this.searchMajorList = res.data;
      }
    },
    async selectSearchMajorChangeEdit(val) {
      this.searchClassList = [];
      let res = await getClassListApi({
        major: val
      });
      if (res && res.code == 200) {
        this.searchClassList = res.data;
      }
    },
    //角色列表
    async getRoleList() {
      let res = await getRoleListApi();
      if (res && res.code == 200) {
        this.roleList = res.data;
      }
    },
    //页数改变触发
    currentChange(val) {
      this.searchModel.currentPage = val;
      this.getLsit();
    },
    //页容量
    sizeChange(val) {
      this.searchModel.pageSize = val;
      this.getLsit();
    },
    //删除
    async deleteBtn(row) {
      const confrim = await this.$myconfirm("确定删除该数据吗?");
      if (confrim) {
        let res = await deleteApi({
          stuId: row.stuId
        });
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          this.getLsit();
        }
      }
    },
    //编辑
    editBtn(row) {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //查询编辑的信息
      this.getIfById(row.stuId);
      //查询学院
      this.collogeList = [];
      this.getCollogeList();
      //设置弹框属性
      this.addDialog.title = "编辑学生";
      this.addDialog.visible = true;
      this.addModel.type = "1";
      //密码清空
      this.addModel.password = "";
    },
    //根据学生id查询学生信息
    async getIfById(stuId) {
      let res = await getByIdApi({
        stuId: stuId
      });
      if (res && res.code == 200) {
        //设置编辑的信息
        this.$objCoppy(res.data, this.addModel);
        this.selectChangeEdit(res.data.collageId);
        this.selectMajorChangeEdit(res.data.majorId);
      }
    },
    async selectMajorChangeEdit(val) {
      this.classList = [];
      let res = await getClassListApi({
        major: val
      });
      if (res && res.code == 200) {
        this.classList = res.data;
      }
    },
    async selectChangeEdit(val) {
      //清空数据
      this.majorList = [];
      let res = await getMajorListApi({
        collageId: val
      });
      if (res && res.code == 200) {
        //设置专业数据
        this.majorList = res.data;
      }
    },
    //获取表格数据
    async getLsit() {
      let res = await listApi(this.searchModel);
      if (res && res.code == 200) {
        //设置表格数据
        this.tableList = res.data.records;
        this.searchModel.total = res.data.total;
      }
    },
    //专业选择事件
    async selectMajorChange(val) {
      this.addModel.classId = "";
      this.classList = [];
      let res = await getClassListApi({
        major: val
      });
      if (res && res.code == 200) {
        this.classList = res.data;
      }
      // console.log(this.classList);
    },
    //选用选择事件,返回专业列表
    async selectChange(val) {
      //清空数据
      this.addModel.majorId = "";
      this.majorList = [];
      this.addModel.classId = "";
      this.classList = [];
      // console.log(val);
      let res = await getMajorListApi({
        collageId: val
      });
      if (res && res.code == 200) {
        //设置专业数据
        this.majorList = res.data;
      }
    },
    //弹框确定
    onConfirm() {
      this.$refs.addForm.validate(async valid => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            //刷新列表
            this.getLsit();
            this.addDialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.addDialog.visible = false;
    },
    async resetPasBtn(row) {
      const conirm = await this.$myconfirm(
        "确定重置密码吗？重置之后密码为【666666】"
      );
      if (conirm) {
        let res = await resetPasswordApi({
          stuId: row.stuId,
          password: "666666"
        });
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          this.addDialog.visible = false;
        }
      }
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //查询学院
      this.collogeList = [];
      this.getCollogeList();
      //设置弹框属性
      this.addDialog.title = "新增学生";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    //查询学院
    async getCollogeList() {
      let res = await getCollegeListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.collogeList = res.data;
      }
    },
    //重置按钮
    resetBtn() {
      this.searchModel.collageId = "";
      this.searchModel.classId = "";
      this.searchModel.majorId = "";
      this.searchModel.stuName = "";
      this.searchModel.currentPage = 1;
      this.getLsit();
    },
    //搜索按钮
    searchBtn() {
      console.log(this.searchModel);
      this.getLsit();
    }
  }
};
</script>

<style lang="scss" scoped></style>

```









#### 第122讲 公告敏感信息处理

##### 1、SysNoticeController控制器list()和getTopList()方法修改为如下

```js
//列表查询
@GetMapping("/list")
public ResultVo list(NoticeParm parm){
    //构造分页对象
    IPage<SysNotice> page = new Page<>(parm.getCurrentPage(),parm.getPageSize());
    //查询条件
    QueryWrapper<SysNotice> query = new QueryWrapper<>();
    if(StringUtils.isNotEmpty(parm.getNoticeTitle())){
        query.lambda().like(SysNotice::getNoticeTitle,parm.getNoticeTitle());
    }
    query.lambda().orderByDesc(SysNotice::getCreateTime);
    IPage<SysNotice> list = sysNoticeService.page(page, query);
    list.getRecords().stream().forEach(item ->{
        if(item.getTypes().equals("1")){
            String content = item.getNoticeText();
            String first = content.substring(0, content.indexOf("+"));

            //截切第二个+之后的内容
            int index = content.indexOf("+");
            int second = content.indexOf("+",index+1);
            String snum = content.substring(index+1,second);
            String newtext = content.substring(second+1);
            String newContent = Utils.subName(first) + "," + Utils.subNum(snum) + "," + newtext;
            item.setNoticeText(newContent);
        }
    });
    return ResultUtils.success("查询成功",list);
}
//首页公告
@GetMapping("/getTopList")
public ResultVo getTopList(){
    QueryWrapper<SysNotice> query = new QueryWrapper<>();
    query.lambda().orderByDesc(SysNotice::getCreateTime).last("limit 3");
    List<SysNotice> list = sysNoticeService.list(query);
    list.stream().forEach(item ->{
        if(item.getTypes().equals("1")){
            String content = item.getNoticeText();
            String first = content.substring(0, content.indexOf("+"));

            //截切第二个+之后的内容
            int index = content.indexOf("+");
            int second = content.indexOf("+",index+1);
            String snum = content.substring(index+1,second);
            String newtext = content.substring(second+1);
            String newContent = Utils.subName(first) + "," + Utils.subNum(snum) + "," + newtext;
            item.setNoticeText(newContent);
        }
    });
    return ResultUtils.success("查询成功",list);
}
```

##### 2、公告页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchModel" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="searchModel.noticeTitle"
          placeholder="请输入公告标题"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button
          v-permission="['sys:sysNotice:add']"
          type="primary"
          icon="el-icon-plus"
          @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableList" border stripe>
      <el-table-column prop="noticeTitle" label="标题"></el-table-column>
      <el-table-column prop="noticeText" label="内容"></el-table-column>
      <el-table-column prop="createTime" label="发布时间"></el-table-column>
      <el-table-column
        v-if="$checkPermission(['sys:sysNotice:edit', 'sys:sysNotice:delete'])"
        label="操作"
        align="center"
        width="220"
      >
        <template slot-scope="scope">
          <el-button
            v-permission="['sys:sysNotice:edit']"
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            v-permission="['sys:sysNotice:delete']"
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="searchModel.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="searchModel.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="searchModel.total"
      background
    >
    </el-pagination>

    <!-- 弹框 -->
    <sys-dialog
      :title="addDialog.title"
      :height="addDialog.height"
      :width="addDialog.width"
      :visible="addDialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addForm"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="noticeTitle" label="标题">
            <el-input v-model="addModel.noticeTitle"></el-input>
          </el-form-item>
          <el-tooltip
            class="item"
            effect="dark"
            content="敏感公告请按：姓名+学号+内容格式发布"
            placement="bottom"
          >
            <el-form-item prop="noticeText" label="公告内容">
              <el-input
                type="textarea"
                v-model="addModel.noticeText"
              ></el-input>
            </el-form-item>
          </el-tooltip>
          <el-form-item prop="types" label="敏感公告">
            <el-radio-group v-model="addModel.types">
              <el-radio :label="'0'">否</el-radio>
              <el-radio :label="'1'">是</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { Message } from 'element-ui';
import { addApi, listApi, editApi, deleteApi,getByIdApi } from "@/api/notice.js";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  components: {
    SysDialog
  },
  data() {
    return {
      tableHeight: 0,
      tableList: [],
      rules: {
        noticeTitle: [
          {
            trigger: "blur",
            message: "请输入公告标题",
            required: true
          }
        ],
        noticeText: [
          {
            trigger: "blur",
            message: "请输入公告内容",
            required: true
          }
        ],
        types: [
          {
            trigger: "blur",
            message: "请选择是否是敏感公告",
            required: true
          }
        ]
      },
      addModel: {
        type: "",
        types: "",
        noticeId: "",
        noticeTitle: "",
        noticeText: ""
      },
      //弹框属性
      addDialog: {
        title: "",
        height: 180,
        width: 650,
        visible: false
      },
      searchModel: {
        currentPage: 1,
        pageSize: 10,
        noticeTitle: "",
        total: 0
      }
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  methods: {
    currentChange(val) {
      this.searchModel.currentPage = val;
      this.getList();
    },
    sizeChange(val) {
      this.searchModel.pageSize = val;
      this.getList();
    },
    async deleteBtn(row) {
      const confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteApi({
          noticeId: row.noticeId
        });
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          this.getList();
        }
      }
    },
    async editBtn(row) {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      let res = await getByIdApi({
        noticeId:row.noticeId
      })
      if(res && res.code == 200){
        Object.assign(this.addModel,res.data)
      }
      //设置弹框属性
      this.addDialog.title = "编辑公告";
      this.addDialog.visible = true;
      this.addModel.type = "1";
    },
    async getList() {
      let res = await listApi(this.searchModel);
      if (res && res.code == 200) {
        this.tableList = res.data.records;
        this.searchModel.total = res.data.total;
      }
    },
    onConfirm() {
      this.$refs.addForm.validate(async valid => {
        if (valid) {
          if(this.addModel.types == "1"){
            let index = this.addModel.noticeText.indexOf("+");
            let second = this.addModel.noticeText.indexOf("+",index+1);
            if(index == -1 || second == -1){
              Message.warning('敏感公告请按：姓名+学号+内容格式发布')
              return;
            }
          }
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.getList();
            this.addDialog.visible = false;
          }
        }
      });
    },
    onClose() {
      this.addDialog.visible = false;
    },
    addBtn() {
      //清空表单
      this.$resetForm("addForm", this.addModel);
      //设置弹框属性
      this.addDialog.title = "新增公告";
      this.addDialog.visible = true;
      this.addModel.type = "0";
    },
    searchBtn() {
      this.getList();
    },
    resetBtn() {
      this.searchModel.noticeTitle = "";
      this.searchModel.currentPage = 1;
      this.getList();
    }
  }
};
</script>

<style lang="scss" scoped></style>

```















































